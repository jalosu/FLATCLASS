@startuml
title Medición automática de peces planos:\n Pipeline maestro

start

partition "M1 - Captura" {
  :Disparo por barrera/PLC;
  :Captura de imagen + metadatos;
  if (¿Frame válido?) then (Sí)
    :Imagen_raw;
  else (No)
    :Error captura;
    stop
  endif
}

partition "M2 - Calibración de escala" {
  if (¿Calibración vigente?) then (Sí)
    :Usar escala px→mm guardada;
  else (No)
    :Detectar patrón referencia;
    if (¿Detectado?) then (Sí)
      :Calcular escala px→mm;
    else (No)
      :Marcar sin_escala;
    endif
  endif
}

partition "M3 - Imagen" {

  partition "1) Preprocesado" {
  :Reducción de rudio;
  :Suavizado de bordes;
  :Normalización iluminación (CLAHE);
  :Conversión a HSV
  :Definición ROI (opcional);
  }

  partition "2) Segmentación" {
  :Definición de ROI;
  :Semillas /Umbrales;
  :GrabCut / Umbral + Morfología;
  :Máscara pez (fg_mask);
  if (¿Máscara válida?) then (Sí)
    :Seguir;
  else (No)
    :Error segmentación;
    stop
  endif
  }

  partition "3) Selección" {
  :Buscar contornos/componentes;
  if (¿Hay candidatos?) then (Sí)
    :Seleccionar principal (mayor área/ROI);
    :Verificar QC (área mínima, elongación, posición);
    if (¿QC OK?) then (Sí)
      :Contorno principal;
    else (No)
      :Rechazo QC;
      stop
    endif
  else (No)
    :Error sin objeto;
    stop
  endif
}

partition "4) Medición" {
  :PCA sobre puntos de controno;
  :Construir caja PCA y eje mayor;
  :Overlay (contorno + medidas);
  :Obtener dimensiones;
  if (¿Escala disponible?) then (Sí)
    :Convertir a mm/cm;
  else (No)
    :Medidas en px;
  endif
}

}

partition "M4 - Salida y persistencia" {
  :Payload {medidas, QC, timestamp};
  :Guardar en BBDD/FS;
  :Notificar PLC/MQTT/REST;
}

stop
@enduml