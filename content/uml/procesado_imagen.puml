@startuml 
title Extracción características morfométricas de un lenguado desde imagen

start

:'Foto capturada' desde trigger barrera/PLC;
:Recibir imagen (buffer/memoria);

partition "A) Ajuste de dimensiones (Calibración de escala)" {
  if (¿Hay calibración válida activa?) then (Sí)
    :Leer factores px→mm activos (timestamp, id cámara);
  else (No)
    :Detectar patrón de referencia (p. ej., fiduciales, checkerboard, regla);
    if (¿Patrón detectado?) then (Sí)
      :Calcular escala px→mm y (opcional) homografía;
      :Actualizar/guardar parámetros de calibración;
    else (No)
      :Marcar medición como 'sin escala fiable';
      :Continuar en px (opcional) o abortar;
    endif
  endif
}

partition "B) Preprocesado" {
  :Corrección geométrica (si homografía/distorsión) – opcional;
  :Normalización ligera de iluminación/contraste (p. ej., CLAHE);
  :Filtrado suave anti-ruido (mediana/gaussiano ligero);
  :Definir ROI si procede (zona útil de la cinta);
}

partition "C) Segmentación del pez" {
  :Espacio de color adecuado (HSV/LAB);
  :Semillas/máscaras iniciales (fondo vs pez) o umbral adaptativo;
  :Algoritmo de segmentación (p. ej., GrabCut/Umbral+Morfol.);
  :Postproceso morfológico (close/open, fill holes);
}

partition "D) Selección de objeto y validaciones" {
  :Encontrar contornos/Componentes conectados;
  if (¿Existen candidatos?) then (Sí)
    :Seleccionar componente principal (área/máscara más grande);
    :Comprobaciones QC (área mínima, elongación, posición en ROI);
    if (¿Cumple QC?) then (Sí)
      :Continuar;
    else (No)
      :Marcar imagen como 'rechazo QC' (ruido/oclusiones);
      :Registrar incidente y (opcional) solicitar recaptura;
      stop
    endif
  else (No)
    :Registro error 'sin pez';
    :Opcional: recaptura/descartar;
    stop
  endif
}

partition "E) Extracción de medidas" {
  :Calcular contorno y área en px;
  :Rectángulo mínimo (minAreaRect) → largo y ancho en px;
  if (¿Escala px→mm disponible?) then (Sí)
    :Convertir a mm/cm (largo, ancho, área);
  else (No)
    :Conservar medidas en px y marcar 'sin escala';
  endif
  :Opcional: eje esquelético/longitud curvilínea;
}

partition "F) Salida y persistencia" {
  :Componer overlay (contorno, caja, medidas);
  :Empaquetar resultado (medidas, flags QC, id lote, timestamp);
  :Guardar en base de datos/archivo y (opcional) topic MQTT/PLC;
  :Emitir evento OK/ERROR para el PLC/Supervisión;
}

stop
@enduml