
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>2.4. M3 - Imagen &#8212; FLATCLASS - FLATfish Length and Thickness CLASification System by Artificial Intelligence</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]]}, "options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'content/01/Modulo-3';</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="2.5. M4 - Salida y persistencia" href="Modulo-4.html" />
    <link rel="prev" title="2.3. M2 - Calibración" href="Modulo-2.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../_static/flatclass_logo.png" class="logo__image only-light" alt="FLATCLASS - FLATfish Length and Thickness CLASification System by Artificial Intelligence - Home"/>
    <script>document.write(`<img src="../../_static/flatclass_logo.png" class="logo__image only-dark" alt="FLATCLASS - FLATfish Length and Thickness CLASification System by Artificial Intelligence - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">PT1 - Visión Artificial</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="Requisitos.html">1. Especificación de requisitos</a></li>
<li class="toctree-l1 current active has-children"><a class="reference internal" href="Imagen.html">2. Sistema de visión artificial</a><details open="open"><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="Modulo-1.html">2.2. M1 - Captura</a></li>
<li class="toctree-l2"><a class="reference internal" href="Modulo-2.html">2.3. M2 - Calibración</a></li>
<li class="toctree-l2 current active"><a class="current reference internal" href="#">2.4. M3 - Imagen</a></li>
<li class="toctree-l2"><a class="reference internal" href="Modulo-4.html">2.5. M4 - Salida y persistencia</a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">PT2 - Datasets</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../02/Dataset.html">3. Obtención y etiquetado del dataset</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../02/Generador.html">4. Generación de datos sintéticos</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../02/GaussianCopula.html">4.2. Gaussian Copula</a></li>
<li class="toctree-l2"><a class="reference internal" href="../02/CTGAN.html">4.3. Conditional Tabular GAN (CTGAN)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../02/TVAE.html">4.4. Tabular Variational Autoencoder (TVAE)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../02/Conclusion.html">4.5. Conclusión</a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">PT3 - Predicción del Peso</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../03/Peso.html">5. Desarrollo Experimental de un Modelo de IA para la Estimación del Peso</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../03/Coeficientes.html">5.2. Estudio matemático de las relaciones entre las dimensiones morfológicas y el peso</a></li>
<li class="toctree-l2"><a class="reference internal" href="../03/Analisis.html">5.3. Análisis del modelo alométrico longitud-anchura</a></li>
<li class="toctree-l2"><a class="reference internal" href="../03/Modelo.html">5.4. Algoritmo de inferencia del peso <span class="math notranslate nohighlight">\(W\)</span></a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">PT4 - Sistema de clasificación automática</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../04/Mecatronica.html">6. Sistema mecatrónico de separación</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">



<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>M3 - Imagen</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#preprocesado">2.4.1. Preprocesado</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#segmentacion">2.4.2. Segmentación</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#seleccion-y-medicion">2.4.3. Selección y medición</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#otras-funciones">2.4.4. Otras funciones</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="m3-imagen">
<h1><span class="section-number">2.4. </span>M3 - Imagen<a class="headerlink" href="#m3-imagen" title="Link to this heading">#</a></h1>
<p>Este módulo es el núcleo del sistema de visión artificial. Operativamente está compuesto por cuatro bloques funcionales que siguen el flujo recogido en la <a class="reference internal" href="#figura-wp1-imagen-6"><span class="std std-numref">Figura 2.6</span></a>:</p>
<figure class="align-center" id="figura-wp1-imagen-6">
<a class="reference internal image-reference" href="../../_images/Modulo-3.png"><img alt="UML del modúlo de visión artificial" src="../../_images/Modulo-3.png" style="width: 25%;" />
</a>
<figcaption>
<p><span class="caption-number">Figura 2.6 </span><span class="caption-text">Bloques funcionales del módulo de imagen (visión artificial)</span><a class="headerlink" href="#figura-wp1-imagen-6" title="Link to this image">#</a></p>
</figcaption>
</figure>
<p>El motor de este módulo se sustenta sobre el algoritmo GrabCut. GrabCut es un método semiautomático para segmentar objetos en una imagen, es decir, para separar una región de interés del resto de la escena. Fue propuesto en 2004 por Rother, Kolmogorov y Blake [<a class="reference external" href="https://doi.org/10.1145/1015706.1015720">Rother et al., 2004</a>], y se ha convertido en una herramienta clásica en visión por computadora debido a su equilibrio entre precisión y facilidad de uso.</p>
<p>En su planteamiento original, el algoritmo necesita una pequeña intervención del usuario para trazar un rectángulo que contenga aproximadamente el objeto que se desea extraer. A partir de ahí, GrabCut trabaja de forma iterativa para refinar la segmentación sin necesidad de más entradas, aunque también permite correcciones manuales si es necesario.</p>
<p>Matemáticamente, GrabCut modela los colores del objeto (primer plano o foreground) y del entorno (fondo o background) mediante modelos de mezcla gaussiana (GMM, por sus siglas en inglés)[<a class="reference external" href="https://doi.org/10.1007/978-1-4615-7566-5">Bishop, 2006</a>]. Estos modelos permiten representar distribuciones complejas de color como la combinación de varias campanas gaussianas, cada una capturando un tono o textura característica. Así, en lugar de asumir que todos los píxeles del objeto tienen el mismo color, el GMM reconoce que pueden existir múltiples modos (o grupos) de colores dentro de la misma región.</p>
<p>Además del color, GrabCut también considera la estructura espacial de la imagen: píxeles cercanos tienden a pertenecer a la misma clase. Esta idea se modela mediante un campo aleatorio de Markov (MRF), que penaliza soluciones en las que píxeles vecinos tienen etiquetas muy diferentes sin una justificación clara en los datos (por ejemplo, un cambio brusco de color). De esta forma, se evitan segmentaciones irregulares o con ruido [<a class="reference external" href="https://doi.org/10.1007/978-1-84882-437-9">Li, 2009</a>].</p>
<p>Todo esto se combina en una función de energía que mide lo “buena” que es una segmentación propuesta. Minimizar esta energía equivale a encontrar la máscara que mejor explica los colores observados (usando los GMMs) y que, al mismo tiempo, sea espacialmente coherente (gracias al MRF).</p>
<p>En el contexto de FLATCLASS este algoritmo se ha adaptado para no contar con intervención humana inicial. Para aislar el objeto de interés (lenguado) se ha usado una cinta transportadora de color azul, cuyo tono varía ligeramente debido a iluminación escasa, no homogénea, sombras, presencia de gotas de agua o textura del material. Dado que el objeto y el fondo tienen colores claramente distintos, y aún asumiendo que el fondo no es uniforme, se puede indicar al algoritmo que el fondo es predominantemente azul y que el objeto (lenguado) ocupa aproximadamente el centro de la imagen (<a class="reference internal" href="#figura-wp1-imagen-7"><span class="std std-numref">Figura 2.7</span></a>).</p>
<figure class="align-center" id="figura-wp1-imagen-7">
<a class="reference internal image-reference" href="../../_images/P22C-ML_0_calibrated.png"><img alt="Captura de lenguado" src="../../_images/P22C-ML_0_calibrated.png" style="width: 50%;" />
</a>
<figcaption>
<p><span class="caption-number">Figura 2.7 </span><span class="caption-text">Imagen real de lenguado obtenida con el sistema de captura</span><a class="headerlink" href="#figura-wp1-imagen-7" title="Link to this image">#</a></p>
</figcaption>
</figure>
<p>Para mejorar la detección, el <em>pipeline</em> acorta el área de exploración al rectángulo que engloba la cinta y el pez, definiendo de forma automática la región de interés (ROI). Para ello se usa detección cromática robusta de la cinta azul y en un análisis perfilado por columnas que localiza el tramo contiguo donde la cobertura del color azul es dominante a lo largo de toda la altura de la imagen. Primero, el prefiltrado (NLMeans + bilateral + CLAHE) estabiliza ruido e iluminación para que el tono azul sea más estable espectralmente (el bilateral preserva bordes [<a class="reference external" href="https://www.academia.edu/103435418/Bilateral_filtering_for_gray_and_color_images">Tomasi et al., 1998</a>]. A continuación, en espacio HSV se estima de forma adaptativa el intervalo cromático del azul calculando el pico del histograma del matiz (H) en una banda central y con saturación alta (S) —estrategia inspirada en histogramas de color para indexación/segmentación—, lo que compensa variaciones de cámara e iluminación. Con ese umbral dinámico se genera una máscara binaria “azul”; sobre ella, para cada columna <span class="math notranslate nohighlight">\(j\)</span> se computa la razón de cobertura azul <span class="math notranslate nohighlight">\(r_j=\dfrac{1}{H} \sum^H_{y=1} {blue(y,j)}\)</span>. Se marcan como “cinta” las columnas con <span class="math notranslate nohighlight">\(r_j \geq \tau\)</span> y se elige el tramo contíguo más largo <span class="math notranslate nohighlight">\([x_1,x_2]\)</span> de columnas que cumplen el criterio. Esto elimina de forma natural las columnas metálicas laterales correspondientes al soporte de la cámara (fotografía <a class="reference internal" href="#figura-wp1-imagen-7"><span class="std std-numref">Figura 2.7</span></a>), que o bien tienen <span class="math notranslate nohighlight">\(r_j\)</span> bajo o aparecen como tramos cortos no contiguos.</p>
<p>En vertical se repite el razonamiento sobre filas dentro de <span class="math notranslate nohighlight">\([x_1,x_2]\)</span> para obtener <span class="math notranslate nohighlight">\([y_1,y_2]\)</span>. El ROI final es el rectángulo acolchado <span class="math notranslate nohighlight">\(R=(x,y,w,h)\)</span> que engloba <span class="math notranslate nohighlight">\([x_1,x_2] \times [y_1,y_2]\)</span>. Esta determinación geométrica evita depender de cierres morfológicos agresivos (que pueden “invadir” el metal) y se apoya en principios de morfología matemática y conectividad [<a class="reference external" href="https://link.springer.com/book/10.1007/978-3-662-05088-0">Soille, 2003</a>]. La ROI así calculada se utiliza después para restringir GrabCut, etiquetando como “probable fondo” los bordes de la imagen y como “probable primer plano” la región central, al tiempo que se definen en el código tonos de azul como semillas reforzadas para GrabCut, garantizando que la segmentación psoterior se concentre en el pez y la cinta [<a class="reference external" href="https://doi.org/10.1145/1015706.1015720">Rother et al., 2004</a>].</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">cv2</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

<span class="c1"># -------------------------</span>
<span class="c1"># CONFIG</span>
<span class="c1"># -------------------------</span>
<span class="n">CONFIG</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;img_path&quot;</span><span class="p">:</span> <span class="s2">&quot;./original.png&quot;</span><span class="p">,</span>
    <span class="s2">&quot;out_prefix&quot;</span><span class="p">:</span> <span class="s2">&quot;./out/sole_&quot;</span><span class="p">,</span>
    <span class="s2">&quot;pad_roi&quot;</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span>

    <span class="c1"># Prefilter</span>
    <span class="s2">&quot;nlmeans_h&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
    <span class="s2">&quot;bilateral_d&quot;</span><span class="p">:</span> <span class="mi">9</span><span class="p">,</span> <span class="s2">&quot;bilateral_sigmaC&quot;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span> <span class="s2">&quot;bilateral_sigmaS&quot;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span>
    <span class="s2">&quot;clahe_clip&quot;</span><span class="p">:</span> <span class="mf">2.0</span><span class="p">,</span> <span class="s2">&quot;clahe_tiles&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span>

    <span class="c1"># Dynamic blue threshold</span>
    <span class="s2">&quot;blue_sat_min&quot;</span><span class="p">:</span> <span class="mi">80</span><span class="p">,</span>
    <span class="s2">&quot;blue_half_window&quot;</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span>

    <span class="c1"># ROI by blue column coverage</span>
    <span class="s2">&quot;belt_col_cover_ratio&quot;</span><span class="p">:</span> <span class="mf">0.22</span><span class="p">,</span>
    <span class="s2">&quot;belt_min_width_px&quot;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>

    <span class="c1"># GrabCut</span>
    <span class="s2">&quot;pr_fg_kernel&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">19</span><span class="p">),</span>
    <span class="s2">&quot;sure_fg_pct_contrast&quot;</span><span class="p">:</span> <span class="mi">70</span><span class="p">,</span>
    <span class="s2">&quot;sure_fg_pct_dt&quot;</span><span class="p">:</span> <span class="mi">60</span><span class="p">,</span>
    <span class="s2">&quot;gc_iters&quot;</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span>

    <span class="c1"># Guard-rails (BG) inside ROI</span>
    <span class="s2">&quot;guard_frac_w&quot;</span><span class="p">:</span> <span class="mf">0.03</span><span class="p">,</span>
    <span class="s2">&quot;guard_min_px&quot;</span><span class="p">:</span> <span class="mi">14</span><span class="p">,</span>
    <span class="s2">&quot;guard_max_px&quot;</span><span class="p">:</span> <span class="mi">48</span><span class="p">,</span>

    <span class="c1"># Postprocess</span>
    <span class="s2">&quot;post_close_kernel&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">13</span><span class="p">),</span>

    <span class="c1"># Candidate filter &amp; shape prior (STRICT)</span>
    <span class="s2">&quot;min_area_px2&quot;</span><span class="p">:</span> <span class="mi">5000</span><span class="p">,</span>
    <span class="s2">&quot;min_width_px&quot;</span><span class="p">:</span> <span class="mi">32</span><span class="p">,</span>
    <span class="s2">&quot;edge_clear_px&quot;</span><span class="p">:</span> <span class="mi">16</span><span class="p">,</span>
    <span class="s2">&quot;shape_mu_log_aspect&quot;</span><span class="p">:</span> <span class="mf">0.92</span><span class="p">,</span>  <span class="c1"># ~aspect 2.5</span>
    <span class="s2">&quot;shape_sigma&quot;</span><span class="p">:</span> <span class="mf">0.35</span><span class="p">,</span>

    <span class="c1"># Relaxed fallback deltas (used if strict fails)</span>
    <span class="s2">&quot;relax&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;min_area_px2&quot;</span><span class="p">:</span> <span class="mi">1500</span><span class="p">,</span>
        <span class="s2">&quot;min_width_px&quot;</span><span class="p">:</span> <span class="mi">14</span><span class="p">,</span>
        <span class="s2">&quot;edge_clear_px&quot;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>
        <span class="s2">&quot;shape_sigma&quot;</span><span class="p">:</span> <span class="mf">0.70</span><span class="p">,</span>
        <span class="s2">&quot;allow_touch_edges&quot;</span><span class="p">:</span> <span class="kc">True</span>
    <span class="p">},</span>

    <span class="c1"># Optional metric scale</span>
    <span class="s2">&quot;scale_json&quot;</span><span class="p">:</span> <span class="s2">&quot;./calibracion_px_mm.json&quot;</span><span class="p">,</span>

    <span class="c1"># --- switches ---</span>
    <span class="s2">&quot;debug&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>     <span class="c1"># PNGs on/off</span>
    <span class="s2">&quot;save_csv&quot;</span><span class="p">:</span> <span class="kc">True</span>    <span class="c1"># CSV on/off</span>
<span class="p">}</span>

<span class="c1"># -------------------------</span>
<span class="c1"># Utilities</span>
<span class="c1"># -------------------------</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_dbg</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">CONFIG</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;debug&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span>

<span class="k">def</span><span class="w"> </span><span class="nf">_ensure_dir</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">save_img</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">img</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Unconditional file save (internal).&quot;&quot;&quot;</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">CONFIG</span><span class="p">[</span><span class="s2">&quot;out_prefix&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">name</span>
    <span class="n">_ensure_dir</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">img</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">cv2</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">img</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cv2</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">img</span> <span class="k">if</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span> <span class="k">else</span> <span class="n">img</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">p</span>

<span class="k">def</span><span class="w"> </span><span class="nf">save_img_dbg</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">img</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Save only if CONFIG[&#39;debug&#39;] is True; otherwise return None.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">_dbg</span><span class="p">():</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="n">save_img</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">img</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">save_csv_dbg</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Save CSV only if CONFIG[&#39;save_csv&#39;] is True; returns path or None.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">CONFIG</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;save_csv&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="n">out_path</span> <span class="o">=</span> <span class="n">CONFIG</span><span class="p">[</span><span class="s2">&quot;out_prefix&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">name</span>
    <span class="n">_ensure_dir</span><span class="p">(</span><span class="n">out_path</span><span class="p">)</span>
    <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">out_path</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">out_path</span>

<span class="k">def</span><span class="w"> </span><span class="nf">get_scale_mm_per_px</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">get_mm_per_px</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_mm_per_px</span>  <span class="c1"># type: ignore</span>
        <span class="n">val</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">get_mm_per_px</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">val</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">val</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">CONFIG</span><span class="p">[</span><span class="s2">&quot;scale_json&quot;</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">read_text</span><span class="p">())</span>
            <span class="n">val</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mm_per_px&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">val</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">val</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
    <span class="k">return</span> <span class="kc">None</span>

<span class="c1"># ---- Morphology helpers to avoid kernel errors ----</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_morph</span><span class="p">(</span><span class="n">img</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">op</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">shape</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">ksize</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span><span class="nb">int</span><span class="p">],</span> <span class="n">iters</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Robust wrapper for cv2.morphologyEx:</span>
<span class="sd">    - Ensures uint8 input</span>
<span class="sd">    - Always builds a valid kernel</span>
<span class="sd">    - Uses positional args for compatibility</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">img</span><span class="o">.</span><span class="n">dtype</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">img</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="nb">bool</span><span class="p">:</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span> <span class="o">*</span> <span class="mi">255</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
    <span class="n">k</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">getStructuringElement</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">ksize</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">ksize</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span>
    <span class="k">return</span> <span class="n">cv2</span><span class="o">.</span><span class="n">morphologyEx</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">iters</span><span class="p">),</span> <span class="n">cv2</span><span class="o">.</span><span class="n">BORDER_CONSTANT</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">_open</span><span class="p">(</span><span class="n">img</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">shape</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">ksize</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span><span class="nb">int</span><span class="p">],</span> <span class="n">iters</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">_morph</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">MORPH_OPEN</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">ksize</span><span class="p">,</span> <span class="n">iters</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">_close</span><span class="p">(</span><span class="n">img</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">shape</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">ksize</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span><span class="nb">int</span><span class="p">],</span> <span class="n">iters</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">_morph</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">MORPH_CLOSE</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">ksize</span><span class="p">,</span> <span class="n">iters</span><span class="p">)</span>

<span class="c1"># -------------------------</span>
<span class="c1"># Pipeline blocks</span>
<span class="c1"># -------------------------</span>
<span class="k">def</span><span class="w"> </span><span class="nf">prefilter</span><span class="p">(</span><span class="n">bgr</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="n">den</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">fastNlMeansDenoisingColored</span><span class="p">(</span>
        <span class="n">bgr</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">h</span><span class="o">=</span><span class="n">CONFIG</span><span class="p">[</span><span class="s2">&quot;nlmeans_h&quot;</span><span class="p">],</span> <span class="n">hColor</span><span class="o">=</span><span class="n">CONFIG</span><span class="p">[</span><span class="s2">&quot;nlmeans_h&quot;</span><span class="p">],</span>
        <span class="n">templateWindowSize</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">searchWindowSize</span><span class="o">=</span><span class="mi">21</span>
    <span class="p">)</span>
    <span class="n">den</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">bilateralFilter</span><span class="p">(</span>
        <span class="n">den</span><span class="p">,</span> <span class="n">d</span><span class="o">=</span><span class="n">CONFIG</span><span class="p">[</span><span class="s2">&quot;bilateral_d&quot;</span><span class="p">],</span>
        <span class="n">sigmaColor</span><span class="o">=</span><span class="n">CONFIG</span><span class="p">[</span><span class="s2">&quot;bilateral_sigmaC&quot;</span><span class="p">],</span> <span class="n">sigmaSpace</span><span class="o">=</span><span class="n">CONFIG</span><span class="p">[</span><span class="s2">&quot;bilateral_sigmaS&quot;</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">hsv</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">den</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2HSV</span><span class="p">)</span>
    <span class="n">h</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">hsv</span><span class="p">)</span>
    <span class="n">clahe</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">createCLAHE</span><span class="p">(</span><span class="n">CONFIG</span><span class="p">[</span><span class="s2">&quot;clahe_clip&quot;</span><span class="p">],</span> <span class="n">CONFIG</span><span class="p">[</span><span class="s2">&quot;clahe_tiles&quot;</span><span class="p">])</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">clahe</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">merge</span><span class="p">([</span><span class="n">h</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">v</span><span class="p">]),</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_HSV2BGR</span><span class="p">)</span>
    <span class="n">save_img_dbg</span><span class="p">(</span><span class="s2">&quot;01_prefilter.png&quot;</span><span class="p">,</span> <span class="n">out</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">out</span>

<span class="k">def</span><span class="w"> </span><span class="nf">dynamic_blue_threshold</span><span class="p">(</span><span class="n">hsv</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
    <span class="n">H</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">hsv</span><span class="p">)</span>
    <span class="n">Hh</span><span class="p">,</span> <span class="n">Wh</span> <span class="o">=</span> <span class="n">H</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">Wh</span> <span class="o">*</span> <span class="mf">0.32</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">Wh</span> <span class="o">*</span> <span class="mf">0.68</span><span class="p">)</span>
    <span class="n">band</span> <span class="o">=</span> <span class="n">H</span><span class="p">[:,</span> <span class="n">x1</span><span class="p">:</span><span class="n">x2</span><span class="p">];</span> <span class="n">band_s</span> <span class="o">=</span> <span class="n">S</span><span class="p">[:,</span> <span class="n">x1</span><span class="p">:</span><span class="n">x2</span><span class="p">]</span>
    <span class="n">mask_sat</span> <span class="o">=</span> <span class="n">band_s</span> <span class="o">&gt;</span> <span class="n">CONFIG</span><span class="p">[</span><span class="s2">&quot;blue_sat_min&quot;</span><span class="p">]</span>
    <span class="n">hh</span> <span class="o">=</span> <span class="n">band</span><span class="p">[</span><span class="n">mask_sat</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">hh</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">lower</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">95</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">30</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
        <span class="n">upper</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">125</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">hist</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">calcHist</span><span class="p">([</span><span class="n">hh</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="kc">None</span><span class="p">,</span> <span class="p">[</span><span class="mi">180</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">180</span><span class="p">])</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="n">peak</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">hist</span><span class="p">));</span> <span class="n">hw</span> <span class="o">=</span> <span class="n">CONFIG</span><span class="p">[</span><span class="s2">&quot;blue_half_window&quot;</span><span class="p">]</span>
        <span class="n">lower</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">peak</span> <span class="o">-</span> <span class="n">hw</span><span class="p">),</span> <span class="mi">80</span><span class="p">,</span> <span class="mi">30</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
        <span class="n">upper</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">min</span><span class="p">(</span><span class="mi">179</span><span class="p">,</span> <span class="n">peak</span> <span class="o">+</span> <span class="n">hw</span><span class="p">),</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">lower</span><span class="p">,</span> <span class="n">upper</span>

<span class="k">def</span><span class="w"> </span><span class="nf">_longest_true_run</span><span class="p">(</span><span class="n">vec_bool</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
    <span class="n">best_i</span> <span class="o">=</span> <span class="n">best_j</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="n">cur_i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">vec_bool</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">v</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cur_i</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span> <span class="n">cur_i</span> <span class="o">=</span> <span class="n">k</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cur_i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">best_i</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="p">(</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span> <span class="o">-</span> <span class="n">cur_i</span><span class="p">)</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">best_j</span> <span class="o">-</span> <span class="n">best_i</span><span class="p">):</span>
                    <span class="n">best_i</span><span class="p">,</span> <span class="n">best_j</span> <span class="o">=</span> <span class="n">cur_i</span><span class="p">,</span> <span class="n">k</span><span class="o">-</span><span class="mi">1</span>
                <span class="n">cur_i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">if</span> <span class="n">cur_i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">k</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">vec_bool</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">best_i</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="p">(</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span> <span class="o">-</span> <span class="n">cur_i</span><span class="p">)</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">best_j</span> <span class="o">-</span> <span class="n">best_i</span><span class="p">):</span>
            <span class="n">best_i</span><span class="p">,</span> <span class="n">best_j</span> <span class="o">=</span> <span class="n">cur_i</span><span class="p">,</span> <span class="n">k</span><span class="o">-</span><span class="mi">1</span>
    <span class="k">return</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">best_i</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="p">(</span><span class="n">best_i</span><span class="p">,</span> <span class="n">best_j</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">belt_roi_from_blue</span><span class="p">(</span><span class="n">hsv</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">lower</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">upper</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ROI = rectángulo sobre la cinta:</span>
<span class="sd">    - Umbral HSV → máscara azul</span>
<span class="sd">    - Cobertura azul por columna y tramo contiguo más largo</span>
<span class="sd">    - Rango vertical por filas en ese tramo</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">H</span><span class="p">,</span> <span class="n">W</span> <span class="o">=</span> <span class="n">hsv</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">blue_raw</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">inRange</span><span class="p">(</span><span class="n">hsv</span><span class="p">,</span> <span class="n">lower</span><span class="p">,</span> <span class="n">upper</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
    <span class="n">blue</span> <span class="o">=</span> <span class="n">_open</span><span class="p">(</span><span class="n">blue_raw</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">MORPH_RECT</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">blue</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">medianBlur</span><span class="p">(</span><span class="n">blue</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

    <span class="n">col_counts</span> <span class="o">=</span> <span class="p">(</span><span class="n">blue</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
    <span class="n">cover_ratio</span> <span class="o">=</span> <span class="n">col_counts</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">H</span><span class="p">)</span>
    <span class="n">col_mask</span> <span class="o">=</span> <span class="n">cover_ratio</span> <span class="o">&gt;=</span> <span class="n">CONFIG</span><span class="p">[</span><span class="s2">&quot;belt_col_cover_ratio&quot;</span><span class="p">]</span>
    <span class="n">run</span> <span class="o">=</span> <span class="n">_longest_true_run</span><span class="p">(</span><span class="n">col_mask</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">run</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;No se identificó ningún tramo de cinta por cobertura azul.&quot;</span><span class="p">)</span>
    <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span> <span class="o">=</span> <span class="n">run</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">x2</span> <span class="o">-</span> <span class="n">x1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">CONFIG</span><span class="p">[</span><span class="s2">&quot;belt_min_width_px&quot;</span><span class="p">]:</span>
        <span class="n">relax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.02</span><span class="p">,</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">CONFIG</span><span class="p">[</span><span class="s2">&quot;belt_col_cover_ratio&quot;</span><span class="p">])</span>
        <span class="n">col_mask_relaxed</span> <span class="o">=</span> <span class="n">cover_ratio</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">CONFIG</span><span class="p">[</span><span class="s2">&quot;belt_col_cover_ratio&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">relax</span><span class="p">)</span>
        <span class="n">run2</span> <span class="o">=</span> <span class="n">_longest_true_run</span><span class="p">(</span><span class="n">col_mask_relaxed</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">run2</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="p">(</span><span class="n">run2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">run2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">CONFIG</span><span class="p">[</span><span class="s2">&quot;belt_min_width_px&quot;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;La anchura estimada de la cinta es demasiado pequeña.&quot;</span><span class="p">)</span>
        <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span> <span class="o">=</span> <span class="n">run2</span>

    <span class="n">blue_slice</span> <span class="o">=</span> <span class="n">blue</span><span class="p">[:,</span> <span class="n">x1</span><span class="p">:</span><span class="n">x2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">row_counts</span> <span class="o">=</span> <span class="p">(</span><span class="n">blue_slice</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
    <span class="n">row_mask</span> <span class="o">=</span> <span class="n">row_counts</span> <span class="o">&gt;=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="mf">0.02</span> <span class="o">*</span> <span class="p">(</span><span class="n">x2</span> <span class="o">-</span> <span class="n">x1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)))</span>
    <span class="n">row_run</span> <span class="o">=</span> <span class="n">_longest_true_run</span><span class="p">(</span><span class="n">row_mask</span><span class="p">)</span>
    <span class="n">y1</span><span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">H</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="n">row_run</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">row_run</span>

    <span class="n">pad</span> <span class="o">=</span> <span class="n">CONFIG</span><span class="p">[</span><span class="s2">&quot;pad_roi&quot;</span><span class="p">]</span>
    <span class="n">x</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">x1</span> <span class="o">-</span> <span class="n">pad</span><span class="p">);</span> <span class="n">y</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">y1</span> <span class="o">-</span> <span class="n">pad</span><span class="p">)</span>
    <span class="n">w</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">W</span> <span class="o">-</span> <span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="n">x2</span> <span class="o">-</span> <span class="n">x1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">pad</span><span class="p">)</span>
    <span class="n">h</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">H</span> <span class="o">-</span> <span class="n">y</span><span class="p">,</span> <span class="p">(</span><span class="n">y2</span> <span class="o">-</span> <span class="n">y1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">pad</span><span class="p">)</span>

    <span class="n">dbg</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">hsv</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_HSV2BGR</span><span class="p">)</span>
    <span class="n">cv2</span><span class="o">.</span><span class="n">rectangle</span><span class="p">(</span><span class="n">dbg</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">w</span><span class="p">,</span> <span class="n">y</span> <span class="o">+</span> <span class="n">h</span><span class="p">),</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">vis</span> <span class="o">=</span> <span class="n">dbg</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">vis</span><span class="p">[:,</span> <span class="n">col_mask</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">addWeighted</span><span class="p">(</span><span class="n">vis</span><span class="p">[:,</span> <span class="n">col_mask</span><span class="p">,</span> <span class="p">:],</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">vis</span><span class="p">[:,</span> <span class="n">col_mask</span><span class="p">,</span> <span class="p">:],</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)),</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">save_img_dbg</span><span class="p">(</span><span class="s2">&quot;02b_belt_columns.png&quot;</span><span class="p">,</span> <span class="n">vis</span><span class="p">)</span>
    <span class="n">save_img_dbg</span><span class="p">(</span><span class="s2">&quot;03_roi_debug.png&quot;</span><span class="p">,</span> <span class="n">dbg</span><span class="p">)</span>
    <span class="n">save_img_dbg</span><span class="p">(</span><span class="s2">&quot;02_blue_mask.png&quot;</span><span class="p">,</span> <span class="n">blue_raw</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">),</span> <span class="n">blue</span>

<span class="k">def</span><span class="w"> </span><span class="nf">seeds_in_roi</span><span class="p">(</span><span class="n">bgr_roi</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">lower</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">upper</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
    <span class="n">hsv</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">bgr_roi</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2HSV</span><span class="p">)</span>
    <span class="n">blue</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">inRange</span><span class="p">(</span><span class="n">hsv</span><span class="p">,</span> <span class="n">lower</span><span class="p">,</span> <span class="n">upper</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
    <span class="n">not_blue</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">bitwise_not</span><span class="p">(</span><span class="n">blue</span><span class="p">)</span>

    <span class="n">k_vert</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">getStructuringElement</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">MORPH_ELLIPSE</span><span class="p">,</span> <span class="n">CONFIG</span><span class="p">[</span><span class="s2">&quot;pr_fg_kernel&quot;</span><span class="p">])</span>
    <span class="n">pr_fg</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">dilate</span><span class="p">(</span><span class="n">not_blue</span><span class="p">,</span> <span class="n">k_vert</span><span class="p">,</span> <span class="n">iterations</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">h</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">hsv</span><span class="p">)</span>
    <span class="n">belt_h</span> <span class="o">=</span> <span class="n">h</span><span class="p">[</span><span class="n">blue</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">);</span> <span class="n">belt_s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">blue</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">belt_h</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
        <span class="n">mu_h</span><span class="p">,</span> <span class="n">mu_s</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">belt_h</span><span class="p">)),</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">belt_s</span><span class="p">))</span>
        <span class="n">dh</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">absdiff</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">mu_h</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">absdiff</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">mu_s</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
        <span class="n">contrast</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">addWeighted</span><span class="p">(</span><span class="n">dh</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">,</span> <span class="n">ds</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">thr</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">contrast</span><span class="p">,</span> <span class="n">CONFIG</span><span class="p">[</span><span class="s2">&quot;sure_fg_pct_contrast&quot;</span><span class="p">]))</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">hi</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">threshold</span><span class="p">(</span><span class="n">contrast</span><span class="p">,</span> <span class="n">thr</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">THRESH_BINARY</span><span class="p">)</span>
        <span class="n">sure_fg</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">bitwise_and</span><span class="p">(</span><span class="n">hi</span><span class="p">,</span> <span class="n">not_blue</span><span class="p">)</span>
        <span class="n">save_img_dbg</span><span class="p">(</span><span class="s2">&quot;07_contrast.png&quot;</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="n">contrast</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">NORM_MINMAX</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sure_fg</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">erode</span><span class="p">(</span><span class="n">pr_fg</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">getStructuringElement</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">MORPH_ELLIPSE</span><span class="p">,</span> <span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">9</span><span class="p">)),</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">dist</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">distanceTransform</span><span class="p">((</span><span class="n">pr_fg</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">),</span> <span class="n">cv2</span><span class="o">.</span><span class="n">DIST_L2</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">dist</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
        <span class="n">th</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">dist</span><span class="p">[</span><span class="n">dist</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">],</span> <span class="n">CONFIG</span><span class="p">[</span><span class="s2">&quot;sure_fg_pct_dt&quot;</span><span class="p">])</span>
        <span class="n">sure_fg</span> <span class="o">|=</span> <span class="p">(</span><span class="n">dist</span> <span class="o">&gt;</span> <span class="n">th</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span> <span class="o">*</span> <span class="mi">255</span>

    <span class="n">gc_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">blue</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">GC_PR_BGD</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
    <span class="n">gc_mask</span><span class="p">[</span><span class="n">blue</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>    <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">GC_BGD</span>
    <span class="n">gc_mask</span><span class="p">[</span><span class="n">pr_fg</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>   <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">GC_PR_FGD</span>
    <span class="n">gc_mask</span><span class="p">[</span><span class="n">sure_fg</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">GC_FGD</span>

    <span class="c1"># Horizontal borders as BG</span>
    <span class="n">m</span> <span class="o">=</span> <span class="mi">6</span>
    <span class="n">gc_mask</span><span class="p">[:</span><span class="n">m</span><span class="p">,</span> <span class="p">:]</span>  <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">GC_BGD</span>
    <span class="n">gc_mask</span><span class="p">[</span><span class="o">-</span><span class="n">m</span><span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">GC_BGD</span>
    <span class="c1"># Lateral guard-rails as BG</span>
    <span class="n">W</span> <span class="o">=</span> <span class="n">gc_mask</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">g</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">CONFIG</span><span class="p">[</span><span class="s2">&quot;guard_frac_w&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">W</span><span class="p">)</span>
    <span class="n">g</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">CONFIG</span><span class="p">[</span><span class="s2">&quot;guard_min_px&quot;</span><span class="p">],</span> <span class="nb">min</span><span class="p">(</span><span class="n">CONFIG</span><span class="p">[</span><span class="s2">&quot;guard_max_px&quot;</span><span class="p">],</span> <span class="n">g</span><span class="p">))</span>
    <span class="n">gc_mask</span><span class="p">[:,</span> <span class="p">:</span><span class="n">g</span><span class="p">]</span>  <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">GC_BGD</span>
    <span class="n">gc_mask</span><span class="p">[:,</span> <span class="o">-</span><span class="n">g</span><span class="p">:]</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">GC_BGD</span>

    <span class="n">save_img_dbg</span><span class="p">(</span><span class="s2">&quot;04_pr_fg.png&quot;</span><span class="p">,</span> <span class="n">pr_fg</span><span class="p">)</span>
    <span class="n">save_img_dbg</span><span class="p">(</span><span class="s2">&quot;05_sure_fg.png&quot;</span><span class="p">,</span> <span class="n">sure_fg</span><span class="p">)</span>
    <span class="n">save_img_dbg</span><span class="p">(</span><span class="s2">&quot;06_not_blue.png&quot;</span><span class="p">,</span> <span class="n">not_blue</span><span class="p">)</span>
    <span class="n">save_img_dbg</span><span class="p">(</span><span class="s2">&quot;08_gc_seeds.png&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">gc_mask</span> <span class="o">*</span> <span class="p">(</span><span class="mi">255</span> <span class="o">//</span> <span class="mi">3</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">gc_mask</span>

<span class="k">def</span><span class="w"> </span><span class="nf">render_candidates_debug</span><span class="p">(</span><span class="n">bgr_base</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                            <span class="n">cnts</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
                            <span class="n">scores</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
                            <span class="n">best_idx</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
                            <span class="n">roi_xywh</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span><span class="nb">int</span><span class="p">,</span><span class="nb">int</span><span class="p">,</span><span class="nb">int</span><span class="p">],</span>
                            <span class="n">tag</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Writes PNG only in debug; returns path or None.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">_dbg</span><span class="p">():</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="n">vis</span> <span class="o">=</span> <span class="n">bgr_base</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">xR</span><span class="p">,</span> <span class="n">yR</span><span class="p">,</span> <span class="n">wR</span><span class="p">,</span> <span class="n">hR</span> <span class="o">=</span> <span class="n">roi_xywh</span>
    <span class="n">cv2</span><span class="o">.</span><span class="n">rectangle</span><span class="p">(</span><span class="n">vis</span><span class="p">,</span> <span class="p">(</span><span class="n">xR</span><span class="p">,</span> <span class="n">yR</span><span class="p">),</span> <span class="p">(</span><span class="n">xR</span> <span class="o">+</span> <span class="n">wR</span><span class="p">,</span> <span class="n">yR</span> <span class="o">+</span> <span class="n">hR</span><span class="p">),</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>

    <span class="n">sc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">scores</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="k">if</span> <span class="n">scores</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">sc</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
        <span class="n">sc</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">sc</span><span class="p">)]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">scn</span> <span class="o">=</span> <span class="p">(</span><span class="n">sc</span> <span class="o">-</span> <span class="n">sc</span><span class="o">.</span><span class="n">min</span><span class="p">())</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="mf">1e-9</span><span class="p">,</span> <span class="n">sc</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">sc</span><span class="o">.</span><span class="n">min</span><span class="p">())</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">sc</span> <span class="o">==</span> <span class="n">sc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">sc</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cnts</span><span class="p">):</span>
        <span class="n">color</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">);</span> <span class="n">thick</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="k">if</span> <span class="n">best_idx</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">==</span> <span class="n">best_idx</span><span class="p">:</span>
            <span class="n">color</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="n">thick</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="n">cv2</span><span class="o">.</span><span class="n">drawContours</span><span class="p">(</span><span class="n">vis</span><span class="p">,</span> <span class="p">[</span><span class="n">c</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="n">thick</span><span class="p">)</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">boundingRect</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">scores</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span> <span class="k">else</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;nan&quot;</span><span class="p">)</span>
        <span class="n">txt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;s=</span><span class="si">{</span><span class="n">s</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">  </span><span class="si">{</span><span class="n">w</span><span class="si">}</span><span class="s2">x</span><span class="si">{</span><span class="n">h</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">y_txt</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="n">y</span> <span class="o">-</span> <span class="mi">5</span><span class="p">)</span>
        <span class="p">(</span><span class="n">tw</span><span class="p">,</span> <span class="n">th</span><span class="p">),</span> <span class="n">_</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">getTextSize</span><span class="p">(</span><span class="n">txt</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">FONT_HERSHEY_SIMPLEX</span><span class="p">,</span> <span class="mf">0.45</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">cv2</span><span class="o">.</span><span class="n">rectangle</span><span class="p">(</span><span class="n">vis</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y_txt</span> <span class="o">-</span> <span class="n">th</span> <span class="o">-</span> <span class="mi">4</span><span class="p">),</span> <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">tw</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="n">y_txt</span> <span class="o">+</span> <span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">cv2</span><span class="o">.</span><span class="n">putText</span><span class="p">(</span><span class="n">vis</span><span class="p">,</span> <span class="n">txt</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">y_txt</span><span class="p">),</span> <span class="n">cv2</span><span class="o">.</span><span class="n">FONT_HERSHEY_SIMPLEX</span><span class="p">,</span> <span class="mf">0.45</span><span class="p">,</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">LINE_AA</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sc</span><span class="o">.</span><span class="n">size</span> <span class="ow">and</span> <span class="p">(</span><span class="n">best_idx</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">best_idx</span><span class="p">):</span>
            <span class="n">alpha</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="mf">0.35</span> <span class="o">+</span> <span class="mf">0.45</span> <span class="o">*</span> <span class="n">scn</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">cv2</span><span class="o">.</span><span class="n">drawContours</span><span class="p">(</span><span class="n">vis</span><span class="p">,</span> <span class="p">[</span><span class="n">c</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">alpha</span> <span class="o">*</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">color</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">save_img</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;10_candidates_</span><span class="si">{</span><span class="n">tag</span><span class="si">}</span><span class="s2">.png&quot;</span><span class="p">,</span> <span class="n">vis</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">contour_scores</span><span class="p">(</span><span class="n">cnts</span><span class="p">,</span> <span class="n">roi</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">xR</span><span class="p">,</span> <span class="n">yR</span><span class="p">,</span> <span class="n">wR</span><span class="p">,</span> <span class="n">hR</span> <span class="o">=</span> <span class="n">roi</span>
    <span class="k">if</span> <span class="n">strict</span><span class="p">:</span>
        <span class="n">min_area</span> <span class="o">=</span> <span class="n">CONFIG</span><span class="p">[</span><span class="s2">&quot;min_area_px2&quot;</span><span class="p">]</span>
        <span class="n">min_width</span> <span class="o">=</span> <span class="n">CONFIG</span><span class="p">[</span><span class="s2">&quot;min_width_px&quot;</span><span class="p">]</span>
        <span class="n">edge_clear</span> <span class="o">=</span> <span class="n">CONFIG</span><span class="p">[</span><span class="s2">&quot;edge_clear_px&quot;</span><span class="p">]</span>
        <span class="n">mu</span> <span class="o">=</span> <span class="n">CONFIG</span><span class="p">[</span><span class="s2">&quot;shape_mu_log_aspect&quot;</span><span class="p">]</span>
        <span class="n">sg</span> <span class="o">=</span> <span class="n">CONFIG</span><span class="p">[</span><span class="s2">&quot;shape_sigma&quot;</span><span class="p">]</span>
        <span class="n">allow_touch_edges</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">min_area</span> <span class="o">=</span> <span class="n">CONFIG</span><span class="p">[</span><span class="s2">&quot;relax&quot;</span><span class="p">][</span><span class="s2">&quot;min_area_px2&quot;</span><span class="p">]</span>
        <span class="n">min_width</span> <span class="o">=</span> <span class="n">CONFIG</span><span class="p">[</span><span class="s2">&quot;relax&quot;</span><span class="p">][</span><span class="s2">&quot;min_width_px&quot;</span><span class="p">]</span>
        <span class="n">edge_clear</span> <span class="o">=</span> <span class="n">CONFIG</span><span class="p">[</span><span class="s2">&quot;relax&quot;</span><span class="p">][</span><span class="s2">&quot;edge_clear_px&quot;</span><span class="p">]</span>
        <span class="n">mu</span> <span class="o">=</span> <span class="n">CONFIG</span><span class="p">[</span><span class="s2">&quot;shape_mu_log_aspect&quot;</span><span class="p">]</span>
        <span class="n">sg</span> <span class="o">=</span> <span class="n">CONFIG</span><span class="p">[</span><span class="s2">&quot;relax&quot;</span><span class="p">][</span><span class="s2">&quot;shape_sigma&quot;</span><span class="p">]</span>
        <span class="n">allow_touch_edges</span> <span class="o">=</span> <span class="n">CONFIG</span><span class="p">[</span><span class="s2">&quot;relax&quot;</span><span class="p">][</span><span class="s2">&quot;allow_touch_edges&quot;</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">score</span><span class="p">(</span><span class="n">c</span><span class="p">):</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">contourArea</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">A</span> <span class="o">&lt;</span> <span class="n">min_area</span><span class="p">:</span>
            <span class="k">return</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
        <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">w0</span><span class="p">,</span> <span class="n">h0</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">boundingRect</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">min</span><span class="p">(</span><span class="n">w0</span><span class="p">,</span> <span class="n">h0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">min_width</span><span class="p">:</span>
            <span class="k">return</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">allow_touch_edges</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">xR</span> <span class="o">+</span> <span class="n">x0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">xR</span> <span class="o">+</span> <span class="n">edge_clear</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">xR</span> <span class="o">+</span> <span class="n">x0</span> <span class="o">+</span> <span class="n">w0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">xR</span> <span class="o">+</span> <span class="n">wR</span> <span class="o">-</span> <span class="n">edge_clear</span><span class="p">):</span>
                <span class="k">return</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
        <span class="n">a</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">w0</span><span class="p">,</span> <span class="n">h0</span><span class="p">)</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">w0</span><span class="p">,</span> <span class="n">h0</span><span class="p">))</span>
        <span class="n">w_aspect</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">-</span> <span class="n">mu</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="p">(</span><span class="n">sg</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)))</span>
        <span class="n">hull</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">convexHull</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="n">Ah</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">contourArea</span><span class="p">(</span><span class="n">hull</span><span class="p">)</span>
        <span class="n">solidity</span> <span class="o">=</span> <span class="p">(</span><span class="n">A</span> <span class="o">/</span> <span class="n">Ah</span><span class="p">)</span> <span class="k">if</span> <span class="n">Ah</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.0</span>
        <span class="n">w_sol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">solidity</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">A</span> <span class="o">*</span> <span class="n">w_aspect</span> <span class="o">*</span> <span class="p">(</span><span class="mf">0.6</span> <span class="o">+</span> <span class="mf">0.4</span> <span class="o">*</span> <span class="n">w_sol</span><span class="p">))</span>

    <span class="k">return</span> <span class="p">[</span><span class="n">score</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cnts</span><span class="p">]</span>

<span class="c1"># -------------------------</span>
<span class="c1"># Run</span>
<span class="c1"># -------------------------</span>
<span class="k">def</span><span class="w"> </span><span class="nf">extractor</span><span class="p">():</span>
    <span class="n">IMG_PATH</span> <span class="o">=</span> <span class="n">CONFIG</span><span class="p">[</span><span class="s2">&quot;img_path&quot;</span><span class="p">]</span>
    <span class="n">bgr0</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">IMG_PATH</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">IMREAD_COLOR</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">bgr0</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No se pudo leer la imagen: </span><span class="si">{</span><span class="n">IMG_PATH</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># 1) Prefilter</span>
    <span class="n">bgr</span> <span class="o">=</span> <span class="n">prefilter</span><span class="p">(</span><span class="n">bgr0</span><span class="p">)</span>

    <span class="c1"># 2) Dynamic blue &amp; ROI</span>
    <span class="n">hsv</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">bgr</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2HSV</span><span class="p">)</span>
    <span class="n">lower</span><span class="p">,</span> <span class="n">upper</span> <span class="o">=</span> <span class="n">dynamic_blue_threshold</span><span class="p">(</span><span class="n">hsv</span><span class="p">)</span>
    <span class="n">roi</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">belt_roi_from_blue</span><span class="p">(</span><span class="n">hsv</span><span class="p">,</span> <span class="n">lower</span><span class="p">,</span> <span class="n">upper</span><span class="p">)</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="n">roi</span>
    <span class="n">crop</span> <span class="o">=</span> <span class="n">bgr</span><span class="p">[</span><span class="n">y</span><span class="p">:</span><span class="n">y</span> <span class="o">+</span> <span class="n">h</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span><span class="n">x</span> <span class="o">+</span> <span class="n">w</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="c1"># 3) GrabCut seeds + run</span>
    <span class="n">gc_mask</span> <span class="o">=</span> <span class="n">seeds_in_roi</span><span class="p">(</span><span class="n">crop</span><span class="p">,</span> <span class="n">lower</span><span class="p">,</span> <span class="n">upper</span><span class="p">)</span>
    <span class="n">bg_model</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">65</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">fg_model</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">65</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">cv2</span><span class="o">.</span><span class="n">grabCut</span><span class="p">(</span><span class="n">crop</span><span class="p">,</span> <span class="n">gc_mask</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">bg_model</span><span class="p">,</span> <span class="n">fg_model</span><span class="p">,</span> <span class="n">CONFIG</span><span class="p">[</span><span class="s2">&quot;gc_iters&quot;</span><span class="p">],</span> <span class="n">cv2</span><span class="o">.</span><span class="n">GC_INIT_WITH_MASK</span><span class="p">)</span>

    <span class="c1"># 4) Post-process mask</span>
    <span class="n">mask_roi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">gc_mask</span> <span class="o">==</span> <span class="n">cv2</span><span class="o">.</span><span class="n">GC_FGD</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">gc_mask</span> <span class="o">==</span> <span class="n">cv2</span><span class="o">.</span><span class="n">GC_PR_FGD</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
    <span class="n">save_img_dbg</span><span class="p">(</span><span class="s2">&quot;09_mask_roi_raw.png&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">mask_roi</span> <span class="o">*</span> <span class="mi">255</span><span class="p">))</span>
    <span class="n">mask_roi</span> <span class="o">=</span> <span class="n">_close</span><span class="p">(</span><span class="n">mask_roi</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">MORPH_ELLIPSE</span><span class="p">,</span> <span class="n">CONFIG</span><span class="p">[</span><span class="s2">&quot;post_close_kernel&quot;</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">mask_roi</span> <span class="o">=</span> <span class="n">_open</span><span class="p">(</span><span class="n">mask_roi</span><span class="p">,</span>  <span class="n">cv2</span><span class="o">.</span><span class="n">MORPH_ELLIPSE</span><span class="p">,</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">full</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">bgr</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
    <span class="n">full</span><span class="p">[</span><span class="n">y</span><span class="p">:</span><span class="n">y</span> <span class="o">+</span> <span class="n">h</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span><span class="n">x</span> <span class="o">+</span> <span class="n">w</span><span class="p">]</span> <span class="o">=</span> <span class="n">mask_roi</span>

    <span class="c1"># 5) Contours &amp; scoring (strict → relaxed fallback)</span>
    <span class="n">cnts</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">findContours</span><span class="p">((</span><span class="n">full</span> <span class="o">*</span> <span class="mi">255</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">),</span> <span class="n">cv2</span><span class="o">.</span><span class="n">RETR_EXTERNAL</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">CHAIN_APPROX_NONE</span><span class="p">)</span>
    <span class="n">scores_strict</span> <span class="o">=</span> <span class="n">contour_scores</span><span class="p">(</span><span class="n">cnts</span><span class="p">,</span> <span class="n">roi</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">if</span> <span class="n">cnts</span> <span class="k">else</span> <span class="p">[]</span>
    <span class="n">best_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">scores_strict</span><span class="p">))</span> <span class="k">if</span> <span class="n">scores_strict</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="n">strict_ok</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">scores_strict</span><span class="p">)</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">scores_strict</span><span class="p">[</span><span class="n">best_idx</span><span class="p">])</span> <span class="ow">and</span> <span class="p">(</span><span class="n">scores_strict</span><span class="p">[</span><span class="n">best_idx</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">render_candidates_debug</span><span class="p">(</span><span class="n">bgr0</span><span class="p">,</span> <span class="n">cnts</span><span class="p">,</span> <span class="n">scores_strict</span><span class="p">,</span> <span class="n">best_idx</span> <span class="k">if</span> <span class="n">strict_ok</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span> <span class="n">roi</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="s2">&quot;strict&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">strict_ok</span><span class="p">:</span>
        <span class="n">scores_relax</span> <span class="o">=</span> <span class="n">contour_scores</span><span class="p">(</span><span class="n">cnts</span><span class="p">,</span> <span class="n">roi</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">if</span> <span class="n">cnts</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="n">best_idx_relax</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">scores_relax</span><span class="p">))</span> <span class="k">if</span> <span class="n">scores_relax</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">relaxed_ok</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">scores_relax</span><span class="p">)</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">scores_relax</span><span class="p">[</span><span class="n">best_idx_relax</span><span class="p">])</span> <span class="ow">and</span> <span class="p">(</span><span class="n">scores_relax</span><span class="p">[</span><span class="n">best_idx_relax</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">render_candidates_debug</span><span class="p">(</span><span class="n">bgr0</span><span class="p">,</span> <span class="n">cnts</span><span class="p">,</span> <span class="n">scores_relax</span><span class="p">,</span> <span class="n">best_idx_relax</span> <span class="k">if</span> <span class="n">relaxed_ok</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span> <span class="n">roi</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="s2">&quot;relaxed&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">relaxed_ok</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">cnts</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;No contornos tras segmentación.&quot;</span><span class="p">)</span>
            <span class="c1"># last-resort: largest area</span>
            <span class="n">areas</span> <span class="o">=</span> <span class="p">[</span><span class="n">cv2</span><span class="o">.</span><span class="n">contourArea</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cnts</span><span class="p">]</span>
            <span class="n">use_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">areas</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">use_idx</span> <span class="o">=</span> <span class="n">best_idx_relax</span>
        <span class="n">used_scores</span> <span class="o">=</span> <span class="n">scores_relax</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">use_idx</span> <span class="o">=</span> <span class="n">best_idx</span>
        <span class="n">used_scores</span> <span class="o">=</span> <span class="n">scores_strict</span>

    <span class="n">cnt</span> <span class="o">=</span> <span class="n">cnts</span><span class="p">[</span><span class="n">use_idx</span><span class="p">]</span>

    <span class="c1"># 6) PCA measures</span>
    <span class="n">pts</span> <span class="o">=</span> <span class="n">cnt</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">mean</span><span class="p">,</span> <span class="n">eigvecs</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">PCACompute2</span><span class="p">(</span><span class="n">pts</span><span class="p">,</span> <span class="n">mean</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">mean</span> <span class="o">=</span> <span class="n">mean</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eigvecs</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">pts_c</span> <span class="o">=</span> <span class="n">pts</span> <span class="o">-</span> <span class="n">mean</span>
    <span class="n">pts_r</span> <span class="o">=</span> <span class="n">pts_c</span> <span class="o">@</span> <span class="n">R</span><span class="o">.</span><span class="n">T</span>
    <span class="n">min_x</span><span class="p">,</span> <span class="n">max_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">pts_r</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">pts_r</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span>
    <span class="n">min_y</span><span class="p">,</span> <span class="n">max_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">pts_r</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">pts_r</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="n">length_px</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">max_x</span> <span class="o">-</span> <span class="n">min_x</span><span class="p">)</span>
    <span class="n">width_px</span>  <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">max_y</span> <span class="o">-</span> <span class="n">min_y</span><span class="p">)</span>
    <span class="n">area_px2</span>  <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">contourArea</span><span class="p">(</span><span class="n">cnt</span><span class="p">))</span>

    <span class="c1"># 7) Overlay</span>
    <span class="n">rgb</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">bgr0</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2RGB</span><span class="p">)</span>
    <span class="n">overlay</span> <span class="o">=</span> <span class="n">rgb</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">box_r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">min_x</span><span class="p">,</span> <span class="n">min_y</span><span class="p">],</span> <span class="p">[</span><span class="n">max_x</span><span class="p">,</span> <span class="n">min_y</span><span class="p">],</span> <span class="p">[</span><span class="n">max_x</span><span class="p">,</span> <span class="n">max_y</span><span class="p">],</span> <span class="p">[</span><span class="n">min_x</span><span class="p">,</span> <span class="n">max_y</span><span class="p">]],</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">box_img</span> <span class="o">=</span> <span class="p">(</span><span class="n">box_r</span> <span class="o">@</span> <span class="n">R</span><span class="p">)</span> <span class="o">+</span> <span class="n">mean</span>
    <span class="n">box_img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">(</span><span class="n">box_img</span><span class="p">)</span>
    <span class="n">cv2</span><span class="o">.</span><span class="n">drawContours</span><span class="p">(</span><span class="n">overlay</span><span class="p">,</span> <span class="p">[</span><span class="n">cnt</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">cv2</span><span class="o">.</span><span class="n">polylines</span><span class="p">(</span><span class="n">overlay</span><span class="p">,</span> <span class="p">[</span><span class="n">box_img</span><span class="p">],</span> <span class="kc">True</span><span class="p">,</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">i_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">pts_r</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]);</span> <span class="n">i_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">pts_r</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span>
    <span class="n">p1</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">pts_r</span><span class="p">[</span><span class="n">i_min</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="mf">0.0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="o">@</span> <span class="n">R</span><span class="p">)</span> <span class="o">+</span> <span class="n">mean</span>
    <span class="n">p2</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">pts_r</span><span class="p">[</span><span class="n">i_max</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="mf">0.0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="o">@</span> <span class="n">R</span><span class="p">)</span> <span class="o">+</span> <span class="n">mean</span>
    <span class="n">cv2</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">overlay</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">(</span><span class="n">p1</span><span class="p">)),</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">(</span><span class="n">p2</span><span class="p">)),</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">cv2</span><span class="o">.</span><span class="n">rectangle</span><span class="p">(</span><span class="n">overlay</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">w</span><span class="p">,</span> <span class="n">y</span> <span class="o">+</span> <span class="n">h</span><span class="p">),</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>

    <span class="c1"># 8) Units</span>
    <span class="n">mm_per_px</span> <span class="o">=</span> <span class="n">get_scale_mm_per_px</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">mm_per_px</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">mm_per_px</span><span class="p">)</span> <span class="ow">and</span> <span class="n">mm_per_px</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">length_mm</span> <span class="o">=</span> <span class="n">length_px</span> <span class="o">*</span> <span class="n">mm_per_px</span>
        <span class="n">width_mm</span>  <span class="o">=</span> <span class="n">width_px</span>  <span class="o">*</span> <span class="n">mm_per_px</span>
        <span class="n">area_mm2</span>  <span class="o">=</span> <span class="n">area_px2</span>  <span class="o">*</span> <span class="p">(</span><span class="n">mm_per_px</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">mm_per_px</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;nan&quot;</span><span class="p">);</span> <span class="n">length_mm</span> <span class="o">=</span> <span class="n">width_mm</span> <span class="o">=</span> <span class="n">area_mm2</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;nan&quot;</span><span class="p">)</span>

    <span class="c1"># 9) Optional outputs</span>
    <span class="n">mask_full</span> <span class="o">=</span> <span class="p">(</span><span class="n">full</span> <span class="o">*</span> <span class="mi">255</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
    <span class="n">mask_path</span> <span class="o">=</span> <span class="n">save_img_dbg</span><span class="p">(</span><span class="s2">&quot;mask_debug.png&quot;</span><span class="p">,</span> <span class="n">mask_full</span><span class="p">)</span>
    <span class="n">overlay_path</span> <span class="o">=</span> <span class="n">save_img_dbg</span><span class="p">(</span><span class="s2">&quot;overlay_debug.png&quot;</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">overlay</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_RGB2BGR</span><span class="p">))</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([{</span>
        <span class="s2">&quot;image_path&quot;</span><span class="p">:</span> <span class="n">IMG_PATH</span><span class="p">,</span>
        <span class="s2">&quot;roi_x&quot;</span><span class="p">:</span> <span class="n">x</span><span class="p">,</span> <span class="s2">&quot;roi_y&quot;</span><span class="p">:</span> <span class="n">y</span><span class="p">,</span> <span class="s2">&quot;roi_w&quot;</span><span class="p">:</span> <span class="n">w</span><span class="p">,</span> <span class="s2">&quot;roi_h&quot;</span><span class="p">:</span> <span class="n">h</span><span class="p">,</span>
        <span class="s2">&quot;length_px&quot;</span><span class="p">:</span> <span class="n">length_px</span><span class="p">,</span> <span class="s2">&quot;width_px&quot;</span><span class="p">:</span> <span class="n">width_px</span><span class="p">,</span> <span class="s2">&quot;area_px2&quot;</span><span class="p">:</span> <span class="n">area_px2</span><span class="p">,</span>
        <span class="s2">&quot;mm_per_px&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">mm_per_px</span><span class="p">)</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">mm_per_px</span><span class="p">)</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
        <span class="s2">&quot;length_mm&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">length_mm</span><span class="p">)</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">length_mm</span><span class="p">)</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
        <span class="s2">&quot;width_mm&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">width_mm</span><span class="p">)</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">width_mm</span><span class="p">)</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
        <span class="s2">&quot;area_mm2&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">area_mm2</span><span class="p">)</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">area_mm2</span><span class="p">)</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
        <span class="s2">&quot;best_score&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">used_scores</span><span class="p">[</span><span class="n">use_idx</span><span class="p">])</span> <span class="k">if</span> <span class="p">(</span><span class="n">used_scores</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">used_scores</span><span class="p">[</span><span class="n">use_idx</span><span class="p">]))</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="p">}])</span>
    <span class="n">csv_path</span> <span class="o">=</span> <span class="n">save_csv_dbg</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="s2">&quot;measurements_debug.csv&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;roi&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">),</span>
        <span class="s2">&quot;length_px&quot;</span><span class="p">:</span> <span class="n">length_px</span><span class="p">,</span> <span class="s2">&quot;width_px&quot;</span><span class="p">:</span> <span class="n">width_px</span><span class="p">,</span> <span class="s2">&quot;area_px2&quot;</span><span class="p">:</span> <span class="n">area_px2</span><span class="p">,</span>
        <span class="s2">&quot;mm_per_px&quot;</span><span class="p">:</span> <span class="n">mm_per_px</span><span class="p">,</span> <span class="s2">&quot;length_mm&quot;</span><span class="p">:</span> <span class="n">length_mm</span><span class="p">,</span> <span class="s2">&quot;width_mm&quot;</span><span class="p">:</span> <span class="n">width_mm</span><span class="p">,</span> <span class="s2">&quot;area_mm2&quot;</span><span class="p">:</span> <span class="n">area_mm2</span><span class="p">,</span>
        <span class="s2">&quot;mask_img&quot;</span><span class="p">:</span> <span class="n">mask_full</span><span class="p">,</span> <span class="s2">&quot;overlay_img&quot;</span><span class="p">:</span> <span class="n">overlay</span><span class="p">,</span>
        <span class="s2">&quot;mask_path&quot;</span><span class="p">:</span> <span class="n">mask_path</span><span class="p">,</span> <span class="s2">&quot;overlay_path&quot;</span><span class="p">:</span> <span class="n">overlay_path</span><span class="p">,</span> <span class="s2">&quot;csv_path&quot;</span><span class="p">:</span> <span class="n">csv_path</span><span class="p">,</span>
        <span class="s2">&quot;df&quot;</span><span class="p">:</span> <span class="n">df</span>
    <span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<p>El algoritmo de visión desarrollado se sustenta sobre una seria de funciones, cada una responsable de resolver el bloque operativo definido en la <a class="reference internal" href="#figura-wp1-imagen-6"><span class="std std-numref">Figura 2.6</span></a>.</p>
<section id="preprocesado">
<h2><span class="section-number">2.4.1. </span>Preprocesado<a class="headerlink" href="#preprocesado" title="Link to this heading">#</a></h2>
<p>Este bloque funcional se sustenta sobre las siguientes funciones:</p>
<ul class="simple">
<li><p><strong>prefilter(bgr).</strong> Toma como entrada una imagen BGR (<code class="docutils literal notranslate"><span class="pre">np.ndarray</span></code>) y devuelve una versión prefiltrada en BGR tras aplicar NLMeans (reducción de ruido no local), filtro bilateral (suavizado que preserva bordes) y CLAHE en el canal V (HSV). Su utilidad es mejorar la relación señal-ruido y homogeneizar la iluminación antes de la segmentación, estabilizando los modelos de apariencia usados por GrabCut y reduciendo artefactos de borde; en términos prácticos, atenúa alta frecuencia sin degradar discontinuidades relevantes (cabeza/cola del pez frente a la cinta).</p></li>
<li><p><strong>dynamic_blue_threshold(hsv).</strong> Recibe una imagen en HSV y retorna dos vectores <code class="docutils literal notranslate"><span class="pre">lower</span></code> y <code class="docutils literal notranslate"><span class="pre">upper</span></code> (umbrales HSV) que acotan dinámicamente el color azul de la cinta. Estima el pico del histograma del canal H en una franja vertical central (filtrada por saturación mínima) y construye un intervalo <span class="math notranslate nohighlight">\([\,H_0\pm\Delta H\,]\)</span>. Su utilidad es adaptar la detección del fondo (cinta) a cambios de cámara/iluminación, reforzando la separación fondo (azul) / no-fondo para las semillas de GrabCut.</p></li>
<li><p><strong>_longest_true_run(vec_bool)</strong> Realiza una búsqueda lineal del tramo contiguo máximo de verdaderos. Como parámetro de entrada necesita un vector booleano 1D (np.ndarray) y devuelve <span class="math notranslate nohighlight">\((i, j)\)</span> (índices inclusive) del segmento más largo con <em>True</em>, o <em>None</em> si no existe. Se usa para fijar límites horizontales (columnas) y verticales (filas) de la cinta.</p></li>
<li><p><strong>belt_roi_from_blue(hsv, lower, upper).</strong> Recibe la imagen HSV y los umbrales <code class="docutils literal notranslate"><span class="pre">lower/upper</span></code>; devuelve la ROI de la cinta como tupla <code class="docutils literal notranslate"><span class="pre">(x,</span> <span class="pre">y,</span> <span class="pre">w,</span> <span class="pre">h)</span></code> y la máscara binaria <code class="docutils literal notranslate"><span class="pre">blue</span></code>. Umbraliza el azul, limpia con operaciones morfológicas (apertura/cierre) y toma el <em>bounding box</em> de la mayor componente conexa, expandiéndolo con <em>padding</em>. Su utilidad es anclar espacialmente el problema: restringe la segmentación a la banda transportadora (banda a banda), evitando que estructuras ajenas (p. ej., metálicas) perturben la optimización.</p></li>
<li><p><strong>_morph(img, op, shape, ksize, iters=1)</strong> Se trata de un envoltorio de la interfaz de OpenCV <code class="docutils literal notranslate"><span class="pre">cv2.morphologyEx</span></code> usada para aplicar operaciones morfológicas apertura, cierre, gradiente morfológico, tophat, blackhat, hit-or-miss) sobre la imagen. Como entrada necesita: img (np.uint8 o convertible), op (operación de OpenCV), shape (tipo de elemento estructurante), ksize (tupla de tamaño), iters (int) retornando la imagen procesada (np.ndarray) y evitando errores de resolución de sobrecarga.</p></li>
<li><p><strong>_open(img, shape, ksize, iters=1)</strong> Aplica una apertura morfológica especializada con <code class="docutils literal notranslate"><span class="pre">cv2.MORPH_OPEN</span></code>. Se usa para eliminar ruido fino preservando estructuras mayores.</p></li>
<li><p><strong>_close(img, shape, ksize, iters=1)</strong> Aplica un cierre morfológico especializado. Misma signatura que <code class="docutils literal notranslate"><span class="pre">_open</span></code> pero con <code class="docutils literal notranslate"><span class="pre">cv2.MORPH_CLOSE</span></code>. Rellena huecos/pequeñas discontinuidades en máscaras binarizadas; devuelve np.ndarray.</p></li>
</ul>
</section>
<section id="segmentacion">
<h2><span class="section-number">2.4.2. </span>Segmentación<a class="headerlink" href="#segmentacion" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p><strong>seeds_in_roi(bgr_roi, lower, upper).</strong> Recibe el recorte BGR de la ROI y los umbrales HSV; devuelve <code class="docutils literal notranslate"><span class="pre">gc_mask</span></code>, una máscara de estados entera con etiquetas de GrabCut {BG seguro, PR_BG, PR_FG, FG}. Construye las semillas así: (i) <strong>BG seguro</strong> = píxeles azules; (ii) <strong>PR_FG</strong> = no-azul dilatado con kernel anisotrópico (alto y estrecho) para conectar zonas finas (cola/cabeza); (iii) <strong>FG seguro</strong> = no-azul con alto contraste cromático respecto al azul (combinación de distancias en H y S umbraladas por percentil), reforzado mediante <strong>distance transform</strong> sobre PR_FG; además fija el borde de la ROI como BG. Su utilidad es condicionar favorablemente la minimización de la energía de GrabCut (término de datos GMM + término de suavidad por corte en grafo), reduciendo fugas y pérdidas en extremos.</p></li>
</ul>
</section>
<section id="seleccion-y-medicion">
<h2><span class="section-number">2.4.3. </span>Selección y medición<a class="headerlink" href="#seleccion-y-medicion" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p><strong>contour_scores(cnts, roi, strict=True)</strong> Realiza una ponderación morfológica de candidatos. Como entredas necesita: contornos <code class="docutils literal notranslate"><span class="pre">cnts</span></code>, ROI <code class="docutils literal notranslate"><span class="pre">(x,y,w,h)</span></code> y un crietrio de severidad. Para cada contorno calcula <code class="docutils literal notranslate"><span class="pre">score</span> <span class="pre">=</span> <span class="pre">área</span> <span class="pre">×</span> <span class="pre">prior(log-aspecto)</span> <span class="pre">×</span> <span class="pre">solidez</span></code>, aplicando filtros de área, anchura mínima y proximidad a bordes (relajables en modo <em>non-strict</em>). Devuelve una lista de <code class="docutils literal notranslate"><span class="pre">float</span></code> alineada con <code class="docutils literal notranslate"><span class="pre">cnts</span></code>.</p></li>
<li><p><strong>extractor().</strong> No recibe argumentos y devuelve: <code class="docutils literal notranslate"><span class="pre">overlay_path</span></code>, <code class="docutils literal notranslate"><span class="pre">mask_path</span></code>, <code class="docutils literal notranslate"><span class="pre">csv_path</span></code> (rutas), <code class="docutils literal notranslate"><span class="pre">length_px</span></code>, <code class="docutils literal notranslate"><span class="pre">width_px</span></code>, <code class="docutils literal notranslate"><span class="pre">area_px2</span></code> (magnitudes en píxeles), <code class="docutils literal notranslate"><span class="pre">mm_per_px</span></code> (si existe) y la <code class="docutils literal notranslate"><span class="pre">roi</span></code> empleada. Orquesta todo el pipeline: carga y prefiltra la imagen; estima el umbral azul dinámico y extrae la ROI de la cinta; genera semillas y ejecuta GrabCut con iteraciones configurables; aplica postproceso morfológico (cierre/apertura); selecciona el contorno del pez por área + alargamiento; calcula <strong>longitud</strong> y <strong>anchura</strong> proyectando el contorno sobre los autovectores de la <strong>PCA</strong> (extensión <span class="math notranslate nohighlight">\(\max-\min\)</span> en cada eje) y el <strong>área</strong> con <code class="docutils literal notranslate"><span class="pre">cv2.contourArea</span></code>; finalmente guarda las salidas (overlay, máscara y CSV) y convierte a unidades métricas si hay factor de escala disponible.</p></li>
</ul>
</section>
<section id="otras-funciones">
<h2><span class="section-number">2.4.4. </span>Otras funciones<a class="headerlink" href="#otras-funciones" title="Link to this heading">#</a></h2>
<p>El pipeline también proporciona algunas funciones auxiliares como:</p>
<ul class="simple">
<li><p><strong>render_candidates_debug(bgr_base, cnts, scores, best_idx, roi_xywh, tag)</strong> Es una función útil en una auditoría visual del criterio de selección. Como entradas necesita: imagen base, lista de contornos, lista de scores, índice del mejor (o <code class="docutils literal notranslate"><span class="pre">None</span></code>), ROI <code class="docutils literal notranslate"><span class="pre">(x,y,w,h)</span></code> y etiqueta de texto. Dibuja ROI y contornos (verde el seleccionado, rojo el resto) con anotación de puntuación y guarda el fichero .PNG sólo en modo <code class="docutils literal notranslate"><span class="pre">debug</span></code>, devolviendo su ruta o <code class="docutils literal notranslate"><span class="pre">None</span></code>.</p></li>
<li><p><strong>save_img(name, img)</strong> Guarda las imágenes obtendias en los procesos anteriores. Como variables de entrada usa: <code class="docutils literal notranslate"><span class="pre">name</span> <span class="pre">(str)</span></code> e <code class="docutils literal notranslate"><span class="pre">img</span> <span class="pre">(np.ndarray,</span> <span class="pre">BGR</span> <span class="pre">o</span> <span class="pre">1</span> <span class="pre">canal)</span></code>. Escribe el array en disco en con el parámetro <code class="docutils literal notranslate"><span class="pre">CONFIG[&quot;out_prefix&quot;]+name</span></code> y devuelve la ruta escrita <code class="docutils literal notranslate"><span class="pre">(str)</span></code>. Esta función centraliza la serialización de artefactos visuales.</p></li>
<li><p><strong>save_img_dbg(name, img)</strong> Esta función es similar a la anterior(recibe los mismos parámetros que <code class="docutils literal notranslate"><span class="pre">save_img</span></code>) pero sólo guarda si <code class="docutils literal notranslate"><span class="pre">CONFIG[&quot;debug&quot;]==True</span></code>. Devuelve la ruta escrita o <code class="docutils literal notranslate"><span class="pre">None</span></code> si no hubo escritura. Implementa además el patrón de side-effects controlados por flag.</p></li>
<li><p><strong>save_csv_dbg(df, name)</strong> Garantiza la persistencia de los resultados del proceso en formato CSV sólo si <code class="docutils literal notranslate"><span class="pre">CONFIG[&quot;save_csv&quot;]==True</span></code>. Los parámetros de entreda son un <code class="docutils literal notranslate"><span class="pre">df</span> <span class="pre">(DataFrame</span> <span class="pre">de</span> <span class="pre">Pandas)</span></code> y el nombre <code class="docutils literal notranslate"><span class="pre">name</span> <span class="pre">(str)</span></code> del fichero. Guarda el CSV en <code class="docutils literal notranslate"><span class="pre">CONFIG[&quot;out_prefix&quot;]+name</span></code> y devuelve la ruta o <code class="docutils literal notranslate"><span class="pre">None</span></code>. Permite desacoplar cómputo en memoria de la E/S de informes.</p></li>
<li><p><strong>get_scale_mm_per_px().</strong> No recibe argumentos y devuelve el factor escalar <code class="docutils literal notranslate"><span class="pre">mm_per_px</span></code> (flotante) o <code class="docutils literal notranslate"><span class="pre">None</span></code> si no está disponible. Internamente busca primero una función externa del usuario <code class="docutils literal notranslate"><span class="pre">get_mm_per_px()</span></code> y, en su defecto, un fichero <code class="docutils literal notranslate"><span class="pre">calibracion_px_mm.json</span></code> con la clave <code class="docutils literal notranslate"><span class="pre">&quot;mm_per_px&quot;</span></code>, que debería existir tras haber realizado una calibración. Su utilidad es habilitar la conversión métrica de las magnitudes geométricas estimadas en píxeles —longitud, anchura y área.</p></li>
</ul>
<p>Para ejecutar el pipeline basta con:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># -------------------------</span>
<span class="c1"># Execute &amp; (optional) display</span>
<span class="c1"># -------------------------</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">extractor</span><span class="p">()</span>

<span class="c1"># Visualización en notebook (no guarda archivos por sí misma)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Overlay final&quot;</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="s2">&quot;overlay_img&quot;</span><span class="p">]);</span> <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Máscara final&quot;</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="s2">&quot;mask_img&quot;</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Área de interés (ROI): </span><span class="si">{</span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;roi&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Medidas detectadas: L=</span><span class="si">{</span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;length_px&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">px  W=</span><span class="si">{</span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;width_px&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">px  A=</span><span class="si">{</span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;area_px2&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">px^2&quot;</span><span class="p">)</span>
<span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="s2">&quot;mm_per_px&quot;</span><span class="p">]):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Medidas reales: L=</span><span class="si">{</span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;length_mm&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> mm  W=</span><span class="si">{</span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;width_mm&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> mm  A=</span><span class="si">{</span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;area_mm2&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> mm^2  Resolución </span><span class="si">{</span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;mm_per_px&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2"> mm/px&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;PNG overlay guardado: </span><span class="si">{</span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;overlay_path&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;PNG máscara guardado: </span><span class="si">{</span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;mask_path&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;CSV datos: </span><span class="si">{</span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;csv_path&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Área de interés (ROI): (368, 0, 1114, 1080)
Medidas detectadas: L=739.7px  W=293.5px  A=151972.5px^2
Medidas reales: L=36.99 mm  W=14.67 mm  A=379.93 mm^2  Resolución 0.050000 mm/px
PNG overlay guardado: ./out/sole_overlay_debug.png
PNG máscara guardado: ./out/sole_mask_debug.png
CSV datos: ./out/sole_measurements_debug.csv
</pre></div>
</div>
<img alt="../../_images/58afe5eb239fdc55b1394752fb51d68fb00c43161cfcc8fad6cd905ce2b3b890.png" src="../../_images/58afe5eb239fdc55b1394752fb51d68fb00c43161cfcc8fad6cd905ce2b3b890.png" />
</div>
</div>
<p>Como se puede apreciar en las imágenes del proceso, el <em>pipeline</em> define adecuadamente el área de interés al ancho de la cinta (recuadro color violeta) y es capaz detectar el pez (recuadro amarillo) y obtener el contorno (verde) y las medidas del mismo.</p>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./content/01"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="Modulo-2.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title"><span class="section-number">2.3. </span>M2 - Calibración</p>
      </div>
    </a>
    <a class="right-next"
       href="Modulo-4.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title"><span class="section-number">2.5. </span>M4 - Salida y persistencia</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#preprocesado">2.4.1. Preprocesado</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#segmentacion">2.4.2. Segmentación</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#seleccion-y-medicion">2.4.3. Selección y medición</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#otras-funciones">2.4.4. Otras funciones</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Javier Álvarez Osuna
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright Feeding Systems S.L. - GNU General Public License 2025.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>