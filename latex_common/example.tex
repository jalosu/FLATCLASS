%% Generated by Sphinx.
\def\sphinxdocclass{jupyterBook}
\documentclass[a4paper,10pt,spanish]{jupyterBook}
\ifdefined\pdfpxdimen
   \let\sphinxpxdimen\pdfpxdimen\else\newdimen\sphinxpxdimen
\fi \sphinxpxdimen=.75bp\relax
\ifdefined\pdfimageresolution
    \pdfimageresolution= \numexpr \dimexpr1in\relax/\sphinxpxdimen\relax
\fi
%% let collapsible pdf bookmarks panel have high depth per default
\PassOptionsToPackage{bookmarksdepth=5}{hyperref}
%% turn off hyperref patch of \index as sphinx.xdy xindy module takes care of
%% suitable \hyperpage mark-up, working around hyperref-xindy incompatibility
\PassOptionsToPackage{hyperindex=false}{hyperref}
%% memoir class requires extra handling
\makeatletter\@ifclassloaded{memoir}
{\ifdefined\memhyperindexfalse\memhyperindexfalse\fi}{}\makeatother

\PassOptionsToPackage{booktabs}{sphinx}
\PassOptionsToPackage{colorrows}{sphinx}

\PassOptionsToPackage{warn}{textcomp}

\catcode`^^^^00a0\active\protected\def^^^^00a0{\leavevmode\nobreak\ }
\usepackage{cmap}
\usepackage{fontspec}
\defaultfontfeatures[\rmfamily,\sffamily,\ttfamily]{}
\usepackage{amsmath,amssymb,amstext}
\usepackage{polyglossia}
\setmainlanguage{spanish}
\renewcommand{\partname}{Paquete de Trabajo}
\renewcommand{\thepart}{\arabic{part}}
\renewcommand{\thechapter}{\arabic{chapter}}



\setmainfont{FreeSerif}[
  Extension      = .otf,
  UprightFont    = *,
  ItalicFont     = *Italic,
  BoldFont       = *Bold,
  BoldItalicFont = *BoldItalic
]
\setsansfont{FreeSans}[
  Extension      = .otf,
  UprightFont    = *,
  ItalicFont     = *Oblique,
  BoldFont       = *Bold,
  BoldItalicFont = *BoldOblique,
]
\setmonofont{FreeMono}[
  Extension      = .otf,
  UprightFont    = *,
  ItalicFont     = *Oblique,
  BoldFont       = *Bold,
  BoldItalicFont = *BoldOblique,
]



\usepackage[Bjarne]{fncychap}
\usepackage[,numfigreset=1,mathnumfig]{sphinx}

\fvset{fontsize=\scriptsize}
\usepackage{geometry}


% Include hyperref last.
\usepackage{hyperref}
% Fix anchor placement for figures with captions.
\usepackage{hypcap}% it must be loaded after hyperref.
% Set up styles of URL: it should be placed after hyperref.
\urlstyle{same}

\usepackage{sphinxmessages}



% Start of preamble defined in sphinx-jupyterbook-latex %
\usepackage[Latin,Greek]{ucharclasses}
\usepackage{unicode-math}
% fixing title of the toc
\addto\captionsenglish{\renewcommand{\contentsname}{Contents}}
\hypersetup{
    pdfencoding=auto,
    psdextra
}
% End of preamble defined in sphinx-jupyterbook-latex %



% ===================== PARCHE DEFINITIVO =====================
% Ejecutar las redefiniciones *al iniciar el documento* para que sean las √∫ltimas.
\AtBeginDocument{%
  % Forzar r√≥tulos en espa√±ol aunque la clase est√© en 'english'
  \addto\captionsenglish{%
    \renewcommand{\partname}{Paquete de Trabajo}%
    \renewcommand{\chaptername}{Cap√≠tulo}%
    % Si quieres forzar "√çndice" globalmente, descomenta:
    %\renewcommand{\contentsname}{√çndice}%
    \renewcommand{\figurename}{Figura}%
    \renewcommand{\tablename}{Tabla}%
  }%
  % Evitar que Sphinx convierta 1,2,3 -> "One, Two, Three"
  \makeatletter
  \providecommand{\sphinxnumstr}[1]{#1}%
  \renewcommand{\sphinxnumstr}[1]{#1}% devuelve el n√∫mero tal cual (ar√°bigo)
  % Asegurar numeraci√≥n ar√°biga en contadores principales
  \renewcommand{\thepart}{\arabic{part}}%
  \renewcommand{\thechapter}{\arabic{chapter}}%
  % (opcional) numeraci√≥n 1.1, 1.2‚Ä¶:
  %\renewcommand{\thesection}{\thechapter.\arabic{section}}%
  %\renewcommand{\thesubsection}{\thesection.\arabic{subsection}}%
  \makeatother
}
% ================== FIN PARCHE DEFINITIVO ====================

\title{FLATCLASS - FLATfish Length and Thickness CLASification System by Artificial Intelligence}
\date{}
\release{}
\author{Javier √Ålvarez Osuna}
\newcommand{\sphinxlogo}{\vbox{}}
\renewcommand{\releasename}{}
\makeindex
\input{fff-background.tex}
\begin{document}

\pagestyle{empty}
\sphinxmaketitle
\pagestyle{plain}
\sphinxtableofcontents
\pagestyle{normal}
\phantomsection\label{\detokenize{content/intro::doc}}


\sphinxAtStartPar
La acuicultura es uno de los sectores de producci√≥n de alimentos de m√°s r√°pido crecimiento a nivel mundial, con un incremento anual del 5.3\% en la √∫ltima d√©cada {[}{[}FAO, 2024{]}{]} (https://doi.org/10.4060/cd0683en). Dentro de este sector, la cr√≠a de peces planos, como el lenguado (\sphinxstyleemphasis{Solea solea}) y el rodaballo (\sphinxstyleemphasis{Scophthalmus maximus}), representa un
nicho importante debido a su alto valor comercial y demanda en mercados gourmet. Sin embargo, la producci√≥n de estos peces enfrenta desaf√≠os significativos en la fase de alevinaje, donde la clasificaci√≥n
de alevines por tama√±o y la estimaci√≥n de su peso son procesos cr√≠ticos para garantizar un crecimiento uniforme y maximizar la supervivencia \sphinxhref{https://doi.org/10.1038/s41586-021-03308-6}{{[}Naylor et al., 2021{]}}.

\sphinxAtStartPar
Una clasificaci√≥n de alevines precisa permite la agrupaci√≥n por tama√±os homog√©neos, lo cual es crucial para optimizar la alimentaci√≥n, minimizar la competencia intraespec√≠fica y reducir el riesgo de mortalidad por agresi√≥n o est√©s. √âste es un proceso laborioso propenso a errores que tambi√©n consume tiempo y recursos, lo que reduce la eficiencia operativa y aumenta los costos de producci√≥n \sphinxhref{https://doi.org/10.1016/S0144-8609(01)00091-7}{{[}Papandroulakis et al., 2002{]}}. En la actualidad la industria est√° usando sistemas semi\sphinxhyphen{}autom√°ticos para la clasificaci√≥n de alevines, que si bien suponen una clara mejora, a√∫n presentan limitaciones significativas. Uno de los principales problemas es que estos sistemas suelen basarse en un √∫nico criterio de clasificaci√≥n: el peso o la altura del pez. Esta falta de multifactorialidad en el proceso de clasificaci√≥n (\sphinxstyleemphasis{gradding}¬†en t√©rmico anglosaj√≥n) limita su sensibilidad y precisi√≥n. Por ejemplo, un sistema que solo mide el peso puede pasar por alto variaciones importantes en la morfolog√≠a del pez, como la longitud o el ancho, que tambi√©n son indicadores clave de su desarrollo y salud. De manera similar, un sistema que solo considera la altura puede no capturar adecuadamente las diferencias en el volumen o la condici√≥n corporal de los alevines, lo que puede llevar a una clasificaci√≥n sub√≥ptima.

\sphinxAtStartPar
Esta dependencia de un √∫nico par√°metro no solo reduce la eficacia del proceso de clasificaci√≥n, sino que tambi√©n puede generar resultados inconsistentes. Por ejemplo, dos peces con el mismo peso podr√≠an tener formas corporales muy diferentes, lo que afectar√≠a su crecimiento futuro y su adaptaci√≥n a los tanques de engorde. Adem√°s, estos sistemas semi\sphinxhyphen{}autom√°ticos suelen ser extremadamente invasivos, ya que requieren manipulaci√≥n f√≠sica para medir el peso o la altura, lo que aumenta el estr√©s en los peces y puede elevar las tasas de mortalidad hasta un 15\% en algunos casos \sphinxhref{https://doi.org/10.1016/j.biosystemseng.2017.10.014}{{[}F√∏re et al., 2018{]}}. Esta falta de sensibilidad en el proceso de¬†gradding¬†limitan la capacidad de los productores para optimizar el manejo de los alevines, lo que puede resultar en una alta variabilidad en el crecimiento y una reducci√≥n en la calidad del producto final. no solo afecta la calidad del producto final, sino que tambi√©n limita la capacidad de los productores para optimizar el manejo de los alevines y garantizar un crecimiento uniforme.

\sphinxAtStartPar
La limitaci√≥n de los sistemas semi\sphinxhyphen{}autom√°ticos a un √∫nico criterio de clasificaci√≥n subraya la necesidad de adoptar tecnolog√≠as m√°s avanzadas que puedan integrar m√∫ltiples par√°metros morfom√©tricos en tiempo real. Aqu√≠ es donde entra en juego la inteligencia artificial (IA). Tecnolog√≠as avanzadas de inteligencia artificial (IA) como el reconocimiento de im√°genes (visi√≥n por computador) y aprendizaje profundo ofrece una soluci√≥n prometedora. Las redes neuronales convolucionales (CNN) han demostrado ser herramientas poderosas para tareas de clasificaci√≥n y segmentaci√≥n de im√°genes en m√∫ltiples dominios. Por ejemplo, trabajos recientes han utilizado CNN para la identificaci√≥n de enfermedades en peces y la estimaci√≥n de biomasa en sistemas de cultivo {[}\sphinxhref{https://doi.org/10.22075/ijnaa.2022.5839}{Hasan et al., 2022}, \sphinxhref{https://www.researchgate.net/publication/384679490\_A\_Convolutional\_Neural\_Network\_Approach\_for\_Precision\_Fish\_Disease\_Detection}{Haddad et al., 2024}{]}. Estas tecnolog√≠as no solo ofrecen altos niveles de precisi√≥n, sino que tambi√©n permiten el procesamiento en tiempo real, un requisito indispensable en aplicaciones industriales. En el caso espec√≠fico de la clasificaci√≥n de alevines, la IA permite combinar precisi√≥n en la identificaci√≥n de tama√±os con la estimaci√≥n de par√°metros morfom√©tricos, como longitud, anchura y superficie visible del pez, para estimar su peso sin necesidad de contacto f√≠sico.

\sphinxAtStartPar
La capacidad de estos sistemas para proporcionar los datos en tiempo real sobre las poblaciones de alevines proporciona a los operadores informaci√≥n valiosa para la toma de decisiones estrat√©gicas, como el ajuste de tasas de alimentaci√≥n o el dise√±o de planes de transferencia a estanques de engorde, lo que mejora significativamente la eficiencia operativa, reduciendo los costos y aumentando la rentabilidad de las operaciones acu√≠colas {[}\sphinxhref{https://doi.org/10.3389/fmars.2021.823173}{Kandimalia et al., 2022}{]}, \sphinxhref{https://doi.org/10.1038/s41586-021-03308-6}{{[}Naylor et al., 2021{]}}. Adicionalmente, la implantaci√≥n de estos sistemas inteligentes de clasificaci√≥n tambi√©n contribuye a la sostenibilidad ambiental y econ√≥mica de las piscifactor√≠as. Al clasificar de forma m√°s precisa y eficiente, se optimizan los recursos alimenticios y se reduce el desperdicio de alimento, que es uno de los costos m√°s significativos en la acuicultura. Mientras que al reducir el estr√©s y la manipulaci√≥n de los peces, se minimiza el riesgo de enfermedades y se promueve un crecimiento m√°s saludable y uniforme {[}\sphinxhref{https://doi.org/10.1016/j.applanim.2006.09.001}{Ashley., 2007}{]}.

\sphinxAtStartPar
\sphinxstylestrong{FLATCLASS} es la propuesta de Feeding Systems S.L. para desarrollar un sistema automatizado de gradding de peces planos (lenguado y rodaballo), basado en visi√≥n artificial y algoritmos de aprendizaje autom√°tico, que permita no solo la clasificaci√≥n precisa y en tiempo real de los individuos seg√∫n su tama√±o, sino tambi√©n el contaje unitario de ejemplares procesados y la estimaci√≥n individual de su peso. Todo ello garantizando una integraci√≥n fluida en las l√≠neas de producci√≥n existentes y proporcionando datos clave para una gesti√≥n eficiente del cultivo acu√≠cola. La implementaci√≥n de este sistema busca mejorar la productividad mediante la digitalizaci√≥n y automatizaci√≥n de procesos, reducir costos operativos y proporcionar datos estad√≠sticos para la optimizaci√≥n del manejo y alimentaci√≥n de los peces.

\sphinxAtStartPar
Este libro recopila los resultados cient√≠ficos y t√©cnicos obtenidos en el marco del proyecto \sphinxstylestrong{FLATCLASS}, organizados en cap√≠tulos correspondientes a cada paquete de trabajo. A lo largo de sus p√°ginas, se presentan de manera estructurada las investigaciones realizadas, los avances alcanzados y las soluciones desarrolladas, sustentadas en metodolog√≠as rigurosas y an√°lisis cr√≠tico. Cada apartado puede ser considerado un entregable y ofrece una visi√≥n detallada de los hallazgos, contribuciones y lecciones aprendidas, con el fin de servir como referencia para la comunidad acad√©mica y profesional. El documento no solo sintetiza el conocimiento generado, sino que tambi√©n destaca su aplicabilidad y potencial impacto en el √°mbito de la IA aplicada al sector de la acuicultura.

\sphinxstepscope


\part{PT1 \sphinxhyphen{} Visi√≥n Artificial}

\sphinxstepscope


\chapter{Especificaci√≥n de requisitos}
\label{\detokenize{content/01/Requisitos:especificacion-de-requisitos}}\label{\detokenize{content/01/Requisitos::doc}}
\begin{sphinxadmonition}{note}{Resumen}

\sphinxAtStartPar
El presente documento recoge de forma estructurada los requisitos funcionales y t√©cnicos necesarios para el desarrollo del sistema FLATCLASS, una soluci√≥n automatizada basada en visi√≥n artificial e inteligencia artificial para la clasificaci√≥n en tiempo real de alevines de lenguado. En √©l se definen los criterios operativos para la captura de im√°genes, calibraci√≥n de tama√±os, clasificaci√≥n morfom√©trica, estimaci√≥n de peso, y separaci√≥n automatizada de los ejemplares, as√≠ como los mecanismos de trazabilidad, visualizaci√≥n y seguridad en el acceso a los datos.

\sphinxAtStartPar
\sphinxstylestrong{Entregable}: E1.1\\
\sphinxstylestrong{Versi√≥n}: 1.0\\
\sphinxstylestrong{Autor}: Javier √Ålvarez Osuna\\
\sphinxstylestrong{Email}: javier.osuna@fishfarmfeeder.com\\
\sphinxstylestrong{ORCID}: \sphinxhref{https://orcid.org/0000-0001-7063-1279}{0000\sphinxhyphen{}0001\sphinxhyphen{}7063\sphinxhyphen{}1279}\\
\sphinxstylestrong{Licencia}: CC\sphinxhyphen{}BY\sphinxhyphen{}4.0\\
\sphinxstylestrong{C√≥digo proyecto}: IG408M.2025.000.000072

\begin{figure}[H]
\centering

\noindent\sphinxincludegraphics[width=1.000\linewidth]{{FLATCLASS_logo_publicidad}.png}
\end{figure}
\end{sphinxadmonition}


\section{Introducci√≥n}
\label{\detokenize{content/01/Requisitos:introduccion}}
\sphinxAtStartPar
El presente documento define los requisitos funcionales y t√©cnicos del sistema \sphinxstylestrong{FLATCLASS}, un sistema de clasificaci√≥n automatizada de alevines de lenguado especialmente√° orientado a mejorar la eficiencia y trazabilidad del proceso de \sphinxstyleemphasis{gradding} dentro de entornos acu√≠colas.

\sphinxAtStartPar
Este sistema se basa en una arquitectura de procesamiento distribuido que integra visi√≥n artificial, algoritmos de procesamiento de im√°genes y modelos de aprendizaje autom√°tico para la clasificaci√≥n y estimaci√≥n del peso de los alevines en tiempo real. El flujo operativo se divide en dos fases principales: una fase de muestreo y parametrizaci√≥n, en la que se establecen los criterios de clasificaci√≥n a partir del an√°lisis estad√≠stico de una muestra representativa, y una fase de operaci√≥n continua, en la que el sistema ejecuta la clasificaci√≥n y la estimaci√≥n de peso de cada pez mientras este atraviesa la l√≠nea de producci√≥n.

\begin{figure}[htbp]
\centering

\noindent\sphinxincludegraphics[width=1.000\linewidth]{{Modelo_funcional}.png}
\end{figure}

\sphinxAtStartPar
Para cada uno de los procesos se han identificado las restricciones necesarias para garantizar que el sistema cumple con las funcionalidades esperadas. Dichas restricciones se han clasificado en uno de los siguientes grupos de requisitos: funcionales, t√©cnicos y deseables.


\section{Requisitos Funcionales}
\label{\detokenize{content/01/Requisitos:requisitos-funcionales}}

\begin{savenotes}\sphinxattablestart
\sphinxthistablewithglobalstyle
\centering
\begin{tabulary}{\linewidth}[t]{TTT}
\sphinxtoprule
\sphinxstyletheadfamily
\sphinxAtStartPar
\sphinxstylestrong{C√≥digo}
&\sphinxstyletheadfamily
\sphinxAtStartPar
\sphinxstylestrong{Proceso}
&\sphinxstyletheadfamily
\sphinxAtStartPar
\sphinxstylestrong{Requisito Funcional}
\\
\sphinxmidrule
\sphinxtableatstartofbodyhook
\sphinxAtStartPar
\sphinxstylestrong{RF01}
&
\sphinxAtStartPar
Captura y an√°lisis de imagen
&
\sphinxAtStartPar
El sistema debe procesar un alev√≠n cada 5 segundos por canal, con un total de 4 canales funcionando en paralelo.
\\
\sphinxhline
\sphinxAtStartPar
\sphinxstylestrong{RF02}
&
\sphinxAtStartPar
Captura y an√°lisis de imagen
&
\sphinxAtStartPar
Resoluci√≥n de imagen: las im√°genes deben capturarse a resoluci√≥n 1920x1080 px usando c√°maras para asegurar precisi√≥n morfom√©trica.
\\
\sphinxhline
\sphinxAtStartPar
\sphinxstylestrong{RF03}
&
\sphinxAtStartPar
Clasificaci√≥n y separaci√≥n
&
\sphinxAtStartPar
Cada sesi√≥n empieza una calibraci√≥n previa con N ‚â§ 200 im√°genes para definir rangos de tama√±o establecidos por el usuario (peque√±o, mediano, grande).
\\
\sphinxhline
\sphinxAtStartPar
\sphinxstylestrong{RF04}
&
\sphinxAtStartPar
Clasificaci√≥n y separaci√≥n
&
\sphinxAtStartPar
Separaci√≥n autom√°tica en 4 categor√≠as: el sistema debe clasificar en peque√±o, mediano, grande o error.
\\
\sphinxhline
\sphinxAtStartPar
\sphinxstylestrong{RF05}
&
\sphinxAtStartPar
Calsificaci√≥n y separaci√≥n
&
\sphinxAtStartPar
Inferencia de peso por IA: el sistema debe estimar el peso con un error m√°ximo del 5\% utilizando regresi√≥n multiparam√©trica en log\sphinxhyphen{}transformada.
\\
\sphinxhline
\sphinxAtStartPar
\sphinxstylestrong{RF06}
&
\sphinxAtStartPar
Clasificaci√≥n y separaci√≥n
&
\sphinxAtStartPar
Separaci√≥n f√≠sica automatizada: los peces deben desviarse mediante compuertas autom√°ticas seg√∫n su categor√≠a.
\\
\sphinxhline
\sphinxAtStartPar
\sphinxstylestrong{RF07}
&
\sphinxAtStartPar
Visualizaci√≥n
&
\sphinxAtStartPar
Visualizaci√≥n y control en interfaz web: el sistema deber√° permitir parametrizaci√≥n, visualizaci√≥n en tiempo real y acceso a hist√≥ricos.
\\
\sphinxhline
\sphinxAtStartPar
\sphinxstylestrong{RF08}
&
\sphinxAtStartPar
Registro de datos
&
\sphinxAtStartPar
Gesti√≥n de datos y trazabilidad: todos los datos se almacenan en MongoDB con UID, timestamp, medidas, peso y clasificaci√≥n.
\\
\sphinxhline
\sphinxAtStartPar
\sphinxstylestrong{RF09}
&
\sphinxAtStartPar
Visualizaci√≥n
&
\sphinxAtStartPar
Validaci√≥n supervisada: debe permitir revisar manualmente clasificaciones dudosas para retroalimentaci√≥n del sistema.
\\
\sphinxbottomrule
\end{tabulary}
\sphinxtableafterendhook\par
\sphinxattableend\end{savenotes}


\section{Requisitos T√©cnicos}
\label{\detokenize{content/01/Requisitos:requisitos-tecnicos}}

\begin{savenotes}\sphinxattablestart
\sphinxthistablewithglobalstyle
\centering
\begin{tabulary}{\linewidth}[t]{TT}
\sphinxtoprule
\sphinxstyletheadfamily
\sphinxAtStartPar
\sphinxstylestrong{C√≥digo}
&\sphinxstyletheadfamily
\sphinxAtStartPar
\sphinxstylestrong{Requisito T√©cnico}
\\
\sphinxmidrule
\sphinxtableatstartofbodyhook
\sphinxAtStartPar
\sphinxstylestrong{RT01}
&
\sphinxAtStartPar
Arquitectura h√≠brida: procesamiento Edge con GPU avanzada (Jetson u otra), backend en Python y control en Node\sphinxhyphen{}RED.
\\
\sphinxhline
\sphinxAtStartPar
\sphinxstylestrong{RT02}
&
\sphinxAtStartPar
Modelo de datos: MongoDB almacenar√° UID, timestamp, dimensiones, clasificaci√≥n y predicci√≥n de peso.
\\
\sphinxhline
\sphinxAtStartPar
\sphinxstylestrong{RT03}
&
\sphinxAtStartPar
Interfaz multiusuario: m√≠nimo 2 perfiles (operador y supervisor) con distintos permisos.
\\
\sphinxhline
\sphinxAtStartPar
\sphinxstylestrong{RT04}
&
\sphinxAtStartPar
API REST: el sistema debe implementar al menos los siguientes endpoints:‚Ä¢ \sphinxcode{\sphinxupquote{GET /records?from=YYYY\sphinxhyphen{}MM\sphinxhyphen{}DD\&to=YYYY\sphinxhyphen{}MM\sphinxhyphen{}DD}}: Recupera registros procesados en el intervalo de fechas indicado.‚Ä¢ \sphinxcode{\sphinxupquote{GET /record/\{id\}}}: Devuelve los datos completos del pez individual con ID espec√≠fico.‚Ä¢ \sphinxcode{\sphinxupquote{GET /summary}}: Proporciona un resumen estad√≠stico por lote (n√∫mero por categor√≠a, medias de peso y superficie).‚Ä¢ \sphinxcode{\sphinxupquote{POST /calibration}}: Env√≠a un nuevo conjunto de umbrales de clasificaci√≥n definidos por el usuario.‚Ä¢ \sphinxcode{\sphinxupquote{GET /image/\{id\}}}: Accede a la imagen almacenada correspondiente al pez con ID √∫nico.
\\
\sphinxhline
\sphinxAtStartPar
\sphinxstylestrong{RT05}
&
\sphinxAtStartPar
Seguridad de acceso a API:‚Ä¢ Autenticaci√≥n mediante token (JWT o equivalente).‚Ä¢ Cifrado obligatorio v√≠a HTTPS.‚Ä¢ Registro de logs con IP, usuario y timestamp.‚Ä¢ Control de acceso por roles (lectura, escritura, administraci√≥n).‚Ä¢ Almacenamiento seguro de credenciales con rotaci√≥n peri√≥dica.
\\
\sphinxbottomrule
\end{tabulary}
\sphinxtableafterendhook\par
\sphinxattableend\end{savenotes}


\section{Requisitos Deseables}
\label{\detokenize{content/01/Requisitos:requisitos-deseables}}

\begin{savenotes}\sphinxattablestart
\sphinxthistablewithglobalstyle
\centering
\begin{tabulary}{\linewidth}[t]{TT}
\sphinxtoprule
\sphinxstyletheadfamily
\sphinxAtStartPar
\sphinxstylestrong{C√≥digo}
&\sphinxstyletheadfamily
\sphinxAtStartPar
\sphinxstylestrong{Requisito Deseable}
\\
\sphinxmidrule
\sphinxtableatstartofbodyhook
\sphinxAtStartPar
\sphinxstylestrong{RD01}
&
\sphinxAtStartPar
Minimizaci√≥n del estr√©s animal mediante separaci√≥n suave.
\\
\sphinxhline
\sphinxAtStartPar
\sphinxstylestrong{RD02}
&
\sphinxAtStartPar
Cifrado opcional de datos y versionado de modelos IA.
\\
\sphinxhline
\sphinxAtStartPar
\sphinxstylestrong{RD03}
&
\sphinxAtStartPar
Sistema de alerta por error recurrente o desviaci√≥n de modelo.
\\
\sphinxbottomrule
\end{tabulary}
\sphinxtableafterendhook\par
\sphinxattableend\end{savenotes}

\sphinxstepscope


\chapter{Sistema de visi√≥n artificial}
\label{\detokenize{content/01/Imagen:sistema-de-vision-artificial}}\label{\detokenize{content/01/Imagen::doc}}
\begin{sphinxadmonition}{note}{Resumen}

\sphinxAtStartPar
El presente documento recoge los trabajos relativos al m√≥dulo de visi√≥n artificial de \sphinxstylestrong{FLATCLASS}. Este m√≥dulo es el responsable de la adquisici√≥n, normalizado, segmentaci√≥n y extracci√≥n de las caracter√≠sticas mormom√©tricas de los alevines de lenguado.

\sphinxAtStartPar
\sphinxstylestrong{Entregable}: E1.2\\
\sphinxstylestrong{Versi√≥n}: 1.0\\
\sphinxstylestrong{Autor}: Javier √Ålvarez Osuna\\
\sphinxstylestrong{Email}: javier.osuna@fishfarmfeeder.com\\
\sphinxstylestrong{ORCID}: \sphinxhref{https://orcid.org/0000-0001-7063-1279}{0000\sphinxhyphen{}0001\sphinxhyphen{}7063\sphinxhyphen{}1279}\\
\sphinxstylestrong{Licencia}: CC\sphinxhyphen{}BY\sphinxhyphen{}4.0\\
\sphinxstylestrong{C√≥digo proyecto}: IG408M.2025.000.000072

\begin{figure}[H]
\centering

\noindent\sphinxincludegraphics[width=1.000\linewidth]{{FLATCLASS_logo_publicidad}.png}
\end{figure}
\end{sphinxadmonition}


\section{Introducci√≥n}
\label{\detokenize{content/01/Imagen:introduccion}}
\sphinxAtStartPar
Uno de los objetivos t√©cnicos plantedos en \sphinxstylestrong{FLATCLASS} se centra en el Desarrollo e integraci√≥n de un sistema de visi√≥n artificial de alta resoluci√≥n que permita la captura precisa de im√°genes de los alevines en tiempo real, asegurando una segmentaci√≥n eficaz y el c√°lculo autom√°tico del √°rea de superficie, longitud y anchura de cada individuo. El sistema autom√°tico desarrollado permite la medici√≥n sin contacto de las caracter√≠sticas morfom√©tricas de lenguados (\sphinxstyleemphasis{Solea solea}) tales como la longitud total (L), la anchura corporal (A) y la superficie real (S) a partir de las im√°genes fotogr√°ficas, obtenidas con una c√°mara Datalogic P22C 600\sphinxhyphen{}000 ML, mediante un algoritmo de procesado. Este algoritmo permite realizar la medici√≥n incluso cuando la cola del pez plano est√° deformada o cuando el pez se encuentra orientado de manera aleatoria, informando del nivel de fiabilidad de las mediciones cuando los resultados puedan persentar dudas. Este √∫ltimo aspecto es especialmente importante si tenemos en cuenta que el proceso de clasificaci√≥n de juveniles se suele producir en ambientes de baja luminosidad y alta concentraci√≥n de humedad que introduce importantes restricciones en la calidad de las im√°genes obtenidas.

\sphinxAtStartPar
El n√∫cleo del sistema se sustenta en \sphinxstylestrong{GrabCut}, un m√©todo de segmentaci√≥n de im√°genes interactivo basado en teor√≠a de grafos y optimizaci√≥n de cortes m√≠nimos en campos aleatorios de Markov (MRF) definido por primera vez por \sphinxhref{https://doi.org/10.1145/1015706.1015720}{Rother et al.,} en 2004. El usuario define inicialmente un recuadro aproximado que contiene el pez, permitiendo al algoritmo estimar la distribuci√≥n de color del primer plano y el fondo mediante modelos de mezcla gaussiana (Gaussian Mixture Models, GMM). Posteriormente, se plantea una funci√≥n de energ√≠a que combina un t√©rmino regional (basado en las probabilidades del GMM) y un t√©rmino de continuidad espacial (prefiriendo regiones conectadas con etiquetas uniformes), la cual se minimiza mediante un corte en el grafo (graph cut). Este proceso se itera hasta converger en una segmentaci√≥n refinada del pez frente al fondo {[}\sphinxhref{https://doi.org/10.1016/j.jksuci.2020.07.005}{Alsmadi et al., 2022}{]}.

\sphinxAtStartPar
GrabCut ha sido objeto de mejoras continuas en los √∫ltimos a√±os, incluyendo variantes que integran mapas de saliencia, superp√≠xeles o funciones de energ√≠a modificadas que permiten segmentaciones m√°s precisas y autom√°ticas {[}\sphinxhref{https://doi.org/10.3390/math11081965}{Wang et al., 2023}{]}. En el contexto acu√≠cola, diferentes trabajos han aplicado algoritmos derivados de GrabCut (como versiones adaptadas o iterativas) para refinar la segmentaci√≥n en im√°genes de peces. Por ejemplo, \sphinxhref{https://doi.org/10.11975/j.issn.1002-6819.2020.21.026}{Huang et al., 2023} han desarrollado un sistema de visi√≥n binocular en acuicultura utiliz√≥ GrabCut adaptativo por contraste para segmentar peces bajo el agua, logrando un error porcentual medio en la medida de longitud de solo 0,9\%. Asimismo, en el √°mbito de la fenotipificaci√≥n de peces de tilapia, GrabCut se ha empleado para afinar muestras en los bordes de segmentaci√≥n, mejorando el IoU hasta un 81‚ÄØ\% cuando se combina con redes profundas {[}\sphinxhref{https://doi.org/10.3390/app13179635}{Feng et al., 2023}{]}.

\sphinxAtStartPar
Para la extracci√≥n de los par√°metros morfom√©tricos de alevines de lenguado a partir de im√°genes digitales en vista dorsal, GrabCut es especialmente adecuado por varias razones clave. Primero, requiere m√≠nima interacci√≥n (√∫nicamente un recuadro inicial o ROI \sphinxhyphen{} \sphinxstyleemphasis{Region Of Interest}), lo cual es pr√°ctico en entornos productivos con alto flujo de muestras. Segundo, al basarse en modelos estad√≠sticos de color y continuidad espacial, puede separar con precisi√≥n el pez del fondo uniforme de la cinta que lo transporta, incluso con variaciones de iluminaci√≥n. Esto resulta esencial para c√°lculos fiables de longitud, anchura y superficie del pez. Finalmente, es computacionalmente eficiente y ya est√° implementado en bibliotecas comunes como OpenCV, lo que facilita su integraci√≥n en un sistema automatizado de procesamiento de im√°genes en planta.

\sphinxAtStartPar
El flujograma del \sphinxstylestrong{algoritmo de extracci√≥n de caracter√≠sticas morfom√©tricas} desarrollado se recoge en la siguiente figura:

\begin{figure}[htbp]
\centering
\capstart

\noindent\sphinxincludegraphics[width=0.250\linewidth]{{Process_Img_Master_final}.png}
\caption{Pipeline del sistema de extracci√≥n de caracter√≠sticas}\label{\detokenize{content/01/Imagen:figura-wp1-imagen-1}}\end{figure}

\sphinxAtStartPar
Como se puede apreciar, el sistema est√° formado por cuatro m√≥dulos funcionales cada uno de ellos responsable de una funci√≥n espec√≠fica. En las siguientes secciones se estudia con mayor detalle cada uno de ellos y las tecnolog√≠as hardware\sphinxhyphen{}software usadas.

\sphinxstepscope


\section{M1 \sphinxhyphen{} Captura}
\label{\detokenize{content/01/Modulo-1:m1-captura}}\label{\detokenize{content/01/Modulo-1::doc}}
\sphinxAtStartPar
Este m√≥dulo es el responsable de la adquisici√≥n de las im√°genes. Funcionalmente este m√≥dulo se sustenta sobre una barrera l√°ser \sphinxhyphen{} a modo de trigger \sphinxhyphen{} a la entrada del canal (cinta transportadora) que cuando es interrumpida por el paso de un alev√≠n activa la captura de la fotograf√≠a. La c√°mara env√≠a la foto capturada a trav√©s del protocolo TCP al sistema de visi√≥n en d√≥nde se lleva a cabo el flujo de acciones recogido en el siguiente diagrama.

\begin{figure}[htbp]
\centering
\capstart

\noindent\sphinxincludegraphics[width=0.500\linewidth]{{Modulo-1}.png}
\caption{Flujograma del m√≥dulo de captura}\label{\detokenize{content/01/Modulo-1:figura-wp1-imagen-2}}\end{figure}

\sphinxAtStartPar
El motor que controla el flujo de acciones se ha desarrollado sobre la base de Node\sphinxhyphen{}RED. Node\sphinxhyphen{}RED es una herramienta de programaci√≥n visual basada en flujos desarrollada inicialmente por IBM, que permite integrar dispositivos, APIs y servicios mediante nodos configurables. Su arquitectura est√° construida sobre Node.js, lo que le proporciona un alto rendimiento y la capacidad de ejecutar procesos en tiempo real sobre hardware ligero (desde servidores industriales hasta dispositivos embebidos como Raspberry Pi). Los flujos en Node\sphinxhyphen{}RED se representan gr√°ficamente, facilitando la implementaci√≥n de sistemas complejos en entornos de IoT e Industria 4.0. Adem√°s, su ecosistema de nodos permite la integraci√≥n directa con protocolos industriales (p. ej., MQTT, OPC\sphinxhyphen{}UA, Modbus, TCP\sphinxhyphen{}UDP), bases de datos, sistemas de control (PLC) y librer√≠as externas en Python o C++, lo que lo convierte en una plataforma id√≥nea para la adquisici√≥n y procesamiento de datos heterog√©neos.

\sphinxAtStartPar
En el contexto del m√≥dulo de captura de im√°genes descrito, Node\sphinxhyphen{}RED ofrece ventajas cr√≠ticas: permite orquestar la se√±al de disparo proveniente de una barrera, gestiona la adquisici√≥n de la imagen junto con sus metadatos (timestamp, ID, par√°metros de c√°mara‚Ä¶) y aplicar rutinas de validaci√≥n para garantizar la integridad del frame capturado. El hecho adicional de poder programar funciones personalizadas en JavaScript o integrar scripts externos en Python, permite ejecutar c√≥digo necesario para validar si la imagen es utilizable (\sphinxcode{\sphinxupquote{¬øFrame v√°lido?}}) antes de enviarla a etapas posteriores de procesado, minimizando errores y p√©rdidas de informaci√≥n. El flujo responsable de la adquisici√≥n y los nodos implicados se refleja en la siguiente figura.

\begin{figure}[htbp]
\centering
\capstart

\noindent\sphinxincludegraphics[width=1.000\linewidth]{{Modulo-1_nodered}.png}
\caption{Flujo de acciones responsable del m√≥dulo de captura de imagen}\label{\detokenize{content/01/Modulo-1:figura-wp1-imagen-3}}\end{figure}

\sphinxstepscope


\section{M2 \sphinxhyphen{} Calibraci√≥n}
\label{\detokenize{content/01/Modulo-2:m2-calibracion}}\label{\detokenize{content/01/Modulo-2::doc}}
\sphinxAtStartPar
Para poder extraer las dimensiones reales (mm) de la longitud, anchura y altura es necesario que el sistema disponga de alg√∫n tipo de calibraci√≥n. Para ello la forma m√°s r√°pida es disponer de un damero (Checkerboard) de dimensiones exactas y conocidas como el de la figura, en el que cada una de las inserciones internas mide exactamente 10 mm de lado.

\begin{figure}[htbp]
\centering
\capstart

\noindent\sphinxincludegraphics[width=0.750\linewidth]{{checkerboard_10x10}.png}
\caption{Checkerdoard (damero) para calibraci√≥n}\label{\detokenize{content/01/Modulo-2:figura-wp1-imagen-4}}\end{figure}

\sphinxAtStartPar
Si \(ùêø_{px}\) es la longitud medida en p√≠xeles de un objeto cuya longitud real \(L_{mm}\) es conocida (10 mm en nuestro damero), la escala se define como:
\begin{equation*}
\begin{split}
ùë†[mm/px]=\dfrac{L_{mm}}{ùêø_{px}}
\end{split}
\end{equation*}
\sphinxAtStartPar
Para robustez, se usa la mediana de m√∫ltiples aristas horizontales y verticales {[}\sphinxhref{https://doi.org/10.1109/34.888718}{Zang, Z., 2020}{]}. La incertidumbre relativa de primer orden es:
\begin{equation}\label{equation:content/01/Modulo-2:incertidumbre_calibracion}
\begin{split}\left(\frac{\sigma_s}{s}\right)^2 \;\approx\;
\left(\frac{\sigma_{L_{\text{mm}}}}{L_{\text{mm}}}\right)^2 \;+\;
\left(\frac{\sigma_{L_{\text{px}}}}{L_{\text{px}}}\right)^2\end{split}
\end{equation}
\sphinxAtStartPar
El flujo UML que resuelve la calibraci√≥n es el siguiente:

\begin{figure}[htbp]
\centering
\capstart

\noindent\sphinxincludegraphics[width=0.750\linewidth]{{Modulo-2}.png}
\caption{UML proceso de calibraci√≥n}\label{\detokenize{content/01/Modulo-2:figura-wp1-imagen-5}}\end{figure}

\begin{sphinxuseclass}{cell}\begin{sphinxVerbatimInput}

\begin{sphinxuseclass}{cell_input}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{}\PYGZsh{} INSTALACION DE LIBRERIAS}
\PYG{c+c1}{\PYGZsh{} Ejecutar la siguiente l√≠nea si no se ha previmente}

\PYG{c+c1}{\PYGZsh{}!pip install opencv\PYGZhy{}python}
\end{sphinxVerbatim}

\end{sphinxuseclass}\end{sphinxVerbatimInput}

\end{sphinxuseclass}
\begin{sphinxuseclass}{cell}\begin{sphinxVerbatimInput}

\begin{sphinxuseclass}{cell_input}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{}\PYGZsh{} IMPORT Y UTILIDAES DE E/S}

\PYG{c+c1}{\PYGZsh{} Importa librer√≠as y define utilidades para leer/escribir JSON con seguridad.}

\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{json}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{dataclasses}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{dataclass}\PYG{p}{,} \PYG{n}{asdict}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{pathlib}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{Path}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{typing}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{Optional}\PYG{p}{,} \PYG{n}{Dict}\PYG{p}{,} \PYG{n}{Any}\PYG{p}{,} \PYG{n}{Tuple}

\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{numpy}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{np}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{cv2}

\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{load\PYGZus{}json}\PYG{p}{(}\PYG{n}{path}\PYG{p}{:} \PYG{n}{Path}\PYG{p}{)} \PYG{o}{\PYGZhy{}}\PYG{o}{\PYGZgt{}} \PYG{n}{Optional}\PYG{p}{[}\PYG{n+nb}{dict}\PYG{p}{]}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Carga un JSON si existe; devuelve None si no existe.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{k}{if} \PYG{o+ow}{not} \PYG{n}{path}\PYG{o}{.}\PYG{n}{exists}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{return} \PYG{k+kc}{None}
    \PYG{k}{with} \PYG{n}{path}\PYG{o}{.}\PYG{n}{open}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{r}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{encoding}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{utf\PYGZhy{}8}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)} \PYG{k}{as} \PYG{n}{f}\PYG{p}{:}
        \PYG{k}{return} \PYG{n}{json}\PYG{o}{.}\PYG{n}{load}\PYG{p}{(}\PYG{n}{f}\PYG{p}{)}

\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{save\PYGZus{}json}\PYG{p}{(}\PYG{n}{path}\PYG{p}{:} \PYG{n}{Path}\PYG{p}{,} \PYG{n}{data}\PYG{p}{:} \PYG{n+nb}{dict}\PYG{p}{)} \PYG{o}{\PYGZhy{}}\PYG{o}{\PYGZgt{}} \PYG{k+kc}{None}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Guarda un dict como JSON (UTF\PYGZhy{}8, con indentado) y crea carpetas si no existen.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{n}{path}\PYG{o}{.}\PYG{n}{parent}\PYG{o}{.}\PYG{n}{mkdir}\PYG{p}{(}\PYG{n}{parents}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{,} \PYG{n}{exist\PYGZus{}ok}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{)}
    \PYG{k}{with} \PYG{n}{path}\PYG{o}{.}\PYG{n}{open}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{w}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{encoding}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{utf\PYGZhy{}8}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)} \PYG{k}{as} \PYG{n}{f}\PYG{p}{:}
        \PYG{n}{json}\PYG{o}{.}\PYG{n}{dump}\PYG{p}{(}\PYG{n}{data}\PYG{p}{,} \PYG{n}{f}\PYG{p}{,} \PYG{n}{indent}\PYG{o}{=}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{ensure\PYGZus{}ascii}\PYG{o}{=}\PYG{k+kc}{False}\PYG{p}{)}
\end{sphinxVerbatim}

\end{sphinxuseclass}\end{sphinxVerbatimInput}

\end{sphinxuseclass}
\begin{sphinxuseclass}{cell}\begin{sphinxVerbatimInput}

\begin{sphinxuseclass}{cell_input}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{}\PYGZsh{} CONFIGURACION }

\PYG{c+c1}{\PYGZsh{} fija rutas y par√°metros del patr√≥n para el damero}

\PYG{c+c1}{\PYGZsh{} === CONFIG (ajustada al damero de calibrado) ===================================}
\PYG{n}{CALIB\PYGZus{}FILE} \PYG{o}{=} \PYG{n}{Path}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{./calibracion\PYGZus{}px\PYGZus{}mm.json}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Patr√≥n de referencia: DAMERO 10x10 cuadrados =\PYGZgt{} 9x9 intersecciones internas}
\PYG{n}{CHECKERBOARD\PYGZus{}SQUARE\PYGZus{}MM} \PYG{o}{=} \PYG{l+m+mf}{10.0}
\PYG{n}{CHECKERBOARD\PYGZus{}SQUARES\PYGZus{}COLS} \PYG{o}{=} \PYG{l+m+mi}{10}   \PYG{c+c1}{\PYGZsh{} n√∫mero de cuadrados horizontales}
\PYG{n}{CHECKERBOARD\PYGZus{}SQUARES\PYGZus{}ROWS} \PYG{o}{=} \PYG{l+m+mi}{10}   \PYG{c+c1}{\PYGZsh{} n√∫mero de cuadrados verticales}
\PYG{n}{CHECKERBOARD\PYGZus{}INTERNAL\PYGZus{}COLS} \PYG{o}{=} \PYG{n}{CHECKERBOARD\PYGZus{}SQUARES\PYGZus{}COLS} \PYG{o}{\PYGZhy{}} \PYG{l+m+mi}{1}  \PYG{c+c1}{\PYGZsh{} 9 intersecciones internas}
\PYG{n}{CHECKERBOARD\PYGZus{}INTERNAL\PYGZus{}ROWS} \PYG{o}{=} \PYG{n}{CHECKERBOARD\PYGZus{}SQUARES\PYGZus{}ROWS} \PYG{o}{\PYGZhy{}} \PYG{l+m+mi}{1}  \PYG{c+c1}{\PYGZsh{} 9 intersecciones internas}

\PYG{c+c1}{\PYGZsh{} Agregaci√≥n robusta de distancias entre esquinas: \PYGZdq{}median\PYGZdq{} o \PYGZdq{}mean\PYGZdq{}}
\PYG{n}{AGGREGATION} \PYG{o}{=} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{median}\PYG{l+s+s2}{\PYGZdq{}}

\PYG{c+c1}{\PYGZsh{} Usa la imagen del  damero de referencia.}
\PYG{n}{IMG\PYGZus{}PATH} \PYG{o}{=} \PYG{n}{Path}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{.././assets/checkerboard\PYGZus{}10mm\PYGZus{}200pxmm.png}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\end{sphinxVerbatim}

\end{sphinxuseclass}\end{sphinxVerbatimInput}

\end{sphinxuseclass}
\begin{sphinxuseclass}{cell}\begin{sphinxVerbatimInput}

\begin{sphinxuseclass}{cell_input}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{}\PYGZsh{} ESTRUCTURA DE CALIBRACION Y PERSISTENCIA}

\PYG{c+c1}{\PYGZsh{} Define la estructura (dataclass) que se guardar√° en JSON y las funciones de lectura/escritura}
\PYG{c+c1}{\PYGZsh{} del fichero de calibraci√≥n}

\PYG{n+nd}{@dataclass}
\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{Calibration}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Estructura persistente de calibraci√≥n.}
\PYG{l+s+sd}{    \PYGZhy{} mm\PYGZus{}per\PYGZus{}px: escala (mil√≠metros por p√≠xel).}
\PYG{l+s+sd}{    \PYGZhy{} method: m√©todo usado (\PYGZdq{}checkerboard\PYGZdq{}).}
\PYG{l+s+sd}{    \PYGZhy{} meta: metadatos/diagn√≥sticos (estad√≠sticos de distancias en p√≠xeles, etc.).}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{n}{mm\PYGZus{}per\PYGZus{}px}\PYG{p}{:} \PYG{n+nb}{float}
    \PYG{n}{method}\PYG{p}{:} \PYG{n+nb}{str}
    \PYG{n}{meta}\PYG{p}{:} \PYG{n}{Dict}\PYG{p}{[}\PYG{n+nb}{str}\PYG{p}{,} \PYG{n}{Any}\PYG{p}{]}

\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{load\PYGZus{}calibration}\PYG{p}{(}\PYG{n}{path}\PYG{p}{:} \PYG{n}{Path}\PYG{p}{)} \PYG{o}{\PYGZhy{}}\PYG{o}{\PYGZgt{}} \PYG{n}{Optional}\PYG{p}{[}\PYG{n}{Calibration}\PYG{p}{]}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Lee la calibraci√≥n desde JSON; devuelve None si no existe o si hay formato inv√°lido.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{n}{data} \PYG{o}{=} \PYG{n}{load\PYGZus{}json}\PYG{p}{(}\PYG{n}{path}\PYG{p}{)}
    \PYG{k}{if} \PYG{n}{data} \PYG{o+ow}{is} \PYG{k+kc}{None}\PYG{p}{:}
        \PYG{k}{return} \PYG{k+kc}{None}
    \PYG{k}{try}\PYG{p}{:}
        \PYG{k}{return} \PYG{n}{Calibration}\PYG{p}{(}
            \PYG{n}{mm\PYGZus{}per\PYGZus{}px}\PYG{o}{=}\PYG{n+nb}{float}\PYG{p}{(}\PYG{n}{data}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{mm\PYGZus{}per\PYGZus{}px}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{p}{)}\PYG{p}{,}
            \PYG{n}{method}\PYG{o}{=}\PYG{n+nb}{str}\PYG{p}{(}\PYG{n}{data}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{method}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{p}{)}\PYG{p}{,}
            \PYG{n}{meta}\PYG{o}{=}\PYG{n+nb}{dict}\PYG{p}{(}\PYG{n}{data}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{meta}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{p}{)}\PYG{p}{,}
        \PYG{p}{)}
    \PYG{k}{except} \PYG{n+ne}{Exception}\PYG{p}{:}
        \PYG{k}{return} \PYG{k+kc}{None}

\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{save\PYGZus{}calibration}\PYG{p}{(}\PYG{n}{path}\PYG{p}{:} \PYG{n}{Path}\PYG{p}{,} \PYG{n}{cal}\PYG{p}{:} \PYG{n}{Calibration}\PYG{p}{)} \PYG{o}{\PYGZhy{}}\PYG{o}{\PYGZgt{}} \PYG{k+kc}{None}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Persistencia de calibraci√≥n a JSON.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{n}{save\PYGZus{}json}\PYG{p}{(}\PYG{n}{path}\PYG{p}{,} \PYG{n}{asdict}\PYG{p}{(}\PYG{n}{cal}\PYG{p}{)}\PYG{p}{)}
\end{sphinxVerbatim}

\end{sphinxuseclass}\end{sphinxVerbatimInput}

\end{sphinxuseclass}
\begin{sphinxuseclass}{cell}\begin{sphinxVerbatimInput}

\begin{sphinxuseclass}{cell_input}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{}\PYGZsh{} DETECCI√ìN DEL DAMERO Y C√ÅLCULO mm/px}

\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{detect\PYGZus{}checkerboard\PYGZus{}scale}\PYG{p}{(}
    \PYG{n}{img\PYGZus{}bgr}\PYG{p}{:} \PYG{n}{np}\PYG{o}{.}\PYG{n}{ndarray}\PYG{p}{,}
    \PYG{n}{cols\PYGZus{}internal}\PYG{p}{:} \PYG{n+nb}{int}\PYG{p}{,}
    \PYG{n}{rows\PYGZus{}internal}\PYG{p}{:} \PYG{n+nb}{int}\PYG{p}{,}
    \PYG{n}{square\PYGZus{}mm}\PYG{p}{:} \PYG{n+nb}{float}\PYG{p}{,}
    \PYG{n}{aggregation}\PYG{p}{:} \PYG{n+nb}{str} \PYG{o}{=} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{median}\PYG{l+s+s2}{\PYGZdq{}}
\PYG{p}{)} \PYG{o}{\PYGZhy{}}\PYG{o}{\PYGZgt{}} \PYG{n}{Optional}\PYG{p}{[}\PYG{n}{Tuple}\PYG{p}{[}\PYG{n+nb}{float}\PYG{p}{,} \PYG{n}{Dict}\PYG{p}{[}\PYG{n+nb}{str}\PYG{p}{,} \PYG{n}{Any}\PYG{p}{]}\PYG{p}{]}\PYG{p}{]}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Detecta un damero de (cols\PYGZus{}internal x rows\PYGZus{}internal) intersecciones internas.}
\PYG{l+s+sd}{    Calcula mm/px usando la mediana (por defecto) de distancias entre esquinas adyacentes.}

\PYG{l+s+sd}{    Devuelve: (mm\PYGZus{}per\PYGZus{}px, diagnostics) si detecta; None si no detecta.}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{n}{gray} \PYG{o}{=} \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{cvtColor}\PYG{p}{(}\PYG{n}{img\PYGZus{}bgr}\PYG{p}{,} \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{COLOR\PYGZus{}BGR2GRAY}\PYG{p}{)}

    \PYG{n}{flags} \PYG{o}{=} \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{CALIB\PYGZus{}CB\PYGZus{}ADAPTIVE\PYGZus{}THRESH} \PYG{o}{|} \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{CALIB\PYGZus{}CB\PYGZus{}NORMALIZE\PYGZus{}IMAGE}
    \PYG{n}{found}\PYG{p}{,} \PYG{n}{corners} \PYG{o}{=} \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{findChessboardCorners}\PYG{p}{(}\PYG{n}{gray}\PYG{p}{,} \PYG{p}{(}\PYG{n}{cols\PYGZus{}internal}\PYG{p}{,} \PYG{n}{rows\PYGZus{}internal}\PYG{p}{)}\PYG{p}{,} \PYG{n}{flags}\PYG{p}{)}

    \PYG{k}{if} \PYG{o+ow}{not} \PYG{n}{found} \PYG{o+ow}{or} \PYG{n}{corners} \PYG{o+ow}{is} \PYG{k+kc}{None}\PYG{p}{:}
        \PYG{k}{return} \PYG{k+kc}{None}

    \PYG{c+c1}{\PYGZsh{} Refinamiento subp√≠xel}
    \PYG{n}{criteria} \PYG{o}{=} \PYG{p}{(}\PYG{n}{cv2}\PYG{o}{.}\PYG{n}{TERM\PYGZus{}CRITERIA\PYGZus{}EPS} \PYG{o}{+} \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{TERM\PYGZus{}CRITERIA\PYGZus{}MAX\PYGZus{}ITER}\PYG{p}{,} \PYG{l+m+mi}{50}\PYG{p}{,} \PYG{l+m+mf}{1e\PYGZhy{}4}\PYG{p}{)}
    \PYG{n}{corners} \PYG{o}{=} \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{cornerSubPix}\PYG{p}{(}\PYG{n}{gray}\PYG{p}{,} \PYG{n}{corners}\PYG{p}{,} \PYG{p}{(}\PYG{l+m+mi}{11}\PYG{p}{,} \PYG{l+m+mi}{11}\PYG{p}{)}\PYG{p}{,} \PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{,} \PYG{n}{criteria}\PYG{p}{)}
    \PYG{n}{corners} \PYG{o}{=} \PYG{n}{corners}\PYG{o}{.}\PYG{n}{reshape}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} N x 2}

    \PYG{c+c1}{\PYGZsh{} Distancias horizontales}
    \PYG{n}{horiz} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
    \PYG{k}{for} \PYG{n}{r} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{rows\PYGZus{}internal}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{for} \PYG{n}{c} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{cols\PYGZus{}internal} \PYG{o}{\PYGZhy{}} \PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{i} \PYG{o}{=} \PYG{n}{r} \PYG{o}{*} \PYG{n}{cols\PYGZus{}internal} \PYG{o}{+} \PYG{n}{c}
            \PYG{n}{j} \PYG{o}{=} \PYG{n}{r} \PYG{o}{*} \PYG{n}{cols\PYGZus{}internal} \PYG{o}{+} \PYG{p}{(}\PYG{n}{c} \PYG{o}{+} \PYG{l+m+mi}{1}\PYG{p}{)}
            \PYG{n}{d} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{linalg}\PYG{o}{.}\PYG{n}{norm}\PYG{p}{(}\PYG{n}{corners}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]} \PYG{o}{\PYGZhy{}} \PYG{n}{corners}\PYG{p}{[}\PYG{n}{j}\PYG{p}{]}\PYG{p}{)}
            \PYG{k}{if} \PYG{n}{d} \PYG{o}{\PYGZgt{}} \PYG{l+m+mi}{0}\PYG{p}{:}
                \PYG{n}{horiz}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{d}\PYG{p}{)}

    \PYG{c+c1}{\PYGZsh{} Distancias verticales}
    \PYG{n}{vert} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
    \PYG{k}{for} \PYG{n}{r} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{rows\PYGZus{}internal} \PYG{o}{\PYGZhy{}} \PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{for} \PYG{n}{c} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{cols\PYGZus{}internal}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{i} \PYG{o}{=} \PYG{n}{r} \PYG{o}{*} \PYG{n}{cols\PYGZus{}internal} \PYG{o}{+} \PYG{n}{c}
            \PYG{n}{j} \PYG{o}{=} \PYG{p}{(}\PYG{n}{r} \PYG{o}{+} \PYG{l+m+mi}{1}\PYG{p}{)} \PYG{o}{*} \PYG{n}{cols\PYGZus{}internal} \PYG{o}{+} \PYG{n}{c}
            \PYG{n}{d} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{linalg}\PYG{o}{.}\PYG{n}{norm}\PYG{p}{(}\PYG{n}{corners}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]} \PYG{o}{\PYGZhy{}} \PYG{n}{corners}\PYG{p}{[}\PYG{n}{j}\PYG{p}{]}\PYG{p}{)}
            \PYG{k}{if} \PYG{n}{d} \PYG{o}{\PYGZgt{}} \PYG{l+m+mi}{0}\PYG{p}{:}
                \PYG{n}{vert}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{d}\PYG{p}{)}

    \PYG{n}{dists} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{n}{horiz} \PYG{o}{+} \PYG{n}{vert}\PYG{p}{,} \PYG{n}{dtype}\PYG{o}{=}\PYG{n+nb}{float}\PYG{p}{)}
    \PYG{k}{if} \PYG{n}{dists}\PYG{o}{.}\PYG{n}{size} \PYG{o}{==} \PYG{l+m+mi}{0}\PYG{p}{:}
        \PYG{k}{return} \PYG{k+kc}{None}

    \PYG{c+c1}{\PYGZsh{} px por cuadrado (mediana por robustez ante outliers)}
    \PYG{n}{px\PYGZus{}per\PYGZus{}square} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{median}\PYG{p}{(}\PYG{n}{dists}\PYG{p}{)} \PYG{k}{if} \PYG{n}{aggregation} \PYG{o}{==} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{median}\PYG{l+s+s2}{\PYGZdq{}} \PYG{k}{else} \PYG{n}{np}\PYG{o}{.}\PYG{n}{mean}\PYG{p}{(}\PYG{n}{dists}\PYG{p}{)}
    \PYG{n}{mm\PYGZus{}per\PYGZus{}px}     \PYG{o}{=} \PYG{n}{square\PYGZus{}mm} \PYG{o}{/} \PYG{n}{px\PYGZus{}per\PYGZus{}square}

    \PYG{n}{diagnostics} \PYG{o}{=} \PYG{p}{\PYGZob{}}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{pattern}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{checkerboard}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{internal\PYGZus{}cols}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n+nb}{int}\PYG{p}{(}\PYG{n}{cols\PYGZus{}internal}\PYG{p}{)}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{internal\PYGZus{}rows}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n+nb}{int}\PYG{p}{(}\PYG{n}{rows\PYGZus{}internal}\PYG{p}{)}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{square\PYGZus{}mm}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n+nb}{float}\PYG{p}{(}\PYG{n}{square\PYGZus{}mm}\PYG{p}{)}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{edges\PYGZus{}count}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n+nb}{int}\PYG{p}{(}\PYG{n}{dists}\PYG{o}{.}\PYG{n}{size}\PYG{p}{)}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{px\PYGZus{}per\PYGZus{}square\PYGZus{}summary}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{mean}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n+nb}{float}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{mean}\PYG{p}{(}\PYG{n}{dists}\PYG{p}{)}\PYG{p}{)}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{median}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n+nb}{float}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{median}\PYG{p}{(}\PYG{n}{dists}\PYG{p}{)}\PYG{p}{)}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{std}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n+nb}{float}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{std}\PYG{p}{(}\PYG{n}{dists}\PYG{p}{,} \PYG{n}{ddof}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{)} \PYG{k}{if} \PYG{n}{dists}\PYG{o}{.}\PYG{n}{size} \PYG{o}{\PYGZgt{}} \PYG{l+m+mi}{1} \PYG{k}{else} \PYG{l+m+mf}{0.0}
        \PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{aggregation}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{aggregation}
    \PYG{p}{\PYGZcb{}}
    \PYG{k}{return} \PYG{n}{mm\PYGZus{}per\PYGZus{}px}\PYG{p}{,} \PYG{n}{diagnostics}
\end{sphinxVerbatim}

\end{sphinxuseclass}\end{sphinxVerbatimInput}

\end{sphinxuseclass}
\begin{sphinxuseclass}{cell}\begin{sphinxVerbatimInput}

\begin{sphinxuseclass}{cell_input}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{}\PYGZsh{} FUNCI√ìN DE CALIBRACI√ìN}

\PYG{c+c1}{\PYGZsh{} implementa literalmente el diagrama de decisiones: }
\PYG{c+c1}{\PYGZsh{} \PYGZhy{} usar calibraci√≥n vigente (permanente) salvo que el usuario fuerce recalibraci√≥n;}
\PYG{c+c1}{\PYGZsh{} \PYGZhy{} si no hay calibraci√≥n o se fuerza, intenta detectar y calcular; }
\PYG{c+c1}{\PYGZsh{} \PYGZhy{} si falla, `sin\PYGZus{}escala`}

\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{run\PYGZus{}calibration\PYGZus{}pipeline\PYGZus{}checkerboard}\PYG{p}{(}
    \PYG{n}{calib\PYGZus{}file}\PYG{p}{:} \PYG{n}{Path}\PYG{p}{,}
    \PYG{n}{img\PYGZus{}path}\PYG{p}{:} \PYG{n}{Path}\PYG{p}{,}
    \PYG{n}{cols\PYGZus{}internal}\PYG{p}{:} \PYG{n+nb}{int}\PYG{p}{,}
    \PYG{n}{rows\PYGZus{}internal}\PYG{p}{:} \PYG{n+nb}{int}\PYG{p}{,}
    \PYG{n}{square\PYGZus{}mm}\PYG{p}{:} \PYG{n+nb}{float}\PYG{p}{,}
    \PYG{n}{aggregation}\PYG{p}{:} \PYG{n+nb}{str} \PYG{o}{=} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{median}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
    \PYG{n}{force\PYGZus{}recalibrate}\PYG{p}{:} \PYG{n+nb}{bool} \PYG{o}{=} \PYG{k+kc}{False}
\PYG{p}{)} \PYG{o}{\PYGZhy{}}\PYG{o}{\PYGZgt{}} \PYG{n}{Dict}\PYG{p}{[}\PYG{n+nb}{str}\PYG{p}{,} \PYG{n}{Any}\PYG{p}{]}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    UML ‚ÄúM2 \PYGZhy{} Calibraci√≥n de escala‚Äù:}

\PYG{l+s+sd}{    if (¬øCalibraci√≥n vigente?) then (S√≠)}
\PYG{l+s+sd}{        :Usar escala px‚Üímm guardada;}
\PYG{l+s+sd}{    else (No)}
\PYG{l+s+sd}{        :Detectar patr√≥n referencia;}
\PYG{l+s+sd}{        if (¬øDetectado?) then (S√≠)}
\PYG{l+s+sd}{            :Calcular escala px‚Üímm; (y guardar)}
\PYG{l+s+sd}{        else (No)}
\PYG{l+s+sd}{            :Marcar sin\PYGZus{}escala;}

\PYG{l+s+sd}{    \PYGZsq{}Vigente\PYGZsq{} = existe calibraci√≥n en disco y NO se fuerza recalibraci√≥n.}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} 1) ¬øCalibraci√≥n \PYGZsq{}vigente\PYGZsq{}?}
    \PYG{k}{if} \PYG{o+ow}{not} \PYG{n}{force\PYGZus{}recalibrate}\PYG{p}{:}
        \PYG{n}{cal} \PYG{o}{=} \PYG{n}{load\PYGZus{}calibration}\PYG{p}{(}\PYG{n}{calib\PYGZus{}file}\PYG{p}{)}
        \PYG{k}{if} \PYG{n}{cal} \PYG{o+ow}{is} \PYG{o+ow}{not} \PYG{k+kc}{None} \PYG{o+ow}{and} \PYG{n}{cal}\PYG{o}{.}\PYG{n}{method} \PYG{o}{==} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{checkerboard}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:}
            \PYG{k}{return} \PYG{p}{\PYGZob{}}
                \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{estado}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{vigente}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
                \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{mm\PYGZus{}per\PYGZus{}px}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{cal}\PYG{o}{.}\PYG{n}{mm\PYGZus{}per\PYGZus{}px}\PYG{p}{,}
                \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{method}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{cal}\PYG{o}{.}\PYG{n}{method}\PYG{p}{,}
                \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{meta}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{cal}\PYG{o}{.}\PYG{n}{meta}
            \PYG{p}{\PYGZcb{}}

    \PYG{c+c1}{\PYGZsh{} 2) No vigente (o se fuerza) \PYGZhy{}\PYGZgt{} Detectar patr√≥n referencia}
    \PYG{k}{if} \PYG{o+ow}{not} \PYG{n}{img\PYGZus{}path}\PYG{o}{.}\PYG{n}{exists}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{return} \PYG{p}{\PYGZob{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{estado}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{sin\PYGZus{}escala}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{motivo}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Imagen no encontrada: }\PYG{l+s+si}{\PYGZob{}}\PYG{n+nb}{str}\PYG{p}{(}\PYG{n}{img\PYGZus{}path}\PYG{p}{)}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{\PYGZcb{}}

    \PYG{n}{img} \PYG{o}{=} \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{imread}\PYG{p}{(}\PYG{n+nb}{str}\PYG{p}{(}\PYG{n}{img\PYGZus{}path}\PYG{p}{)}\PYG{p}{)}
    \PYG{k}{if} \PYG{n}{img} \PYG{o+ow}{is} \PYG{k+kc}{None}\PYG{p}{:}
        \PYG{k}{return} \PYG{p}{\PYGZob{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{estado}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{sin\PYGZus{}escala}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{motivo}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{No se pudo abrir la imagen: }\PYG{l+s+si}{\PYGZob{}}\PYG{n+nb}{str}\PYG{p}{(}\PYG{n}{img\PYGZus{}path}\PYG{p}{)}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{\PYGZcb{}}

    \PYG{n}{res} \PYG{o}{=} \PYG{n}{detect\PYGZus{}checkerboard\PYGZus{}scale}\PYG{p}{(}
        \PYG{n}{img\PYGZus{}bgr}\PYG{o}{=}\PYG{n}{img}\PYG{p}{,}
        \PYG{n}{cols\PYGZus{}internal}\PYG{o}{=}\PYG{n}{cols\PYGZus{}internal}\PYG{p}{,}
        \PYG{n}{rows\PYGZus{}internal}\PYG{o}{=}\PYG{n}{rows\PYGZus{}internal}\PYG{p}{,}
        \PYG{n}{square\PYGZus{}mm}\PYG{o}{=}\PYG{n}{square\PYGZus{}mm}\PYG{p}{,}
        \PYG{n}{aggregation}\PYG{o}{=}\PYG{n}{aggregation}
    \PYG{p}{)}

    \PYG{c+c1}{\PYGZsh{} 3) ¬øDetectado?}
    \PYG{k}{if} \PYG{n}{res} \PYG{o+ow}{is} \PYG{k+kc}{None}\PYG{p}{:}
        \PYG{k}{return} \PYG{p}{\PYGZob{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{estado}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{sin\PYGZus{}escala}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{motivo}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{No se detect√≥ el damero en la imagen}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{\PYGZcb{}}

    \PYG{c+c1}{\PYGZsh{} 4) Calcular escala y guardar}
    \PYG{n}{mm\PYGZus{}per\PYGZus{}px}\PYG{p}{,} \PYG{n}{diag} \PYG{o}{=} \PYG{n}{res}
    \PYG{n}{cal} \PYG{o}{=} \PYG{n}{Calibration}\PYG{p}{(}
        \PYG{n}{mm\PYGZus{}per\PYGZus{}px}\PYG{o}{=}\PYG{n+nb}{float}\PYG{p}{(}\PYG{n}{mm\PYGZus{}per\PYGZus{}px}\PYG{p}{)}\PYG{p}{,}
        \PYG{n}{method}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{checkerboard}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{n}{meta}\PYG{o}{=}\PYG{p}{\PYGZob{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{diagnostics}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{diag}\PYG{p}{\PYGZcb{}}
    \PYG{p}{)}
    \PYG{n}{save\PYGZus{}calibration}\PYG{p}{(}\PYG{n}{calib\PYGZus{}file}\PYG{p}{,} \PYG{n}{cal}\PYG{p}{)}

    \PYG{k}{return} \PYG{p}{\PYGZob{}}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{estado}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{recalibrado}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{mm\PYGZus{}per\PYGZus{}px}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{cal}\PYG{o}{.}\PYG{n}{mm\PYGZus{}per\PYGZus{}px}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{method}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{cal}\PYG{o}{.}\PYG{n}{method}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{meta}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{cal}\PYG{o}{.}\PYG{n}{meta}
    \PYG{p}{\PYGZcb{}}
\end{sphinxVerbatim}

\end{sphinxuseclass}\end{sphinxVerbatimInput}

\end{sphinxuseclass}
\sphinxAtStartPar
Para calibrar el sistema basta con ejecutar una llamada a la funci√≥n anterior \sphinxcode{\sphinxupquote{run\_calibration\_pipeline\_checkerboard()}} del siguiente modo:

\begin{sphinxuseclass}{cell}\begin{sphinxVerbatimInput}

\begin{sphinxuseclass}{cell_input}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{calibration} \PYG{o}{=} \PYG{n}{run\PYGZus{}calibration\PYGZus{}pipeline\PYGZus{}checkerboard}\PYG{p}{(}
    \PYG{n}{calib\PYGZus{}file}\PYG{o}{=}\PYG{n}{CALIB\PYGZus{}FILE}\PYG{p}{,}
    \PYG{n}{img\PYGZus{}path}\PYG{o}{=}\PYG{n}{IMG\PYGZus{}PATH}\PYG{p}{,}
    \PYG{n}{cols\PYGZus{}internal}\PYG{o}{=}\PYG{n}{CHECKERBOARD\PYGZus{}INTERNAL\PYGZus{}COLS}\PYG{p}{,}
    \PYG{n}{rows\PYGZus{}internal}\PYG{o}{=}\PYG{n}{CHECKERBOARD\PYGZus{}INTERNAL\PYGZus{}ROWS}\PYG{p}{,}
    \PYG{n}{square\PYGZus{}mm}\PYG{o}{=}\PYG{n}{CHECKERBOARD\PYGZus{}SQUARE\PYGZus{}MM}\PYG{p}{,}
    \PYG{n}{aggregation}\PYG{o}{=}\PYG{n}{AGGREGATION}\PYG{p}{,}
    \PYG{n}{force\PYGZus{}recalibrate}\PYG{o}{=}\PYG{k+kc}{False}
\PYG{p}{)}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Resultado de la calibraci√≥n: }\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n}{calibration}
\end{sphinxVerbatim}

\end{sphinxuseclass}\end{sphinxVerbatimInput}
\begin{sphinxVerbatimOutput}

\begin{sphinxuseclass}{cell_output}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
Resultado de la calibraci√≥n:
\end{sphinxVerbatim}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYGZob{}\PYGZsq{}estado\PYGZsq{}: \PYGZsq{}vigente\PYGZsq{},
 \PYGZsq{}mm\PYGZus{}per\PYGZus{}px\PYGZsq{}: 0.05,
 \PYGZsq{}method\PYGZsq{}: \PYGZsq{}checkerboard\PYGZsq{},
 \PYGZsq{}meta\PYGZsq{}: \PYGZob{}\PYGZsq{}diagnostics\PYGZsq{}: \PYGZob{}\PYGZsq{}pattern\PYGZsq{}: \PYGZsq{}checkerboard\PYGZsq{},
   \PYGZsq{}internal\PYGZus{}cols\PYGZsq{}: 9,
   \PYGZsq{}internal\PYGZus{}rows\PYGZsq{}: 9,
   \PYGZsq{}square\PYGZus{}mm\PYGZsq{}: 10.0,
   \PYGZsq{}edges\PYGZus{}count\PYGZsq{}: 144,
   \PYGZsq{}px\PYGZus{}per\PYGZus{}square\PYGZus{}summary\PYGZsq{}: \PYGZob{}\PYGZsq{}mean\PYGZsq{}: 200.0, \PYGZsq{}median\PYGZsq{}: 200.0, \PYGZsq{}std\PYGZsq{}: 0.0\PYGZcb{},
   \PYGZsq{}aggregation\PYGZsq{}: \PYGZsq{}median\PYGZsq{}\PYGZcb{}\PYGZcb{}\PYGZcb{}
\end{sphinxVerbatim}

\end{sphinxuseclass}\end{sphinxVerbatimOutput}

\end{sphinxuseclass}
\sphinxAtStartPar
Este m√≥dulo tambi√©n proporciona algunas \sphinxstylestrong{utilidades de conversi√≥n} que permiten, a partir de un calibrado: obtener la escala (\sphinxcode{\sphinxupquote{get\_mm\_per\_px}}), traducir pixeles a mm (\sphinxcode{\sphinxupquote{px\_to\_mm}}) o transformar mm a pixeles (\sphinxcode{\sphinxupquote{mm\_to\_px}}).

\begin{sphinxuseclass}{cell}\begin{sphinxVerbatimInput}

\begin{sphinxuseclass}{cell_input}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{}\PYGZsh{} UTILIDADES DE CONVERSION}

\PYG{c+c1}{\PYGZsh{} Funciones auxiliares para convertir medidas en el pipeline de visi√≥n.}

\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{get\PYGZus{}mm\PYGZus{}per\PYGZus{}px}\PYG{p}{(}\PYG{n}{calib\PYGZus{}file}\PYG{p}{:} \PYG{n}{Path} \PYG{o}{=} \PYG{n}{CALIB\PYGZus{}FILE}\PYG{p}{)} \PYG{o}{\PYGZhy{}}\PYG{o}{\PYGZgt{}} \PYG{n+nb}{float}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Devuelve la escala mm/px le√≠da del archivo de calibraci√≥n.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{n}{cal} \PYG{o}{=} \PYG{n}{load\PYGZus{}calibration}\PYG{p}{(}\PYG{n}{calib\PYGZus{}file}\PYG{p}{)}
    \PYG{k}{if} \PYG{n}{cal} \PYG{o+ow}{is} \PYG{k+kc}{None}\PYG{p}{:}
        \PYG{k}{raise} \PYG{n+ne}{RuntimeError}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{No hay calibraci√≥n guardada en }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{calib\PYGZus{}file}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{. Ejecuta el pipeline primero.}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    \PYG{k}{return} \PYG{n+nb}{float}\PYG{p}{(}\PYG{n}{cal}\PYG{o}{.}\PYG{n}{mm\PYGZus{}per\PYGZus{}px}\PYG{p}{)}

\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{px\PYGZus{}to\PYGZus{}mm}\PYG{p}{(}\PYG{n}{value\PYGZus{}px}\PYG{p}{:} \PYG{n+nb}{float}\PYG{p}{,} \PYG{n}{mm\PYGZus{}per\PYGZus{}px}\PYG{p}{:} \PYG{n+nb}{float}\PYG{p}{)} \PYG{o}{\PYGZhy{}}\PYG{o}{\PYGZgt{}} \PYG{n+nb}{float}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Convierte longitudes en p√≠xeles a mil√≠metros.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{k}{return} \PYG{n+nb}{float}\PYG{p}{(}\PYG{n}{value\PYGZus{}px}\PYG{p}{)} \PYG{o}{*} \PYG{n+nb}{float}\PYG{p}{(}\PYG{n}{mm\PYGZus{}per\PYGZus{}px}\PYG{p}{)}

\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{mm\PYGZus{}to\PYGZus{}px}\PYG{p}{(}\PYG{n}{value\PYGZus{}mm}\PYG{p}{:} \PYG{n+nb}{float}\PYG{p}{,} \PYG{n}{mm\PYGZus{}per\PYGZus{}px}\PYG{p}{:} \PYG{n+nb}{float}\PYG{p}{)} \PYG{o}{\PYGZhy{}}\PYG{o}{\PYGZgt{}} \PYG{n+nb}{float}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Convierte longitudes en mil√≠metros a p√≠xeles.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{k}{if} \PYG{n}{mm\PYGZus{}per\PYGZus{}px} \PYG{o}{\PYGZlt{}}\PYG{o}{=} \PYG{l+m+mi}{0}\PYG{p}{:}
        \PYG{k}{raise} \PYG{n+ne}{ValueError}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{mm\PYGZus{}per\PYGZus{}px debe ser positivo.}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    \PYG{k}{return} \PYG{n+nb}{float}\PYG{p}{(}\PYG{n}{value\PYGZus{}mm}\PYG{p}{)} \PYG{o}{/} \PYG{n+nb}{float}\PYG{p}{(}\PYG{n}{mm\PYGZus{}per\PYGZus{}px}\PYG{p}{)}
\end{sphinxVerbatim}

\end{sphinxuseclass}\end{sphinxVerbatimInput}

\end{sphinxuseclass}
\sphinxAtStartPar
Un ejemplo de uso de estas funciones ser√≠a:

\begin{sphinxuseclass}{cell}\begin{sphinxVerbatimInput}

\begin{sphinxuseclass}{cell_input}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Escala actual mm/px: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{get\PYGZus{}mm\PYGZus{}per\PYGZus{}px}\PYG{p}{(}\PYG{p}{)}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Longitud en mil√≠metros de 1250 px: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{px\PYGZus{}to\PYGZus{}mm}\PYG{p}{(}\PYG{l+m+mi}{1250}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{get\PYGZus{}mm\PYGZus{}per\PYGZus{}px}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{ mm}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Longitud en piexels de 100 mm: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{mm\PYGZus{}to\PYGZus{}px}\PYG{p}{(}\PYG{l+m+mi}{100}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{get\PYGZus{}mm\PYGZus{}per\PYGZus{}px}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{ pixeles}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\end{sphinxVerbatim}

\end{sphinxuseclass}\end{sphinxVerbatimInput}
\begin{sphinxVerbatimOutput}

\begin{sphinxuseclass}{cell_output}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
Escala actual mm/px: 0.05
Longitud en mil√≠metros de 1250 px: 62.5 mm
Longitud en piexels de 100 mm: 2000.0 pixeles
\end{sphinxVerbatim}

\end{sphinxuseclass}\end{sphinxVerbatimOutput}

\end{sphinxuseclass}
\sphinxAtStartPar
Para garantizar y auditar que el proceso de calibraci√≥n se realiza adecuadamente se han definido algunas funciones auxiliares:

\sphinxAtStartPar
\sphinxstylestrong{Control visual y verificaci√≥n del damero}

\begin{sphinxuseclass}{cell}\begin{sphinxVerbatimInput}

\begin{sphinxuseclass}{cell_input}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{}\PYGZsh{} OVERLAY DE CONTROL VISUAL Y .png DIAGN√ìSTICO}

\PYG{c+c1}{\PYGZsh{} Su funci√≥n es verificar y documentar que la detecci√≥n ha sido correcta.}

\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{datetime}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{datetime}

\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{overlay\PYGZus{}checkerboard\PYGZus{}and\PYGZus{}save}\PYG{p}{(}
    \PYG{n}{img\PYGZus{}path}\PYG{p}{:} \PYG{n}{Path}\PYG{p}{,}
    \PYG{n}{out\PYGZus{}path}\PYG{p}{:} \PYG{n}{Path}\PYG{p}{,}
    \PYG{n}{cols\PYGZus{}internal}\PYG{p}{:} \PYG{n+nb}{int}\PYG{p}{,}
    \PYG{n}{rows\PYGZus{}internal}\PYG{p}{:} \PYG{n+nb}{int}\PYG{p}{,}
    \PYG{n}{mm\PYGZus{}per\PYGZus{}px}\PYG{p}{:} \PYG{n+nb}{float} \PYG{o}{=} \PYG{k+kc}{None}\PYG{p}{,}
    \PYG{n}{draw\PYGZus{}rect}\PYG{p}{:} \PYG{n+nb}{bool} \PYG{o}{=} \PYG{k+kc}{True}
\PYG{p}{)} \PYG{o}{\PYGZhy{}}\PYG{o}{\PYGZgt{}} \PYG{n+nb}{dict}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Dibuja esquinas del damero y anota mm/px (si disponible). Guarda PNG.}
\PYG{l+s+sd}{    Devuelve dict con \PYGZsq{}ok\PYGZsq{} y detalles/motivo de fallo.}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{k}{if} \PYG{o+ow}{not} \PYG{n}{img\PYGZus{}path}\PYG{o}{.}\PYG{n}{exists}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{return} \PYG{p}{\PYGZob{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{ok}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{k+kc}{False}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{motivo}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Imagen no encontrada: }\PYG{l+s+si}{\PYGZob{}}\PYG{n+nb}{str}\PYG{p}{(}\PYG{n}{img\PYGZus{}path}\PYG{p}{)}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{\PYGZcb{}}

    \PYG{n}{img} \PYG{o}{=} \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{imread}\PYG{p}{(}\PYG{n+nb}{str}\PYG{p}{(}\PYG{n}{img\PYGZus{}path}\PYG{p}{)}\PYG{p}{)}
    \PYG{k}{if} \PYG{n}{img} \PYG{o+ow}{is} \PYG{k+kc}{None}\PYG{p}{:}
        \PYG{k}{return} \PYG{p}{\PYGZob{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{ok}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{k+kc}{False}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{motivo}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{No se pudo abrir la imagen: }\PYG{l+s+si}{\PYGZob{}}\PYG{n+nb}{str}\PYG{p}{(}\PYG{n}{img\PYGZus{}path}\PYG{p}{)}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{\PYGZcb{}}

    \PYG{n}{gray} \PYG{o}{=} \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{cvtColor}\PYG{p}{(}\PYG{n}{img}\PYG{p}{,} \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{COLOR\PYGZus{}BGR2GRAY}\PYG{p}{)}
    \PYG{n}{flags} \PYG{o}{=} \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{CALIB\PYGZus{}CB\PYGZus{}ADAPTIVE\PYGZus{}THRESH} \PYG{o}{|} \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{CALIB\PYGZus{}CB\PYGZus{}NORMALIZE\PYGZus{}IMAGE}
    \PYG{n}{found}\PYG{p}{,} \PYG{n}{corners} \PYG{o}{=} \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{findChessboardCorners}\PYG{p}{(}\PYG{n}{gray}\PYG{p}{,} \PYG{p}{(}\PYG{n}{cols\PYGZus{}internal}\PYG{p}{,} \PYG{n}{rows\PYGZus{}internal}\PYG{p}{)}\PYG{p}{,} \PYG{n}{flags}\PYG{p}{)}

    \PYG{n}{vis} \PYG{o}{=} \PYG{n}{img}\PYG{o}{.}\PYG{n}{copy}\PYG{p}{(}\PYG{p}{)}
    \PYG{k}{if} \PYG{o+ow}{not} \PYG{n}{found} \PYG{o+ow}{or} \PYG{n}{corners} \PYG{o+ow}{is} \PYG{k+kc}{None}\PYG{p}{:}
        \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{putText}\PYG{p}{(}\PYG{n}{vis}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Checkerboard NO detectado}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{(}\PYG{l+m+mi}{20}\PYG{p}{,} \PYG{l+m+mi}{40}\PYG{p}{)}\PYG{p}{,}
                    \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{FONT\PYGZus{}HERSHEY\PYGZus{}SIMPLEX}\PYG{p}{,} \PYG{l+m+mf}{1.0}\PYG{p}{,} \PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{255}\PYG{p}{)}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{LINE\PYGZus{}AA}\PYG{p}{)}
        \PYG{n}{out\PYGZus{}path}\PYG{o}{.}\PYG{n}{parent}\PYG{o}{.}\PYG{n}{mkdir}\PYG{p}{(}\PYG{n}{parents}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{,} \PYG{n}{exist\PYGZus{}ok}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{)}
        \PYG{n}{ok} \PYG{o}{=} \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{imwrite}\PYG{p}{(}\PYG{n+nb}{str}\PYG{p}{(}\PYG{n}{out\PYGZus{}path}\PYG{p}{)}\PYG{p}{,} \PYG{n}{vis}\PYG{p}{)}
        \PYG{k}{return} \PYG{p}{\PYGZob{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{ok}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n+nb}{bool}\PYG{p}{(}\PYG{n}{ok}\PYG{p}{)}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{motivo}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{No se detecto el damero; PNG guardado con aviso.}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{out}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n+nb}{str}\PYG{p}{(}\PYG{n}{out\PYGZus{}path}\PYG{p}{)}\PYG{p}{\PYGZcb{}}

    \PYG{n}{criteria} \PYG{o}{=} \PYG{p}{(}\PYG{n}{cv2}\PYG{o}{.}\PYG{n}{TERM\PYGZus{}CRITERIA\PYGZus{}EPS} \PYG{o}{+} \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{TERM\PYGZus{}CRITERIA\PYGZus{}MAX\PYGZus{}ITER}\PYG{p}{,} \PYG{l+m+mi}{50}\PYG{p}{,} \PYG{l+m+mf}{1e\PYGZhy{}4}\PYG{p}{)}
    \PYG{n}{corners} \PYG{o}{=} \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{cornerSubPix}\PYG{p}{(}\PYG{n}{gray}\PYG{p}{,} \PYG{n}{corners}\PYG{p}{,} \PYG{p}{(}\PYG{l+m+mi}{11}\PYG{p}{,} \PYG{l+m+mi}{11}\PYG{p}{)}\PYG{p}{,} \PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{,} \PYG{n}{criteria}\PYG{p}{)}

    \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{drawChessboardCorners}\PYG{p}{(}\PYG{n}{vis}\PYG{p}{,} \PYG{p}{(}\PYG{n}{cols\PYGZus{}internal}\PYG{p}{,} \PYG{n}{rows\PYGZus{}internal}\PYG{p}{)}\PYG{p}{,} \PYG{n}{corners}\PYG{p}{,} \PYG{n}{found}\PYG{p}{)}

    \PYG{k}{if} \PYG{n}{draw\PYGZus{}rect}\PYG{p}{:}
        \PYG{n}{pts} \PYG{o}{=} \PYG{n}{corners}\PYG{o}{.}\PYG{n}{reshape}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{)}
        \PYG{n}{x\PYGZus{}min}\PYG{p}{,} \PYG{n}{y\PYGZus{}min} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{floor}\PYG{p}{(}\PYG{n}{pts}\PYG{o}{.}\PYG{n}{min}\PYG{p}{(}\PYG{n}{axis}\PYG{o}{=}\PYG{l+m+mi}{0}\PYG{p}{)}\PYG{p}{)}\PYG{o}{.}\PYG{n}{astype}\PYG{p}{(}\PYG{n+nb}{int}\PYG{p}{)}
        \PYG{n}{x\PYGZus{}max}\PYG{p}{,} \PYG{n}{y\PYGZus{}max} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{ceil}\PYG{p}{(}\PYG{n}{pts}\PYG{o}{.}\PYG{n}{max}\PYG{p}{(}\PYG{n}{axis}\PYG{o}{=}\PYG{l+m+mi}{0}\PYG{p}{)}\PYG{p}{)}\PYG{o}{.}\PYG{n}{astype}\PYG{p}{(}\PYG{n+nb}{int}\PYG{p}{)}
        \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{rectangle}\PYG{p}{(}\PYG{n}{vis}\PYG{p}{,} \PYG{p}{(}\PYG{n}{x\PYGZus{}min}\PYG{p}{,} \PYG{n}{y\PYGZus{}min}\PYG{p}{)}\PYG{p}{,} \PYG{p}{(}\PYG{n}{x\PYGZus{}max}\PYG{p}{,} \PYG{n}{y\PYGZus{}max}\PYG{p}{)}\PYG{p}{,} \PYG{p}{(}\PYG{l+m+mi}{255}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{)}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{)}

    \PYG{n}{y0} \PYG{o}{=} \PYG{l+m+mi}{30}
    \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{putText}\PYG{p}{(}\PYG{n}{vis}\PYG{p}{,} \PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Damero }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{cols\PYGZus{}internal}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{x}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{rows\PYGZus{}internal}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{ (intersecciones)}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{(}\PYG{l+m+mi}{20}\PYG{p}{,} \PYG{n}{y0}\PYG{p}{)}\PYG{p}{,}
                \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{FONT\PYGZus{}HERSHEY\PYGZus{}SIMPLEX}\PYG{p}{,} \PYG{l+m+mf}{0.8}\PYG{p}{,} \PYG{p}{(}\PYG{l+m+mi}{50}\PYG{p}{,} \PYG{l+m+mi}{220}\PYG{p}{,} \PYG{l+m+mi}{50}\PYG{p}{)}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{LINE\PYGZus{}AA}\PYG{p}{)}
    \PYG{n}{y0} \PYG{o}{+}\PYG{o}{=} \PYG{l+m+mi}{30}
    \PYG{k}{if} \PYG{n}{mm\PYGZus{}per\PYGZus{}px} \PYG{o+ow}{is} \PYG{o+ow}{not} \PYG{k+kc}{None}\PYG{p}{:}
        \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{putText}\PYG{p}{(}\PYG{n}{vis}\PYG{p}{,} \PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Escala: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{mm\PYGZus{}per\PYGZus{}px}\PYG{l+s+si}{:}\PYG{l+s+s2}{.6f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{ mm/px}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{(}\PYG{l+m+mi}{20}\PYG{p}{,} \PYG{n}{y0}\PYG{p}{)}\PYG{p}{,}
                    \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{FONT\PYGZus{}HERSHEY\PYGZus{}SIMPLEX}\PYG{p}{,} \PYG{l+m+mf}{0.8}\PYG{p}{,} \PYG{p}{(}\PYG{l+m+mi}{50}\PYG{p}{,} \PYG{l+m+mi}{220}\PYG{p}{,} \PYG{l+m+mi}{50}\PYG{p}{)}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{LINE\PYGZus{}AA}\PYG{p}{)}
        \PYG{n}{y0} \PYG{o}{+}\PYG{o}{=} \PYG{l+m+mi}{30}
    \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{putText}\PYG{p}{(}\PYG{n}{vis}\PYG{p}{,} \PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Timestamp: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{datetime}\PYG{o}{.}\PYG{n}{now}\PYG{p}{(}\PYG{p}{)}\PYG{o}{.}\PYG{n}{isoformat}\PYG{p}{(}\PYG{n}{timespec}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{seconds}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{(}\PYG{l+m+mi}{20}\PYG{p}{,} \PYG{n}{y0}\PYG{p}{)}\PYG{p}{,}
                \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{FONT\PYGZus{}HERSHEY\PYGZus{}SIMPLEX}\PYG{p}{,} \PYG{l+m+mf}{0.7}\PYG{p}{,} \PYG{p}{(}\PYG{l+m+mi}{200}\PYG{p}{,} \PYG{l+m+mi}{200}\PYG{p}{,} \PYG{l+m+mi}{200}\PYG{p}{)}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{LINE\PYGZus{}AA}\PYG{p}{)}

    \PYG{n}{out\PYGZus{}path}\PYG{o}{.}\PYG{n}{parent}\PYG{o}{.}\PYG{n}{mkdir}\PYG{p}{(}\PYG{n}{parents}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{,} \PYG{n}{exist\PYGZus{}ok}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{)}
    \PYG{n}{ok} \PYG{o}{=} \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{imwrite}\PYG{p}{(}\PYG{n+nb}{str}\PYG{p}{(}\PYG{n}{out\PYGZus{}path}\PYG{p}{)}\PYG{p}{,} \PYG{n}{vis}\PYG{p}{)}
    \PYG{k}{return} \PYG{p}{\PYGZob{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{ok}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n+nb}{bool}\PYG{p}{(}\PYG{n}{ok}\PYG{p}{)}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{motivo}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{\PYGZdq{}} \PYG{k}{if} \PYG{n}{ok} \PYG{k}{else} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{cv2.imwrite fallo}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{out}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n+nb}{str}\PYG{p}{(}\PYG{n}{out\PYGZus{}path}\PYG{p}{)}\PYG{p}{\PYGZcb{}}
\end{sphinxVerbatim}

\end{sphinxuseclass}\end{sphinxVerbatimInput}

\end{sphinxuseclass}
\sphinxAtStartPar
El siguiente c√≥digo muestra c√≥mo ejecutar la funci√≥n \sphinxcode{\sphinxupquote{overlay\_checkerboard\_and\_save}}.

\begin{sphinxuseclass}{cell}\begin{sphinxVerbatimInput}

\begin{sphinxuseclass}{cell_input}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{pathlib}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{Path}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{IPython}\PYG{n+nn}{.}\PYG{n+nn}{display}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{Image}\PYG{p}{,} \PYG{n}{display}

\PYG{c+c1}{\PYGZsh{} Lee la escala guardada (mm/px) para anotarla en la imagen}
\PYG{n}{mm\PYGZus{}per\PYGZus{}px\PYGZus{}annot} \PYG{o}{=} \PYG{n}{get\PYGZus{}mm\PYGZus{}per\PYGZus{}px}\PYG{p}{(}\PYG{p}{)}

\PYG{n}{OUT\PYGZus{}PNG} \PYG{o}{=} \PYG{n}{Path}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{./diagnosticos/diagnostico\PYGZus{}calibracion.png}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}

\PYG{n}{overlay\PYGZus{}info} \PYG{o}{=} \PYG{n}{overlay\PYGZus{}checkerboard\PYGZus{}and\PYGZus{}save}\PYG{p}{(}
    \PYG{n}{img\PYGZus{}path}\PYG{o}{=}\PYG{n}{IMG\PYGZus{}PATH}\PYG{p}{,}
    \PYG{n}{out\PYGZus{}path}\PYG{o}{=}\PYG{n}{OUT\PYGZus{}PNG}\PYG{p}{,}
    \PYG{n}{cols\PYGZus{}internal}\PYG{o}{=}\PYG{n}{CHECKERBOARD\PYGZus{}INTERNAL\PYGZus{}COLS}\PYG{p}{,}  \PYG{c+c1}{\PYGZsh{} 9}
    \PYG{n}{rows\PYGZus{}internal}\PYG{o}{=}\PYG{n}{CHECKERBOARD\PYGZus{}INTERNAL\PYGZus{}ROWS}\PYG{p}{,}  \PYG{c+c1}{\PYGZsh{} 9}
    \PYG{n}{mm\PYGZus{}per\PYGZus{}px}\PYG{o}{=}\PYG{n}{mm\PYGZus{}per\PYGZus{}px\PYGZus{}annot}\PYG{p}{,}                 \PYG{c+c1}{\PYGZsh{} se anotar√° \PYGZdq{}Escala: X mm/px\PYGZdq{}}
    \PYG{n}{draw\PYGZus{}rect}\PYG{o}{=}\PYG{k+kc}{True}
\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Mostrar la imagen resultante en el notebook}
\PYG{n}{DISPLAY\PYGZus{}WIDTH} \PYG{o}{=} \PYG{l+m+mi}{800}  \PYG{c+c1}{\PYGZsh{} px}
\PYG{n}{display}\PYG{p}{(}\PYG{n}{Image}\PYG{p}{(}\PYG{n}{filename}\PYG{o}{=}\PYG{n+nb}{str}\PYG{p}{(}\PYG{n}{OUT\PYGZus{}PNG}\PYG{p}{)}\PYG{p}{,} \PYG{n}{embed}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{,} \PYG{n}{width}\PYG{o}{=}\PYG{n}{DISPLAY\PYGZus{}WIDTH}\PYG{p}{)}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} (Opcional) Ver detalles del overlay/guardado}
\PYG{n}{overlay\PYGZus{}info}
\end{sphinxVerbatim}

\end{sphinxuseclass}\end{sphinxVerbatimInput}
\begin{sphinxVerbatimOutput}

\begin{sphinxuseclass}{cell_output}
\noindent\sphinxincludegraphics[width=800\sphinxpxdimen]{{e4932947a5bc7203d0a0677b9fa23dd59aa50735814d15cced69e7bd7d3496f4}.png}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYGZob{}\PYGZsq{}ok\PYGZsq{}: True, \PYGZsq{}motivo\PYGZsq{}: \PYGZsq{}\PYGZsq{}, \PYGZsq{}out\PYGZsq{}: \PYGZsq{}diagnosticos\PYGZbs{}\PYGZbs{}diagnostico\PYGZus{}calibracion.png\PYGZsq{}\PYGZcb{}
\end{sphinxVerbatim}

\end{sphinxuseclass}\end{sphinxVerbatimOutput}

\end{sphinxuseclass}
\sphinxAtStartPar
\sphinxstylestrong{Validaci√≥n num√©rica}

\sphinxAtStartPar
Esta funci√≥n lee la calibraci√≥n existente y estima la incertidumbre seg√∫n la ecuaci√≥n \eqref{equation:content/01/Modulo-2:incertidumbre_calibracion}

\begin{sphinxuseclass}{cell}\begin{sphinxVerbatimInput}

\begin{sphinxuseclass}{cell_input}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{}\PYGZsh{} VALIDACI√ìN NUM√âRICA}

\PYG{c+c1}{\PYGZsh{} Lee la calibraci√≥n y reporta mm/px y px/mm estimado la incertidumbre}

\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{load\PYGZus{}calibration\PYGZus{}dict}\PYG{p}{(}\PYG{n}{path}\PYG{p}{:} \PYG{n}{Path}\PYG{p}{)} \PYG{o}{\PYGZhy{}}\PYG{o}{\PYGZgt{}} \PYG{n+nb}{dict}\PYG{p}{:}
    \PYG{k}{if} \PYG{o+ow}{not} \PYG{n}{path}\PYG{o}{.}\PYG{n}{exists}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{raise} \PYG{n+ne}{FileNotFoundError}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{No existe el archivo de calibraci√≥n: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{path}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    \PYG{k}{with} \PYG{n}{path}\PYG{o}{.}\PYG{n}{open}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{r}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{encoding}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{utf\PYGZhy{}8}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)} \PYG{k}{as} \PYG{n}{f}\PYG{p}{:}
        \PYG{k}{return} \PYG{n}{json}\PYG{o}{.}\PYG{n}{load}\PYG{p}{(}\PYG{n}{f}\PYG{p}{)}

\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{validation\PYGZus{}report}\PYG{p}{(}\PYG{n}{calib\PYGZus{}json}\PYG{p}{:} \PYG{n+nb}{dict}\PYG{p}{,} \PYG{n}{assume\PYGZus{}square\PYGZus{}exact\PYGZus{}mm}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{,} \PYG{n}{square\PYGZus{}sigma\PYGZus{}mm}\PYG{o}{=}\PYG{l+m+mf}{0.0}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Reporta mm/px, px/mm e incertidumbre estimada.}
\PYG{l+s+sd}{    \PYGZhy{} Si conoces la tolerancia del patr√≥n (p.ej. ¬±0.02 mm), usa assume\PYGZus{}square\PYGZus{}exact\PYGZus{}mm=False y square\PYGZus{}sigma\PYGZus{}mm=0.02.}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{n}{mm\PYGZus{}per\PYGZus{}px} \PYG{o}{=} \PYG{n+nb}{float}\PYG{p}{(}\PYG{n}{calib\PYGZus{}json}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{mm\PYGZus{}per\PYGZus{}px}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{p}{)}
    \PYG{n}{px\PYGZus{}per\PYGZus{}mm} \PYG{o}{=} \PYG{l+m+mf}{1.0} \PYG{o}{/} \PYG{n}{mm\PYGZus{}per\PYGZus{}px} \PYG{k}{if} \PYG{n}{mm\PYGZus{}per\PYGZus{}px} \PYG{o}{\PYGZgt{}} \PYG{l+m+mi}{0} \PYG{k}{else} \PYG{n}{np}\PYG{o}{.}\PYG{n}{nan}

    \PYG{n}{diag} \PYG{o}{=} \PYG{n}{calib\PYGZus{}json}\PYG{o}{.}\PYG{n}{get}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{meta}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{\PYGZob{}}\PYG{p}{\PYGZcb{}}\PYG{p}{)}\PYG{o}{.}\PYG{n}{get}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{diagnostics}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{\PYGZob{}}\PYG{p}{\PYGZcb{}}\PYG{p}{)}
    \PYG{n}{pattern} \PYG{o}{=} \PYG{n}{diag}\PYG{o}{.}\PYG{n}{get}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{pattern}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{checkerboard}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    \PYG{n}{px\PYGZus{}sum} \PYG{o}{=} \PYG{n}{diag}\PYG{o}{.}\PYG{n}{get}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{px\PYGZus{}per\PYGZus{}square\PYGZus{}summary}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{\PYGZob{}}\PYG{p}{\PYGZcb{}}\PYG{p}{)}
    \PYG{n}{aggregation} \PYG{o}{=} \PYG{n}{diag}\PYG{o}{.}\PYG{n}{get}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{aggregation}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{median}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    \PYG{n}{square\PYGZus{}mm} \PYG{o}{=} \PYG{n+nb}{float}\PYG{p}{(}\PYG{n}{diag}\PYG{o}{.}\PYG{n}{get}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{square\PYGZus{}mm}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{np}\PYG{o}{.}\PYG{n}{nan}\PYG{p}{)}\PYG{p}{)}

    \PYG{n}{center\PYGZus{}px} \PYG{o}{=} \PYG{n}{px\PYGZus{}sum}\PYG{o}{.}\PYG{n}{get}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{median}\PYG{l+s+s2}{\PYGZdq{}} \PYG{k}{if} \PYG{n}{aggregation} \PYG{o}{==} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{median}\PYG{l+s+s2}{\PYGZdq{}} \PYG{k}{else} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{mean}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{k+kc}{None}\PYG{p}{)}
    \PYG{n}{std\PYGZus{}px} \PYG{o}{=} \PYG{n}{px\PYGZus{}sum}\PYG{o}{.}\PYG{n}{get}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{std}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{k+kc}{None}\PYG{p}{)}
    \PYG{n}{n\PYGZus{}edges} \PYG{o}{=} \PYG{n}{diag}\PYG{o}{.}\PYG{n}{get}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{edges\PYGZus{}count}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{k+kc}{None}\PYG{p}{)}

    \PYG{n}{sigma\PYGZus{}s} \PYG{o}{=} \PYG{k+kc}{None}
    \PYG{n}{ci95} \PYG{o}{=} \PYG{p}{(}\PYG{k+kc}{None}\PYG{p}{,} \PYG{k+kc}{None}\PYG{p}{)}
    \PYG{n}{details} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{p}{\PYGZcb{}}

    \PYG{k}{if} \PYG{n}{center\PYGZus{}px} \PYG{o+ow}{and} \PYG{n}{std\PYGZus{}px} \PYG{o+ow}{is} \PYG{o+ow}{not} \PYG{k+kc}{None} \PYG{o+ow}{and} \PYG{n}{center\PYGZus{}px} \PYG{o}{\PYGZgt{}} \PYG{l+m+mi}{0}\PYG{p}{:}
        \PYG{n}{sigma\PYGZus{}square} \PYG{o}{=} \PYG{l+m+mf}{0.0} \PYG{k}{if} \PYG{n}{assume\PYGZus{}square\PYGZus{}exact\PYGZus{}mm} \PYG{k}{else} \PYG{n+nb}{float}\PYG{p}{(}\PYG{n}{square\PYGZus{}sigma\PYGZus{}mm}\PYG{p}{)}

        \PYG{c+c1}{\PYGZsh{} Error est√°ndar del estimador: media vs mediana}
        \PYG{k}{if} \PYG{n}{n\PYGZus{}edges} \PYG{o+ow}{and} \PYG{n}{n\PYGZus{}edges} \PYG{o}{\PYGZgt{}} \PYG{l+m+mi}{1}\PYG{p}{:}
            \PYG{k}{if} \PYG{n}{aggregation} \PYG{o}{==} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{mean}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:}
                \PYG{n}{se\PYGZus{}px} \PYG{o}{=} \PYG{n}{std\PYGZus{}px} \PYG{o}{/} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sqrt}\PYG{p}{(}\PYG{n}{n\PYGZus{}edges}\PYG{p}{)}
            \PYG{k}{else}\PYG{p}{:}
                \PYG{n}{se\PYGZus{}px} \PYG{o}{=} \PYG{l+m+mf}{1.253} \PYG{o}{*} \PYG{n}{std\PYGZus{}px} \PYG{o}{/} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sqrt}\PYG{p}{(}\PYG{n}{n\PYGZus{}edges}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} aprox. SE de la mediana}
        \PYG{k}{else}\PYG{p}{:}
            \PYG{n}{se\PYGZus{}px} \PYG{o}{=} \PYG{n}{std\PYGZus{}px}

        \PYG{c+c1}{\PYGZsh{} Propagaci√≥n de errores (1er orden)}
        \PYG{n}{rel\PYGZus{}sq} \PYG{o}{=} \PYG{p}{(}\PYG{n}{sigma\PYGZus{}square} \PYG{o}{/} \PYG{n}{square\PYGZus{}mm}\PYG{p}{)}\PYG{o}{*}\PYG{o}{*}\PYG{l+m+mi}{2} \PYG{k}{if} \PYG{p}{(}\PYG{n}{square\PYGZus{}mm} \PYG{o+ow}{and} \PYG{n}{square\PYGZus{}mm} \PYG{o}{\PYGZgt{}} \PYG{l+m+mi}{0}\PYG{p}{)} \PYG{k}{else} \PYG{l+m+mf}{0.0}
        \PYG{n}{rel\PYGZus{}px} \PYG{o}{=} \PYG{p}{(}\PYG{n}{se\PYGZus{}px} \PYG{o}{/} \PYG{n}{center\PYGZus{}px}\PYG{p}{)}\PYG{o}{*}\PYG{o}{*}\PYG{l+m+mi}{2}
        \PYG{n}{rel\PYGZus{}s}  \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sqrt}\PYG{p}{(}\PYG{n}{rel\PYGZus{}sq} \PYG{o}{+} \PYG{n}{rel\PYGZus{}px}\PYG{p}{)}

        \PYG{n}{sigma\PYGZus{}s} \PYG{o}{=} \PYG{n}{rel\PYGZus{}s} \PYG{o}{*} \PYG{n}{mm\PYGZus{}per\PYGZus{}px}
        \PYG{n}{ci95} \PYG{o}{=} \PYG{p}{(}\PYG{n}{mm\PYGZus{}per\PYGZus{}px} \PYG{o}{\PYGZhy{}} \PYG{l+m+mf}{1.96} \PYG{o}{*} \PYG{n}{sigma\PYGZus{}s}\PYG{p}{,} \PYG{n}{mm\PYGZus{}per\PYGZus{}px} \PYG{o}{+} \PYG{l+m+mf}{1.96} \PYG{o}{*} \PYG{n}{sigma\PYGZus{}s}\PYG{p}{)}

        \PYG{n}{details} \PYG{o}{=} \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{center\PYGZus{}px}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{center\PYGZus{}px}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{std\PYGZus{}px\PYGZus{}edges}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{std\PYGZus{}px}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{se\PYGZus{}px\PYGZus{}used}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{se\PYGZus{}px}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{n\PYGZus{}edges}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{n\PYGZus{}edges}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{aggregation}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{aggregation}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{square\PYGZus{}mm}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{square\PYGZus{}mm}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{sigma\PYGZus{}square\PYGZus{}mm}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{sigma\PYGZus{}square}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{rel\PYGZus{}uncertainty\PYGZus{}s}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{rel\PYGZus{}s}
        \PYG{p}{\PYGZcb{}}

    \PYG{k}{return} \PYG{p}{\PYGZob{}}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{mm\PYGZus{}per\PYGZus{}px}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{mm\PYGZus{}per\PYGZus{}px}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{px\PYGZus{}per\PYGZus{}mm}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{px\PYGZus{}per\PYGZus{}mm}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{method}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{calib\PYGZus{}json}\PYG{o}{.}\PYG{n}{get}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{method}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{pattern}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{pattern}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{uncertainty\PYGZus{}sigma\PYGZus{}mm\PYGZus{}per\PYGZus{}px}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{sigma\PYGZus{}s}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{ci95\PYGZus{}mm\PYGZus{}per\PYGZus{}px}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{ci95}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{diagnostics\PYGZus{}available}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{(}\PYG{n}{std\PYGZus{}px} \PYG{o+ow}{is} \PYG{o+ow}{not} \PYG{k+kc}{None}\PYG{p}{)}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{details}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{details}
    \PYG{p}{\PYGZcb{}}
\end{sphinxVerbatim}

\end{sphinxuseclass}\end{sphinxVerbatimInput}

\end{sphinxuseclass}
\begin{sphinxuseclass}{cell}\begin{sphinxVerbatimInput}

\begin{sphinxuseclass}{cell_input}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} === Ejecutar validaci√≥n ===}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Validaci√≥n num√©rica e incertidumbre:}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n}{cal\PYGZus{}data} \PYG{o}{=} \PYG{n}{load\PYGZus{}calibration\PYGZus{}dict}\PYG{p}{(}\PYG{n}{CALIB\PYGZus{}FILE}\PYG{p}{)}
\PYG{n}{report} \PYG{o}{=} \PYG{n}{validation\PYGZus{}report}\PYG{p}{(}\PYG{n}{cal\PYGZus{}data}\PYG{p}{,} \PYG{n}{assume\PYGZus{}square\PYGZus{}exact\PYGZus{}mm}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{,} \PYG{n}{square\PYGZus{}sigma\PYGZus{}mm}\PYG{o}{=}\PYG{l+m+mf}{0.0}\PYG{p}{)}
\PYG{n}{report}
\end{sphinxVerbatim}

\end{sphinxuseclass}\end{sphinxVerbatimInput}
\begin{sphinxVerbatimOutput}

\begin{sphinxuseclass}{cell_output}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
Validaci√≥n num√©rica e incertidumbre:
\end{sphinxVerbatim}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYGZob{}\PYGZsq{}mm\PYGZus{}per\PYGZus{}px\PYGZsq{}: 0.05,
 \PYGZsq{}px\PYGZus{}per\PYGZus{}mm\PYGZsq{}: 20.0,
 \PYGZsq{}method\PYGZsq{}: \PYGZsq{}checkerboard\PYGZsq{},
 \PYGZsq{}pattern\PYGZsq{}: \PYGZsq{}checkerboard\PYGZsq{},
 \PYGZsq{}uncertainty\PYGZus{}sigma\PYGZus{}mm\PYGZus{}per\PYGZus{}px\PYGZsq{}: np.float64(0.0),
 \PYGZsq{}ci95\PYGZus{}mm\PYGZus{}per\PYGZus{}px\PYGZsq{}: (np.float64(0.05), np.float64(0.05)),
 \PYGZsq{}diagnostics\PYGZus{}available\PYGZsq{}: True,
 \PYGZsq{}details\PYGZsq{}: \PYGZob{}\PYGZsq{}center\PYGZus{}px\PYGZsq{}: 200.0,
  \PYGZsq{}std\PYGZus{}px\PYGZus{}edges\PYGZsq{}: 0.0,
  \PYGZsq{}se\PYGZus{}px\PYGZus{}used\PYGZsq{}: np.float64(0.0),
  \PYGZsq{}n\PYGZus{}edges\PYGZsq{}: 144,
  \PYGZsq{}aggregation\PYGZsq{}: \PYGZsq{}median\PYGZsq{},
  \PYGZsq{}square\PYGZus{}mm\PYGZsq{}: 10.0,
  \PYGZsq{}sigma\PYGZus{}square\PYGZus{}mm\PYGZsq{}: 0.0,
  \PYGZsq{}rel\PYGZus{}uncertainty\PYGZus{}s\PYGZsq{}: np.float64(0.0)\PYGZcb{}\PYGZcb{}
\end{sphinxVerbatim}

\end{sphinxuseclass}\end{sphinxVerbatimOutput}

\end{sphinxuseclass}
\sphinxAtStartPar
\sphinxstylestrong{(Re)calibraci√≥n forzada}
El usuario puede querer forzar una nueva calibraci√≥n. La funci√≥n \sphinxcode{\sphinxupquote{recalibrar\_y\_generar\_png()}} fuerza rec√°lculo con el damero y genera un PNG de control visual.

\begin{sphinxuseclass}{cell}\begin{sphinxVerbatimInput}

\begin{sphinxuseclass}{cell_input}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{}\PYGZsh{} UTILIDAD DE RECALIBRACION FORZADA CON .png DE DIAGNOSTICO}

\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{recalibrar\PYGZus{}y\PYGZus{}generar\PYGZus{}png}\PYG{p}{(}
    \PYG{n}{calib\PYGZus{}file}\PYG{p}{:} \PYG{n}{Path}\PYG{p}{,}
    \PYG{n}{img\PYGZus{}path}\PYG{p}{:} \PYG{n}{Path}\PYG{p}{,}
    \PYG{n}{cols\PYGZus{}internal}\PYG{p}{:} \PYG{n+nb}{int}\PYG{p}{,}
    \PYG{n}{rows\PYGZus{}internal}\PYG{p}{:} \PYG{n+nb}{int}\PYG{p}{,}
    \PYG{n}{square\PYGZus{}mm}\PYG{p}{:} \PYG{n+nb}{float}\PYG{p}{,}
    \PYG{n}{aggregation}\PYG{p}{:} \PYG{n+nb}{str} \PYG{o}{=} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{median}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
    \PYG{n}{out\PYGZus{}png}\PYG{p}{:} \PYG{n}{Path} \PYG{o}{=} \PYG{n}{Path}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{./diagnosticos/diagnostico\PYGZus{}calibracion.png}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{timestamp\PYGZus{}bgr}\PYG{p}{:} \PYG{n+nb}{tuple} \PYG{o}{=} \PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{255}\PYG{p}{)}\PYG{p}{,}   \PYG{c+c1}{\PYGZsh{} ROJO en BGR (por defecto)}
    \PYG{n}{box\PYGZus{}bgr}\PYG{p}{:} \PYG{n+nb}{tuple} \PYG{o}{=} \PYG{p}{(}\PYG{l+m+mi}{255}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{)}\PYG{p}{,}         \PYG{c+c1}{\PYGZsh{} Azul para rect√°ngulo envolvente}
    \PYG{n}{text\PYGZus{}bgr}\PYG{p}{:} \PYG{n+nb}{tuple} \PYG{o}{=} \PYG{p}{(}\PYG{l+m+mi}{50}\PYG{p}{,} \PYG{l+m+mi}{220}\PYG{p}{,} \PYG{l+m+mi}{50}\PYG{p}{)}       \PYG{c+c1}{\PYGZsh{} Verde para textos informativos}
\PYG{p}{)} \PYG{o}{\PYGZhy{}}\PYG{o}{\PYGZgt{}} \PYG{n+nb}{dict}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Fuerza la recalibraci√≥n usando el damero de \PYGZsq{}img\PYGZus{}path\PYGZsq{} y genera un PNG de diagn√≥stico.}
\PYG{l+s+sd}{    \PYGZhy{} Dibuja esquinas detectadas, rect√°ngulo envolvente y anota mm/px.}
\PYG{l+s+sd}{    \PYGZhy{} Pinta el timestamp en ROJO (BGR=(0,0,255) por defecto).}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Par√°metros}
\PYG{l+s+sd}{    \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{l+s+sd}{    calib\PYGZus{}file : Path}
\PYG{l+s+sd}{        Ruta del JSON donde se guardar√° la calibraci√≥n (mm/px, meta).}
\PYG{l+s+sd}{    img\PYGZus{}path : Path}
\PYG{l+s+sd}{        Ruta de la imagen del damero (10x10 ‚Üí 9x9 intersecciones internas).}
\PYG{l+s+sd}{    cols\PYGZus{}internal, rows\PYGZus{}internal : int}
\PYG{l+s+sd}{        Intersecciones internas del damero (p.ej., 9x9 para 10x10 cuadrados).}
\PYG{l+s+sd}{    square\PYGZus{}mm : float}
\PYG{l+s+sd}{        Tama√±o f√≠sico del lado de cada cuadrado (mm), p.ej. 10.0.}
\PYG{l+s+sd}{    aggregation : \PYGZob{}\PYGZdq{}median\PYGZdq{},\PYGZdq{}mean\PYGZdq{}\PYGZcb{}}
\PYG{l+s+sd}{        Agregaci√≥n para estimar px por cuadrado (robusta por defecto: \PYGZdq{}median\PYGZdq{}).}
\PYG{l+s+sd}{    out\PYGZus{}png : Path}
\PYG{l+s+sd}{        Ruta de salida del PNG de diagn√≥stico.}
\PYG{l+s+sd}{    timestamp\PYGZus{}bgr : tuple}
\PYG{l+s+sd}{        Color BGR para el timestamp (rojo por defecto).}
\PYG{l+s+sd}{    box\PYGZus{}bgr : tuple}
\PYG{l+s+sd}{        Color BGR del rect√°ngulo envolvente (azul por defecto).}
\PYG{l+s+sd}{    text\PYGZus{}bgr : tuple}
\PYG{l+s+sd}{        Color BGR para textos informativos (verde por defecto).}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{    Returns}
\PYG{l+s+sd}{    \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{l+s+sd}{    dict con claves:}
\PYG{l+s+sd}{      \PYGZhy{} \PYGZdq{}recal\PYGZdq{}: dict con el resultado de la recalibraci√≥n (estado, mm\PYGZus{}per\PYGZus{}px, meta)}
\PYG{l+s+sd}{      \PYGZhy{} \PYGZdq{}overlay\PYGZdq{}: dict con \PYGZob{}\PYGZdq{}ok\PYGZdq{}: bool, \PYGZdq{}out\PYGZdq{}: str(ruta\PYGZus{}png)\PYGZcb{} (o motivo de fallo)}
\PYG{l+s+sd}{      \PYGZhy{} \PYGZdq{}mm\PYGZus{}per\PYGZus{}px\PYGZdq{}: float o None (si no disponible)}
\PYG{l+s+sd}{      \PYGZhy{} \PYGZdq{}estado\PYGZdq{}: str (e.g., \PYGZdq{}recalibrado\PYGZdq{}, \PYGZdq{}vigente\PYGZdq{}, \PYGZdq{}sin\PYGZus{}escala\PYGZdq{})}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{datetime}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{datetime}

    \PYG{c+c1}{\PYGZsh{} 1) Forzar recalibraci√≥n (usa la funci√≥n del pipeline del notebook)}
    \PYG{n}{recal} \PYG{o}{=} \PYG{n}{run\PYGZus{}calibration\PYGZus{}pipeline\PYGZus{}checkerboard}\PYG{p}{(}
        \PYG{n}{calib\PYGZus{}file}\PYG{o}{=}\PYG{n}{calib\PYGZus{}file}\PYG{p}{,}
        \PYG{n}{img\PYGZus{}path}\PYG{o}{=}\PYG{n}{img\PYGZus{}path}\PYG{p}{,}
        \PYG{n}{cols\PYGZus{}internal}\PYG{o}{=}\PYG{n}{cols\PYGZus{}internal}\PYG{p}{,}
        \PYG{n}{rows\PYGZus{}internal}\PYG{o}{=}\PYG{n}{rows\PYGZus{}internal}\PYG{p}{,}
        \PYG{n}{square\PYGZus{}mm}\PYG{o}{=}\PYG{n}{square\PYGZus{}mm}\PYG{p}{,}
        \PYG{n}{aggregation}\PYG{o}{=}\PYG{n}{aggregation}\PYG{p}{,}
        \PYG{n}{force\PYGZus{}recalibrate}\PYG{o}{=}\PYG{k+kc}{True}
    \PYG{p}{)}

    \PYG{c+c1}{\PYGZsh{} 2) Preparar overlay (detectar de nuevo para dibujar) con TIMESTAMP ROJO}
    \PYG{k}{if} \PYG{o+ow}{not} \PYG{n}{img\PYGZus{}path}\PYG{o}{.}\PYG{n}{exists}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{return} \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{recal}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{recal}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{overlay}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{ok}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{k+kc}{False}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{motivo}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Imagen no encontrada: }\PYG{l+s+si}{\PYGZob{}}\PYG{n+nb}{str}\PYG{p}{(}\PYG{n}{img\PYGZus{}path}\PYG{p}{)}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{\PYGZcb{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{mm\PYGZus{}per\PYGZus{}px}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n+nb}{float}\PYG{p}{(}\PYG{n}{recal}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{mm\PYGZus{}per\PYGZus{}px}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{p}{)} \PYG{k}{if} \PYG{n+nb}{isinstance}\PYG{p}{(}\PYG{n}{recal}\PYG{p}{,} \PYG{n+nb}{dict}\PYG{p}{)} \PYG{o+ow}{and} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{mm\PYGZus{}per\PYGZus{}px}\PYG{l+s+s2}{\PYGZdq{}} \PYG{o+ow}{in} \PYG{n}{recal} \PYG{k}{else} \PYG{k+kc}{None}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{estado}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{recal}\PYG{o}{.}\PYG{n}{get}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{estado}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)} \PYG{k}{if} \PYG{n+nb}{isinstance}\PYG{p}{(}\PYG{n}{recal}\PYG{p}{,} \PYG{n+nb}{dict}\PYG{p}{)} \PYG{k}{else} \PYG{k+kc}{None}
        \PYG{p}{\PYGZcb{}}

    \PYG{n}{img} \PYG{o}{=} \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{imread}\PYG{p}{(}\PYG{n+nb}{str}\PYG{p}{(}\PYG{n}{img\PYGZus{}path}\PYG{p}{)}\PYG{p}{)}
    \PYG{k}{if} \PYG{n}{img} \PYG{o+ow}{is} \PYG{k+kc}{None}\PYG{p}{:}
        \PYG{k}{return} \PYG{p}{\PYGZob{}}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{recal}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{recal}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{overlay}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{ok}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{k+kc}{False}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{motivo}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{No se pudo abrir la imagen: }\PYG{l+s+si}{\PYGZob{}}\PYG{n+nb}{str}\PYG{p}{(}\PYG{n}{img\PYGZus{}path}\PYG{p}{)}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{\PYGZcb{}}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{mm\PYGZus{}per\PYGZus{}px}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n+nb}{float}\PYG{p}{(}\PYG{n}{recal}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{mm\PYGZus{}per\PYGZus{}px}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{p}{)} \PYG{k}{if} \PYG{n+nb}{isinstance}\PYG{p}{(}\PYG{n}{recal}\PYG{p}{,} \PYG{n+nb}{dict}\PYG{p}{)} \PYG{o+ow}{and} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{mm\PYGZus{}per\PYGZus{}px}\PYG{l+s+s2}{\PYGZdq{}} \PYG{o+ow}{in} \PYG{n}{recal} \PYG{k}{else} \PYG{k+kc}{None}\PYG{p}{,}
            \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{estado}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{recal}\PYG{o}{.}\PYG{n}{get}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{estado}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)} \PYG{k}{if} \PYG{n+nb}{isinstance}\PYG{p}{(}\PYG{n}{recal}\PYG{p}{,} \PYG{n+nb}{dict}\PYG{p}{)} \PYG{k}{else} \PYG{k+kc}{None}
        \PYG{p}{\PYGZcb{}}

    \PYG{n}{gray} \PYG{o}{=} \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{cvtColor}\PYG{p}{(}\PYG{n}{img}\PYG{p}{,} \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{COLOR\PYGZus{}BGR2GRAY}\PYG{p}{)}
    \PYG{n}{flags} \PYG{o}{=} \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{CALIB\PYGZus{}CB\PYGZus{}ADAPTIVE\PYGZus{}THRESH} \PYG{o}{|} \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{CALIB\PYGZus{}CB\PYGZus{}NORMALIZE\PYGZus{}IMAGE}
    \PYG{n}{found}\PYG{p}{,} \PYG{n}{corners} \PYG{o}{=} \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{findChessboardCorners}\PYG{p}{(}\PYG{n}{gray}\PYG{p}{,} \PYG{p}{(}\PYG{n}{cols\PYGZus{}internal}\PYG{p}{,} \PYG{n}{rows\PYGZus{}internal}\PYG{p}{)}\PYG{p}{,} \PYG{n}{flags}\PYG{p}{)}

    \PYG{n}{vis} \PYG{o}{=} \PYG{n}{img}\PYG{o}{.}\PYG{n}{copy}\PYG{p}{(}\PYG{p}{)}
    \PYG{k}{if} \PYG{o+ow}{not} \PYG{n}{found} \PYG{o+ow}{or} \PYG{n}{corners} \PYG{o+ow}{is} \PYG{k+kc}{None}\PYG{p}{:}
        \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{putText}\PYG{p}{(}
            \PYG{n}{vis}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Checkerboard NO detectado}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{(}\PYG{l+m+mi}{20}\PYG{p}{,} \PYG{l+m+mi}{40}\PYG{p}{)}\PYG{p}{,}
            \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{FONT\PYGZus{}HERSHEY\PYGZus{}SIMPLEX}\PYG{p}{,} \PYG{l+m+mf}{1.0}\PYG{p}{,} \PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{255}\PYG{p}{)}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{LINE\PYGZus{}AA}
        \PYG{p}{)}
        \PYG{c+c1}{\PYGZsh{} timestamp en rojo aunque no haya detecci√≥n}
        \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{putText}\PYG{p}{(}
            \PYG{n}{vis}\PYG{p}{,} \PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Timestamp: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{datetime}\PYG{o}{.}\PYG{n}{now}\PYG{p}{(}\PYG{p}{)}\PYG{o}{.}\PYG{n}{isoformat}\PYG{p}{(}\PYG{n}{timespec}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{seconds}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{(}\PYG{l+m+mi}{20}\PYG{p}{,} \PYG{l+m+mi}{80}\PYG{p}{)}\PYG{p}{,}
            \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{FONT\PYGZus{}HERSHEY\PYGZus{}SIMPLEX}\PYG{p}{,} \PYG{l+m+mf}{0.7}\PYG{p}{,} \PYG{n}{timestamp\PYGZus{}bgr}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{LINE\PYGZus{}AA}
        \PYG{p}{)}
    \PYG{k}{else}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Refinar esquinas y dibujarlas}
        \PYG{n}{criteria} \PYG{o}{=} \PYG{p}{(}\PYG{n}{cv2}\PYG{o}{.}\PYG{n}{TERM\PYGZus{}CRITERIA\PYGZus{}EPS} \PYG{o}{+} \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{TERM\PYGZus{}CRITERIA\PYGZus{}MAX\PYGZus{}ITER}\PYG{p}{,} \PYG{l+m+mi}{50}\PYG{p}{,} \PYG{l+m+mf}{1e\PYGZhy{}4}\PYG{p}{)}
        \PYG{n}{corners} \PYG{o}{=} \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{cornerSubPix}\PYG{p}{(}\PYG{n}{gray}\PYG{p}{,} \PYG{n}{corners}\PYG{p}{,} \PYG{p}{(}\PYG{l+m+mi}{11}\PYG{p}{,} \PYG{l+m+mi}{11}\PYG{p}{)}\PYG{p}{,} \PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{,} \PYG{n}{criteria}\PYG{p}{)}
        \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{drawChessboardCorners}\PYG{p}{(}\PYG{n}{vis}\PYG{p}{,} \PYG{p}{(}\PYG{n}{cols\PYGZus{}internal}\PYG{p}{,} \PYG{n}{rows\PYGZus{}internal}\PYG{p}{)}\PYG{p}{,} \PYG{n}{corners}\PYG{p}{,} \PYG{n}{found}\PYG{p}{)}

        \PYG{c+c1}{\PYGZsh{} Rect√°ngulo envolvente}
        \PYG{n}{pts} \PYG{o}{=} \PYG{n}{corners}\PYG{o}{.}\PYG{n}{reshape}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{)}
        \PYG{n}{x\PYGZus{}min}\PYG{p}{,} \PYG{n}{y\PYGZus{}min} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{floor}\PYG{p}{(}\PYG{n}{pts}\PYG{o}{.}\PYG{n}{min}\PYG{p}{(}\PYG{n}{axis}\PYG{o}{=}\PYG{l+m+mi}{0}\PYG{p}{)}\PYG{p}{)}\PYG{o}{.}\PYG{n}{astype}\PYG{p}{(}\PYG{n+nb}{int}\PYG{p}{)}
        \PYG{n}{x\PYGZus{}max}\PYG{p}{,} \PYG{n}{y\PYGZus{}max} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{ceil}\PYG{p}{(}\PYG{n}{pts}\PYG{o}{.}\PYG{n}{max}\PYG{p}{(}\PYG{n}{axis}\PYG{o}{=}\PYG{l+m+mi}{0}\PYG{p}{)}\PYG{p}{)}\PYG{o}{.}\PYG{n}{astype}\PYG{p}{(}\PYG{n+nb}{int}\PYG{p}{)}
        \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{rectangle}\PYG{p}{(}\PYG{n}{vis}\PYG{p}{,} \PYG{p}{(}\PYG{n}{x\PYGZus{}min}\PYG{p}{,} \PYG{n}{y\PYGZus{}min}\PYG{p}{)}\PYG{p}{,} \PYG{p}{(}\PYG{n}{x\PYGZus{}max}\PYG{p}{,} \PYG{n}{y\PYGZus{}max}\PYG{p}{)}\PYG{p}{,} \PYG{n}{box\PYGZus{}bgr}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{)}

        \PYG{c+c1}{\PYGZsh{} Textos informativos (verde por defecto)}
        \PYG{n}{y0} \PYG{o}{=} \PYG{l+m+mi}{30}
        \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{putText}\PYG{p}{(}
            \PYG{n}{vis}\PYG{p}{,} \PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Damero }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{cols\PYGZus{}internal}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{x}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{rows\PYGZus{}internal}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{ (intersecciones)}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{(}\PYG{l+m+mi}{20}\PYG{p}{,} \PYG{n}{y0}\PYG{p}{)}\PYG{p}{,}
            \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{FONT\PYGZus{}HERSHEY\PYGZus{}SIMPLEX}\PYG{p}{,} \PYG{l+m+mf}{0.8}\PYG{p}{,} \PYG{n}{text\PYGZus{}bgr}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{LINE\PYGZus{}AA}
        \PYG{p}{)}
        \PYG{n}{y0} \PYG{o}{+}\PYG{o}{=} \PYG{l+m+mi}{30}
        \PYG{n}{mmpp} \PYG{o}{=} \PYG{n+nb}{float}\PYG{p}{(}\PYG{n}{recal}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{mm\PYGZus{}per\PYGZus{}px}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{p}{)} \PYG{k}{if} \PYG{n+nb}{isinstance}\PYG{p}{(}\PYG{n}{recal}\PYG{p}{,} \PYG{n+nb}{dict}\PYG{p}{)} \PYG{o+ow}{and} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{mm\PYGZus{}per\PYGZus{}px}\PYG{l+s+s2}{\PYGZdq{}} \PYG{o+ow}{in} \PYG{n}{recal} \PYG{k}{else} \PYG{k+kc}{None}
        \PYG{k}{if} \PYG{n}{mmpp} \PYG{o+ow}{is} \PYG{o+ow}{not} \PYG{k+kc}{None}\PYG{p}{:}
            \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{putText}\PYG{p}{(}
                \PYG{n}{vis}\PYG{p}{,} \PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Escala: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{mmpp}\PYG{l+s+si}{:}\PYG{l+s+s2}{.6f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{ mm/px}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{(}\PYG{l+m+mi}{20}\PYG{p}{,} \PYG{n}{y0}\PYG{p}{)}\PYG{p}{,}
                \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{FONT\PYGZus{}HERSHEY\PYGZus{}SIMPLEX}\PYG{p}{,} \PYG{l+m+mf}{0.8}\PYG{p}{,} \PYG{n}{text\PYGZus{}bgr}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{LINE\PYGZus{}AA}
            \PYG{p}{)}
            \PYG{n}{y0} \PYG{o}{+}\PYG{o}{=} \PYG{l+m+mi}{30}

        \PYG{c+c1}{\PYGZsh{} TIMESTAMP en ROJO}
        \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{putText}\PYG{p}{(}
            \PYG{n}{vis}\PYG{p}{,} \PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Timestamp: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{datetime}\PYG{o}{.}\PYG{n}{now}\PYG{p}{(}\PYG{p}{)}\PYG{o}{.}\PYG{n}{isoformat}\PYG{p}{(}\PYG{n}{timespec}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{seconds}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{(}\PYG{l+m+mi}{20}\PYG{p}{,} \PYG{n}{y0}\PYG{p}{)}\PYG{p}{,}
            \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{FONT\PYGZus{}HERSHEY\PYGZus{}SIMPLEX}\PYG{p}{,} \PYG{l+m+mf}{0.7}\PYG{p}{,} \PYG{n}{timestamp\PYGZus{}bgr}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{LINE\PYGZus{}AA}
        \PYG{p}{)}

    \PYG{c+c1}{\PYGZsh{} 3) Guardar PNG}
    \PYG{n}{out\PYGZus{}png}\PYG{o}{.}\PYG{n}{parent}\PYG{o}{.}\PYG{n}{mkdir}\PYG{p}{(}\PYG{n}{parents}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{,} \PYG{n}{exist\PYGZus{}ok}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{)}
    \PYG{n}{ok} \PYG{o}{=} \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{imwrite}\PYG{p}{(}\PYG{n+nb}{str}\PYG{p}{(}\PYG{n}{out\PYGZus{}png}\PYG{p}{)}\PYG{p}{,} \PYG{n}{vis}\PYG{p}{)}

    \PYG{k}{return} \PYG{p}{\PYGZob{}}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{recal}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{recal}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{overlay}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{ok}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n+nb}{bool}\PYG{p}{(}\PYG{n}{ok}\PYG{p}{)}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{out}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n+nb}{str}\PYG{p}{(}\PYG{n}{out\PYGZus{}png}\PYG{p}{)} \PYG{k}{if} \PYG{n}{ok} \PYG{k}{else} \PYG{k+kc}{None}\PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{mm\PYGZus{}per\PYGZus{}px}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n+nb}{float}\PYG{p}{(}\PYG{n}{recal}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{mm\PYGZus{}per\PYGZus{}px}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{p}{)} \PYG{k}{if} \PYG{n+nb}{isinstance}\PYG{p}{(}\PYG{n}{recal}\PYG{p}{,} \PYG{n+nb}{dict}\PYG{p}{)} \PYG{o+ow}{and} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{mm\PYGZus{}per\PYGZus{}px}\PYG{l+s+s2}{\PYGZdq{}} \PYG{o+ow}{in} \PYG{n}{recal} \PYG{k}{else} \PYG{k+kc}{None}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{estado}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{recal}\PYG{o}{.}\PYG{n}{get}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{estado}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)} \PYG{k}{if} \PYG{n+nb}{isinstance}\PYG{p}{(}\PYG{n}{recal}\PYG{p}{,} \PYG{n+nb}{dict}\PYG{p}{)} \PYG{k}{else} \PYG{k+kc}{None}
    \PYG{p}{\PYGZcb{}}
\end{sphinxVerbatim}

\end{sphinxuseclass}\end{sphinxVerbatimInput}

\end{sphinxuseclass}
\sphinxAtStartPar
Un ejemplo de uso de esta funci√≥n de recalibrado forzado ser√≠a:

\begin{sphinxuseclass}{cell}\begin{sphinxVerbatimInput}

\begin{sphinxuseclass}{cell_input}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{OUT\PYGZus{}PNG} \PYG{o}{=} \PYG{n}{Path}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{./diagnosticos/recalibrado.png}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n}{res} \PYG{o}{=} \PYG{n}{recalibrar\PYGZus{}y\PYGZus{}generar\PYGZus{}png}\PYG{p}{(}
    \PYG{n}{calib\PYGZus{}file}\PYG{o}{=}\PYG{n}{CALIB\PYGZus{}FILE}\PYG{p}{,}
    \PYG{n}{img\PYGZus{}path}\PYG{o}{=}\PYG{n}{IMG\PYGZus{}PATH}\PYG{p}{,}
    \PYG{n}{cols\PYGZus{}internal}\PYG{o}{=}\PYG{n}{CHECKERBOARD\PYGZus{}INTERNAL\PYGZus{}COLS}\PYG{p}{,}
    \PYG{n}{rows\PYGZus{}internal}\PYG{o}{=}\PYG{n}{CHECKERBOARD\PYGZus{}INTERNAL\PYGZus{}ROWS}\PYG{p}{,}
    \PYG{n}{square\PYGZus{}mm}\PYG{o}{=}\PYG{n}{CHECKERBOARD\PYGZus{}SQUARE\PYGZus{}MM}\PYG{p}{,}
    \PYG{n}{aggregation}\PYG{o}{=}\PYG{n}{AGGREGATION}\PYG{p}{,}
    \PYG{n}{out\PYGZus{}png}\PYG{o}{=}\PYG{n}{OUT\PYGZus{}PNG}
\PYG{p}{)}

\PYG{n}{res}

\PYG{c+c1}{\PYGZsh{} Visualizaci√≥n del .png de (re)calibrado}
\PYG{n}{DISPLAY\PYGZus{}WIDTH} \PYG{o}{=} \PYG{l+m+mi}{800}  \PYG{c+c1}{\PYGZsh{} px}
\PYG{n}{display}\PYG{p}{(}\PYG{n}{Image}\PYG{p}{(}\PYG{n}{filename}\PYG{o}{=}\PYG{n+nb}{str}\PYG{p}{(}\PYG{n}{OUT\PYGZus{}PNG}\PYG{p}{)}\PYG{p}{,} \PYG{n}{embed}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{,} \PYG{n}{width}\PYG{o}{=}\PYG{n}{DISPLAY\PYGZus{}WIDTH}\PYG{p}{)}\PYG{p}{)}
\end{sphinxVerbatim}

\end{sphinxuseclass}\end{sphinxVerbatimInput}
\begin{sphinxVerbatimOutput}

\begin{sphinxuseclass}{cell_output}
\noindent\sphinxincludegraphics[width=800\sphinxpxdimen]{{e9eeb1de0a4605fa31fafa9fa1aef09bbf312616aaa9c03ed22fe7e55e629e11}.png}

\end{sphinxuseclass}\end{sphinxVerbatimOutput}

\end{sphinxuseclass}
\sphinxstepscope


\section{M3 \sphinxhyphen{} Imagen}
\label{\detokenize{content/01/Modulo-3:m3-imagen}}\label{\detokenize{content/01/Modulo-3::doc}}
\sphinxAtStartPar
Este m√≥dulo es el n√∫cleo del sistema de visi√≥n artificial. Operativamente est√° compuesto por cuatro bloques funcionales que siguen el flujo recogido en la siguiente imagen:

\begin{figure}[htbp]
\centering
\capstart

\noindent\sphinxincludegraphics[width=0.250\linewidth]{{Modulo-3}.png}
\caption{Bloques funcionales del m√≥dulo de imagen (visi√≥n artificial)}\label{\detokenize{content/01/Modulo-3:figura-wp1-imagen-6}}\end{figure}

\sphinxAtStartPar
El motor de este m√≥dulo se sustenta sobre el algoritmo GrabCut. GrabCut es un m√©todo semiautom√°tico para segmentar objetos en una imagen, es decir, para separar una regi√≥n de inter√©s del resto de la escena. Fue propuesto en 2004 por Rother, Kolmogorov y Blake {[}\sphinxhref{https://doi.org/10.1145/1015706.1015720}{Rother et al., 2004}{]}, y se ha convertido en una herramienta cl√°sica en visi√≥n por computadora debido a su equilibrio entre precisi√≥n y facilidad de uso.

\sphinxAtStartPar
En su planteamiento original, el algoritmo necesita una peque√±a intervenci√≥n del usuario para trazar un rect√°ngulo que contenga aproximadamente el objeto que se desea extraer. A partir de ah√≠, GrabCut trabaja de forma iterativa para refinar la segmentaci√≥n sin necesidad de m√°s entradas, aunque tambi√©n permite correcciones manuales si es necesario.

\sphinxAtStartPar
Matem√°ticamente, GrabCut modela los colores del objeto (primer plano o foreground) y del entorno (fondo o background) mediante modelos de mezcla gaussiana (GMM, por sus siglas en ingl√©s){[}\sphinxhref{https://doi.org/10.1007/978-1-4615-7566-5}{Bishop, 2006}{]}. Estos modelos permiten representar distribuciones complejas de color como la combinaci√≥n de varias campanas gaussianas, cada una capturando un tono o textura caracter√≠stica. As√≠, en lugar de asumir que todos los p√≠xeles del objeto tienen el mismo color, el GMM reconoce que pueden existir m√∫ltiples modos (o grupos) de colores dentro de la misma regi√≥n.

\sphinxAtStartPar
Adem√°s del color, GrabCut tambi√©n considera la estructura espacial de la imagen: p√≠xeles cercanos tienden a pertenecer a la misma clase. Esta idea se modela mediante un campo aleatorio de Markov (MRF), que penaliza soluciones en las que p√≠xeles vecinos tienen etiquetas muy diferentes sin una justificaci√≥n clara en los datos (por ejemplo, un cambio brusco de color). De esta forma, se evitan segmentaciones irregulares o con ruido {[}\sphinxhref{https://doi.org/10.1007/978-1-84882-437-9}{Li, 2009}{]}.

\sphinxAtStartPar
Todo esto se combina en una funci√≥n de energ√≠a que mide lo ‚Äúbuena‚Äù que es una segmentaci√≥n propuesta. Minimizar esta energ√≠a equivale a encontrar la m√°scara que mejor explica los colores observados (usando los GMMs) y que, al mismo tiempo, sea espacialmente coherente (gracias al MRF).

\sphinxAtStartPar
En el contexto de FLATCLASS este algoritmo se ha adaptado para no contar con intervenci√≥n humana inicial. Para aislar el objeto de inter√©s (lenguado) se ha usado una cinta transportadora de color azul, cuyo tono var√≠a ligeramente debido a iluminaci√≥n escasa, no homog√©nea, sombras, presencia de gotas de agua o textura del material. Dado que el objeto y el fondo tienen colores claramente distintos, y a√∫n asumiendo que el fondo no es uniforme, se puede indicar al algoritmo que el fondo es predominantemente azul y que el objeto (lenguado) ocupa aproximadamente el centro de la imagen.

\begin{figure}[htbp]
\centering
\capstart

\noindent\sphinxincludegraphics[width=0.500\linewidth]{{P22C-ML_0_calibrated}.png}
\caption{Imagen real de lenguado obtenida con el sistema de captura}\label{\detokenize{content/01/Modulo-3:figura-wp1-imagen-7}}\end{figure}

\sphinxAtStartPar
Para mejorar la detecci√≥n, el \sphinxstyleemphasis{pipeline} acorta el √°rea de exploraci√≥n al rect√°ngulo que engloba la cinta y el pez, definiendo de forma autom√°tica la regi√≥n de inter√©s (ROI). Para ello se usa detecci√≥n crom√°tica robusta de la cinta azul y en un an√°lisis perfilado por columnas que localiza el tramo contiguo donde la cobertura del color azul es dominante a lo largo de toda la altura de la imagen. Primero, el prefiltrado (NLMeans + bilateral + CLAHE) estabiliza ruido e iluminaci√≥n para que el tono azul sea m√°s estable espectralmente (el bilateral preserva bordes {[}\sphinxhref{https://www.academia.edu/103435418/Bilateral\_filtering\_for\_gray\_and\_color\_images}{Tomasi et al., 1998}{]}. A continuaci√≥n, en espacio HSV se estima de forma adaptativa el intervalo crom√°tico del azul calculando el pico del histograma del matiz (H) en una banda central y con saturaci√≥n alta (S) ‚Äîestrategia inspirada en histogramas de color para indexaci√≥n/segmentaci√≥n‚Äî, lo que compensa variaciones de c√°mara e iluminaci√≥n. Con ese umbral din√°mico se genera una m√°scara binaria ‚Äúazul‚Äù; sobre ella, para cada columna \(j\) se computa la raz√≥n de cobertura azul \(r_j=\dfrac{1}{H} \sum^H_{y=1} {blue(y,j)}\). Se marcan como ‚Äúcinta‚Äù las columnas con \(r_j \geq \tau\) y se elige el tramo cont√≠guo m√°s largo \([x_1,x_2]\) de columnas que cumplen el criterio. Esto elimina de forma natural las columnas met√°licas laterales correspondientes al soporte de la c√°mara (fotograf√≠a ), que o bien tienen \(r_j\) bajo o aparecen como tramos cortos no contiguos.

\sphinxAtStartPar
En vertical se repite el razonamiento sobre filas dentro de \([x_1,x_2]\) para obtener \([y_1,y_2]\). El ROI final es el rect√°ngulo acolchado \(R=(x,y,w,h)\) que engloba \([x_1,x_2] \times [y_1,y_2]\). Esta determinaci√≥n geom√©trica evita depender de cierres morfol√≥gicos agresivos (que pueden ‚Äúinvadir‚Äù el metal) y se apoya en principios de morfolog√≠a matem√°tica y conectividad {[}\sphinxhref{https://link.springer.com/book/10.1007/978-3-662-05088-0}{Soille, 2003}{]}. La ROI as√≠ calculada se utiliza despu√©s para restringir GrabCut, etiquetando como ‚Äúprobable fondo‚Äù los bordes de la imagen y como ‚Äúprobable primer plano‚Äù la regi√≥n central, al tiempo que se definen en el c√≥digo tonos de azul como semillas reforzadas para GrabCut, garantizando que la segmentaci√≥n psoterior se concentre en el pez y la cinta {[}\sphinxhref{https://doi.org/10.1145/1015706.1015720}{Rother et al., 2004}{]}.

\begin{sphinxuseclass}{cell}\begin{sphinxVerbatimInput}

\begin{sphinxuseclass}{cell_input}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{cv2}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{json}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{numpy}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{np}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{pandas}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{pd}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{pathlib}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{Path}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{matplotlib}\PYG{n+nn}{.}\PYG{n+nn}{pyplot}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{plt}

\PYG{c+c1}{\PYGZsh{} \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{c+c1}{\PYGZsh{} CONFIG}
\PYG{c+c1}{\PYGZsh{} \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{n}{CONFIG} \PYG{o}{=} \PYG{p}{\PYGZob{}}
    \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{img\PYGZus{}path}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{./original.png}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
    \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{out\PYGZus{}prefix}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{./out/sole\PYGZus{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
    \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{pad\PYGZus{}roi}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mi}{12}\PYG{p}{,}

    \PYG{c+c1}{\PYGZsh{} Prefilter}
    \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{nlmeans\PYGZus{}h}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mi}{5}\PYG{p}{,}
    \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{bilateral\PYGZus{}d}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mi}{9}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{bilateral\PYGZus{}sigmaC}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mi}{50}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{bilateral\PYGZus{}sigmaS}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mi}{50}\PYG{p}{,}
    \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{clahe\PYGZus{}clip}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mf}{2.0}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{clahe\PYGZus{}tiles}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{(}\PYG{l+m+mi}{8}\PYG{p}{,} \PYG{l+m+mi}{8}\PYG{p}{)}\PYG{p}{,}

    \PYG{c+c1}{\PYGZsh{} Dynamic blue threshold}
    \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{blue\PYGZus{}sat\PYGZus{}min}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mi}{80}\PYG{p}{,}
    \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{blue\PYGZus{}half\PYGZus{}window}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mi}{15}\PYG{p}{,}

    \PYG{c+c1}{\PYGZsh{} ROI by blue column coverage}
    \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{belt\PYGZus{}col\PYGZus{}cover\PYGZus{}ratio}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mf}{0.22}\PYG{p}{,}
    \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{belt\PYGZus{}min\PYGZus{}width\PYGZus{}px}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mi}{200}\PYG{p}{,}

    \PYG{c+c1}{\PYGZsh{} GrabCut}
    \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{pr\PYGZus{}fg\PYGZus{}kernel}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{(}\PYG{l+m+mi}{7}\PYG{p}{,} \PYG{l+m+mi}{19}\PYG{p}{)}\PYG{p}{,}
    \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{sure\PYGZus{}fg\PYGZus{}pct\PYGZus{}contrast}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mi}{70}\PYG{p}{,}
    \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{sure\PYGZus{}fg\PYGZus{}pct\PYGZus{}dt}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mi}{60}\PYG{p}{,}
    \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{gc\PYGZus{}iters}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mi}{12}\PYG{p}{,}

    \PYG{c+c1}{\PYGZsh{} Guard\PYGZhy{}rails (BG) inside ROI}
    \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{guard\PYGZus{}frac\PYGZus{}w}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mf}{0.03}\PYG{p}{,}
    \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{guard\PYGZus{}min\PYGZus{}px}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mi}{14}\PYG{p}{,}
    \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{guard\PYGZus{}max\PYGZus{}px}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mi}{48}\PYG{p}{,}

    \PYG{c+c1}{\PYGZsh{} Postprocess}
    \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{post\PYGZus{}close\PYGZus{}kernel}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{(}\PYG{l+m+mi}{9}\PYG{p}{,} \PYG{l+m+mi}{13}\PYG{p}{)}\PYG{p}{,}

    \PYG{c+c1}{\PYGZsh{} Candidate filter \PYGZam{} shape prior (STRICT)}
    \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{min\PYGZus{}area\PYGZus{}px2}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mi}{5000}\PYG{p}{,}
    \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{min\PYGZus{}width\PYGZus{}px}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mi}{32}\PYG{p}{,}
    \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{edge\PYGZus{}clear\PYGZus{}px}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mi}{16}\PYG{p}{,}
    \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{shape\PYGZus{}mu\PYGZus{}log\PYGZus{}aspect}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mf}{0.92}\PYG{p}{,}  \PYG{c+c1}{\PYGZsh{} \PYGZti{}aspect 2.5}
    \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{shape\PYGZus{}sigma}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mf}{0.35}\PYG{p}{,}

    \PYG{c+c1}{\PYGZsh{} Relaxed fallback deltas (used if strict fails)}
    \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{relax}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{min\PYGZus{}area\PYGZus{}px2}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mi}{1500}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{min\PYGZus{}width\PYGZus{}px}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mi}{14}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{edge\PYGZus{}clear\PYGZus{}px}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mi}{6}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{shape\PYGZus{}sigma}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mf}{0.70}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{allow\PYGZus{}touch\PYGZus{}edges}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{k+kc}{True}
    \PYG{p}{\PYGZcb{}}\PYG{p}{,}

    \PYG{c+c1}{\PYGZsh{} Optional metric scale}
    \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{scale\PYGZus{}json}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{./calibracion\PYGZus{}px\PYGZus{}mm.json}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}

    \PYG{c+c1}{\PYGZsh{} \PYGZhy{}\PYGZhy{}\PYGZhy{} switches \PYGZhy{}\PYGZhy{}\PYGZhy{}}
    \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{debug}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{k+kc}{True}\PYG{p}{,}     \PYG{c+c1}{\PYGZsh{} PNGs on/off}
    \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{save\PYGZus{}csv}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{k+kc}{True}    \PYG{c+c1}{\PYGZsh{} CSV on/off}
\PYG{p}{\PYGZcb{}}

\PYG{c+c1}{\PYGZsh{} \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{c+c1}{\PYGZsh{} Utilities}
\PYG{c+c1}{\PYGZsh{} \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{\PYGZus{}dbg}\PYG{p}{(}\PYG{p}{)} \PYG{o}{\PYGZhy{}}\PYG{o}{\PYGZgt{}} \PYG{n+nb}{bool}\PYG{p}{:}
    \PYG{k}{return} \PYG{n+nb}{bool}\PYG{p}{(}\PYG{n}{CONFIG}\PYG{o}{.}\PYG{n}{get}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{debug}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{k+kc}{False}\PYG{p}{)}\PYG{p}{)}

\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{\PYGZus{}ensure\PYGZus{}dir}\PYG{p}{(}\PYG{n}{path}\PYG{p}{:} \PYG{n+nb}{str}\PYG{p}{)}\PYG{p}{:}
    \PYG{n}{Path}\PYG{p}{(}\PYG{n}{path}\PYG{p}{)}\PYG{o}{.}\PYG{n}{parent}\PYG{o}{.}\PYG{n}{mkdir}\PYG{p}{(}\PYG{n}{parents}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{,} \PYG{n}{exist\PYGZus{}ok}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{)}

\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{save\PYGZus{}img}\PYG{p}{(}\PYG{n}{name}\PYG{p}{:} \PYG{n+nb}{str}\PYG{p}{,} \PYG{n}{img}\PYG{p}{)} \PYG{o}{\PYGZhy{}}\PYG{o}{\PYGZgt{}} \PYG{n+nb}{str}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Unconditional file save (internal).\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{n}{p} \PYG{o}{=} \PYG{n}{CONFIG}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{out\PYGZus{}prefix}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]} \PYG{o}{+} \PYG{n}{name}
    \PYG{n}{\PYGZus{}ensure\PYGZus{}dir}\PYG{p}{(}\PYG{n}{p}\PYG{p}{)}
    \PYG{k}{if} \PYG{n}{img}\PYG{o}{.}\PYG{n}{ndim} \PYG{o}{==} \PYG{l+m+mi}{2}\PYG{p}{:}
        \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{imwrite}\PYG{p}{(}\PYG{n}{p}\PYG{p}{,} \PYG{n}{img}\PYG{p}{)}
    \PYG{k}{else}\PYG{p}{:}
        \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{imwrite}\PYG{p}{(}\PYG{n}{p}\PYG{p}{,} \PYG{n}{img} \PYG{k}{if} \PYG{n}{img}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]} \PYG{o}{==} \PYG{l+m+mi}{3} \PYG{k}{else} \PYG{n}{img}\PYG{p}{[}\PYG{o}{.}\PYG{o}{.}\PYG{o}{.}\PYG{p}{,} \PYG{p}{:}\PYG{l+m+mi}{3}\PYG{p}{]}\PYG{p}{)}
    \PYG{k}{return} \PYG{n}{p}

\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{save\PYGZus{}img\PYGZus{}dbg}\PYG{p}{(}\PYG{n}{name}\PYG{p}{:} \PYG{n+nb}{str}\PYG{p}{,} \PYG{n}{img}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Save only if CONFIG[\PYGZsq{}debug\PYGZsq{}] is True; otherwise return None.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{k}{if} \PYG{o+ow}{not} \PYG{n}{\PYGZus{}dbg}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{return} \PYG{k+kc}{None}
    \PYG{k}{return} \PYG{n}{save\PYGZus{}img}\PYG{p}{(}\PYG{n}{name}\PYG{p}{,} \PYG{n}{img}\PYG{p}{)}

\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{save\PYGZus{}csv\PYGZus{}dbg}\PYG{p}{(}\PYG{n}{df}\PYG{p}{:} \PYG{n}{pd}\PYG{o}{.}\PYG{n}{DataFrame}\PYG{p}{,} \PYG{n}{name}\PYG{p}{:} \PYG{n+nb}{str}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Save CSV only if CONFIG[\PYGZsq{}save\PYGZus{}csv\PYGZsq{}] is True; returns path or None.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{k}{if} \PYG{o+ow}{not} \PYG{n}{CONFIG}\PYG{o}{.}\PYG{n}{get}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{save\PYGZus{}csv}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{k+kc}{False}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{return} \PYG{k+kc}{None}
    \PYG{n}{out\PYGZus{}path} \PYG{o}{=} \PYG{n}{CONFIG}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{out\PYGZus{}prefix}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]} \PYG{o}{+} \PYG{n}{name}
    \PYG{n}{\PYGZus{}ensure\PYGZus{}dir}\PYG{p}{(}\PYG{n}{out\PYGZus{}path}\PYG{p}{)}
    \PYG{n}{df}\PYG{o}{.}\PYG{n}{to\PYGZus{}csv}\PYG{p}{(}\PYG{n}{out\PYGZus{}path}\PYG{p}{,} \PYG{n}{index}\PYG{o}{=}\PYG{k+kc}{False}\PYG{p}{)}
    \PYG{k}{return} \PYG{n}{out\PYGZus{}path}

\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{get\PYGZus{}scale\PYGZus{}mm\PYGZus{}per\PYGZus{}px}\PYG{p}{(}\PYG{p}{)} \PYG{o}{\PYGZhy{}}\PYG{o}{\PYGZgt{}} \PYG{n+nb}{float} \PYG{o}{|} \PYG{k+kc}{None}\PYG{p}{:}
    \PYG{k}{try}\PYG{p}{:}
        \PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{get\PYGZus{}mm\PYGZus{}per\PYGZus{}px}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{get\PYGZus{}mm\PYGZus{}per\PYGZus{}px}  \PYG{c+c1}{\PYGZsh{} type: ignore}
        \PYG{n}{val} \PYG{o}{=} \PYG{n+nb}{float}\PYG{p}{(}\PYG{n}{get\PYGZus{}mm\PYGZus{}per\PYGZus{}px}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}
        \PYG{k}{if} \PYG{n}{val} \PYG{o}{\PYGZgt{}} \PYG{l+m+mi}{0}\PYG{p}{:}
            \PYG{k}{return} \PYG{n}{val}
    \PYG{k}{except} \PYG{n+ne}{Exception}\PYG{p}{:}
        \PYG{k}{pass}
    \PYG{n}{p} \PYG{o}{=} \PYG{n}{Path}\PYG{p}{(}\PYG{n}{CONFIG}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{scale\PYGZus{}json}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{p}{)}
    \PYG{k}{if} \PYG{n}{p}\PYG{o}{.}\PYG{n}{exists}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{try}\PYG{p}{:}
            \PYG{n}{data} \PYG{o}{=} \PYG{n}{json}\PYG{o}{.}\PYG{n}{loads}\PYG{p}{(}\PYG{n}{p}\PYG{o}{.}\PYG{n}{read\PYGZus{}text}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}
            \PYG{n}{val} \PYG{o}{=} \PYG{n+nb}{float}\PYG{p}{(}\PYG{n}{data}\PYG{o}{.}\PYG{n}{get}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{mm\PYGZus{}per\PYGZus{}px}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{)}\PYG{p}{)}
            \PYG{k}{if} \PYG{n}{val} \PYG{o}{\PYGZgt{}} \PYG{l+m+mi}{0}\PYG{p}{:}
                \PYG{k}{return} \PYG{n}{val}
        \PYG{k}{except} \PYG{n+ne}{Exception}\PYG{p}{:}
            \PYG{k}{pass}
    \PYG{k}{return} \PYG{k+kc}{None}

\PYG{c+c1}{\PYGZsh{} \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{} Morphology helpers to avoid kernel errors \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{\PYGZus{}morph}\PYG{p}{(}\PYG{n}{img}\PYG{p}{:} \PYG{n}{np}\PYG{o}{.}\PYG{n}{ndarray}\PYG{p}{,} \PYG{n}{op}\PYG{p}{:} \PYG{n+nb}{int}\PYG{p}{,} \PYG{n}{shape}\PYG{p}{:} \PYG{n+nb}{int}\PYG{p}{,} \PYG{n}{ksize}\PYG{p}{:} \PYG{n+nb}{tuple}\PYG{p}{[}\PYG{n+nb}{int}\PYG{p}{,}\PYG{n+nb}{int}\PYG{p}{]}\PYG{p}{,} \PYG{n}{iters}\PYG{p}{:} \PYG{n+nb}{int} \PYG{o}{=} \PYG{l+m+mi}{1}\PYG{p}{)} \PYG{o}{\PYGZhy{}}\PYG{o}{\PYGZgt{}} \PYG{n}{np}\PYG{o}{.}\PYG{n}{ndarray}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Robust wrapper for cv2.morphologyEx:}
\PYG{l+s+sd}{    \PYGZhy{} Ensures uint8 input}
\PYG{l+s+sd}{    \PYGZhy{} Always builds a valid kernel}
\PYG{l+s+sd}{    \PYGZhy{} Uses positional args for compatibility}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{k}{if} \PYG{n}{img}\PYG{o}{.}\PYG{n}{dtype} \PYG{o}{!=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{uint8}\PYG{p}{:}
        \PYG{k}{if} \PYG{n}{img}\PYG{o}{.}\PYG{n}{dtype} \PYG{o}{==} \PYG{n+nb}{bool}\PYG{p}{:}
            \PYG{n}{img} \PYG{o}{=} \PYG{n}{img}\PYG{o}{.}\PYG{n}{astype}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{uint8}\PYG{p}{)} \PYG{o}{*} \PYG{l+m+mi}{255}
        \PYG{k}{else}\PYG{p}{:}
            \PYG{n}{img} \PYG{o}{=} \PYG{n}{img}\PYG{o}{.}\PYG{n}{astype}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{uint8}\PYG{p}{)}
    \PYG{n}{k} \PYG{o}{=} \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{getStructuringElement}\PYG{p}{(}\PYG{n}{shape}\PYG{p}{,} \PYG{p}{(}\PYG{n+nb}{int}\PYG{p}{(}\PYG{n}{ksize}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{)}\PYG{p}{,} \PYG{n+nb}{int}\PYG{p}{(}\PYG{n}{ksize}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)}\PYG{p}{)}\PYG{p}{)}
    \PYG{k}{return} \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{morphologyEx}\PYG{p}{(}\PYG{n}{img}\PYG{p}{,} \PYG{n}{op}\PYG{p}{,} \PYG{n}{k}\PYG{p}{,} \PYG{k+kc}{None}\PYG{p}{,} \PYG{k+kc}{None}\PYG{p}{,} \PYG{n+nb}{int}\PYG{p}{(}\PYG{n}{iters}\PYG{p}{)}\PYG{p}{,} \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{BORDER\PYGZus{}CONSTANT}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{)}

\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{\PYGZus{}open}\PYG{p}{(}\PYG{n}{img}\PYG{p}{:} \PYG{n}{np}\PYG{o}{.}\PYG{n}{ndarray}\PYG{p}{,} \PYG{n}{shape}\PYG{p}{:} \PYG{n+nb}{int}\PYG{p}{,} \PYG{n}{ksize}\PYG{p}{:} \PYG{n+nb}{tuple}\PYG{p}{[}\PYG{n+nb}{int}\PYG{p}{,}\PYG{n+nb}{int}\PYG{p}{]}\PYG{p}{,} \PYG{n}{iters}\PYG{p}{:} \PYG{n+nb}{int} \PYG{o}{=} \PYG{l+m+mi}{1}\PYG{p}{)} \PYG{o}{\PYGZhy{}}\PYG{o}{\PYGZgt{}} \PYG{n}{np}\PYG{o}{.}\PYG{n}{ndarray}\PYG{p}{:}
    \PYG{k}{return} \PYG{n}{\PYGZus{}morph}\PYG{p}{(}\PYG{n}{img}\PYG{p}{,} \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{MORPH\PYGZus{}OPEN}\PYG{p}{,} \PYG{n}{shape}\PYG{p}{,} \PYG{n}{ksize}\PYG{p}{,} \PYG{n}{iters}\PYG{p}{)}

\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{\PYGZus{}close}\PYG{p}{(}\PYG{n}{img}\PYG{p}{:} \PYG{n}{np}\PYG{o}{.}\PYG{n}{ndarray}\PYG{p}{,} \PYG{n}{shape}\PYG{p}{:} \PYG{n+nb}{int}\PYG{p}{,} \PYG{n}{ksize}\PYG{p}{:} \PYG{n+nb}{tuple}\PYG{p}{[}\PYG{n+nb}{int}\PYG{p}{,}\PYG{n+nb}{int}\PYG{p}{]}\PYG{p}{,} \PYG{n}{iters}\PYG{p}{:} \PYG{n+nb}{int} \PYG{o}{=} \PYG{l+m+mi}{1}\PYG{p}{)} \PYG{o}{\PYGZhy{}}\PYG{o}{\PYGZgt{}} \PYG{n}{np}\PYG{o}{.}\PYG{n}{ndarray}\PYG{p}{:}
    \PYG{k}{return} \PYG{n}{\PYGZus{}morph}\PYG{p}{(}\PYG{n}{img}\PYG{p}{,} \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{MORPH\PYGZus{}CLOSE}\PYG{p}{,} \PYG{n}{shape}\PYG{p}{,} \PYG{n}{ksize}\PYG{p}{,} \PYG{n}{iters}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{c+c1}{\PYGZsh{} Pipeline blocks}
\PYG{c+c1}{\PYGZsh{} \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{prefilter}\PYG{p}{(}\PYG{n}{bgr}\PYG{p}{:} \PYG{n}{np}\PYG{o}{.}\PYG{n}{ndarray}\PYG{p}{)} \PYG{o}{\PYGZhy{}}\PYG{o}{\PYGZgt{}} \PYG{n}{np}\PYG{o}{.}\PYG{n}{ndarray}\PYG{p}{:}
    \PYG{n}{den} \PYG{o}{=} \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{fastNlMeansDenoisingColored}\PYG{p}{(}
        \PYG{n}{bgr}\PYG{p}{,} \PYG{k+kc}{None}\PYG{p}{,} \PYG{n}{h}\PYG{o}{=}\PYG{n}{CONFIG}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{nlmeans\PYGZus{}h}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{p}{,} \PYG{n}{hColor}\PYG{o}{=}\PYG{n}{CONFIG}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{nlmeans\PYGZus{}h}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{p}{,}
        \PYG{n}{templateWindowSize}\PYG{o}{=}\PYG{l+m+mi}{7}\PYG{p}{,} \PYG{n}{searchWindowSize}\PYG{o}{=}\PYG{l+m+mi}{21}
    \PYG{p}{)}
    \PYG{n}{den} \PYG{o}{=} \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{bilateralFilter}\PYG{p}{(}
        \PYG{n}{den}\PYG{p}{,} \PYG{n}{d}\PYG{o}{=}\PYG{n}{CONFIG}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{bilateral\PYGZus{}d}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{p}{,}
        \PYG{n}{sigmaColor}\PYG{o}{=}\PYG{n}{CONFIG}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{bilateral\PYGZus{}sigmaC}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{p}{,} \PYG{n}{sigmaSpace}\PYG{o}{=}\PYG{n}{CONFIG}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{bilateral\PYGZus{}sigmaS}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}
    \PYG{p}{)}
    \PYG{n}{hsv} \PYG{o}{=} \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{cvtColor}\PYG{p}{(}\PYG{n}{den}\PYG{p}{,} \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{COLOR\PYGZus{}BGR2HSV}\PYG{p}{)}
    \PYG{n}{h}\PYG{p}{,} \PYG{n}{s}\PYG{p}{,} \PYG{n}{v} \PYG{o}{=} \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{split}\PYG{p}{(}\PYG{n}{hsv}\PYG{p}{)}
    \PYG{n}{clahe} \PYG{o}{=} \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{createCLAHE}\PYG{p}{(}\PYG{n}{CONFIG}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{clahe\PYGZus{}clip}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{p}{,} \PYG{n}{CONFIG}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{clahe\PYGZus{}tiles}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{p}{)}
    \PYG{n}{v} \PYG{o}{=} \PYG{n}{clahe}\PYG{o}{.}\PYG{n}{apply}\PYG{p}{(}\PYG{n}{v}\PYG{p}{)}
    \PYG{n}{out} \PYG{o}{=} \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{cvtColor}\PYG{p}{(}\PYG{n}{cv2}\PYG{o}{.}\PYG{n}{merge}\PYG{p}{(}\PYG{p}{[}\PYG{n}{h}\PYG{p}{,} \PYG{n}{s}\PYG{p}{,} \PYG{n}{v}\PYG{p}{]}\PYG{p}{)}\PYG{p}{,} \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{COLOR\PYGZus{}HSV2BGR}\PYG{p}{)}
    \PYG{n}{save\PYGZus{}img\PYGZus{}dbg}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{01\PYGZus{}prefilter.png}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{out}\PYG{p}{)}
    \PYG{k}{return} \PYG{n}{out}

\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{dynamic\PYGZus{}blue\PYGZus{}threshold}\PYG{p}{(}\PYG{n}{hsv}\PYG{p}{:} \PYG{n}{np}\PYG{o}{.}\PYG{n}{ndarray}\PYG{p}{)}\PYG{p}{:}
    \PYG{n}{H}\PYG{p}{,} \PYG{n}{S}\PYG{p}{,} \PYG{n}{\PYGZus{}} \PYG{o}{=} \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{split}\PYG{p}{(}\PYG{n}{hsv}\PYG{p}{)}
    \PYG{n}{Hh}\PYG{p}{,} \PYG{n}{Wh} \PYG{o}{=} \PYG{n}{H}\PYG{o}{.}\PYG{n}{shape}
    \PYG{n}{x1}\PYG{p}{,} \PYG{n}{x2} \PYG{o}{=} \PYG{n+nb}{int}\PYG{p}{(}\PYG{n}{Wh} \PYG{o}{*} \PYG{l+m+mf}{0.32}\PYG{p}{)}\PYG{p}{,} \PYG{n+nb}{int}\PYG{p}{(}\PYG{n}{Wh} \PYG{o}{*} \PYG{l+m+mf}{0.68}\PYG{p}{)}
    \PYG{n}{band} \PYG{o}{=} \PYG{n}{H}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{n}{x1}\PYG{p}{:}\PYG{n}{x2}\PYG{p}{]}\PYG{p}{;} \PYG{n}{band\PYGZus{}s} \PYG{o}{=} \PYG{n}{S}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{n}{x1}\PYG{p}{:}\PYG{n}{x2}\PYG{p}{]}
    \PYG{n}{mask\PYGZus{}sat} \PYG{o}{=} \PYG{n}{band\PYGZus{}s} \PYG{o}{\PYGZgt{}} \PYG{n}{CONFIG}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{blue\PYGZus{}sat\PYGZus{}min}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}
    \PYG{n}{hh} \PYG{o}{=} \PYG{n}{band}\PYG{p}{[}\PYG{n}{mask\PYGZus{}sat}\PYG{p}{]}\PYG{o}{.}\PYG{n}{flatten}\PYG{p}{(}\PYG{p}{)}
    \PYG{k}{if} \PYG{n}{hh}\PYG{o}{.}\PYG{n}{size} \PYG{o}{==} \PYG{l+m+mi}{0}\PYG{p}{:}
        \PYG{n}{lower} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{p}{[}\PYG{l+m+mi}{95}\PYG{p}{,} \PYG{l+m+mi}{100}\PYG{p}{,} \PYG{l+m+mi}{30}\PYG{p}{]}\PYG{p}{,} \PYG{n}{np}\PYG{o}{.}\PYG{n}{uint8}\PYG{p}{)}
        \PYG{n}{upper} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{p}{[}\PYG{l+m+mi}{125}\PYG{p}{,} \PYG{l+m+mi}{255}\PYG{p}{,} \PYG{l+m+mi}{255}\PYG{p}{]}\PYG{p}{,} \PYG{n}{np}\PYG{o}{.}\PYG{n}{uint8}\PYG{p}{)}
    \PYG{k}{else}\PYG{p}{:}
        \PYG{n}{hist} \PYG{o}{=} \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{calcHist}\PYG{p}{(}\PYG{p}{[}\PYG{n}{hh}\PYG{o}{.}\PYG{n}{astype}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{uint8}\PYG{p}{)}\PYG{p}{]}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,} \PYG{k+kc}{None}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{180}\PYG{p}{]}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{180}\PYG{p}{]}\PYG{p}{)}\PYG{o}{.}\PYG{n}{flatten}\PYG{p}{(}\PYG{p}{)}
        \PYG{n}{peak} \PYG{o}{=} \PYG{n+nb}{int}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{argmax}\PYG{p}{(}\PYG{n}{hist}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;} \PYG{n}{hw} \PYG{o}{=} \PYG{n}{CONFIG}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{blue\PYGZus{}half\PYGZus{}window}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}
        \PYG{n}{lower} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{p}{[}\PYG{n+nb}{max}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{peak} \PYG{o}{\PYGZhy{}} \PYG{n}{hw}\PYG{p}{)}\PYG{p}{,} \PYG{l+m+mi}{80}\PYG{p}{,} \PYG{l+m+mi}{30}\PYG{p}{]}\PYG{p}{,} \PYG{n}{np}\PYG{o}{.}\PYG{n}{uint8}\PYG{p}{)}
        \PYG{n}{upper} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{p}{[}\PYG{n+nb}{min}\PYG{p}{(}\PYG{l+m+mi}{179}\PYG{p}{,} \PYG{n}{peak} \PYG{o}{+} \PYG{n}{hw}\PYG{p}{)}\PYG{p}{,} \PYG{l+m+mi}{255}\PYG{p}{,} \PYG{l+m+mi}{255}\PYG{p}{]}\PYG{p}{,} \PYG{n}{np}\PYG{o}{.}\PYG{n}{uint8}\PYG{p}{)}
    \PYG{k}{return} \PYG{n}{lower}\PYG{p}{,} \PYG{n}{upper}

\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{\PYGZus{}longest\PYGZus{}true\PYGZus{}run}\PYG{p}{(}\PYG{n}{vec\PYGZus{}bool}\PYG{p}{:} \PYG{n}{np}\PYG{o}{.}\PYG{n}{ndarray}\PYG{p}{)}\PYG{p}{:}
    \PYG{n}{best\PYGZus{}i} \PYG{o}{=} \PYG{n}{best\PYGZus{}j} \PYG{o}{=} \PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{;} \PYG{n}{cur\PYGZus{}i} \PYG{o}{=} \PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}
    \PYG{k}{for} \PYG{n}{k}\PYG{p}{,} \PYG{n}{v} \PYG{o+ow}{in} \PYG{n+nb}{enumerate}\PYG{p}{(}\PYG{n}{vec\PYGZus{}bool}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{if} \PYG{n}{v}\PYG{p}{:}
            \PYG{k}{if} \PYG{n}{cur\PYGZus{}i} \PYG{o}{\PYGZlt{}} \PYG{l+m+mi}{0}\PYG{p}{:} \PYG{n}{cur\PYGZus{}i} \PYG{o}{=} \PYG{n}{k}
        \PYG{k}{else}\PYG{p}{:}
            \PYG{k}{if} \PYG{n}{cur\PYGZus{}i} \PYG{o}{\PYGZgt{}}\PYG{o}{=} \PYG{l+m+mi}{0}\PYG{p}{:}
                \PYG{k}{if} \PYG{n}{best\PYGZus{}i} \PYG{o}{\PYGZlt{}} \PYG{l+m+mi}{0} \PYG{o+ow}{or} \PYG{p}{(}\PYG{n}{k}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1} \PYG{o}{\PYGZhy{}} \PYG{n}{cur\PYGZus{}i}\PYG{p}{)} \PYG{o}{\PYGZgt{}} \PYG{p}{(}\PYG{n}{best\PYGZus{}j} \PYG{o}{\PYGZhy{}} \PYG{n}{best\PYGZus{}i}\PYG{p}{)}\PYG{p}{:}
                    \PYG{n}{best\PYGZus{}i}\PYG{p}{,} \PYG{n}{best\PYGZus{}j} \PYG{o}{=} \PYG{n}{cur\PYGZus{}i}\PYG{p}{,} \PYG{n}{k}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}
                \PYG{n}{cur\PYGZus{}i} \PYG{o}{=} \PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}
    \PYG{k}{if} \PYG{n}{cur\PYGZus{}i} \PYG{o}{\PYGZgt{}}\PYG{o}{=} \PYG{l+m+mi}{0}\PYG{p}{:}
        \PYG{n}{k} \PYG{o}{=} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{vec\PYGZus{}bool}\PYG{p}{)}
        \PYG{k}{if} \PYG{n}{best\PYGZus{}i} \PYG{o}{\PYGZlt{}} \PYG{l+m+mi}{0} \PYG{o+ow}{or} \PYG{p}{(}\PYG{n}{k}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1} \PYG{o}{\PYGZhy{}} \PYG{n}{cur\PYGZus{}i}\PYG{p}{)} \PYG{o}{\PYGZgt{}} \PYG{p}{(}\PYG{n}{best\PYGZus{}j} \PYG{o}{\PYGZhy{}} \PYG{n}{best\PYGZus{}i}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{best\PYGZus{}i}\PYG{p}{,} \PYG{n}{best\PYGZus{}j} \PYG{o}{=} \PYG{n}{cur\PYGZus{}i}\PYG{p}{,} \PYG{n}{k}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}
    \PYG{k}{return} \PYG{k+kc}{None} \PYG{k}{if} \PYG{n}{best\PYGZus{}i} \PYG{o}{\PYGZlt{}} \PYG{l+m+mi}{0} \PYG{k}{else} \PYG{p}{(}\PYG{n}{best\PYGZus{}i}\PYG{p}{,} \PYG{n}{best\PYGZus{}j}\PYG{p}{)}

\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{belt\PYGZus{}roi\PYGZus{}from\PYGZus{}blue}\PYG{p}{(}\PYG{n}{hsv}\PYG{p}{:} \PYG{n}{np}\PYG{o}{.}\PYG{n}{ndarray}\PYG{p}{,} \PYG{n}{lower}\PYG{p}{:} \PYG{n}{np}\PYG{o}{.}\PYG{n}{ndarray}\PYG{p}{,} \PYG{n}{upper}\PYG{p}{:} \PYG{n}{np}\PYG{o}{.}\PYG{n}{ndarray}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    ROI = rect√°ngulo sobre la cinta:}
\PYG{l+s+sd}{    \PYGZhy{} Umbral HSV ‚Üí m√°scara azul}
\PYG{l+s+sd}{    \PYGZhy{} Cobertura azul por columna y tramo contiguo m√°s largo}
\PYG{l+s+sd}{    \PYGZhy{} Rango vertical por filas en ese tramo}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{n}{H}\PYG{p}{,} \PYG{n}{W} \PYG{o}{=} \PYG{n}{hsv}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{[}\PYG{p}{:}\PYG{l+m+mi}{2}\PYG{p}{]}
    \PYG{n}{blue\PYGZus{}raw} \PYG{o}{=} \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{inRange}\PYG{p}{(}\PYG{n}{hsv}\PYG{p}{,} \PYG{n}{lower}\PYG{p}{,} \PYG{n}{upper}\PYG{p}{)}\PYG{o}{.}\PYG{n}{astype}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{uint8}\PYG{p}{)}
    \PYG{n}{blue} \PYG{o}{=} \PYG{n}{\PYGZus{}open}\PYG{p}{(}\PYG{n}{blue\PYGZus{}raw}\PYG{p}{,} \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{MORPH\PYGZus{}RECT}\PYG{p}{,} \PYG{p}{(}\PYG{l+m+mi}{3}\PYG{p}{,} \PYG{l+m+mi}{3}\PYG{p}{)}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}
    \PYG{n}{blue} \PYG{o}{=} \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{medianBlur}\PYG{p}{(}\PYG{n}{blue}\PYG{p}{,} \PYG{l+m+mi}{3}\PYG{p}{)}

    \PYG{n}{col\PYGZus{}counts} \PYG{o}{=} \PYG{p}{(}\PYG{n}{blue} \PYG{o}{\PYGZgt{}} \PYG{l+m+mi}{0}\PYG{p}{)}\PYG{o}{.}\PYG{n}{sum}\PYG{p}{(}\PYG{n}{axis}\PYG{o}{=}\PYG{l+m+mi}{0}\PYG{p}{)}\PYG{o}{.}\PYG{n}{astype}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{int32}\PYG{p}{)}
    \PYG{n}{cover\PYGZus{}ratio} \PYG{o}{=} \PYG{n}{col\PYGZus{}counts} \PYG{o}{/} \PYG{n+nb}{float}\PYG{p}{(}\PYG{n}{H}\PYG{p}{)}
    \PYG{n}{col\PYGZus{}mask} \PYG{o}{=} \PYG{n}{cover\PYGZus{}ratio} \PYG{o}{\PYGZgt{}}\PYG{o}{=} \PYG{n}{CONFIG}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{belt\PYGZus{}col\PYGZus{}cover\PYGZus{}ratio}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}
    \PYG{n}{run} \PYG{o}{=} \PYG{n}{\PYGZus{}longest\PYGZus{}true\PYGZus{}run}\PYG{p}{(}\PYG{n}{col\PYGZus{}mask}\PYG{p}{)}
    \PYG{k}{if} \PYG{n}{run} \PYG{o+ow}{is} \PYG{k+kc}{None}\PYG{p}{:}
        \PYG{k}{raise} \PYG{n+ne}{RuntimeError}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{No se identific√≥ ning√∫n tramo de cinta por cobertura azul.}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    \PYG{n}{x1}\PYG{p}{,} \PYG{n}{x2} \PYG{o}{=} \PYG{n}{run}
    \PYG{k}{if} \PYG{p}{(}\PYG{n}{x2} \PYG{o}{\PYGZhy{}} \PYG{n}{x1} \PYG{o}{+} \PYG{l+m+mi}{1}\PYG{p}{)} \PYG{o}{\PYGZlt{}} \PYG{n}{CONFIG}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{belt\PYGZus{}min\PYGZus{}width\PYGZus{}px}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{p}{:}
        \PYG{n}{relax} \PYG{o}{=} \PYG{n+nb}{max}\PYG{p}{(}\PYG{l+m+mf}{0.02}\PYG{p}{,} \PYG{l+m+mf}{0.5} \PYG{o}{*} \PYG{n}{CONFIG}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{belt\PYGZus{}col\PYGZus{}cover\PYGZus{}ratio}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{p}{)}
        \PYG{n}{col\PYGZus{}mask\PYGZus{}relaxed} \PYG{o}{=} \PYG{n}{cover\PYGZus{}ratio} \PYG{o}{\PYGZgt{}}\PYG{o}{=} \PYG{p}{(}\PYG{n}{CONFIG}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{belt\PYGZus{}col\PYGZus{}cover\PYGZus{}ratio}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]} \PYG{o}{\PYGZhy{}} \PYG{n}{relax}\PYG{p}{)}
        \PYG{n}{run2} \PYG{o}{=} \PYG{n}{\PYGZus{}longest\PYGZus{}true\PYGZus{}run}\PYG{p}{(}\PYG{n}{col\PYGZus{}mask\PYGZus{}relaxed}\PYG{p}{)}
        \PYG{k}{if} \PYG{n}{run2} \PYG{o+ow}{is} \PYG{k+kc}{None} \PYG{o+ow}{or} \PYG{p}{(}\PYG{n}{run2}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]} \PYG{o}{\PYGZhy{}} \PYG{n}{run2}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]} \PYG{o}{+} \PYG{l+m+mi}{1}\PYG{p}{)} \PYG{o}{\PYGZlt{}} \PYG{n}{CONFIG}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{belt\PYGZus{}min\PYGZus{}width\PYGZus{}px}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{p}{:}
            \PYG{k}{raise} \PYG{n+ne}{RuntimeError}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{La anchura estimada de la cinta es demasiado peque√±a.}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
        \PYG{n}{x1}\PYG{p}{,} \PYG{n}{x2} \PYG{o}{=} \PYG{n}{run2}

    \PYG{n}{blue\PYGZus{}slice} \PYG{o}{=} \PYG{n}{blue}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{n}{x1}\PYG{p}{:}\PYG{n}{x2} \PYG{o}{+} \PYG{l+m+mi}{1}\PYG{p}{]}
    \PYG{n}{row\PYGZus{}counts} \PYG{o}{=} \PYG{p}{(}\PYG{n}{blue\PYGZus{}slice} \PYG{o}{\PYGZgt{}} \PYG{l+m+mi}{0}\PYG{p}{)}\PYG{o}{.}\PYG{n}{sum}\PYG{p}{(}\PYG{n}{axis}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{o}{.}\PYG{n}{astype}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{int32}\PYG{p}{)}
    \PYG{n}{row\PYGZus{}mask} \PYG{o}{=} \PYG{n}{row\PYGZus{}counts} \PYG{o}{\PYGZgt{}}\PYG{o}{=} \PYG{n+nb}{max}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n+nb}{int}\PYG{p}{(}\PYG{l+m+mf}{0.02} \PYG{o}{*} \PYG{p}{(}\PYG{n}{x2} \PYG{o}{\PYGZhy{}} \PYG{n}{x1} \PYG{o}{+} \PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{)}\PYG{p}{)}
    \PYG{n}{row\PYGZus{}run} \PYG{o}{=} \PYG{n}{\PYGZus{}longest\PYGZus{}true\PYGZus{}run}\PYG{p}{(}\PYG{n}{row\PYGZus{}mask}\PYG{p}{)}
    \PYG{n}{y1}\PYG{p}{,} \PYG{n}{y2} \PYG{o}{=} \PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{H} \PYG{o}{\PYGZhy{}} \PYG{l+m+mi}{1}\PYG{p}{)} \PYG{k}{if} \PYG{n}{row\PYGZus{}run} \PYG{o+ow}{is} \PYG{k+kc}{None} \PYG{k}{else} \PYG{n}{row\PYGZus{}run}

    \PYG{n}{pad} \PYG{o}{=} \PYG{n}{CONFIG}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{pad\PYGZus{}roi}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}
    \PYG{n}{x} \PYG{o}{=} \PYG{n+nb}{max}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{x1} \PYG{o}{\PYGZhy{}} \PYG{n}{pad}\PYG{p}{)}\PYG{p}{;} \PYG{n}{y} \PYG{o}{=} \PYG{n+nb}{max}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{y1} \PYG{o}{\PYGZhy{}} \PYG{n}{pad}\PYG{p}{)}
    \PYG{n}{w} \PYG{o}{=} \PYG{n+nb}{min}\PYG{p}{(}\PYG{n}{W} \PYG{o}{\PYGZhy{}} \PYG{n}{x}\PYG{p}{,} \PYG{p}{(}\PYG{n}{x2} \PYG{o}{\PYGZhy{}} \PYG{n}{x1} \PYG{o}{+} \PYG{l+m+mi}{1}\PYG{p}{)} \PYG{o}{+} \PYG{l+m+mi}{2} \PYG{o}{*} \PYG{n}{pad}\PYG{p}{)}
    \PYG{n}{h} \PYG{o}{=} \PYG{n+nb}{min}\PYG{p}{(}\PYG{n}{H} \PYG{o}{\PYGZhy{}} \PYG{n}{y}\PYG{p}{,} \PYG{p}{(}\PYG{n}{y2} \PYG{o}{\PYGZhy{}} \PYG{n}{y1} \PYG{o}{+} \PYG{l+m+mi}{1}\PYG{p}{)} \PYG{o}{+} \PYG{l+m+mi}{2} \PYG{o}{*} \PYG{n}{pad}\PYG{p}{)}

    \PYG{n}{dbg} \PYG{o}{=} \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{cvtColor}\PYG{p}{(}\PYG{n}{hsv}\PYG{p}{,} \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{COLOR\PYGZus{}HSV2BGR}\PYG{p}{)}
    \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{rectangle}\PYG{p}{(}\PYG{n}{dbg}\PYG{p}{,} \PYG{p}{(}\PYG{n}{x}\PYG{p}{,} \PYG{n}{y}\PYG{p}{)}\PYG{p}{,} \PYG{p}{(}\PYG{n}{x} \PYG{o}{+} \PYG{n}{w}\PYG{p}{,} \PYG{n}{y} \PYG{o}{+} \PYG{n}{h}\PYG{p}{)}\PYG{p}{,} \PYG{p}{(}\PYG{l+m+mi}{255}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{255}\PYG{p}{)}\PYG{p}{,} \PYG{l+m+mi}{3}\PYG{p}{)}
    \PYG{n}{vis} \PYG{o}{=} \PYG{n}{dbg}\PYG{o}{.}\PYG{n}{copy}\PYG{p}{(}\PYG{p}{)}
    \PYG{n}{vis}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{n}{col\PYGZus{}mask}\PYG{p}{,} \PYG{p}{:}\PYG{p}{]} \PYG{o}{=} \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{addWeighted}\PYG{p}{(}\PYG{n}{vis}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{n}{col\PYGZus{}mask}\PYG{p}{,} \PYG{p}{:}\PYG{p}{]}\PYG{p}{,} \PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{n}{np}\PYG{o}{.}\PYG{n}{full\PYGZus{}like}\PYG{p}{(}\PYG{n}{vis}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{n}{col\PYGZus{}mask}\PYG{p}{,} \PYG{p}{:}\PYG{p}{]}\PYG{p}{,} \PYG{p}{(}\PYG{l+m+mi}{255}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{)}\PYG{p}{)}\PYG{p}{,} \PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{)}
    \PYG{n}{save\PYGZus{}img\PYGZus{}dbg}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{02b\PYGZus{}belt\PYGZus{}columns.png}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{vis}\PYG{p}{)}
    \PYG{n}{save\PYGZus{}img\PYGZus{}dbg}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{03\PYGZus{}roi\PYGZus{}debug.png}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{dbg}\PYG{p}{)}
    \PYG{n}{save\PYGZus{}img\PYGZus{}dbg}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{02\PYGZus{}blue\PYGZus{}mask.png}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{blue\PYGZus{}raw}\PYG{p}{)}
    \PYG{k}{return} \PYG{p}{(}\PYG{n}{x}\PYG{p}{,} \PYG{n}{y}\PYG{p}{,} \PYG{n}{w}\PYG{p}{,} \PYG{n}{h}\PYG{p}{)}\PYG{p}{,} \PYG{n}{blue}

\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{seeds\PYGZus{}in\PYGZus{}roi}\PYG{p}{(}\PYG{n}{bgr\PYGZus{}roi}\PYG{p}{:} \PYG{n}{np}\PYG{o}{.}\PYG{n}{ndarray}\PYG{p}{,} \PYG{n}{lower}\PYG{p}{:} \PYG{n}{np}\PYG{o}{.}\PYG{n}{ndarray}\PYG{p}{,} \PYG{n}{upper}\PYG{p}{:} \PYG{n}{np}\PYG{o}{.}\PYG{n}{ndarray}\PYG{p}{)}\PYG{p}{:}
    \PYG{n}{hsv} \PYG{o}{=} \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{cvtColor}\PYG{p}{(}\PYG{n}{bgr\PYGZus{}roi}\PYG{p}{,} \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{COLOR\PYGZus{}BGR2HSV}\PYG{p}{)}
    \PYG{n}{blue} \PYG{o}{=} \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{inRange}\PYG{p}{(}\PYG{n}{hsv}\PYG{p}{,} \PYG{n}{lower}\PYG{p}{,} \PYG{n}{upper}\PYG{p}{)}\PYG{o}{.}\PYG{n}{astype}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{uint8}\PYG{p}{)}
    \PYG{n}{not\PYGZus{}blue} \PYG{o}{=} \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{bitwise\PYGZus{}not}\PYG{p}{(}\PYG{n}{blue}\PYG{p}{)}

    \PYG{n}{k\PYGZus{}vert} \PYG{o}{=} \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{getStructuringElement}\PYG{p}{(}\PYG{n}{cv2}\PYG{o}{.}\PYG{n}{MORPH\PYGZus{}ELLIPSE}\PYG{p}{,} \PYG{n}{CONFIG}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{pr\PYGZus{}fg\PYGZus{}kernel}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{p}{)}
    \PYG{n}{pr\PYGZus{}fg} \PYG{o}{=} \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{dilate}\PYG{p}{(}\PYG{n}{not\PYGZus{}blue}\PYG{p}{,} \PYG{n}{k\PYGZus{}vert}\PYG{p}{,} \PYG{n}{iterations}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{)}

    \PYG{n}{h}\PYG{p}{,} \PYG{n}{s}\PYG{p}{,} \PYG{n}{\PYGZus{}} \PYG{o}{=} \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{split}\PYG{p}{(}\PYG{n}{hsv}\PYG{p}{)}
    \PYG{n}{belt\PYGZus{}h} \PYG{o}{=} \PYG{n}{h}\PYG{p}{[}\PYG{n}{blue} \PYG{o}{\PYGZgt{}} \PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{astype}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{float32}\PYG{p}{)}\PYG{p}{;} \PYG{n}{belt\PYGZus{}s} \PYG{o}{=} \PYG{n}{s}\PYG{p}{[}\PYG{n}{blue} \PYG{o}{\PYGZgt{}} \PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{astype}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{float32}\PYG{p}{)}
    \PYG{k}{if} \PYG{n}{belt\PYGZus{}h}\PYG{o}{.}\PYG{n}{size}\PYG{p}{:}
        \PYG{n}{mu\PYGZus{}h}\PYG{p}{,} \PYG{n}{mu\PYGZus{}s} \PYG{o}{=} \PYG{n+nb}{float}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{median}\PYG{p}{(}\PYG{n}{belt\PYGZus{}h}\PYG{p}{)}\PYG{p}{)}\PYG{p}{,} \PYG{n+nb}{float}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{median}\PYG{p}{(}\PYG{n}{belt\PYGZus{}s}\PYG{p}{)}\PYG{p}{)}
        \PYG{n}{dh} \PYG{o}{=} \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{absdiff}\PYG{p}{(}\PYG{n}{h}\PYG{o}{.}\PYG{n}{astype}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{int16}\PYG{p}{)}\PYG{p}{,} \PYG{n}{np}\PYG{o}{.}\PYG{n}{full\PYGZus{}like}\PYG{p}{(}\PYG{n}{h}\PYG{p}{,} \PYG{n+nb}{int}\PYG{p}{(}\PYG{n}{mu\PYGZus{}h}\PYG{p}{)}\PYG{p}{,} \PYG{n}{np}\PYG{o}{.}\PYG{n}{int16}\PYG{p}{)}\PYG{p}{)}\PYG{o}{.}\PYG{n}{astype}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{uint8}\PYG{p}{)}
        \PYG{n}{ds} \PYG{o}{=} \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{absdiff}\PYG{p}{(}\PYG{n}{s}\PYG{o}{.}\PYG{n}{astype}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{int16}\PYG{p}{)}\PYG{p}{,} \PYG{n}{np}\PYG{o}{.}\PYG{n}{full\PYGZus{}like}\PYG{p}{(}\PYG{n}{s}\PYG{p}{,} \PYG{n+nb}{int}\PYG{p}{(}\PYG{n}{mu\PYGZus{}s}\PYG{p}{)}\PYG{p}{,} \PYG{n}{np}\PYG{o}{.}\PYG{n}{int16}\PYG{p}{)}\PYG{p}{)}\PYG{o}{.}\PYG{n}{astype}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{uint8}\PYG{p}{)}
        \PYG{n}{contrast} \PYG{o}{=} \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{addWeighted}\PYG{p}{(}\PYG{n}{dh}\PYG{p}{,} \PYG{l+m+mf}{0.7}\PYG{p}{,} \PYG{n}{ds}\PYG{p}{,} \PYG{l+m+mf}{0.3}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{)}
        \PYG{n}{thr} \PYG{o}{=} \PYG{n+nb}{int}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{percentile}\PYG{p}{(}\PYG{n}{contrast}\PYG{p}{,} \PYG{n}{CONFIG}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{sure\PYGZus{}fg\PYGZus{}pct\PYGZus{}contrast}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{p}{)}\PYG{p}{)}
        \PYG{n}{\PYGZus{}}\PYG{p}{,} \PYG{n}{hi} \PYG{o}{=} \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{threshold}\PYG{p}{(}\PYG{n}{contrast}\PYG{p}{,} \PYG{n}{thr}\PYG{p}{,} \PYG{l+m+mi}{255}\PYG{p}{,} \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{THRESH\PYGZus{}BINARY}\PYG{p}{)}
        \PYG{n}{sure\PYGZus{}fg} \PYG{o}{=} \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{bitwise\PYGZus{}and}\PYG{p}{(}\PYG{n}{hi}\PYG{p}{,} \PYG{n}{not\PYGZus{}blue}\PYG{p}{)}
        \PYG{n}{save\PYGZus{}img\PYGZus{}dbg}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{07\PYGZus{}contrast.png}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{normalize}\PYG{p}{(}\PYG{n}{contrast}\PYG{p}{,} \PYG{k+kc}{None}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{255}\PYG{p}{,} \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{NORM\PYGZus{}MINMAX}\PYG{p}{)}\PYG{p}{)}
    \PYG{k}{else}\PYG{p}{:}
        \PYG{n}{sure\PYGZus{}fg} \PYG{o}{=} \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{erode}\PYG{p}{(}\PYG{n}{pr\PYGZus{}fg}\PYG{p}{,} \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{getStructuringElement}\PYG{p}{(}\PYG{n}{cv2}\PYG{o}{.}\PYG{n}{MORPH\PYGZus{}ELLIPSE}\PYG{p}{,} \PYG{p}{(}\PYG{l+m+mi}{9}\PYG{p}{,} \PYG{l+m+mi}{9}\PYG{p}{)}\PYG{p}{)}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}

    \PYG{n}{dist} \PYG{o}{=} \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{distanceTransform}\PYG{p}{(}\PYG{p}{(}\PYG{n}{pr\PYGZus{}fg} \PYG{o}{\PYGZgt{}} \PYG{l+m+mi}{0}\PYG{p}{)}\PYG{o}{.}\PYG{n}{astype}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{uint8}\PYG{p}{)}\PYG{p}{,} \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{DIST\PYGZus{}L2}\PYG{p}{,} \PYG{l+m+mi}{5}\PYG{p}{)}
    \PYG{k}{if} \PYG{n}{np}\PYG{o}{.}\PYG{n}{any}\PYG{p}{(}\PYG{n}{dist} \PYG{o}{\PYGZgt{}} \PYG{l+m+mi}{0}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{th} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{percentile}\PYG{p}{(}\PYG{n}{dist}\PYG{p}{[}\PYG{n}{dist} \PYG{o}{\PYGZgt{}} \PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,} \PYG{n}{CONFIG}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{sure\PYGZus{}fg\PYGZus{}pct\PYGZus{}dt}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{p}{)}
        \PYG{n}{sure\PYGZus{}fg} \PYG{o}{|}\PYG{o}{=} \PYG{p}{(}\PYG{n}{dist} \PYG{o}{\PYGZgt{}} \PYG{n}{th}\PYG{p}{)}\PYG{o}{.}\PYG{n}{astype}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{uint8}\PYG{p}{)} \PYG{o}{*} \PYG{l+m+mi}{255}

    \PYG{n}{gc\PYGZus{}mask} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{full}\PYG{p}{(}\PYG{n}{blue}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{,} \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{GC\PYGZus{}PR\PYGZus{}BGD}\PYG{p}{,} \PYG{n}{np}\PYG{o}{.}\PYG{n}{uint8}\PYG{p}{)}
    \PYG{n}{gc\PYGZus{}mask}\PYG{p}{[}\PYG{n}{blue} \PYG{o}{\PYGZgt{}} \PYG{l+m+mi}{0}\PYG{p}{]}    \PYG{o}{=} \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{GC\PYGZus{}BGD}
    \PYG{n}{gc\PYGZus{}mask}\PYG{p}{[}\PYG{n}{pr\PYGZus{}fg} \PYG{o}{\PYGZgt{}} \PYG{l+m+mi}{0}\PYG{p}{]}   \PYG{o}{=} \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{GC\PYGZus{}PR\PYGZus{}FGD}
    \PYG{n}{gc\PYGZus{}mask}\PYG{p}{[}\PYG{n}{sure\PYGZus{}fg} \PYG{o}{\PYGZgt{}} \PYG{l+m+mi}{0}\PYG{p}{]} \PYG{o}{=} \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{GC\PYGZus{}FGD}

    \PYG{c+c1}{\PYGZsh{} Horizontal borders as BG}
    \PYG{n}{m} \PYG{o}{=} \PYG{l+m+mi}{6}
    \PYG{n}{gc\PYGZus{}mask}\PYG{p}{[}\PYG{p}{:}\PYG{n}{m}\PYG{p}{,} \PYG{p}{:}\PYG{p}{]}  \PYG{o}{=} \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{GC\PYGZus{}BGD}
    \PYG{n}{gc\PYGZus{}mask}\PYG{p}{[}\PYG{o}{\PYGZhy{}}\PYG{n}{m}\PYG{p}{:}\PYG{p}{,} \PYG{p}{:}\PYG{p}{]} \PYG{o}{=} \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{GC\PYGZus{}BGD}
    \PYG{c+c1}{\PYGZsh{} Lateral guard\PYGZhy{}rails as BG}
    \PYG{n}{W} \PYG{o}{=} \PYG{n}{gc\PYGZus{}mask}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}
    \PYG{n}{g} \PYG{o}{=} \PYG{n+nb}{int}\PYG{p}{(}\PYG{n}{CONFIG}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{guard\PYGZus{}frac\PYGZus{}w}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]} \PYG{o}{*} \PYG{n}{W}\PYG{p}{)}
    \PYG{n}{g} \PYG{o}{=} \PYG{n+nb}{max}\PYG{p}{(}\PYG{n}{CONFIG}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{guard\PYGZus{}min\PYGZus{}px}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{p}{,} \PYG{n+nb}{min}\PYG{p}{(}\PYG{n}{CONFIG}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{guard\PYGZus{}max\PYGZus{}px}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{p}{,} \PYG{n}{g}\PYG{p}{)}\PYG{p}{)}
    \PYG{n}{gc\PYGZus{}mask}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{p}{:}\PYG{n}{g}\PYG{p}{]}  \PYG{o}{=} \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{GC\PYGZus{}BGD}
    \PYG{n}{gc\PYGZus{}mask}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{o}{\PYGZhy{}}\PYG{n}{g}\PYG{p}{:}\PYG{p}{]} \PYG{o}{=} \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{GC\PYGZus{}BGD}

    \PYG{n}{save\PYGZus{}img\PYGZus{}dbg}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{04\PYGZus{}pr\PYGZus{}fg.png}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{pr\PYGZus{}fg}\PYG{p}{)}
    \PYG{n}{save\PYGZus{}img\PYGZus{}dbg}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{05\PYGZus{}sure\PYGZus{}fg.png}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{sure\PYGZus{}fg}\PYG{p}{)}
    \PYG{n}{save\PYGZus{}img\PYGZus{}dbg}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{06\PYGZus{}not\PYGZus{}blue.png}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{not\PYGZus{}blue}\PYG{p}{)}
    \PYG{n}{save\PYGZus{}img\PYGZus{}dbg}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{08\PYGZus{}gc\PYGZus{}seeds.png}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{(}\PYG{n}{gc\PYGZus{}mask} \PYG{o}{*} \PYG{p}{(}\PYG{l+m+mi}{255} \PYG{o}{/}\PYG{o}{/} \PYG{l+m+mi}{3}\PYG{p}{)}\PYG{p}{)}\PYG{o}{.}\PYG{n}{astype}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{uint8}\PYG{p}{)}\PYG{p}{)}
    \PYG{k}{return} \PYG{n}{gc\PYGZus{}mask}

\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{render\PYGZus{}candidates\PYGZus{}debug}\PYG{p}{(}\PYG{n}{bgr\PYGZus{}base}\PYG{p}{:} \PYG{n}{np}\PYG{o}{.}\PYG{n}{ndarray}\PYG{p}{,}
                            \PYG{n}{cnts}\PYG{p}{:} \PYG{n+nb}{list}\PYG{p}{,}
                            \PYG{n}{scores}\PYG{p}{:} \PYG{n+nb}{list}\PYG{p}{,}
                            \PYG{n}{best\PYGZus{}idx}\PYG{p}{:} \PYG{n+nb}{int} \PYG{o}{|} \PYG{k+kc}{None}\PYG{p}{,}
                            \PYG{n}{roi\PYGZus{}xywh}\PYG{p}{:} \PYG{n+nb}{tuple}\PYG{p}{[}\PYG{n+nb}{int}\PYG{p}{,}\PYG{n+nb}{int}\PYG{p}{,}\PYG{n+nb}{int}\PYG{p}{,}\PYG{n+nb}{int}\PYG{p}{]}\PYG{p}{,}
                            \PYG{n}{tag}\PYG{p}{:} \PYG{n+nb}{str}\PYG{p}{)}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}Writes PNG only in debug; returns path or None.\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{k}{if} \PYG{o+ow}{not} \PYG{n}{\PYGZus{}dbg}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{return} \PYG{k+kc}{None}
    \PYG{n}{vis} \PYG{o}{=} \PYG{n}{bgr\PYGZus{}base}\PYG{o}{.}\PYG{n}{copy}\PYG{p}{(}\PYG{p}{)}
    \PYG{n}{xR}\PYG{p}{,} \PYG{n}{yR}\PYG{p}{,} \PYG{n}{wR}\PYG{p}{,} \PYG{n}{hR} \PYG{o}{=} \PYG{n}{roi\PYGZus{}xywh}
    \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{rectangle}\PYG{p}{(}\PYG{n}{vis}\PYG{p}{,} \PYG{p}{(}\PYG{n}{xR}\PYG{p}{,} \PYG{n}{yR}\PYG{p}{)}\PYG{p}{,} \PYG{p}{(}\PYG{n}{xR} \PYG{o}{+} \PYG{n}{wR}\PYG{p}{,} \PYG{n}{yR} \PYG{o}{+} \PYG{n}{hR}\PYG{p}{)}\PYG{p}{,} \PYG{p}{(}\PYG{l+m+mi}{255}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{255}\PYG{p}{)}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{)}

    \PYG{n}{sc} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{n}{scores}\PYG{p}{,} \PYG{n}{dtype}\PYG{o}{=}\PYG{n}{np}\PYG{o}{.}\PYG{n}{float32}\PYG{p}{)} \PYG{k}{if} \PYG{n}{scores} \PYG{k}{else} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{p}{[}\PYG{p}{]}\PYG{p}{,} \PYG{n}{np}\PYG{o}{.}\PYG{n}{float32}\PYG{p}{)}
    \PYG{k}{if} \PYG{n}{sc}\PYG{o}{.}\PYG{n}{size}\PYG{p}{:}
        \PYG{n}{sc}\PYG{p}{[}\PYG{o}{\PYGZti{}}\PYG{n}{np}\PYG{o}{.}\PYG{n}{isfinite}\PYG{p}{(}\PYG{n}{sc}\PYG{p}{)}\PYG{p}{]} \PYG{o}{=} \PYG{l+m+mf}{0.0}
        \PYG{n}{scn} \PYG{o}{=} \PYG{p}{(}\PYG{n}{sc} \PYG{o}{\PYGZhy{}} \PYG{n}{sc}\PYG{o}{.}\PYG{n}{min}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)} \PYG{o}{/} \PYG{n+nb}{max}\PYG{p}{(}\PYG{l+m+mf}{1e\PYGZhy{}9}\PYG{p}{,} \PYG{n}{sc}\PYG{o}{.}\PYG{n}{max}\PYG{p}{(}\PYG{p}{)} \PYG{o}{\PYGZhy{}} \PYG{n}{sc}\PYG{o}{.}\PYG{n}{min}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)} \PYG{k}{if} \PYG{o+ow}{not} \PYG{n}{np}\PYG{o}{.}\PYG{n}{all}\PYG{p}{(}\PYG{n}{sc} \PYG{o}{==} \PYG{n}{sc}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{)} \PYG{k}{else} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros\PYGZus{}like}\PYG{p}{(}\PYG{n}{sc}\PYG{p}{)}

    \PYG{k}{for} \PYG{n}{i}\PYG{p}{,} \PYG{n}{c} \PYG{o+ow}{in} \PYG{n+nb}{enumerate}\PYG{p}{(}\PYG{n}{cnts}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{color} \PYG{o}{=} \PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{255}\PYG{p}{)}\PYG{p}{;} \PYG{n}{thick} \PYG{o}{=} \PYG{l+m+mi}{2}
        \PYG{k}{if} \PYG{n}{best\PYGZus{}idx} \PYG{o+ow}{is} \PYG{o+ow}{not} \PYG{k+kc}{None} \PYG{o+ow}{and} \PYG{n}{i} \PYG{o}{==} \PYG{n}{best\PYGZus{}idx}\PYG{p}{:}
            \PYG{n}{color} \PYG{o}{=} \PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{255}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{)}\PYG{p}{;} \PYG{n}{thick} \PYG{o}{=} \PYG{l+m+mi}{3}
        \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{drawContours}\PYG{p}{(}\PYG{n}{vis}\PYG{p}{,} \PYG{p}{[}\PYG{n}{c}\PYG{p}{]}\PYG{p}{,} \PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{color}\PYG{p}{,} \PYG{n}{thick}\PYG{p}{)}
        \PYG{n}{x}\PYG{p}{,} \PYG{n}{y}\PYG{p}{,} \PYG{n}{w}\PYG{p}{,} \PYG{n}{h} \PYG{o}{=} \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{boundingRect}\PYG{p}{(}\PYG{n}{c}\PYG{p}{)}
        \PYG{n}{s} \PYG{o}{=} \PYG{n}{scores}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]} \PYG{k}{if} \PYG{n}{i} \PYG{o}{\PYGZlt{}} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{scores}\PYG{p}{)} \PYG{k}{else} \PYG{n+nb}{float}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{nan}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
        \PYG{n}{txt} \PYG{o}{=} \PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{s=}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{s}\PYG{l+s+si}{:}\PYG{l+s+s2}{.0f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{  }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{w}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{x}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{h}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}
        \PYG{n}{y\PYGZus{}txt} \PYG{o}{=} \PYG{n+nb}{max}\PYG{p}{(}\PYG{l+m+mi}{15}\PYG{p}{,} \PYG{n}{y} \PYG{o}{\PYGZhy{}} \PYG{l+m+mi}{5}\PYG{p}{)}
        \PYG{p}{(}\PYG{n}{tw}\PYG{p}{,} \PYG{n}{th}\PYG{p}{)}\PYG{p}{,} \PYG{n}{\PYGZus{}} \PYG{o}{=} \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{getTextSize}\PYG{p}{(}\PYG{n}{txt}\PYG{p}{,} \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{FONT\PYGZus{}HERSHEY\PYGZus{}SIMPLEX}\PYG{p}{,} \PYG{l+m+mf}{0.45}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}
        \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{rectangle}\PYG{p}{(}\PYG{n}{vis}\PYG{p}{,} \PYG{p}{(}\PYG{n}{x}\PYG{p}{,} \PYG{n}{y\PYGZus{}txt} \PYG{o}{\PYGZhy{}} \PYG{n}{th} \PYG{o}{\PYGZhy{}} \PYG{l+m+mi}{4}\PYG{p}{)}\PYG{p}{,} \PYG{p}{(}\PYG{n}{x} \PYG{o}{+} \PYG{n}{tw} \PYG{o}{+} \PYG{l+m+mi}{4}\PYG{p}{,} \PYG{n}{y\PYGZus{}txt} \PYG{o}{+} \PYG{l+m+mi}{2}\PYG{p}{)}\PYG{p}{,} \PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{)}\PYG{p}{,} \PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{)}
        \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{putText}\PYG{p}{(}\PYG{n}{vis}\PYG{p}{,} \PYG{n}{txt}\PYG{p}{,} \PYG{p}{(}\PYG{n}{x} \PYG{o}{+} \PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{y\PYGZus{}txt}\PYG{p}{)}\PYG{p}{,} \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{FONT\PYGZus{}HERSHEY\PYGZus{}SIMPLEX}\PYG{p}{,} \PYG{l+m+mf}{0.45}\PYG{p}{,} \PYG{p}{(}\PYG{l+m+mi}{255}\PYG{p}{,} \PYG{l+m+mi}{255}\PYG{p}{,} \PYG{l+m+mi}{255}\PYG{p}{)}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{LINE\PYGZus{}AA}\PYG{p}{)}
        \PYG{k}{if} \PYG{n}{sc}\PYG{o}{.}\PYG{n}{size} \PYG{o+ow}{and} \PYG{p}{(}\PYG{n}{best\PYGZus{}idx} \PYG{o+ow}{is} \PYG{k+kc}{None} \PYG{o+ow}{or} \PYG{n}{i} \PYG{o}{!=} \PYG{n}{best\PYGZus{}idx}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{alpha} \PYG{o}{=} \PYG{n+nb}{float}\PYG{p}{(}\PYG{l+m+mf}{0.35} \PYG{o}{+} \PYG{l+m+mf}{0.45} \PYG{o}{*} \PYG{n}{scn}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}\PYG{p}{)}
            \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{drawContours}\PYG{p}{(}\PYG{n}{vis}\PYG{p}{,} \PYG{p}{[}\PYG{n}{c}\PYG{p}{]}\PYG{p}{,} \PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n+nb}{tuple}\PYG{p}{(}\PYG{n+nb}{int}\PYG{p}{(}\PYG{n}{alpha} \PYG{o}{*} \PYG{n}{v}\PYG{p}{)} \PYG{k}{for} \PYG{n}{v} \PYG{o+ow}{in} \PYG{n}{color}\PYG{p}{)}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{)}

    \PYG{k}{return} \PYG{n}{save\PYGZus{}img}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{10\PYGZus{}candidates\PYGZus{}}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{tag}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{.png}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{vis}\PYG{p}{)}

\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{contour\PYGZus{}scores}\PYG{p}{(}\PYG{n}{cnts}\PYG{p}{,} \PYG{n}{roi}\PYG{p}{,} \PYG{n}{strict}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{)}\PYG{p}{:}
    \PYG{n}{xR}\PYG{p}{,} \PYG{n}{yR}\PYG{p}{,} \PYG{n}{wR}\PYG{p}{,} \PYG{n}{hR} \PYG{o}{=} \PYG{n}{roi}
    \PYG{k}{if} \PYG{n}{strict}\PYG{p}{:}
        \PYG{n}{min\PYGZus{}area} \PYG{o}{=} \PYG{n}{CONFIG}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{min\PYGZus{}area\PYGZus{}px2}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}
        \PYG{n}{min\PYGZus{}width} \PYG{o}{=} \PYG{n}{CONFIG}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{min\PYGZus{}width\PYGZus{}px}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}
        \PYG{n}{edge\PYGZus{}clear} \PYG{o}{=} \PYG{n}{CONFIG}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{edge\PYGZus{}clear\PYGZus{}px}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}
        \PYG{n}{mu} \PYG{o}{=} \PYG{n}{CONFIG}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{shape\PYGZus{}mu\PYGZus{}log\PYGZus{}aspect}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}
        \PYG{n}{sg} \PYG{o}{=} \PYG{n}{CONFIG}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{shape\PYGZus{}sigma}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}
        \PYG{n}{allow\PYGZus{}touch\PYGZus{}edges} \PYG{o}{=} \PYG{k+kc}{False}
    \PYG{k}{else}\PYG{p}{:}
        \PYG{n}{min\PYGZus{}area} \PYG{o}{=} \PYG{n}{CONFIG}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{relax}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{min\PYGZus{}area\PYGZus{}px2}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}
        \PYG{n}{min\PYGZus{}width} \PYG{o}{=} \PYG{n}{CONFIG}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{relax}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{min\PYGZus{}width\PYGZus{}px}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}
        \PYG{n}{edge\PYGZus{}clear} \PYG{o}{=} \PYG{n}{CONFIG}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{relax}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{edge\PYGZus{}clear\PYGZus{}px}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}
        \PYG{n}{mu} \PYG{o}{=} \PYG{n}{CONFIG}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{shape\PYGZus{}mu\PYGZus{}log\PYGZus{}aspect}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}
        \PYG{n}{sg} \PYG{o}{=} \PYG{n}{CONFIG}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{relax}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{shape\PYGZus{}sigma}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}
        \PYG{n}{allow\PYGZus{}touch\PYGZus{}edges} \PYG{o}{=} \PYG{n}{CONFIG}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{relax}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{allow\PYGZus{}touch\PYGZus{}edges}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}

    \PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{score}\PYG{p}{(}\PYG{n}{c}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{A} \PYG{o}{=} \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{contourArea}\PYG{p}{(}\PYG{n}{c}\PYG{p}{)}
        \PYG{k}{if} \PYG{n}{A} \PYG{o}{\PYGZlt{}} \PYG{n}{min\PYGZus{}area}\PYG{p}{:}
            \PYG{k}{return} \PYG{o}{\PYGZhy{}}\PYG{n}{np}\PYG{o}{.}\PYG{n}{inf}
        \PYG{n}{x0}\PYG{p}{,} \PYG{n}{y0}\PYG{p}{,} \PYG{n}{w0}\PYG{p}{,} \PYG{n}{h0} \PYG{o}{=} \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{boundingRect}\PYG{p}{(}\PYG{n}{c}\PYG{p}{)}
        \PYG{k}{if} \PYG{n+nb}{min}\PYG{p}{(}\PYG{n}{w0}\PYG{p}{,} \PYG{n}{h0}\PYG{p}{)} \PYG{o}{\PYGZlt{}} \PYG{n}{min\PYGZus{}width}\PYG{p}{:}
            \PYG{k}{return} \PYG{o}{\PYGZhy{}}\PYG{n}{np}\PYG{o}{.}\PYG{n}{inf}
        \PYG{k}{if} \PYG{o+ow}{not} \PYG{n}{allow\PYGZus{}touch\PYGZus{}edges}\PYG{p}{:}
            \PYG{k}{if} \PYG{p}{(}\PYG{n}{xR} \PYG{o}{+} \PYG{n}{x0}\PYG{p}{)} \PYG{o}{\PYGZlt{}} \PYG{p}{(}\PYG{n}{xR} \PYG{o}{+} \PYG{n}{edge\PYGZus{}clear}\PYG{p}{)} \PYG{o+ow}{or} \PYG{p}{(}\PYG{n}{xR} \PYG{o}{+} \PYG{n}{x0} \PYG{o}{+} \PYG{n}{w0}\PYG{p}{)} \PYG{o}{\PYGZgt{}} \PYG{p}{(}\PYG{n}{xR} \PYG{o}{+} \PYG{n}{wR} \PYG{o}{\PYGZhy{}} \PYG{n}{edge\PYGZus{}clear}\PYG{p}{)}\PYG{p}{:}
                \PYG{k}{return} \PYG{o}{\PYGZhy{}}\PYG{n}{np}\PYG{o}{.}\PYG{n}{inf}
        \PYG{n}{a} \PYG{o}{=} \PYG{n+nb}{max}\PYG{p}{(}\PYG{n}{w0}\PYG{p}{,} \PYG{n}{h0}\PYG{p}{)} \PYG{o}{/} \PYG{n+nb}{max}\PYG{p}{(}\PYG{l+m+mf}{1.0}\PYG{p}{,} \PYG{n+nb}{min}\PYG{p}{(}\PYG{n}{w0}\PYG{p}{,} \PYG{n}{h0}\PYG{p}{)}\PYG{p}{)}
        \PYG{n}{w\PYGZus{}aspect} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{exp}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{p}{(}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{log}\PYG{p}{(}\PYG{n}{a}\PYG{p}{)} \PYG{o}{\PYGZhy{}} \PYG{n}{mu}\PYG{p}{)} \PYG{o}{*}\PYG{o}{*} \PYG{l+m+mi}{2}\PYG{p}{)} \PYG{o}{/} \PYG{p}{(}\PYG{l+m+mf}{2.0} \PYG{o}{*} \PYG{p}{(}\PYG{n}{sg} \PYG{o}{*}\PYG{o}{*} \PYG{l+m+mi}{2}\PYG{p}{)}\PYG{p}{)}\PYG{p}{)}
        \PYG{n}{hull} \PYG{o}{=} \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{convexHull}\PYG{p}{(}\PYG{n}{c}\PYG{p}{)}
        \PYG{n}{Ah} \PYG{o}{=} \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{contourArea}\PYG{p}{(}\PYG{n}{hull}\PYG{p}{)}
        \PYG{n}{solidity} \PYG{o}{=} \PYG{p}{(}\PYG{n}{A} \PYG{o}{/} \PYG{n}{Ah}\PYG{p}{)} \PYG{k}{if} \PYG{n}{Ah} \PYG{o}{\PYGZgt{}} \PYG{l+m+mi}{0} \PYG{k}{else} \PYG{l+m+mf}{0.0}
        \PYG{n}{w\PYGZus{}sol} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{clip}\PYG{p}{(}\PYG{n}{solidity}\PYG{p}{,} \PYG{l+m+mf}{0.0}\PYG{p}{,} \PYG{l+m+mf}{1.0}\PYG{p}{)}
        \PYG{k}{return} \PYG{n+nb}{float}\PYG{p}{(}\PYG{n}{A} \PYG{o}{*} \PYG{n}{w\PYGZus{}aspect} \PYG{o}{*} \PYG{p}{(}\PYG{l+m+mf}{0.6} \PYG{o}{+} \PYG{l+m+mf}{0.4} \PYG{o}{*} \PYG{n}{w\PYGZus{}sol}\PYG{p}{)}\PYG{p}{)}

    \PYG{k}{return} \PYG{p}{[}\PYG{n}{score}\PYG{p}{(}\PYG{n}{c}\PYG{p}{)} \PYG{k}{for} \PYG{n}{c} \PYG{o+ow}{in} \PYG{n}{cnts}\PYG{p}{]}

\PYG{c+c1}{\PYGZsh{} \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{c+c1}{\PYGZsh{} Run}
\PYG{c+c1}{\PYGZsh{} \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{extractor}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
    \PYG{n}{IMG\PYGZus{}PATH} \PYG{o}{=} \PYG{n}{CONFIG}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{img\PYGZus{}path}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}
    \PYG{n}{bgr0} \PYG{o}{=} \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{imread}\PYG{p}{(}\PYG{n}{IMG\PYGZus{}PATH}\PYG{p}{,} \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{IMREAD\PYGZus{}COLOR}\PYG{p}{)}
    \PYG{k}{if} \PYG{n}{bgr0} \PYG{o+ow}{is} \PYG{k+kc}{None}\PYG{p}{:}
        \PYG{k}{raise} \PYG{n+ne}{FileNotFoundError}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{No se pudo leer la imagen: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{IMG\PYGZus{}PATH}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}

    \PYG{c+c1}{\PYGZsh{} 1) Prefilter}
    \PYG{n}{bgr} \PYG{o}{=} \PYG{n}{prefilter}\PYG{p}{(}\PYG{n}{bgr0}\PYG{p}{)}

    \PYG{c+c1}{\PYGZsh{} 2) Dynamic blue \PYGZam{} ROI}
    \PYG{n}{hsv} \PYG{o}{=} \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{cvtColor}\PYG{p}{(}\PYG{n}{bgr}\PYG{p}{,} \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{COLOR\PYGZus{}BGR2HSV}\PYG{p}{)}
    \PYG{n}{lower}\PYG{p}{,} \PYG{n}{upper} \PYG{o}{=} \PYG{n}{dynamic\PYGZus{}blue\PYGZus{}threshold}\PYG{p}{(}\PYG{n}{hsv}\PYG{p}{)}
    \PYG{n}{roi}\PYG{p}{,} \PYG{n}{\PYGZus{}} \PYG{o}{=} \PYG{n}{belt\PYGZus{}roi\PYGZus{}from\PYGZus{}blue}\PYG{p}{(}\PYG{n}{hsv}\PYG{p}{,} \PYG{n}{lower}\PYG{p}{,} \PYG{n}{upper}\PYG{p}{)}
    \PYG{n}{x}\PYG{p}{,} \PYG{n}{y}\PYG{p}{,} \PYG{n}{w}\PYG{p}{,} \PYG{n}{h} \PYG{o}{=} \PYG{n}{roi}
    \PYG{n}{crop} \PYG{o}{=} \PYG{n}{bgr}\PYG{p}{[}\PYG{n}{y}\PYG{p}{:}\PYG{n}{y} \PYG{o}{+} \PYG{n}{h}\PYG{p}{,} \PYG{n}{x}\PYG{p}{:}\PYG{n}{x} \PYG{o}{+} \PYG{n}{w}\PYG{p}{]}\PYG{o}{.}\PYG{n}{copy}\PYG{p}{(}\PYG{p}{)}

    \PYG{c+c1}{\PYGZsh{} 3) GrabCut seeds + run}
    \PYG{n}{gc\PYGZus{}mask} \PYG{o}{=} \PYG{n}{seeds\PYGZus{}in\PYGZus{}roi}\PYG{p}{(}\PYG{n}{crop}\PYG{p}{,} \PYG{n}{lower}\PYG{p}{,} \PYG{n}{upper}\PYG{p}{)}
    \PYG{n}{bg\PYGZus{}model} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{65}\PYG{p}{)}\PYG{p}{,} \PYG{n}{np}\PYG{o}{.}\PYG{n}{float64}\PYG{p}{)}
    \PYG{n}{fg\PYGZus{}model} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{65}\PYG{p}{)}\PYG{p}{,} \PYG{n}{np}\PYG{o}{.}\PYG{n}{float64}\PYG{p}{)}
    \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{grabCut}\PYG{p}{(}\PYG{n}{crop}\PYG{p}{,} \PYG{n}{gc\PYGZus{}mask}\PYG{p}{,} \PYG{k+kc}{None}\PYG{p}{,} \PYG{n}{bg\PYGZus{}model}\PYG{p}{,} \PYG{n}{fg\PYGZus{}model}\PYG{p}{,} \PYG{n}{CONFIG}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{gc\PYGZus{}iters}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{p}{,} \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{GC\PYGZus{}INIT\PYGZus{}WITH\PYGZus{}MASK}\PYG{p}{)}

    \PYG{c+c1}{\PYGZsh{} 4) Post\PYGZhy{}process mask}
    \PYG{n}{mask\PYGZus{}roi} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{where}\PYG{p}{(}\PYG{p}{(}\PYG{n}{gc\PYGZus{}mask} \PYG{o}{==} \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{GC\PYGZus{}FGD}\PYG{p}{)} \PYG{o}{|} \PYG{p}{(}\PYG{n}{gc\PYGZus{}mask} \PYG{o}{==} \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{GC\PYGZus{}PR\PYGZus{}FGD}\PYG{p}{)}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{)}\PYG{o}{.}\PYG{n}{astype}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{uint8}\PYG{p}{)}
    \PYG{n}{save\PYGZus{}img\PYGZus{}dbg}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{09\PYGZus{}mask\PYGZus{}roi\PYGZus{}raw.png}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{(}\PYG{n}{mask\PYGZus{}roi} \PYG{o}{*} \PYG{l+m+mi}{255}\PYG{p}{)}\PYG{p}{)}
    \PYG{n}{mask\PYGZus{}roi} \PYG{o}{=} \PYG{n}{\PYGZus{}close}\PYG{p}{(}\PYG{n}{mask\PYGZus{}roi}\PYG{p}{,} \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{MORPH\PYGZus{}ELLIPSE}\PYG{p}{,} \PYG{n}{CONFIG}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{post\PYGZus{}close\PYGZus{}kernel}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}
    \PYG{n}{mask\PYGZus{}roi} \PYG{o}{=} \PYG{n}{\PYGZus{}open}\PYG{p}{(}\PYG{n}{mask\PYGZus{}roi}\PYG{p}{,}  \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{MORPH\PYGZus{}ELLIPSE}\PYG{p}{,} \PYG{p}{(}\PYG{l+m+mi}{5}\PYG{p}{,} \PYG{l+m+mi}{5}\PYG{p}{)}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}

    \PYG{n}{full} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{n}{bgr}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{[}\PYG{p}{:}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{p}{,} \PYG{n}{np}\PYG{o}{.}\PYG{n}{uint8}\PYG{p}{)}
    \PYG{n}{full}\PYG{p}{[}\PYG{n}{y}\PYG{p}{:}\PYG{n}{y} \PYG{o}{+} \PYG{n}{h}\PYG{p}{,} \PYG{n}{x}\PYG{p}{:}\PYG{n}{x} \PYG{o}{+} \PYG{n}{w}\PYG{p}{]} \PYG{o}{=} \PYG{n}{mask\PYGZus{}roi}

    \PYG{c+c1}{\PYGZsh{} 5) Contours \PYGZam{} scoring (strict ‚Üí relaxed fallback)}
    \PYG{n}{cnts}\PYG{p}{,} \PYG{n}{\PYGZus{}} \PYG{o}{=} \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{findContours}\PYG{p}{(}\PYG{p}{(}\PYG{n}{full} \PYG{o}{*} \PYG{l+m+mi}{255}\PYG{p}{)}\PYG{o}{.}\PYG{n}{astype}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{uint8}\PYG{p}{)}\PYG{p}{,} \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{RETR\PYGZus{}EXTERNAL}\PYG{p}{,} \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{CHAIN\PYGZus{}APPROX\PYGZus{}NONE}\PYG{p}{)}
    \PYG{n}{scores\PYGZus{}strict} \PYG{o}{=} \PYG{n}{contour\PYGZus{}scores}\PYG{p}{(}\PYG{n}{cnts}\PYG{p}{,} \PYG{n}{roi}\PYG{p}{,} \PYG{n}{strict}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{)} \PYG{k}{if} \PYG{n}{cnts} \PYG{k}{else} \PYG{p}{[}\PYG{p}{]}
    \PYG{n}{best\PYGZus{}idx} \PYG{o}{=} \PYG{n+nb}{int}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{argmax}\PYG{p}{(}\PYG{n}{scores\PYGZus{}strict}\PYG{p}{)}\PYG{p}{)} \PYG{k}{if} \PYG{n}{scores\PYGZus{}strict} \PYG{k}{else} \PYG{k+kc}{None}
    \PYG{n}{strict\PYGZus{}ok} \PYG{o}{=} \PYG{n+nb}{bool}\PYG{p}{(}\PYG{n}{scores\PYGZus{}strict}\PYG{p}{)} \PYG{o+ow}{and} \PYG{n}{np}\PYG{o}{.}\PYG{n}{isfinite}\PYG{p}{(}\PYG{n}{scores\PYGZus{}strict}\PYG{p}{[}\PYG{n}{best\PYGZus{}idx}\PYG{p}{]}\PYG{p}{)} \PYG{o+ow}{and} \PYG{p}{(}\PYG{n}{scores\PYGZus{}strict}\PYG{p}{[}\PYG{n}{best\PYGZus{}idx}\PYG{p}{]} \PYG{o}{\PYGZgt{}} \PYG{l+m+mi}{0}\PYG{p}{)}
    \PYG{n}{\PYGZus{}} \PYG{o}{=} \PYG{n}{render\PYGZus{}candidates\PYGZus{}debug}\PYG{p}{(}\PYG{n}{bgr0}\PYG{p}{,} \PYG{n}{cnts}\PYG{p}{,} \PYG{n}{scores\PYGZus{}strict}\PYG{p}{,} \PYG{n}{best\PYGZus{}idx} \PYG{k}{if} \PYG{n}{strict\PYGZus{}ok} \PYG{k}{else} \PYG{k+kc}{None}\PYG{p}{,} \PYG{n}{roi}\PYG{p}{,} \PYG{n}{tag}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{strict}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}

    \PYG{k}{if} \PYG{o+ow}{not} \PYG{n}{strict\PYGZus{}ok}\PYG{p}{:}
        \PYG{n}{scores\PYGZus{}relax} \PYG{o}{=} \PYG{n}{contour\PYGZus{}scores}\PYG{p}{(}\PYG{n}{cnts}\PYG{p}{,} \PYG{n}{roi}\PYG{p}{,} \PYG{n}{strict}\PYG{o}{=}\PYG{k+kc}{False}\PYG{p}{)} \PYG{k}{if} \PYG{n}{cnts} \PYG{k}{else} \PYG{p}{[}\PYG{p}{]}
        \PYG{n}{best\PYGZus{}idx\PYGZus{}relax} \PYG{o}{=} \PYG{n+nb}{int}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{argmax}\PYG{p}{(}\PYG{n}{scores\PYGZus{}relax}\PYG{p}{)}\PYG{p}{)} \PYG{k}{if} \PYG{n}{scores\PYGZus{}relax} \PYG{k}{else} \PYG{k+kc}{None}
        \PYG{n}{relaxed\PYGZus{}ok} \PYG{o}{=} \PYG{n+nb}{bool}\PYG{p}{(}\PYG{n}{scores\PYGZus{}relax}\PYG{p}{)} \PYG{o+ow}{and} \PYG{n}{np}\PYG{o}{.}\PYG{n}{isfinite}\PYG{p}{(}\PYG{n}{scores\PYGZus{}relax}\PYG{p}{[}\PYG{n}{best\PYGZus{}idx\PYGZus{}relax}\PYG{p}{]}\PYG{p}{)} \PYG{o+ow}{and} \PYG{p}{(}\PYG{n}{scores\PYGZus{}relax}\PYG{p}{[}\PYG{n}{best\PYGZus{}idx\PYGZus{}relax}\PYG{p}{]} \PYG{o}{\PYGZgt{}} \PYG{l+m+mi}{0}\PYG{p}{)}
        \PYG{n}{\PYGZus{}} \PYG{o}{=} \PYG{n}{render\PYGZus{}candidates\PYGZus{}debug}\PYG{p}{(}\PYG{n}{bgr0}\PYG{p}{,} \PYG{n}{cnts}\PYG{p}{,} \PYG{n}{scores\PYGZus{}relax}\PYG{p}{,} \PYG{n}{best\PYGZus{}idx\PYGZus{}relax} \PYG{k}{if} \PYG{n}{relaxed\PYGZus{}ok} \PYG{k}{else} \PYG{k+kc}{None}\PYG{p}{,} \PYG{n}{roi}\PYG{p}{,} \PYG{n}{tag}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{relaxed}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
        \PYG{k}{if} \PYG{o+ow}{not} \PYG{n}{relaxed\PYGZus{}ok}\PYG{p}{:}
            \PYG{k}{if} \PYG{o+ow}{not} \PYG{n}{cnts}\PYG{p}{:}
                \PYG{k}{raise} \PYG{n+ne}{RuntimeError}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{No contornos tras segmentaci√≥n.}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
            \PYG{c+c1}{\PYGZsh{} last\PYGZhy{}resort: largest area}
            \PYG{n}{areas} \PYG{o}{=} \PYG{p}{[}\PYG{n}{cv2}\PYG{o}{.}\PYG{n}{contourArea}\PYG{p}{(}\PYG{n}{c}\PYG{p}{)} \PYG{k}{for} \PYG{n}{c} \PYG{o+ow}{in} \PYG{n}{cnts}\PYG{p}{]}
            \PYG{n}{use\PYGZus{}idx} \PYG{o}{=} \PYG{n+nb}{int}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{argmax}\PYG{p}{(}\PYG{n}{areas}\PYG{p}{)}\PYG{p}{)}
        \PYG{k}{else}\PYG{p}{:}
            \PYG{n}{use\PYGZus{}idx} \PYG{o}{=} \PYG{n}{best\PYGZus{}idx\PYGZus{}relax}
        \PYG{n}{used\PYGZus{}scores} \PYG{o}{=} \PYG{n}{scores\PYGZus{}relax}
    \PYG{k}{else}\PYG{p}{:}
        \PYG{n}{use\PYGZus{}idx} \PYG{o}{=} \PYG{n}{best\PYGZus{}idx}
        \PYG{n}{used\PYGZus{}scores} \PYG{o}{=} \PYG{n}{scores\PYGZus{}strict}

    \PYG{n}{cnt} \PYG{o}{=} \PYG{n}{cnts}\PYG{p}{[}\PYG{n}{use\PYGZus{}idx}\PYG{p}{]}

    \PYG{c+c1}{\PYGZsh{} 6) PCA measures}
    \PYG{n}{pts} \PYG{o}{=} \PYG{n}{cnt}\PYG{o}{.}\PYG{n}{reshape}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{)}\PYG{o}{.}\PYG{n}{astype}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{float32}\PYG{p}{)}
    \PYG{n}{mean}\PYG{p}{,} \PYG{n}{eigvecs}\PYG{p}{,} \PYG{n}{\PYGZus{}} \PYG{o}{=} \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{PCACompute2}\PYG{p}{(}\PYG{n}{pts}\PYG{p}{,} \PYG{n}{mean}\PYG{o}{=}\PYG{k+kc}{None}\PYG{p}{)}
    \PYG{n}{mean} \PYG{o}{=} \PYG{n}{mean}\PYG{o}{.}\PYG{n}{flatten}\PYG{p}{(}\PYG{p}{)}
    \PYG{n}{R} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{asarray}\PYG{p}{(}\PYG{n}{eigvecs}\PYG{p}{,} \PYG{n}{np}\PYG{o}{.}\PYG{n}{float32}\PYG{p}{)}
    \PYG{n}{pts\PYGZus{}c} \PYG{o}{=} \PYG{n}{pts} \PYG{o}{\PYGZhy{}} \PYG{n}{mean}
    \PYG{n}{pts\PYGZus{}r} \PYG{o}{=} \PYG{n}{pts\PYGZus{}c} \PYG{o}{@} \PYG{n}{R}\PYG{o}{.}\PYG{n}{T}
    \PYG{n}{min\PYGZus{}x}\PYG{p}{,} \PYG{n}{max\PYGZus{}x} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{min}\PYG{p}{(}\PYG{n}{pts\PYGZus{}r}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{)}\PYG{p}{,} \PYG{n}{np}\PYG{o}{.}\PYG{n}{max}\PYG{p}{(}\PYG{n}{pts\PYGZus{}r}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{)}
    \PYG{n}{min\PYGZus{}y}\PYG{p}{,} \PYG{n}{max\PYGZus{}y} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{min}\PYG{p}{(}\PYG{n}{pts\PYGZus{}r}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)}\PYG{p}{,} \PYG{n}{np}\PYG{o}{.}\PYG{n}{max}\PYG{p}{(}\PYG{n}{pts\PYGZus{}r}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)}
    \PYG{n}{length\PYGZus{}px} \PYG{o}{=} \PYG{n+nb}{float}\PYG{p}{(}\PYG{n}{max\PYGZus{}x} \PYG{o}{\PYGZhy{}} \PYG{n}{min\PYGZus{}x}\PYG{p}{)}
    \PYG{n}{width\PYGZus{}px}  \PYG{o}{=} \PYG{n+nb}{float}\PYG{p}{(}\PYG{n}{max\PYGZus{}y} \PYG{o}{\PYGZhy{}} \PYG{n}{min\PYGZus{}y}\PYG{p}{)}
    \PYG{n}{area\PYGZus{}px2}  \PYG{o}{=} \PYG{n+nb}{float}\PYG{p}{(}\PYG{n}{cv2}\PYG{o}{.}\PYG{n}{contourArea}\PYG{p}{(}\PYG{n}{cnt}\PYG{p}{)}\PYG{p}{)}

    \PYG{c+c1}{\PYGZsh{} 7) Overlay}
    \PYG{n}{rgb} \PYG{o}{=} \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{cvtColor}\PYG{p}{(}\PYG{n}{bgr0}\PYG{p}{,} \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{COLOR\PYGZus{}BGR2RGB}\PYG{p}{)}
    \PYG{n}{overlay} \PYG{o}{=} \PYG{n}{rgb}\PYG{o}{.}\PYG{n}{copy}\PYG{p}{(}\PYG{p}{)}
    \PYG{n}{box\PYGZus{}r} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{p}{[}\PYG{p}{[}\PYG{n}{min\PYGZus{}x}\PYG{p}{,} \PYG{n}{min\PYGZus{}y}\PYG{p}{]}\PYG{p}{,} \PYG{p}{[}\PYG{n}{max\PYGZus{}x}\PYG{p}{,} \PYG{n}{min\PYGZus{}y}\PYG{p}{]}\PYG{p}{,} \PYG{p}{[}\PYG{n}{max\PYGZus{}x}\PYG{p}{,} \PYG{n}{max\PYGZus{}y}\PYG{p}{]}\PYG{p}{,} \PYG{p}{[}\PYG{n}{min\PYGZus{}x}\PYG{p}{,} \PYG{n}{max\PYGZus{}y}\PYG{p}{]}\PYG{p}{]}\PYG{p}{,} \PYG{n}{np}\PYG{o}{.}\PYG{n}{float32}\PYG{p}{)}
    \PYG{n}{box\PYGZus{}img} \PYG{o}{=} \PYG{p}{(}\PYG{n}{box\PYGZus{}r} \PYG{o}{@} \PYG{n}{R}\PYG{p}{)} \PYG{o}{+} \PYG{n}{mean}
    \PYG{n}{box\PYGZus{}img} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{int32}\PYG{p}{(}\PYG{n}{box\PYGZus{}img}\PYG{p}{)}
    \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{drawContours}\PYG{p}{(}\PYG{n}{overlay}\PYG{p}{,} \PYG{p}{[}\PYG{n}{cnt}\PYG{p}{]}\PYG{p}{,} \PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{255}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{)}\PYG{p}{,} \PYG{l+m+mi}{3}\PYG{p}{)}
    \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{polylines}\PYG{p}{(}\PYG{n}{overlay}\PYG{p}{,} \PYG{p}{[}\PYG{n}{box\PYGZus{}img}\PYG{p}{]}\PYG{p}{,} \PYG{k+kc}{True}\PYG{p}{,} \PYG{p}{(}\PYG{l+m+mi}{255}\PYG{p}{,} \PYG{l+m+mi}{255}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{)}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{)}
    \PYG{n}{i\PYGZus{}max} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{argmax}\PYG{p}{(}\PYG{n}{pts\PYGZus{}r}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{)}\PYG{p}{;} \PYG{n}{i\PYGZus{}min} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{argmin}\PYG{p}{(}\PYG{n}{pts\PYGZus{}r}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{)}
    \PYG{n}{p1} \PYG{o}{=} \PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{p}{[}\PYG{n}{pts\PYGZus{}r}\PYG{p}{[}\PYG{n}{i\PYGZus{}min}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,} \PYG{l+m+mf}{0.0}\PYG{p}{]}\PYG{p}{,} \PYG{n}{np}\PYG{o}{.}\PYG{n}{float32}\PYG{p}{)} \PYG{o}{@} \PYG{n}{R}\PYG{p}{)} \PYG{o}{+} \PYG{n}{mean}
    \PYG{n}{p2} \PYG{o}{=} \PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{p}{[}\PYG{n}{pts\PYGZus{}r}\PYG{p}{[}\PYG{n}{i\PYGZus{}max}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,} \PYG{l+m+mf}{0.0}\PYG{p}{]}\PYG{p}{,} \PYG{n}{np}\PYG{o}{.}\PYG{n}{float32}\PYG{p}{)} \PYG{o}{@} \PYG{n}{R}\PYG{p}{)} \PYG{o}{+} \PYG{n}{mean}
    \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{line}\PYG{p}{(}\PYG{n}{overlay}\PYG{p}{,} \PYG{n+nb}{tuple}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{int32}\PYG{p}{(}\PYG{n}{p1}\PYG{p}{)}\PYG{p}{)}\PYG{p}{,} \PYG{n+nb}{tuple}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{int32}\PYG{p}{(}\PYG{n}{p2}\PYG{p}{)}\PYG{p}{)}\PYG{p}{,} \PYG{p}{(}\PYG{l+m+mi}{255}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{)}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{)}
    \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{rectangle}\PYG{p}{(}\PYG{n}{overlay}\PYG{p}{,} \PYG{p}{(}\PYG{n}{x}\PYG{p}{,} \PYG{n}{y}\PYG{p}{)}\PYG{p}{,} \PYG{p}{(}\PYG{n}{x} \PYG{o}{+} \PYG{n}{w}\PYG{p}{,} \PYG{n}{y} \PYG{o}{+} \PYG{n}{h}\PYG{p}{)}\PYG{p}{,} \PYG{p}{(}\PYG{l+m+mi}{255}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{255}\PYG{p}{)}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{)}

    \PYG{c+c1}{\PYGZsh{} 8) Units}
    \PYG{n}{mm\PYGZus{}per\PYGZus{}px} \PYG{o}{=} \PYG{n}{get\PYGZus{}scale\PYGZus{}mm\PYGZus{}per\PYGZus{}px}\PYG{p}{(}\PYG{p}{)}
    \PYG{k}{if} \PYG{n}{mm\PYGZus{}per\PYGZus{}px} \PYG{o+ow}{and} \PYG{n}{np}\PYG{o}{.}\PYG{n}{isfinite}\PYG{p}{(}\PYG{n}{mm\PYGZus{}per\PYGZus{}px}\PYG{p}{)} \PYG{o+ow}{and} \PYG{n}{mm\PYGZus{}per\PYGZus{}px} \PYG{o}{\PYGZgt{}} \PYG{l+m+mi}{0}\PYG{p}{:}
        \PYG{n}{length\PYGZus{}mm} \PYG{o}{=} \PYG{n}{length\PYGZus{}px} \PYG{o}{*} \PYG{n}{mm\PYGZus{}per\PYGZus{}px}
        \PYG{n}{width\PYGZus{}mm}  \PYG{o}{=} \PYG{n}{width\PYGZus{}px}  \PYG{o}{*} \PYG{n}{mm\PYGZus{}per\PYGZus{}px}
        \PYG{n}{area\PYGZus{}mm2}  \PYG{o}{=} \PYG{n}{area\PYGZus{}px2}  \PYG{o}{*} \PYG{p}{(}\PYG{n}{mm\PYGZus{}per\PYGZus{}px} \PYG{o}{*}\PYG{o}{*} \PYG{l+m+mi}{2}\PYG{p}{)}
    \PYG{k}{else}\PYG{p}{:}
        \PYG{n}{mm\PYGZus{}per\PYGZus{}px} \PYG{o}{=} \PYG{n+nb}{float}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{nan}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{;} \PYG{n}{length\PYGZus{}mm} \PYG{o}{=} \PYG{n}{width\PYGZus{}mm} \PYG{o}{=} \PYG{n}{area\PYGZus{}mm2} \PYG{o}{=} \PYG{n+nb}{float}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{nan}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}

    \PYG{c+c1}{\PYGZsh{} 9) Optional outputs}
    \PYG{n}{mask\PYGZus{}full} \PYG{o}{=} \PYG{p}{(}\PYG{n}{full} \PYG{o}{*} \PYG{l+m+mi}{255}\PYG{p}{)}\PYG{o}{.}\PYG{n}{astype}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{uint8}\PYG{p}{)}
    \PYG{n}{mask\PYGZus{}path} \PYG{o}{=} \PYG{n}{save\PYGZus{}img\PYGZus{}dbg}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{mask\PYGZus{}debug.png}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{mask\PYGZus{}full}\PYG{p}{)}
    \PYG{n}{overlay\PYGZus{}path} \PYG{o}{=} \PYG{n}{save\PYGZus{}img\PYGZus{}dbg}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{overlay\PYGZus{}debug.png}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{cvtColor}\PYG{p}{(}\PYG{n}{overlay}\PYG{p}{,} \PYG{n}{cv2}\PYG{o}{.}\PYG{n}{COLOR\PYGZus{}RGB2BGR}\PYG{p}{)}\PYG{p}{)}

    \PYG{n}{df} \PYG{o}{=} \PYG{n}{pd}\PYG{o}{.}\PYG{n}{DataFrame}\PYG{p}{(}\PYG{p}{[}\PYG{p}{\PYGZob{}}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{image\PYGZus{}path}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{IMG\PYGZus{}PATH}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{roi\PYGZus{}x}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{x}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{roi\PYGZus{}y}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{y}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{roi\PYGZus{}w}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{w}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{roi\PYGZus{}h}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{h}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{length\PYGZus{}px}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{length\PYGZus{}px}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{width\PYGZus{}px}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{width\PYGZus{}px}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{area\PYGZus{}px2}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{area\PYGZus{}px2}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{mm\PYGZus{}per\PYGZus{}px}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n+nb}{float}\PYG{p}{(}\PYG{n}{mm\PYGZus{}per\PYGZus{}px}\PYG{p}{)} \PYG{k}{if} \PYG{n}{np}\PYG{o}{.}\PYG{n}{isfinite}\PYG{p}{(}\PYG{n}{mm\PYGZus{}per\PYGZus{}px}\PYG{p}{)} \PYG{k}{else} \PYG{n}{np}\PYG{o}{.}\PYG{n}{nan}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{length\PYGZus{}mm}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n+nb}{float}\PYG{p}{(}\PYG{n}{length\PYGZus{}mm}\PYG{p}{)} \PYG{k}{if} \PYG{n}{np}\PYG{o}{.}\PYG{n}{isfinite}\PYG{p}{(}\PYG{n}{length\PYGZus{}mm}\PYG{p}{)} \PYG{k}{else} \PYG{n}{np}\PYG{o}{.}\PYG{n}{nan}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{width\PYGZus{}mm}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n+nb}{float}\PYG{p}{(}\PYG{n}{width\PYGZus{}mm}\PYG{p}{)} \PYG{k}{if} \PYG{n}{np}\PYG{o}{.}\PYG{n}{isfinite}\PYG{p}{(}\PYG{n}{width\PYGZus{}mm}\PYG{p}{)} \PYG{k}{else} \PYG{n}{np}\PYG{o}{.}\PYG{n}{nan}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{area\PYGZus{}mm2}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n+nb}{float}\PYG{p}{(}\PYG{n}{area\PYGZus{}mm2}\PYG{p}{)} \PYG{k}{if} \PYG{n}{np}\PYG{o}{.}\PYG{n}{isfinite}\PYG{p}{(}\PYG{n}{area\PYGZus{}mm2}\PYG{p}{)} \PYG{k}{else} \PYG{n}{np}\PYG{o}{.}\PYG{n}{nan}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{best\PYGZus{}score}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n+nb}{float}\PYG{p}{(}\PYG{n}{used\PYGZus{}scores}\PYG{p}{[}\PYG{n}{use\PYGZus{}idx}\PYG{p}{]}\PYG{p}{)} \PYG{k}{if} \PYG{p}{(}\PYG{n}{used\PYGZus{}scores} \PYG{o+ow}{and} \PYG{n}{np}\PYG{o}{.}\PYG{n}{isfinite}\PYG{p}{(}\PYG{n}{used\PYGZus{}scores}\PYG{p}{[}\PYG{n}{use\PYGZus{}idx}\PYG{p}{]}\PYG{p}{)}\PYG{p}{)} \PYG{k}{else} \PYG{n}{np}\PYG{o}{.}\PYG{n}{nan}
    \PYG{p}{\PYGZcb{}}\PYG{p}{]}\PYG{p}{)}
    \PYG{n}{csv\PYGZus{}path} \PYG{o}{=} \PYG{n}{save\PYGZus{}csv\PYGZus{}dbg}\PYG{p}{(}\PYG{n}{df}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{measurements\PYGZus{}debug.csv}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}

    \PYG{k}{return} \PYG{p}{\PYGZob{}}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{roi}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{p}{(}\PYG{n}{x}\PYG{p}{,} \PYG{n}{y}\PYG{p}{,} \PYG{n}{w}\PYG{p}{,} \PYG{n}{h}\PYG{p}{)}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{length\PYGZus{}px}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{length\PYGZus{}px}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{width\PYGZus{}px}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{width\PYGZus{}px}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{area\PYGZus{}px2}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{area\PYGZus{}px2}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{mm\PYGZus{}per\PYGZus{}px}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{mm\PYGZus{}per\PYGZus{}px}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{length\PYGZus{}mm}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{length\PYGZus{}mm}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{width\PYGZus{}mm}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{width\PYGZus{}mm}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{area\PYGZus{}mm2}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{area\PYGZus{}mm2}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{mask\PYGZus{}img}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{mask\PYGZus{}full}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{overlay\PYGZus{}img}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{overlay}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{mask\PYGZus{}path}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{mask\PYGZus{}path}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{overlay\PYGZus{}path}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{overlay\PYGZus{}path}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{csv\PYGZus{}path}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{csv\PYGZus{}path}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{df}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{n}{df}
    \PYG{p}{\PYGZcb{}}
\end{sphinxVerbatim}

\end{sphinxuseclass}\end{sphinxVerbatimInput}

\end{sphinxuseclass}
\sphinxAtStartPar
El algoritmo de visi√≥n desarrollado se sustenta sobre una seria de funciones, cada una responsable de resolver el bloque operativo definido en la figura \hyperref[\detokenize{content/01/Modulo-3:figura-wp1-imagen-6}]{Fig.\@ \ref{\detokenize{content/01/Modulo-3:figura-wp1-imagen-6}}}.


\subsection{Preprocesado}
\label{\detokenize{content/01/Modulo-3:preprocesado}}
\sphinxAtStartPar
Este bloque funcional se sustenta sobre las siguientes funciones:
\begin{itemize}
\item {}
\sphinxAtStartPar
\sphinxstylestrong{prefilter(bgr).} Toma como entrada una imagen BGR (\sphinxcode{\sphinxupquote{np.ndarray}}) y devuelve una versi√≥n prefiltrada en BGR tras aplicar NLMeans (reducci√≥n de ruido no local), filtro bilateral (suavizado que preserva bordes) y CLAHE en el canal V (HSV). Su utilidad es mejorar la relaci√≥n se√±al\sphinxhyphen{}ruido y homogeneizar la iluminaci√≥n antes de la segmentaci√≥n, estabilizando los modelos de apariencia usados por GrabCut y reduciendo artefactos de borde; en t√©rminos pr√°cticos, aten√∫a alta frecuencia sin degradar discontinuidades relevantes (cabeza/cola del pez frente a la cinta).

\item {}
\sphinxAtStartPar
\sphinxstylestrong{dynamic\_blue\_threshold(hsv).} Recibe una imagen en HSV y retorna dos vectores \sphinxcode{\sphinxupquote{lower}} y \sphinxcode{\sphinxupquote{upper}} (umbrales HSV) que acotan din√°micamente el color azul de la cinta. Estima el pico del histograma del canal H en una franja vertical central (filtrada por saturaci√≥n m√≠nima) y construye un intervalo \([\,H_0\pm\Delta H\,]\). Su utilidad es adaptar la detecci√≥n del fondo (cinta) a cambios de c√°mara/iluminaci√≥n, reforzando la separaci√≥n fondo (azul) / no\sphinxhyphen{}fondo para las semillas de GrabCut.

\item {}
\sphinxAtStartPar
\sphinxstylestrong{\_longest\_true\_run(vec\_bool)} Realiza una b√∫squeda lineal del tramo contiguo m√°ximo de verdaderos. Como par√°metro de entrada necesita un vector booleano 1D (np.ndarray) y devuelve \((i, j)\) (√≠ndices inclusive) del segmento m√°s largo con \sphinxstyleemphasis{True}, o \sphinxstyleemphasis{None} si no existe. Se usa para fijar l√≠mites horizontales (columnas) y verticales (filas) de la cinta.

\item {}
\sphinxAtStartPar
\sphinxstylestrong{belt\_roi\_from\_blue(hsv, lower, upper).} Recibe la imagen HSV y los umbrales \sphinxcode{\sphinxupquote{lower/upper}}; devuelve la ROI de la cinta como tupla \sphinxcode{\sphinxupquote{(x, y, w, h)}} y la m√°scara binaria \sphinxcode{\sphinxupquote{blue}}. Umbraliza el azul, limpia con operaciones morfol√≥gicas (apertura/cierre) y toma el \sphinxstyleemphasis{bounding box} de la mayor componente conexa, expandi√©ndolo con \sphinxstyleemphasis{padding}. Su utilidad es anclar espacialmente el problema: restringe la segmentaci√≥n a la banda transportadora (banda a banda), evitando que estructuras ajenas (p. ej., met√°licas) perturben la optimizaci√≥n.

\item {}
\sphinxAtStartPar
\sphinxstylestrong{\_morph(img, op, shape, ksize, iters=1)} Se trata de un envoltorio de la interfaz de OpenCV \sphinxcode{\sphinxupquote{cv2.morphologyEx}} usada para aplicar operaciones morfol√≥gicas apertura, cierre, gradiente morfol√≥gico, tophat, blackhat, hit\sphinxhyphen{}or\sphinxhyphen{}miss) sobre la imagen. Como entrada necesita: img (np.uint8 o convertible), op (operaci√≥n de OpenCV), shape (tipo de elemento estructurante), ksize (tupla de tama√±o), iters (int) retornando la imagen procesada (np.ndarray) y evitando errores de resoluci√≥n de sobrecarga.

\item {}
\sphinxAtStartPar
\sphinxstylestrong{\_open(img, shape, ksize, iters=1)} Aplica una apertura morfol√≥gica especializada con \sphinxcode{\sphinxupquote{cv2.MORPH\_OPEN}}. Se usa para eliminar ruido fino preservando estructuras mayores.

\item {}
\sphinxAtStartPar
\sphinxstylestrong{\_close(img, shape, ksize, iters=1)} Aplica un cierre morfol√≥gico especializado. Misma signatura que \sphinxcode{\sphinxupquote{\_open}} pero con \sphinxcode{\sphinxupquote{cv2.MORPH\_CLOSE}}. Rellena huecos/peque√±as discontinuidades en m√°scaras binarizadas; devuelve np.ndarray.

\end{itemize}


\subsection{Segmentaci√≥n}
\label{\detokenize{content/01/Modulo-3:segmentacion}}\begin{itemize}
\item {}
\sphinxAtStartPar
\sphinxstylestrong{seeds\_in\_roi(bgr\_roi, lower, upper).} Recibe el recorte BGR de la ROI y los umbrales HSV; devuelve \sphinxcode{\sphinxupquote{gc\_mask}}, una m√°scara de estados entera con etiquetas de GrabCut \{BG seguro, PR\_BG, PR\_FG, FG\}. Construye las semillas as√≠: (i) \sphinxstylestrong{BG seguro} = p√≠xeles azules; (ii) \sphinxstylestrong{PR\_FG} = no\sphinxhyphen{}azul dilatado con kernel anisotr√≥pico (alto y estrecho) para conectar zonas finas (cola/cabeza); (iii) \sphinxstylestrong{FG seguro} = no\sphinxhyphen{}azul con alto contraste crom√°tico respecto al azul (combinaci√≥n de distancias en H y S umbraladas por percentil), reforzado mediante \sphinxstylestrong{distance transform} sobre PR\_FG; adem√°s fija el borde de la ROI como BG. Su utilidad es condicionar favorablemente la minimizaci√≥n de la energ√≠a de GrabCut (t√©rmino de datos GMM + t√©rmino de suavidad por corte en grafo), reduciendo fugas y p√©rdidas en extremos.

\end{itemize}


\subsection{Selecci√≥n y medici√≥n}
\label{\detokenize{content/01/Modulo-3:seleccion-y-medicion}}\begin{itemize}
\item {}
\sphinxAtStartPar
\sphinxstylestrong{contour\_scores(cnts, roi, strict=True)} Realiza una ponderaci√≥n morfol√≥gica de candidatos. Como entredas necesita: contornos \sphinxcode{\sphinxupquote{cnts}}, ROI \sphinxcode{\sphinxupquote{(x,y,w,h)}} y un crietrio de severidad. Para cada contorno calcula \sphinxcode{\sphinxupquote{score = √°rea √ó prior(log\sphinxhyphen{}aspecto) √ó solidez}}, aplicando filtros de √°rea, anchura m√≠nima y proximidad a bordes (relajables en modo \sphinxstyleemphasis{non\sphinxhyphen{}strict}). Devuelve una lista de \sphinxcode{\sphinxupquote{float}} alineada con \sphinxcode{\sphinxupquote{cnts}}.

\item {}
\sphinxAtStartPar
\sphinxstylestrong{extractor().} No recibe argumentos y devuelve: \sphinxcode{\sphinxupquote{overlay\_path}}, \sphinxcode{\sphinxupquote{mask\_path}}, \sphinxcode{\sphinxupquote{csv\_path}} (rutas), \sphinxcode{\sphinxupquote{length\_px}}, \sphinxcode{\sphinxupquote{width\_px}}, \sphinxcode{\sphinxupquote{area\_px2}} (magnitudes en p√≠xeles), \sphinxcode{\sphinxupquote{mm\_per\_px}} (si existe) y la \sphinxcode{\sphinxupquote{roi}} empleada. Orquesta todo el pipeline: carga y prefiltra la imagen; estima el umbral azul din√°mico y extrae la ROI de la cinta; genera semillas y ejecuta GrabCut con iteraciones configurables; aplica postproceso morfol√≥gico (cierre/apertura); selecciona el contorno del pez por √°rea + alargamiento; calcula \sphinxstylestrong{longitud} y \sphinxstylestrong{anchura} proyectando el contorno sobre los autovectores de la \sphinxstylestrong{PCA} (extensi√≥n \(\max-\min\) en cada eje) y el \sphinxstylestrong{√°rea} con \sphinxcode{\sphinxupquote{cv2.contourArea}}; finalmente guarda las salidas (overlay, m√°scara y CSV) y convierte a unidades m√©tricas si hay factor de escala disponible.

\end{itemize}


\subsection{Otras funciones}
\label{\detokenize{content/01/Modulo-3:otras-funciones}}
\sphinxAtStartPar
El pipeline tambi√©n proporciona algunas funciones auxiliares como:
\begin{itemize}
\item {}
\sphinxAtStartPar
\sphinxstylestrong{render\_candidates\_debug(bgr\_base, cnts, scores, best\_idx, roi\_xywh, tag)} Es una funci√≥n √∫til en una auditor√≠a visual del criterio de selecci√≥n. Como entradas necesita: imagen base, lista de contornos, lista de scores, √≠ndice del mejor (o \sphinxcode{\sphinxupquote{None}}), ROI \sphinxcode{\sphinxupquote{(x,y,w,h)}} y etiqueta de texto. Dibuja ROI y contornos (verde el seleccionado, rojo el resto) con anotaci√≥n de puntuaci√≥n y guarda el fichero .PNG s√≥lo en modo \sphinxcode{\sphinxupquote{debug}}, devolviendo su ruta o \sphinxcode{\sphinxupquote{None}}.

\item {}
\sphinxAtStartPar
\sphinxstylestrong{save\_img(name, img)} Guarda las im√°genes obtendias en los procesos anteriores. Como variables de entrada usa: \sphinxcode{\sphinxupquote{name (str)}} e \sphinxcode{\sphinxupquote{img (np.ndarray, BGR o 1 canal)}}. Escribe el array en disco en con el par√°metro \sphinxcode{\sphinxupquote{CONFIG{[}"out\_prefix"{]}+name}} y devuelve la ruta escrita \sphinxcode{\sphinxupquote{(str)}}. Esta funci√≥n centraliza la serializaci√≥n de artefactos visuales.

\item {}
\sphinxAtStartPar
\sphinxstylestrong{save\_img\_dbg(name, img)} Esta funci√≥n es similar a la anterior(recibe los mismos par√°metros que \sphinxcode{\sphinxupquote{save\_img}}) pero s√≥lo guarda si \sphinxcode{\sphinxupquote{CONFIG{[}"debug"{]}==True}}. Devuelve la ruta escrita o \sphinxcode{\sphinxupquote{None}} si no hubo escritura. Implementa adem√°s el patr√≥n de side\sphinxhyphen{}effects controlados por flag.

\item {}
\sphinxAtStartPar
\sphinxstylestrong{save\_csv\_dbg(df, name)} Garantiza la persistencia de los resultados del proceso en formato CSV s√≥lo si \sphinxcode{\sphinxupquote{CONFIG{[}"save\_csv"{]}==True}}. Los par√°metros de entreda son un \sphinxcode{\sphinxupquote{df (DataFrame de Pandas)}} y el nombre \sphinxcode{\sphinxupquote{name (str)}} del fichero. Guarda el CSV en \sphinxcode{\sphinxupquote{CONFIG{[}"out\_prefix"{]}+name}} y devuelve la ruta o \sphinxcode{\sphinxupquote{None}}. Permite desacoplar c√≥mputo en memoria de la E/S de informes.

\item {}
\sphinxAtStartPar
\sphinxstylestrong{get\_scale\_mm\_per\_px().} No recibe argumentos y devuelve el factor escalar \sphinxcode{\sphinxupquote{mm\_per\_px}} (flotante) o \sphinxcode{\sphinxupquote{None}} si no est√° disponible. Internamente busca primero una funci√≥n externa del usuario \sphinxcode{\sphinxupquote{get\_mm\_per\_px()}} y, en su defecto, un fichero \sphinxcode{\sphinxupquote{calibracion\_px\_mm.json}} con la clave \sphinxcode{\sphinxupquote{"mm\_per\_px"}}, que deber√≠a existir tras haber realizado una calibraci√≥n. Su utilidad es habilitar la conversi√≥n m√©trica de las magnitudes geom√©tricas estimadas en p√≠xeles ‚Äîlongitud, anchura y √°rea.

\end{itemize}

\sphinxAtStartPar
Para ejecutar el pipeline basta con:

\begin{sphinxuseclass}{cell}\begin{sphinxVerbatimInput}

\begin{sphinxuseclass}{cell_input}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{c+c1}{\PYGZsh{} Execute \PYGZam{} (optional) display}
\PYG{c+c1}{\PYGZsh{} \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{n}{res} \PYG{o}{=} \PYG{n}{extractor}\PYG{p}{(}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Visualizaci√≥n en notebook (no guarda archivos por s√≠ misma)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{12}\PYG{p}{,} \PYG{l+m+mi}{5}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplot}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{;} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Overlay final}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{;} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{imshow}\PYG{p}{(}\PYG{n}{res}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{overlay\PYGZus{}img}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{p}{)}\PYG{p}{;} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{axis}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{off}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplot}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{)}\PYG{p}{;} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{M√°scara final}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{;} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{imshow}\PYG{p}{(}\PYG{n}{res}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{mask\PYGZus{}img}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{p}{,} \PYG{n}{cmap}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{gray}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{;} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{axis}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{off}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}

\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{√Årea de inter√©s (ROI): }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{res}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{roi}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Medidas detectadas: L=}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{res}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{length\PYGZus{}px}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{l+s+si}{:}\PYG{l+s+s2}{.1f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{px  W=}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{res}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{width\PYGZus{}px}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{l+s+si}{:}\PYG{l+s+s2}{.1f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{px  A=}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{res}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{area\PYGZus{}px2}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{l+s+si}{:}\PYG{l+s+s2}{.1f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{px\PYGZca{}2}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{k}{if} \PYG{n}{np}\PYG{o}{.}\PYG{n}{isfinite}\PYG{p}{(}\PYG{n}{res}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{mm\PYGZus{}per\PYGZus{}px}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{p}{)}\PYG{p}{:}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Medidas reales: L=}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{res}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{length\PYGZus{}mm}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{l+s+si}{:}\PYG{l+s+s2}{.2f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{ mm  W=}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{res}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{width\PYGZus{}mm}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{l+s+si}{:}\PYG{l+s+s2}{.2f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{ mm  A=}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{res}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{area\PYGZus{}mm2}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{l+s+si}{:}\PYG{l+s+s2}{.2f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{ mm\PYGZca{}2  Resoluci√≥n }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{res}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{mm\PYGZus{}per\PYGZus{}px}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{l+s+si}{:}\PYG{l+s+s2}{.6f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{ mm/px}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{PNG overlay guardado: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{res}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{overlay\PYGZus{}path}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{PNG m√°scara guardado: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{res}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{mask\PYGZus{}path}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{CSV datos: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{res}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{csv\PYGZus{}path}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\end{sphinxVerbatim}

\end{sphinxuseclass}\end{sphinxVerbatimInput}
\begin{sphinxVerbatimOutput}

\begin{sphinxuseclass}{cell_output}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
√Årea de inter√©s (ROI): (368, 0, 1114, 1080)
Medidas detectadas: L=745.1px  W=293.4px  A=152108.0px\PYGZca{}2
Medidas reales: L=37.25 mm  W=14.67 mm  A=380.27 mm\PYGZca{}2  Resoluci√≥n 0.050000 mm/px
PNG overlay guardado: ./out/sole\PYGZus{}overlay\PYGZus{}debug.png
PNG m√°scara guardado: ./out/sole\PYGZus{}mask\PYGZus{}debug.png
CSV datos: ./out/sole\PYGZus{}measurements\PYGZus{}debug.csv
\end{sphinxVerbatim}

\noindent\sphinxincludegraphics{{2a29c2c420da628fe8d4d169efb8261f0e80cf00ed791003e75cd91b39b231fd}.png}

\end{sphinxuseclass}\end{sphinxVerbatimOutput}

\end{sphinxuseclass}
\sphinxAtStartPar
Como se puede apreciar en las im√°genes del proceso, el \sphinxstyleemphasis{pipeline} define adecuadamente el √°rea de inter√©s al ancho de la cinta (recuadro color violeta) y es capaz detectar el pez (recuadro amarillo) y obtener el contorno (verde) y las medidas del mismo.

\sphinxstepscope


\section{M4 \sphinxhyphen{} Salida y persistencia}
\label{\detokenize{content/01/Modulo-4:m4-salida-y-persistencia}}\label{\detokenize{content/01/Modulo-4::doc}}
\sphinxAtStartPar
El √∫ltimo de los bloques definido en el flujograma \hyperref[\detokenize{content/01/Imagen:figura-wp1-imagen-1}]{Fig.\@ \ref{\detokenize{content/01/Imagen:figura-wp1-imagen-1}}} es el responsable de la ejecuci√≥n del pipeline de procesado de imagen y el registro en MongoDB de los datos obtenidos del pipeline.

\sphinxAtStartPar
Para ello se ha generado un flujo en Node\sphinxhyphen{}RED que recibe la imagen obtenida (ver m√≥dulo M1\sphinxhyphen{}Captura) y ejecuta el c√≥digo python de extracci√≥n de im√°genes. La informaci√≥n de salida del pipeline es recogida y estructurada adecuadamente para su inclusi√≥n en la base de datos. La definici√≥n formal del JSON es la siguiente:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{p}{\PYGZob{}}
\PYG{+w}{  }\PYG{n+nt}{\PYGZdq{}\PYGZdl{}schema\PYGZdq{}}\PYG{p}{:}\PYG{+w}{ }\PYG{l+s+s2}{\PYGZdq{}https://json\PYGZhy{}schema.org/draft/2020\PYGZhy{}12/schema\PYGZdq{}}\PYG{p}{,}
\PYG{+w}{  }\PYG{n+nt}{\PYGZdq{}title\PYGZdq{}}\PYG{p}{:}\PYG{+w}{ }\PYG{l+s+s2}{\PYGZdq{}FishMeasurement\PYGZdq{}}\PYG{p}{,}
\PYG{+w}{  }\PYG{n+nt}{\PYGZdq{}type\PYGZdq{}}\PYG{p}{:}\PYG{+w}{ }\PYG{l+s+s2}{\PYGZdq{}object\PYGZdq{}}\PYG{p}{,}
\PYG{+w}{  }\PYG{n+nt}{\PYGZdq{}properties\PYGZdq{}}\PYG{p}{:}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{    }\PYG{n+nt}{\PYGZdq{}timestamp\PYGZdq{}}\PYG{p}{:}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{      }\PYG{n+nt}{\PYGZdq{}type\PYGZdq{}}\PYG{p}{:}\PYG{+w}{ }\PYG{l+s+s2}{\PYGZdq{}string\PYGZdq{}}\PYG{p}{,}
\PYG{+w}{      }\PYG{n+nt}{\PYGZdq{}format\PYGZdq{}}\PYG{p}{:}\PYG{+w}{ }\PYG{l+s+s2}{\PYGZdq{}date\PYGZhy{}time\PYGZdq{}}\PYG{p}{,}
\PYG{+w}{      }\PYG{n+nt}{\PYGZdq{}description\PYGZdq{}}\PYG{p}{:}\PYG{+w}{ }\PYG{l+s+s2}{\PYGZdq{}Marca temporal ISO 8601 de la medici√≥n (ej. 2025\PYGZhy{}10\PYGZhy{}15T09:30:00Z)\PYGZdq{}}
\PYG{+w}{    }\PYG{p}{\PYGZcb{},}
\PYG{+w}{    }\PYG{n+nt}{\PYGZdq{}metrics\PYGZdq{}}\PYG{p}{:}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{      }\PYG{n+nt}{\PYGZdq{}type\PYGZdq{}}\PYG{p}{:}\PYG{+w}{ }\PYG{l+s+s2}{\PYGZdq{}object\PYGZdq{}}\PYG{p}{,}
\PYG{+w}{      }\PYG{n+nt}{\PYGZdq{}properties\PYGZdq{}}\PYG{p}{:}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{        }\PYG{n+nt}{\PYGZdq{}pixels\PYGZdq{}}\PYG{p}{:}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{          }\PYG{n+nt}{\PYGZdq{}type\PYGZdq{}}\PYG{p}{:}\PYG{+w}{ }\PYG{l+s+s2}{\PYGZdq{}object\PYGZdq{}}\PYG{p}{,}
\PYG{+w}{          }\PYG{n+nt}{\PYGZdq{}properties\PYGZdq{}}\PYG{p}{:}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{            }\PYG{n+nt}{\PYGZdq{}long\PYGZdq{}}\PYG{p}{:}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{              }\PYG{n+nt}{\PYGZdq{}type\PYGZdq{}}\PYG{p}{:}\PYG{+w}{ }\PYG{l+s+s2}{\PYGZdq{}number\PYGZdq{}}\PYG{p}{,}
\PYG{+w}{              }\PYG{n+nt}{\PYGZdq{}multipleOf\PYGZdq{}}\PYG{p}{:}\PYG{+w}{ }\PYG{l+m+mf}{0.01}\PYG{p}{,}
\PYG{+w}{              }\PYG{n+nt}{\PYGZdq{}description\PYGZdq{}}\PYG{p}{:}\PYG{+w}{ }\PYG{l+s+s2}{\PYGZdq{}Longitud en p√≠xeles (2 decimales)\PYGZdq{}}
\PYG{+w}{            }\PYG{p}{\PYGZcb{},}
\PYG{+w}{            }\PYG{n+nt}{\PYGZdq{}width\PYGZdq{}}\PYG{p}{:}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{              }\PYG{n+nt}{\PYGZdq{}type\PYGZdq{}}\PYG{p}{:}\PYG{+w}{ }\PYG{l+s+s2}{\PYGZdq{}number\PYGZdq{}}\PYG{p}{,}
\PYG{+w}{              }\PYG{n+nt}{\PYGZdq{}multipleOf\PYGZdq{}}\PYG{p}{:}\PYG{+w}{ }\PYG{l+m+mf}{0.01}\PYG{p}{,}
\PYG{+w}{              }\PYG{n+nt}{\PYGZdq{}description\PYGZdq{}}\PYG{p}{:}\PYG{+w}{ }\PYG{l+s+s2}{\PYGZdq{}Anchura en p√≠xeles (2 decimales)\PYGZdq{}}
\PYG{+w}{            }\PYG{p}{\PYGZcb{},}
\PYG{+w}{            }\PYG{n+nt}{\PYGZdq{}surface\PYGZdq{}}\PYG{p}{:}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{              }\PYG{n+nt}{\PYGZdq{}type\PYGZdq{}}\PYG{p}{:}\PYG{+w}{ }\PYG{l+s+s2}{\PYGZdq{}number\PYGZdq{}}\PYG{p}{,}
\PYG{+w}{              }\PYG{n+nt}{\PYGZdq{}multipleOf\PYGZdq{}}\PYG{p}{:}\PYG{+w}{ }\PYG{l+m+mf}{0.01}\PYG{p}{,}
\PYG{+w}{              }\PYG{n+nt}{\PYGZdq{}description\PYGZdq{}}\PYG{p}{:}\PYG{+w}{ }\PYG{l+s+s2}{\PYGZdq{}Superficie en p√≠xeles cuadrados (2 decimales)\PYGZdq{}}
\PYG{+w}{            }\PYG{p}{\PYGZcb{}}
\PYG{+w}{          }\PYG{p}{\PYGZcb{},}
\PYG{+w}{          }\PYG{n+nt}{\PYGZdq{}required\PYGZdq{}}\PYG{p}{:}\PYG{+w}{ }\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}long\PYGZdq{}}\PYG{p}{,}\PYG{+w}{ }\PYG{l+s+s2}{\PYGZdq{}width\PYGZdq{}}\PYG{p}{,}\PYG{+w}{ }\PYG{l+s+s2}{\PYGZdq{}surface\PYGZdq{}}\PYG{p}{]}
\PYG{+w}{        }\PYG{p}{\PYGZcb{},}
\PYG{+w}{        }\PYG{n+nt}{\PYGZdq{}mm\PYGZdq{}}\PYG{p}{:}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{          }\PYG{n+nt}{\PYGZdq{}type\PYGZdq{}}\PYG{p}{:}\PYG{+w}{ }\PYG{l+s+s2}{\PYGZdq{}object\PYGZdq{}}\PYG{p}{,}
\PYG{+w}{          }\PYG{n+nt}{\PYGZdq{}properties\PYGZdq{}}\PYG{p}{:}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{            }\PYG{n+nt}{\PYGZdq{}long\PYGZdq{}}\PYG{p}{:}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{              }\PYG{n+nt}{\PYGZdq{}type\PYGZdq{}}\PYG{p}{:}\PYG{+w}{ }\PYG{l+s+s2}{\PYGZdq{}number\PYGZdq{}}\PYG{p}{,}
\PYG{+w}{              }\PYG{n+nt}{\PYGZdq{}multipleOf\PYGZdq{}}\PYG{p}{:}\PYG{+w}{ }\PYG{l+m+mf}{0.01}\PYG{p}{,}
\PYG{+w}{              }\PYG{n+nt}{\PYGZdq{}description\PYGZdq{}}\PYG{p}{:}\PYG{+w}{ }\PYG{l+s+s2}{\PYGZdq{}Longitud en mil√≠metros (2 decimales)\PYGZdq{}}
\PYG{+w}{            }\PYG{p}{\PYGZcb{},}
\PYG{+w}{            }\PYG{n+nt}{\PYGZdq{}width\PYGZdq{}}\PYG{p}{:}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{              }\PYG{n+nt}{\PYGZdq{}type\PYGZdq{}}\PYG{p}{:}\PYG{+w}{ }\PYG{l+s+s2}{\PYGZdq{}number\PYGZdq{}}\PYG{p}{,}
\PYG{+w}{              }\PYG{n+nt}{\PYGZdq{}multipleOf\PYGZdq{}}\PYG{p}{:}\PYG{+w}{ }\PYG{l+m+mf}{0.01}\PYG{p}{,}
\PYG{+w}{              }\PYG{n+nt}{\PYGZdq{}description\PYGZdq{}}\PYG{p}{:}\PYG{+w}{ }\PYG{l+s+s2}{\PYGZdq{}Anchura en mil√≠metros (2 decimales)\PYGZdq{}}
\PYG{+w}{            }\PYG{p}{\PYGZcb{},}
\PYG{+w}{            }\PYG{n+nt}{\PYGZdq{}surface\PYGZdq{}}\PYG{p}{:}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{              }\PYG{n+nt}{\PYGZdq{}type\PYGZdq{}}\PYG{p}{:}\PYG{+w}{ }\PYG{l+s+s2}{\PYGZdq{}number\PYGZdq{}}\PYG{p}{,}
\PYG{+w}{              }\PYG{n+nt}{\PYGZdq{}multipleOf\PYGZdq{}}\PYG{p}{:}\PYG{+w}{ }\PYG{l+m+mf}{0.01}\PYG{p}{,}
\PYG{+w}{              }\PYG{n+nt}{\PYGZdq{}description\PYGZdq{}}\PYG{p}{:}\PYG{+w}{ }\PYG{l+s+s2}{\PYGZdq{}Superficie en mil√≠metros cuadrados (2 decimales)\PYGZdq{}}
\PYG{+w}{            }\PYG{p}{\PYGZcb{}}
\PYG{+w}{          }\PYG{p}{\PYGZcb{},}
\PYG{+w}{          }\PYG{n+nt}{\PYGZdq{}required\PYGZdq{}}\PYG{p}{:}\PYG{+w}{ }\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}long\PYGZdq{}}\PYG{p}{,}\PYG{+w}{ }\PYG{l+s+s2}{\PYGZdq{}width\PYGZdq{}}\PYG{p}{,}\PYG{+w}{ }\PYG{l+s+s2}{\PYGZdq{}surface\PYGZdq{}}\PYG{p}{]}
\PYG{+w}{        }\PYG{p}{\PYGZcb{}}
\PYG{+w}{      }\PYG{p}{\PYGZcb{},}
\PYG{+w}{      }\PYG{n+nt}{\PYGZdq{}required\PYGZdq{}}\PYG{p}{:}\PYG{+w}{ }\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}pixels\PYGZdq{}}\PYG{p}{,}\PYG{+w}{ }\PYG{l+s+s2}{\PYGZdq{}mm\PYGZdq{}}\PYG{p}{]}
\PYG{+w}{    }\PYG{p}{\PYGZcb{},}
\PYG{+w}{    }\PYG{n+nt}{\PYGZdq{}size\PYGZdq{}}\PYG{p}{:}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{      }\PYG{n+nt}{\PYGZdq{}type\PYGZdq{}}\PYG{p}{:}\PYG{+w}{ }\PYG{l+s+s2}{\PYGZdq{}string\PYGZdq{}}\PYG{p}{,}
\PYG{+w}{      }\PYG{n+nt}{\PYGZdq{}enum\PYGZdq{}}\PYG{p}{:}\PYG{+w}{ }\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}small\PYGZdq{}}\PYG{p}{,}\PYG{+w}{ }\PYG{l+s+s2}{\PYGZdq{}medium\PYGZdq{}}\PYG{p}{,}\PYG{+w}{ }\PYG{l+s+s2}{\PYGZdq{}large\PYGZdq{}}\PYG{p}{],}
\PYG{+w}{      }\PYG{n+nt}{\PYGZdq{}description\PYGZdq{}}\PYG{p}{:}\PYG{+w}{ }\PYG{l+s+s2}{\PYGZdq{}Clasificaci√≥n del pez seg√∫n sus dimensiones\PYGZdq{}}
\PYG{+w}{    }\PYG{p}{\PYGZcb{}}
\PYG{+w}{  }\PYG{p}{\PYGZcb{},}
\PYG{+w}{  }\PYG{n+nt}{\PYGZdq{}required\PYGZdq{}}\PYG{p}{:}\PYG{+w}{ }\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}timestamp\PYGZdq{}}\PYG{p}{,}\PYG{+w}{ }\PYG{l+s+s2}{\PYGZdq{}metrics\PYGZdq{}}\PYG{p}{,}\PYG{+w}{ }\PYG{l+s+s2}{\PYGZdq{}size\PYGZdq{}}\PYG{p}{]}
\PYG{p}{\PYGZcb{}}
\end{sphinxVerbatim}

\sphinxAtStartPar
El flujo de Node\sphinxhyphen{}Red responsable de salida y persistencia de los datos es el que se recoge en la siguiente figura.

\begin{figure}[htbp]
\centering
\capstart

\noindent\sphinxincludegraphics[width=1.000\linewidth]{{Modulo-4_nodered}.png}
\caption{Flujo Node\sphinxhyphen{}RED para persistencia de datos de tama√±o}\label{\detokenize{content/01/Modulo-4:figura-wp1-imagen-8}}\end{figure}

\sphinxstepscope


\part{PT2 \sphinxhyphen{} Datasets}

\sphinxstepscope


\chapter{Obtenci√≥n y etiquetado del dataset}
\label{\detokenize{content/02/Dataset:obtencion-y-etiquetado-del-dataset}}\label{\detokenize{content/02/Dataset::doc}}
\begin{sphinxadmonition}{note}{Resumen}

\sphinxAtStartPar
Este art√≠culo presenta la metodolog√≠a utilizada en la recopilaci√≥n de un conjunto de datos o \sphinxstyleemphasis{dataset}  representativo que relacione las dimensiones corporales de los lenguados con su peso real en condiciones controladas. Para ello se ha contado con la colaboraci√≥n del equipo de producci√≥n de Safistela S.A (\sphinxhref{https://seaeight.eu/seaeight}{Sea8}) para garantizar los controles de calidad estad√≠sticas y el cumplimiento de los est√°ndares √©ticos en investigaci√≥n acu√≠cola.

\sphinxAtStartPar
\sphinxstylestrong{Entregable}: E2.1\\
\sphinxstylestrong{Versi√≥n}: 1.0\\
\sphinxstylestrong{Autor}: Javier √Ålvarez Osuna\\
\sphinxstylestrong{Email}: javier.osuna@fishfarmfeeder.com\\
\sphinxstylestrong{ORCID}: \sphinxhref{https://orcid.org/0000-0001-7063-1279}{0000\sphinxhyphen{}0001\sphinxhyphen{}7063\sphinxhyphen{}1279}\\
\sphinxstylestrong{Licencia}: CC\sphinxhyphen{}BY\sphinxhyphen{}4.0\\
\sphinxstylestrong{C√≥digo proyecto}: IG408M.2025.000.000072

\begin{figure}[H]
\centering

\noindent\sphinxincludegraphics[width=1.000\linewidth]{{FLATCLASS_logo_publicidad}.png}
\end{figure}
\end{sphinxadmonition}


\section{Introducci√≥n}
\label{\detokenize{content/02/Dataset:introduccion}}
\sphinxAtStartPar
El desarrollo de modelos precisos para la estimaci√≥n de peso en peces planos, como el lenguado (Solea spp.), requiere de conjuntos de datos morfom√©tricos robustos que capturen la relaci√≥n entre las dimensiones corporales y el peso real en condiciones controladas. Estas relaciones son fundamentales para aplicaciones en acuicultura, donde la monitorizaci√≥n no invasiva del crecimiento optimiza el manejo productivo y reduce el estr√©s en los organismos {[}\sphinxhref{https://doi.org/10.1371/journal.pone.0157890}{Tak√°cs et al., 2015}{]}. En particular, los juveniles entre 70 \sphinxhyphen{} 90 d√≠as representan una fase cr√≠tica del desarrollo, en la que variaciones en la longitud, altura y anchura pueden correlacionarse significativamente con cambios en la biomasa, siempre que las mediciones se realicen con precisi√≥n y minimizando perturbaciones {[}\sphinxhref{https://doi.org/10.1016/j.aquaculture.2011.03.011}{Costas et al., 2013}{]}.

\sphinxAtStartPar
No obstante, la adquisici√≥n de estos datos enfrenta un desaf√≠o metodol√≥gico clave: equilibrar la exactitud de las mediciones con el bienestar animal. Estudios previos han demostrado que la manipulaci√≥n repetida de ejemplares juveniles induce estr√©s agudo, afectando no solo su fisiolog√≠a, sino tambi√©n la fiabilidad de los datos morfom√©tricos al alterar su postura natural {[}\sphinxhref{https://link.springer.com/article/10.1007/s10695-011-9518-8}{Martins et al., 2012}{]}. Por ello, el protocolo para la obtenci√≥n de los valores morfom√©tricos necesarios se dise√±√≥ bajo el principio de \sphinxstylestrong{‚Äúmedida √∫nica estandarizada‚Äù}, respaldado por controles de calidad estad√≠sticos y t√©cnicas de sedaci√≥n suave, para garantizar tanto la representatividad de los datos como el cumplimiento de los est√°ndares √©ticos en investigaci√≥n acu√≠cola {[}\sphinxhref{https://doi.org/10.1016/j.applanim.2004.02.003}{Conte, 2004}{]}. La metodolog√≠a descrita a continuaci√≥n proporciona un marco reproducible para obtener datos reales confiables, esenciales para el desarrollo de algoritmos de estimaci√≥n de peso en lenguados.


\section{M√©todolog√≠a para la adquisici√≥n de datos morfom√©tricos}
\label{\detokenize{content/02/Dataset:metodologia-para-la-adquisicion-de-datos-morfometricos}}

\subsection{Preparaci√≥n de los Ejemplares}
\label{\detokenize{content/02/Dataset:preparacion-de-los-ejemplares}}
\sphinxAtStartPar
Los juveniles de lenguado (90 d√≠as post\sphinxhyphen{}eclosi√≥n) fueron previamente aclimatados durante 24 h en tanques de cuarentena con condiciones controladas (temperatura: 18 ¬± 1¬∞C, salinidad: 35 ¬± 1 ppt, ox√≠geno disuelto: >6 mg/L) para minimizar el estr√©s asociado al manejo {[}\sphinxhref{https://link.springer.com/article/10.1007/s10695-011-9518-8}{Martins et al., 2012}{]}. Antes de las mediciones, se realiz√≥ un ayuno de 12 h para evitar variaciones en el peso corporal debido a la ingesta de alimento.


\subsection{Protocolo de Medici√≥n}
\label{\detokenize{content/02/Dataset:protocolo-de-medicion}}
\sphinxAtStartPar
Las mediciones morfom√©tricas (peso, longitud total, altura y anchura) se realizaron siguiendo un enfoque de medida √∫nica por variable, fundamentado en criterios de bienestar animal y reproducibilidad estad√≠stica. Cada individuo fue manipulado por un √∫nico operador entrenado, utilizando instrumental calibrado (balanza digital de precisi√≥n ¬±0.01 g y calibrador digital ¬±0.01 cm). Para garantizar la estandarizaci√≥n, la longitud total se midi√≥ desde el rostro hasta el extremo del l√≥bulo caudal en posici√≥n natural, mientras que la altura y anchura se registraron en la regi√≥n de m√°xima dimensi√≥n corporal {[}\sphinxhref{https://www.researchgate.net/publication/282421080\_Advanced\_Techniques\_for\_Morphometric\_Analysis\_in\_Fish}{Tonna 2015}{]}.

\sphinxAtStartPar
La decisi√≥n de no replicar las mediciones se bas√≥ en evidencias que demuestran que la manipulaci√≥n repetida induce estr√©s agudo en estadios juveniles, afectando su homeostasis osm√≥tica y aumentando la mortalidad post\sphinxhyphen{}manejo (Costas et al., 2013). Las r√©plicas requieren mayor tiempo fuera del agua, generando hipoxia y acidosis tisular. Estudios en \sphinxstyleemphasis{Solea senegalensis} muestran que exposiciones > 30 segundos alteran el equilibrio osm√≥tico {[}\sphinxhref{https://doi.org/10.1016/j.aquaculture.2011.03.011}{Costas et al., 2013}{]}. Adem√°s, cada contacto adicional incrementa el riesgo de lesiones (ej. descamaci√≥n, da√±o en aletas) y eleva los niveles de cortisol, afectando su fisiolog√≠a y crecimiento posterior {[}\sphinxhref{https://doi.org/10.1016/j.applanim.2004.02.003}{Conte, 2004}{]}.

\sphinxAtStartPar
Para mitigar riesgos, se emple√≥ sedaci√≥n suave, protocolo validado previamente por el personal facultativo de Safistela S.A (Sea8). Cada ejemplar fue medido en un tiempo m√°ximo de 20 segundos fuera del agua, sobre una superficie h√∫meda para reducir la p√©rdida de mucus.


\subsection{Consideraciones √âticas y de Bienestar}
\label{\detokenize{content/02/Dataset:consideraciones-eticas-y-de-bienestar}}
\sphinxAtStartPar
El protocolo cumpli√≥ con las directrices de la UE (2010/63/EU) para la reducci√≥n del estr√©s en animales de experimentaci√≥n. Se evit√≥ la manipulaci√≥n repetida y se monitorizaron signos de estr√©s post\sphinxhyphen{}manejo (ej. nataci√≥n err√°tica o falta de alimentaci√≥n durante 2 h posteriores). Los ejemplares fueron reintegrados inmediatamente a tanques de recuperaci√≥n con flujo de agua continuo y sombreado para minimizar perturbaciones.


\subsection{Estructura de los datos}
\label{\detokenize{content/02/Dataset:estructura-de-los-datos}}
\sphinxAtStartPar
La base de datos se organiz√≥ en una hoja de Excel con 209 registros y 5 variables (columnas)


\begin{savenotes}\sphinxattablestart
\sphinxthistablewithglobalstyle
\centering
\begin{tabulary}{\linewidth}[t]{TTTT}
\sphinxtoprule
\sphinxstyletheadfamily
\sphinxAtStartPar
Variable
&\sphinxstyletheadfamily
\sphinxAtStartPar
Tipo de Dato
&\sphinxstyletheadfamily
\sphinxAtStartPar
Unidad
&\sphinxstyletheadfamily
\sphinxAtStartPar
Descripci√≥n
\\
\sphinxmidrule
\sphinxtableatstartofbodyhook
\sphinxAtStartPar
ID\_Ejemplar
&
\sphinxAtStartPar
Num√©rico
&
\sphinxAtStartPar
\sphinxhyphen{}
&
\sphinxAtStartPar
N√∫mero entero correlativo.
\\
\sphinxhline
\sphinxAtStartPar
Peso
&
\sphinxAtStartPar
Num√©rico
&
\sphinxAtStartPar
gramos (g)
&
\sphinxAtStartPar
Peso corporal.
\\
\sphinxhline
\sphinxAtStartPar
Longitud
&
\sphinxAtStartPar
Num√©rico
&
\sphinxAtStartPar
cm
&
\sphinxAtStartPar
Longitud total.
\\
\sphinxhline
\sphinxAtStartPar
Altura
&
\sphinxAtStartPar
Num√©rico
&
\sphinxAtStartPar
cm
&
\sphinxAtStartPar
Altura m√°xima del cuerpo.
\\
\sphinxhline
\sphinxAtStartPar
Anchura
&
\sphinxAtStartPar
Num√©rico
&
\sphinxAtStartPar
cm
&
\sphinxAtStartPar
Anchura m√°xima del cuerpo.
\\
\sphinxbottomrule
\end{tabulary}
\sphinxtableafterendhook\par
\sphinxattableend\end{savenotes}


\section{Inspecci√≥n general del conjunto de datos}
\label{\detokenize{content/02/Dataset:inspeccion-general-del-conjunto-de-datos}}
\begin{sphinxuseclass}{cell}\begin{sphinxVerbatimInput}

\begin{sphinxuseclass}{cell_input}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{pandas}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{pd}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{numpy}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{np}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{matplotlib}\PYG{n+nn}{.}\PYG{n+nn}{pyplot}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{plt}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{seaborn}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{sns}

\PYG{c+c1}{\PYGZsh{} Leer el dataset}
\PYG{n}{file\PYGZus{}path} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{.././data/Dimensiones\PYGZus{}lenguado.xlsx}\PYG{l+s+s1}{\PYGZsq{}}
\PYG{n}{df} \PYG{o}{=} \PYG{n}{pd}\PYG{o}{.}\PYG{n}{read\PYGZus{}excel}\PYG{p}{(}\PYG{n}{file\PYGZus{}path}\PYG{p}{)}

\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Forma:}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{df}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{)}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s2}{ Visualizaci√≥n de los 20 primeros registros}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n}{display}\PYG{p}{(}\PYG{n}{df}\PYG{o}{.}\PYG{n}{head}\PYG{p}{(}\PYG{l+m+mi}{15}\PYG{p}{)}\PYG{p}{)}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s2}{ Estad√≠stica b√°sica}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n}{display}\PYG{p}{(}\PYG{n}{df}\PYG{o}{.}\PYG{n}{describe}\PYG{p}{(}\PYG{p}{)}\PYG{o}{.}\PYG{n}{transpose}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}
\end{sphinxVerbatim}

\end{sphinxuseclass}\end{sphinxVerbatimInput}
\begin{sphinxVerbatimOutput}

\begin{sphinxuseclass}{cell_output}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
Forma: (209, 4)

 Visualizaci√≥n de los 20 primeros registros
\end{sphinxVerbatim}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
    Peso (g)  Longitud (cm)  Anchura (cm)  Altura (cm)
0       0.46            3.3           1.3          0.2
1       1.08            4.5           1.1          0.3
2       0.67            3.9           1.5          0.2
3       0.98            4.4           1.7          0.3
4       0.93            4.2           1.8          0.3
5       1.89            4.5           2.0          0.4
6       1.60            5.1           1.8          0.3
7       1.90            5.0           2.0          0.3
8       1.59            5.4           1.9          0.3
9       1.67            5.4           1.9          0.3
10      1.91            5.4           1.9          0.3
11      1.94            5.4           1.9          0.3
12      2.08            5.5           1.9          0.3
13      1.72            5.4           2.0          0.3
14      1.77            5.4           2.0          0.3
\end{sphinxVerbatim}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
 Estad√≠stica b√°sica
\end{sphinxVerbatim}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
               count      mean       std   min   25\PYGZpc{}   50\PYGZpc{}   75\PYGZpc{}    max
Peso (g)       209.0  5.344641  3.635514  0.46  2.82  4.29  6.96  21.98
Longitud (cm)  209.0  7.244498  1.505369  3.30  6.10  7.00  8.30  11.40
Anchura (cm)   209.0  2.788995  0.698297  1.10  2.30  2.70  3.30   5.20
Altura (cm)    209.0  0.462679  0.117033  0.20  0.40  0.50  0.50   0.90
\end{sphinxVerbatim}

\end{sphinxuseclass}\end{sphinxVerbatimOutput}

\end{sphinxuseclass}

\subsection{Distribuciones univariantes}
\label{\detokenize{content/02/Dataset:distribuciones-univariantes}}
\begin{sphinxuseclass}{cell}\begin{sphinxVerbatimInput}

\begin{sphinxuseclass}{cell_input}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} DISTRIBUCIONES UNIVARIANTES}
\PYG{c+c1}{\PYGZsh{} \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{n}{numeric\PYGZus{}cols} \PYG{o}{=} \PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Peso (g)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Longitud (cm)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Anchura (cm)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Altura (cm)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}

\PYG{k}{for} \PYG{n}{col} \PYG{o+ow}{in} \PYG{n}{numeric\PYGZus{}cols}\PYG{p}{:}
    \PYG{n}{fig}\PYG{p}{,} \PYG{n}{ax} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplots}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{l+m+mi}{4}\PYG{p}{)}\PYG{p}{)}
    \PYG{n}{sns}\PYG{o}{.}\PYG{n}{histplot}\PYG{p}{(}\PYG{n}{df}\PYG{p}{[}\PYG{n}{col}\PYG{p}{]}\PYG{p}{,} \PYG{n}{kde}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{,} \PYG{n}{ax}\PYG{o}{=}\PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{\PYGZsh{}3EADB0}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    \PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Histograma \PYGZhy{} }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{col}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    \PYG{n}{sns}\PYG{o}{.}\PYG{n}{violinplot}\PYG{p}{(}\PYG{n}{y}\PYG{o}{=}\PYG{n}{df}\PYG{p}{[}\PYG{n}{col}\PYG{p}{]}\PYG{p}{,} \PYG{n}{ax}\PYG{o}{=}\PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{n}{inner}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{quartile}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    \PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Violinplot \PYGZhy{} }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{col}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
\end{sphinxVerbatim}

\end{sphinxuseclass}\end{sphinxVerbatimInput}
\begin{sphinxVerbatimOutput}

\begin{sphinxuseclass}{cell_output}
\noindent\sphinxincludegraphics{{164f9ed551f0c0f5142355ae586e9e2a19570f5ab9d8ddc807f3ed5c875958b0}.png}

\noindent\sphinxincludegraphics{{ea37e27b71cebb779007811c459223cf4824825a22d820ffcf24b04cd9fd6df0}.png}

\noindent\sphinxincludegraphics{{bdc4e67ea39df3fbf665dee1abf4e8ad27ad41ab749842123b4935f7905084ea}.png}

\noindent\sphinxincludegraphics{{11cd6f82662f825d1cadf8bbbf6e4a31fc5546ce95626629d71aa89663b628e5}.png}

\end{sphinxuseclass}\end{sphinxVerbatimOutput}

\end{sphinxuseclass}

\begin{savenotes}\sphinxattablestart
\sphinxthistablewithglobalstyle
\centering
\begin{tabulary}{\linewidth}[t]{TTT}
\sphinxtoprule
\sphinxstyletheadfamily
\sphinxAtStartPar
\sphinxstylestrong{Variable}
&\sphinxstyletheadfamily
\sphinxAtStartPar
\sphinxstylestrong{Forma del viol√≠n}
&\sphinxstyletheadfamily
\sphinxAtStartPar
\sphinxstylestrong{Interpretaci√≥n}
\\
\sphinxmidrule
\sphinxtableatstartofbodyhook
\sphinxAtStartPar
\sphinxstylestrong{Peso (g)}
&
\sphinxAtStartPar
Ancho entre \sphinxstylestrong{3 ‚Äì 7 g}, cola larga y estrecha hasta ‚âà‚ÄØ22¬†g, varios puntos fuera del bigote superior.
&
\sphinxAtStartPar
Distribuci√≥n \sphinxstylestrong{fuertemente asim√©trica a la derecha}: la mayor√≠a son ejemplares peque√±os‚Äëmedios y unos pocos muy pesados (outliers).
\\
\sphinxhline
\sphinxAtStartPar
\sphinxstylestrong{Longitud (cm)}
&
\sphinxAtStartPar
Viol√≠n casi sim√©trico, m√°s ancho en 6¬†‚Äì¬†8¬†cm, cola superior corta, sin puntos fuera del bigote.
&
\sphinxAtStartPar
Distribuci√≥n \sphinxstylestrong{unimodal y estable}; no hay valores extremos claros, buena candidata a predictor base.
\\
\sphinxhline
\sphinxAtStartPar
\sphinxstylestrong{Anchura (cm)}
&
\sphinxAtStartPar
Pico ancho en 2,5¬†‚Äì¬†3,5¬†cm, cola superior hasta 5,2¬†cm con muy poca densidad, 1‚Äë2 puntos aislados.
&
\sphinxAtStartPar
Forma similar a Longitud pero con \sphinxstylestrong{cola alta leve}; unos pocos peces muy anchos podr√≠an ser anomal√≠as o errores.
\\
\sphinxhline
\sphinxAtStartPar
\sphinxstylestrong{Altura (cm)}
&
\sphinxAtStartPar
Viol√≠n estrecho (0,4¬†‚Äì¬†0,5¬†cm habituales), cola fina hasta 0,9¬†cm, varios puntos aislados arriba.
&
\sphinxAtStartPar
Variable con \sphinxstylestrong{rango peque√±o}; valores altos destacan como outliers y podr√≠an indicar errores de medici√≥n o casos excepcionales.
\\
\sphinxbottomrule
\end{tabulary}
\sphinxtableafterendhook\par
\sphinxattableend\end{savenotes}


\subsection{Distribuciones bivariantes}
\label{\detokenize{content/02/Dataset:distribuciones-bivariantes}}
\begin{sphinxuseclass}{cell}\begin{sphinxVerbatimInput}

\begin{sphinxuseclass}{cell_input}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{sns}\PYG{o}{.}\PYG{n}{pairplot}\PYG{p}{(}\PYG{n}{df}\PYG{p}{[}\PYG{n}{numeric\PYGZus{}cols}\PYG{p}{]}\PYG{p}{,} \PYG{n}{diag\PYGZus{}kind}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{kde}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{suptitle}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Pairplot variables morfol√≥gicas}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{y}\PYG{o}{=}\PYG{l+m+mf}{1.02}\PYG{p}{)}\PYG{p}{;}
\end{sphinxVerbatim}

\end{sphinxuseclass}\end{sphinxVerbatimInput}
\begin{sphinxVerbatimOutput}

\begin{sphinxuseclass}{cell_output}
\noindent\sphinxincludegraphics{{e30b8a547eca74ca6043545a14d481946cea86b21fa4b65e5479d9d5ae63cd29}.png}

\end{sphinxuseclass}\end{sphinxVerbatimOutput}

\end{sphinxuseclass}
\sphinxAtStartPar
El an√°lisis de las relaciones bivariantes muestra que el peso crece exponencialmente con la Longitud y la Anchura, dibujando nubes curvil√≠neas donde los puntos se vuelven m√°s dispersos a medida que el pez gana tama√±o; eso confirma que la relaci√≥n no es estrictamente lineal. Longitud y Anchura mantienen entre s√≠ una correlaci√≥n positiva moderada los peces m√°s largos tienden a ser m√°s anchos mientras que Altura se agrupa fuertemente en torno a un intervalo estrecho y, salvo algunos valores altos an√≥malos, aporta poca variabilidad adicional. En todas las combinaciones que incluyen Peso se aprecian varios puntos solitarios por encima de la nube principal, lo que corrobora la presencia de \sphinxstyleemphasis{outliers}. No se observan clusters separados que sugieran sub\sphinxhyphen{}poblaciones distintas, sino una gradaci√≥n continua, de modo que los valores extremos se interpretan mejor como individuos excepcionales (o posibles errores) que como grupos diferenciados.


\subsection{Matriz de correlaci√≥n}
\label{\detokenize{content/02/Dataset:matriz-de-correlacion}}
\begin{sphinxuseclass}{cell}\begin{sphinxVerbatimInput}

\begin{sphinxuseclass}{cell_input}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} 2. Calcular matriz de correlaci√≥n (m√©todo de Pearson por defecto)}
\PYG{n}{corr\PYGZus{}matrix} \PYG{o}{=} \PYG{n}{df}\PYG{o}{.}\PYG{n}{corr}\PYG{p}{(}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} 3. Crear el gr√°fico}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{l+m+mi}{8}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{sns}\PYG{o}{.}\PYG{n}{heatmap}\PYG{p}{(}\PYG{n}{corr\PYGZus{}matrix}\PYG{p}{,}
            \PYG{n}{annot}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{,}       \PYG{c+c1}{\PYGZsh{} Muestra valores en cada celda}
            \PYG{n}{fmt}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{.2f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}       \PYG{c+c1}{\PYGZsh{} Formato de 2 decimales}
            \PYG{n}{cmap}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{plasma}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,}  \PYG{c+c1}{\PYGZsh{} Mapa de colores (rojo\PYGZhy{}negro\PYGZhy{}azul)}
            \PYG{n}{vmin}\PYG{o}{=}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{vmax}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{,}  \PYG{c+c1}{\PYGZsh{} Rango de correlaci√≥n [\PYGZhy{}1, 1]}
            \PYG{n}{linewidths}\PYG{o}{=}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{c+c1}{\PYGZsh{} Grosor de l√≠neas entre celdas}
            \PYG{n}{mask}\PYG{o}{=}\PYG{n}{np}\PYG{o}{.}\PYG{n}{triu}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{ones\PYGZus{}like}\PYG{p}{(}\PYG{n}{corr\PYGZus{}matrix}\PYG{p}{,} \PYG{n}{dtype}\PYG{o}{=}\PYG{n+nb}{bool}\PYG{p}{)}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} Mostrar solo triangular inferior}
           \PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} 4. Personalizar}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Matriz de Correlaci√≥n de Variables}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{pad}\PYG{o}{=}\PYG{l+m+mi}{20}\PYG{p}{,} \PYG{n}{fontsize}\PYG{o}{=}\PYG{l+m+mi}{14}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{xticks}\PYG{p}{(}\PYG{n}{rotation}\PYG{o}{=}\PYG{l+m+mi}{45}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{yticks}\PYG{p}{(}\PYG{n}{rotation}\PYG{o}{=}\PYG{l+m+mi}{0}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}
\end{sphinxVerbatim}

\end{sphinxuseclass}\end{sphinxVerbatimInput}
\begin{sphinxVerbatimOutput}

\begin{sphinxuseclass}{cell_output}
\noindent\sphinxincludegraphics{{c94ee8fc37810363daaf4753953f89542fdf6cec6e58035f4aa80fec2c6082f1}.png}

\end{sphinxuseclass}\end{sphinxVerbatimOutput}

\end{sphinxuseclass}
\sphinxAtStartPar
La matriz de correlaci√≥n indica que, en el lenguado, el peso est√° fuertemente asociado con la longitud y la anchura (r‚âà0,94), mientras que su asociaci√≥n con la altura (espesor corporal) es claramente menor (r‚âà0,86). En t√©rminos de varianza explicada, longitud y anchura individualmente capturan \textasciitilde{}88\% del comportamiento del peso (r¬≤‚âà0,8836), frente a \textasciitilde{}74\% para la altura (r¬≤‚âà0,7396). Esto es coherente con la biomec√°nica del pez plano: el peso depende del volumen, pero en especies deprimidas dorsoventralmente la variabilidad del √°rea proyectada (aprox. longitud√óanchura) domina sobre la variaci√≥n del espesor. La correlaci√≥n igualmente alta entre longitud y anchura (r‚âà0,94) sugiere una morfolog√≠a con proporciones relativamente estables durante el crecimiento (isometr√≠a planiforme) o, al menos, una fuerte covariaci√≥n de ambas dimensiones; en la pr√°ctica, esto implica multicolinealidad si se usan juntas en regresi√≥n. La correlaci√≥n m√°s baja de peso con la altura indica que el espesor es m√°s variable entre individuos (condici√≥n corporal, estado nutricional, maduraci√≥n gonadal), aportando informaci√≥n menos estable sobre el peso que las dimensiones planas. En conjunto, estas correlaciones significan que la masa del lenguado est√° principalmente determinada por su extensi√≥n superficial y que la altura a√±ade variabilidad m√°s idiosincr√°tica.

\begin{sphinxadmonition}{note}{Varianza explicada}

\sphinxAtStartPar
Sea \(Y=\text{Peso}\) y \(X\in\{\text{Longitud},\text{Anchura},\text{Altura}\}\).

\sphinxAtStartPar
En regresi√≥n lineal simple se cumple:
\$\(
R^2 = r^2,
\)\(
donde \)r=\textbackslash{}mathrm\{corr\}(X,Y)\$.

\sphinxAtStartPar
Con los valores obtenidos en la matriz de correlaci√≥n tenemos que:
\$\(
r_{Y,\text{Longitud}}=0.94,\qquad
r_{Y,\text{Anchura}}=0.94,\qquad
r_{Y,\text{Altura}}=0.86.
\)\$

\sphinxAtStartPar
Por tanto,
\begin{itemize}
\item {}
\sphinxAtStartPar
\(R^2_{\text{Peso}\sim\text{Longitud}} = 0.94^2 = 0.8836 \approx 88.36\%\)

\item {}
\sphinxAtStartPar
\(R^2_{\text{Peso}\sim\text{Ancgurad}} = 0.94^2 = 0.8836 \approx 88.36\%\)

\item {}
\sphinxAtStartPar
\(R^2_{\text{Peso}\sim\text{Altura}} = 0.86^2 = 0.7396 \approx 74\%\)

\end{itemize}
\end{sphinxadmonition}

\sphinxstepscope


\chapter{Generaci√≥n de datos sint√©ticos}
\label{\detokenize{content/02/Generador:generacion-de-datos-sinteticos}}\label{\detokenize{content/02/Generador::doc}}
\begin{sphinxadmonition}{note}{Resumen}

\sphinxAtStartPar
Este art√≠culo presenta las l√≠neas de trabajo desarrolladas para la generaci√≥n de un dataset sint√©tico de tama√±o y peso de lenguados, con el objetivo de proporcionar una base de datos suficientemente amplia y representativa para el entrenamiento, validaci√≥n y mejora de modelos predictivos. Se recogen las metodolog√≠as utilizadas en la generaci√≥n de datos sint√©ticos, incluyendo la modelizaci√≥n estad√≠stica de distribuciones emp√≠ricas, t√©cnicas de simulaci√≥n basadas en procesos de crecimiento biol√≥gico y enfoques de aprendizaje autom√°tico para la s√≠ntesis de datos realistas. Adem√°s, se analizan los criterios de validaci√≥n empleados para garantizar que los datos generados reflejen fielmente las tendencias y variabilidad observadas en poblaciones reales de lenguado (\sphinxstyleemphasis{Solea solea}), asegurando as√≠ su utilidad en el desarrollo de algoritmos precisos y generalizables para la predicci√≥n del peso a partir de variables alometricas.

\sphinxAtStartPar
\sphinxstylestrong{Entregable}: E2.2\\
\sphinxstylestrong{Versi√≥n}: 1.0\\
\sphinxstylestrong{Autor}: Javier √Ålvarez Osuna\\
\sphinxstylestrong{Email}: javier.osuna@fishfarmfeeder.com\\
\sphinxstylestrong{ORCID}: \sphinxhref{https://orcid.org/0000-0001-7063-1279}{0000\sphinxhyphen{}0001\sphinxhyphen{}7063\sphinxhyphen{}1279}\\
\sphinxstylestrong{Licencia}: CC\sphinxhyphen{}BY\sphinxhyphen{}4.0\\
\sphinxstylestrong{C√≥digo proyecto}: IG408M.2025.000.000072

\noindent{\hspace*{\fill}\sphinxincludegraphics[width=1.000\linewidth]{{FLATCLASS_logo_publicidad}.png}\hspace*{\fill}}
\end{sphinxadmonition}


\section{Introducci√≥n}
\label{\detokenize{content/02/Generador:introduccion}}
\sphinxAtStartPar
En el √°mbito de la acuicultura de precisi√≥n, la caracterizaci√≥n morfom√©trica de los peces y su relaci√≥n con el peso corporal constituye un eje central para la optimizaci√≥n de procesos como la clasificaci√≥n autom√°tica, el control de crecimiento y la dosificaci√≥n alimentaria. En el caso particular de los peces planos en fase de alevinaje ‚Äîcomo el lenguado (Solea solea) o el rodaballo (Scophthalmus maximus)‚Äî, las variables morfom√©tricas fundamentales incluyen la longitud corporal, la anchura transversal y la altura dorso\sphinxhyphen{}ventral, par√°metros que definen la geometr√≠a del individuo y que se presumen relacionados de forma sistem√°tica con la biomasa individual.

\sphinxAtStartPar
La necesidad de disponer de un dataset suficientemente amplio, representativo y multivariado, que relacione estas variables morfom√©tricas con el peso corporal correspondiente, responde a m√∫ltiples consideraciones de car√°cter estad√≠stico, biol√≥gico y computacional. Aun en ausencia de un modelo alom√©trico expl√≠cito que relacione de forma determinista dichas variables, es posible anticipar que cualquier estrategia de inferencia o predicci√≥n del peso basada en dimensiones requerir√° una densidad adecuada de datos en el espacio tridimensional definido por longitud, anchura y altura. Este requisito es cr√≠tico para garantizar tanto la fidelidad del ajuste como la capacidad de generalizaci√≥n del modelo aprendido.

\sphinxAtStartPar
Cuando el volumen de datos disponibles es reducido, surgen una serie de limitaciones estructurales:
\begin{itemize}
\item {}
\sphinxAtStartPar
\sphinxstylestrong{Alta varianza en la estimaci√≥n de par√°metros}: La precisi√≥n de los modelos predictivos decae significativamente cuando las observaciones son escasas o est√°n mal distribuidas en el dominio de entrada.

\item {}
\sphinxAtStartPar
\sphinxstylestrong{Riesgo de sobreajuste}: En entornos de datos reducidos, los modelos tienden a capturar ruido en lugar de relaciones funcionales genuinas, lo cual compromete la validez externa.

\item {}
\sphinxAtStartPar
\sphinxstylestrong{Cobertura insuficiente del espacio morfom√©trico}: Se produce una p√©rdida de representatividad en las regiones marginales del dominio, lo que reduce la capacidad del sistema para extrapolar o interpolar en condiciones reales de producci√≥n.

\item {}
\sphinxAtStartPar
\sphinxstylestrong{Sesgos estructurales}: Las muestras peque√±as pueden reflejar sesgos en las condiciones de cr√≠a, gen√©tica o instrumentaci√≥n, induciendo patrones espurios no generalizables.

\end{itemize}

\sphinxAtStartPar
Desde la perspectiva de la matem√°tica probabil√≠stica, esta problem√°tica puede entenderse mediante el marco de la inferencia bayesiana. En este enfoque, el conocimiento sobre los par√°metros \(\theta\) (por ejemplo, la relaci√≥n entre morfolog√≠a y peso) se representa como una distribuci√≥n posterior condicionada a los datos \(D\):
\begin{equation*}
\begin{split}
p(\theta | D) \propto p(D | \theta) \cdot p(\theta)
\end{split}
\end{equation*}
\sphinxAtStartPar
donde \(D\) representa los datos observados. Cuando el tama√±o de \(D\) es reducido, la funci√≥n de verosimilitud \(p(D|a,b)\) tiene una varianza alta, lo que genera estimaciones m√°s inciertas. Al aumentar el tama√±o de \(D\) con datos sint√©ticos plausibles, la estimaci√≥n de \(p(a,b|D)\) se vuelve m√°s precisa, reduciendo la varianza de los par√°metros.

\sphinxAtStartPar
En el contexto de la acuicultura, la recopilaci√≥n masiva de medidas biom√©tricas de precisi√≥n en alevines presenta limitaciones log√≠sticas y econ√≥micas significativas. Por tanto, el uso inteligencia artificial para permite simular observaciones adicionales coherentes con la distribuci√≥n emp√≠rica observada, conservando las correlaciones entre las dimensiones corporales y el peso de los individuos.

\sphinxAtStartPar
En este trabajo se abord√≥ la generaci√≥n de datos sint√©ticos mediante tres m√©todos complementarios: \sphinxstylestrong{Gaussian Copula}, \sphinxstylestrong{CTGAN} y \sphinxstylestrong{TVAE}. Esta aproximaci√≥n multicriterio permite evaluar de manera comparativa la capacidad de cada t√©cnica para replicar no solo las distribuciones marginales de los datos originales, sino tambi√©n las dependencias no lineales propias de los modelos alom√©tricos, t√≠picos en biolog√≠a de organismos. La selecci√≥n final del m√©todo m√°s adecuado se basar√° en un an√°lisis cuantitativo que incluye: (1) m√©tricas de evaluaci√≥n de la calidad sint√©tica (KS\sphinxhyphen{}test, divergencia KL), (2) precisi√≥n en la replicaci√≥n de las ecuaciones alom√©tricas (RMSE entre valores reales y predichos), y (3) viabilidad computacional. Esta comparaci√≥n sistem√°tica garantizar√° que los datos sint√©ticos amplificados mantengan validez ecol√≥gica y estad√≠stica, priorizando el m√©todo que mejor equilibre fidelidad biol√≥gica y escalabilidad, para ser usados en los modelos predictivos de peso.

\sphinxAtStartPar
Los estudios sobre generaci√≥n de datos sint√©ticos llevasoa a cabo en el marco de FLATCLASS responden por tanto, a una doble motivaci√≥n: por un lado, \sphinxstylestrong{ampliar artificialmente el conjunto de datos disponible} para entrenar modelos predictivos del peso a partir de variables morfom√©tricas; y por otro, \sphinxstylestrong{mantener la coherencia estad√≠stica y biol√≥gica} de los registros generados, minimizando los riesgos de sobreajuste y mejorando la capacidad de generalizaci√≥n de los modelos desarrollados.

\sphinxstepscope


\section{Gaussian Copula}
\label{\detokenize{content/02/GaussianCopula:gaussian-copula}}\label{\detokenize{content/02/GaussianCopula::doc}}
\sphinxAtStartPar
El m√©todo Gaussian Copula destaca por su capacidad para modelar dependencias multivariadas entre variables, preservando la estructura estad√≠stica de los datos originales. Este enfoque se basa en la teor√≠a de \sphinxstylestrong{c√≥pulas}, que permite desacoplar las distribuciones marginales de las dependencias entre variables, ofreciendo flexibilidad para generar datos sint√©ticos realistas {[}\sphinxhref{https://arxiv.org/pdf/2009.09471}{Zheng et al., 2020}{]}.

\sphinxAtStartPar
Las \sphinxstylestrong{c√≥pulas} son funciones que vinculan distribuciones marginales univariadas para formar una distribuci√≥n multivariada. El teorema de Sklar (1959) establece que cualquier distribuci√≥n conjunta \(H\) de variables aleatorias \((X_1,X_2,...,X_d)\) puede expresarse como:
\begin{equation*}
\begin{split}H(x_1,x_2,...,x_d)=C(F_1(x_1),F_2(x_2),...,F_d(d_d))\end{split}
\end{equation*}
\sphinxAtStartPar
donde \(C\) es la c√≥pula y \(F_i\) son las funciones de distribuci√≥n marginal. La Gaussian Copula utiliza una c√≥pula derivada de la distribuci√≥n normal multivariada, definida como:
\begin{equation*}
\begin{split}
C_\Sigma(\mathbf{u}) = \Phi_\Sigma \left( \Phi^{-1}(u_1), \Phi^{-1}(u_2), \dots, \Phi^{-1}(u_d) \right)
\end{split}
\end{equation*}
\sphinxAtStartPar
donde:
\begin{itemize}
\item {}
\sphinxAtStartPar
\(\Phi_\Sigma\): es la funci√≥n de distribuci√≥n normal multivariada con matriz de covarianza \(\Sigma\)

\item {}
\sphinxAtStartPar
\(\Phi^{-1}\): es la inversa de la distribuci√≥n normal est√°ndar (quantile function)

\item {}
\sphinxAtStartPar
\(u=(u_1,u_2,...,u_d)\): vector de probabilidades uniformes en \([0,1]\)

\end{itemize}

\sphinxAtStartPar
Los fundamentos matem√°ticos anteriormente descritos, incluyendo el teorema de Sklar, la transformaci√≥n al espacio gaussiano mediante funciones inversas \((Œ¶^{-1)}\), y el muestreo de datos sint√©ticos basado en la matriz de covarianza \((Œ£)\), est√°n implementados de forma eficiente y optimizada dentro de la librer√≠a \sphinxcode{\sphinxupquote{SDV (Synthetic Data Vault)}}. En particular, la clase \sphinxcode{\sphinxupquote{GaussianCopula}} del m√≥dulo \sphinxcode{\sphinxupquote{sdv.tabular}} encapsula estos modelos matem√°ticos, permitiendo la generaci√≥n de datos tabulares sint√©ticos que preservan tanto las distribuciones marginales \((F_i)\) como las dependencias multivariadas \((C_Œ£)\) presentes en los datos originales. La librer√≠a automatiza procesos clave como:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {}
\sphinxAtStartPar
La estimaci√≥n no param√©trica de distribuciones marginales,

\item {}
\sphinxAtStartPar
El c√°lculo de la matriz de correlaci√≥n de rangos (rank correlation), y

\item {}
\sphinxAtStartPar
La generaci√≥n de muestras sint√©ticas mediante inversi√≥n de la c√≥pula \((F_{i}^{-1})\).

\end{enumerate}

\sphinxAtStartPar
Adem√°s, SDV incorpora validaciones internas para garantizar que los datos generados mantengan propiedades estad√≠sticas consistentes, siguiendo las mejores pr√°cticas descritas en la literatura {[}\sphinxhref{https://doi.org/10.1109/DSAA.2016.49}{Patki et al., 2016}{]}.

\begin{sphinxuseclass}{cell}\begin{sphinxVerbatimInput}

\begin{sphinxuseclass}{cell_input}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Importar librer√≠as necesarias}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{pandas}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{pd}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{numpy}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{np}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{scipy}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{matplotlib}\PYG{n+nn}{.}\PYG{n+nn}{pyplot}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{plt}

\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{sdv}\PYG{n+nn}{.}\PYG{n+nn}{single\PYGZus{}table}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{GaussianCopulaSynthesizer}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{sdv}\PYG{n+nn}{.}\PYG{n+nn}{metadata}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{Metadata}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{pathlib}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{Path}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{myst\PYGZus{}nb}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{glue}

\PYG{n}{num\PYGZus{}synthetic} \PYG{o}{=} \PYG{l+m+mi}{500} \PYG{c+c1}{\PYGZsh{}variable para definir el n√∫mero de registros sint√©ticos}

\PYG{c+c1}{\PYGZsh{} 1. Cargar datos reales}
\PYG{c+c1}{\PYGZsh{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{n}{path\PYGZus{}realData} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{.././data/Dimensiones\PYGZus{}lenguado.xlsx}\PYG{l+s+s1}{\PYGZsq{}}
\PYG{n}{real\PYGZus{}data} \PYG{o}{=} \PYG{n}{pd}\PYG{o}{.}\PYG{n}{read\PYGZus{}excel}\PYG{p}{(}\PYG{n}{path\PYGZus{}realData}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} 2. Obtener los metadata del dataset}
\PYG{c+c1}{\PYGZsh{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}

\PYG{n}{metadata\PYGZus{}path} \PYG{o}{=} \PYG{n}{Path}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{.././data/metadata\PYGZus{}lenguado.json}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}

\PYG{k}{if} \PYG{n}{metadata\PYGZus{}path}\PYG{o}{.}\PYG{n}{exists}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
    \PYG{c+c1}{\PYGZsh{} Cargar metadatos desde el JSON (evita el warning)}
    \PYG{n}{metadata} \PYG{o}{=} \PYG{n}{Metadata}\PYG{o}{.}\PYG{n}{load\PYGZus{}from\PYGZus{}json}\PYG{p}{(}\PYG{n}{metadata\PYGZus{}path}\PYG{p}{)}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Metadatos cargados desde JSON.}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{k}{else}\PYG{p}{:}
    \PYG{c+c1}{\PYGZsh{} Detectar metadatos y guardarlos en JSON para futuras ejecuciones}
    \PYG{n}{metadata} \PYG{o}{=} \PYG{n}{Metadata}\PYG{o}{.}\PYG{n}{detect\PYGZus{}from\PYGZus{}dataframe}\PYG{p}{(}\PYG{n}{real\PYGZus{}data}\PYG{p}{)}
    \PYG{n}{metadata}\PYG{o}{.}\PYG{n}{save\PYGZus{}to\PYGZus{}json}\PYG{p}{(}\PYG{n}{metadata\PYGZus{}path}\PYG{p}{)}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Metadatos detectados y guardados en JSON.}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} 3. Sintetizar datos}
\PYG{c+c1}{\PYGZsh{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{n}{synthesizer} \PYG{o}{=} \PYG{n}{GaussianCopulaSynthesizer}\PYG{p}{(}
    \PYG{n}{metadata} \PYG{o}{=} \PYG{n}{metadata}\PYG{p}{,}
    \PYG{n}{enforce\PYGZus{}min\PYGZus{}max\PYGZus{}values} \PYG{o}{=} \PYG{k+kc}{True}\PYG{p}{,} \PYG{c+c1}{\PYGZsh{} Forzar datos real√≠sticos}
    \PYG{n}{enforce\PYGZus{}rounding} \PYG{o}{=} \PYG{k+kc}{True} \PYG{c+c1}{\PYGZsh{} Redondeos autom√°ticos}
    \PYG{p}{)}

\PYG{n}{synthesizer}\PYG{o}{.}\PYG{n}{fit}\PYG{p}{(}\PYG{n}{real\PYGZus{}data}\PYG{p}{)}
\PYG{n}{synthetic\PYGZus{}data} \PYG{o}{=} \PYG{n}{synthesizer}\PYG{o}{.}\PYG{n}{sample}\PYG{p}{(}\PYG{n}{num\PYGZus{}rows}\PYG{o}{=} \PYG{n}{num\PYGZus{}synthetic}\PYG{p}{)}\PYG{p}{;}
\PYG{n}{display}\PYG{p}{(}\PYG{n}{synthetic\PYGZus{}data}\PYG{o}{.}\PYG{n}{head}\PYG{p}{(}\PYG{l+m+mi}{10}\PYG{p}{)}\PYG{p}{)}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Se muestran 10 primeros registros sint√©ticos de un total de }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{num\PYGZus{}synthetic}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}


\PYG{c+c1}{\PYGZsh{} 4. Guardar satos sint√©ticos}
\PYG{c+c1}{\PYGZsh{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{n}{path\PYGZus{}syntheticData} \PYG{o}{=} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{.././data/SyntheticGaussianCopula.xlsx}\PYG{l+s+s2}{\PYGZdq{}}
\PYG{n}{synthetic\PYGZus{}data}\PYG{o}{.}\PYG{n}{to\PYGZus{}excel}\PYG{p}{(}\PYG{n}{path\PYGZus{}syntheticData}\PYG{p}{,} \PYG{n}{index}\PYG{o}{=}\PYG{k+kc}{False}\PYG{p}{,} \PYG{n}{engine}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{openpyxl}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} 5. Validaci√≥n calidad datos sint√©ticos}
\PYG{c+c1}{\PYGZsh{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{sdv}\PYG{n+nn}{.}\PYG{n+nn}{evaluation}\PYG{n+nn}{.}\PYG{n+nn}{single\PYGZus{}table}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{run\PYGZus{}diagnostic}\PYG{p}{,} \PYG{n}{evaluate\PYGZus{}quality}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{sdv}\PYG{n+nn}{.}\PYG{n+nn}{evaluation}\PYG{n+nn}{.}\PYG{n+nn}{single\PYGZus{}table}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{get\PYGZus{}column\PYGZus{}plot}

\PYG{c+c1}{\PYGZsh{}\PYGZsh{} Diagn√≥stico b√°sico}

\PYG{n}{diagnostic} \PYG{o}{=} \PYG{n}{run\PYGZus{}diagnostic}\PYG{p}{(}\PYG{n}{real\PYGZus{}data}\PYG{p}{,} \PYG{n}{synthetic\PYGZus{}data}\PYG{p}{,} \PYG{n}{metadata}\PYG{p}{,} \PYG{k+kc}{False}\PYG{p}{)} \PYG{c+c1}{\PYGZsh{} Se ejecuta el diagn√≥stico sin mostrar en pantalla}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s2}{DIAGN√ìSTICO B√ÅSICO CALIDAD DATOS}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{n}{diagnostic}\PYG{o}{.}\PYG{n}{get\PYGZus{}details}\PYG{p}{(}\PYG{n}{property\PYGZus{}name}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Data Validity}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{)}
\end{sphinxVerbatim}

\end{sphinxuseclass}\end{sphinxVerbatimInput}
\begin{sphinxVerbatimOutput}

\begin{sphinxuseclass}{cell_output}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
Metadatos cargados desde JSON.
\end{sphinxVerbatim}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
   Peso (g)  Longitud (cm)  Anchura (cm)  Altura (cm)
0      8.74            9.0           3.5          0.5
1      7.84            8.7           3.5          0.5
2      2.40            6.5           2.3          0.4
3      7.45            8.3           3.4          0.6
4      7.16            8.1           3.1          0.5
5      2.95            6.1           2.6          0.4
6     15.51           10.9           4.9          0.8
7      4.72            6.9           2.8          0.5
8      7.60            8.9           3.1          0.6
9      3.01            6.3           2.1          0.4
\end{sphinxVerbatim}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
Se muestran 10 primeros registros sint√©ticos de un total de 500

DIAGN√ìSTICO B√ÅSICO CALIDAD DATOS

          Column             Metric  Score
0       Peso (g)  BoundaryAdherence    1.0
1  Longitud (cm)  BoundaryAdherence    1.0
2   Anchura (cm)  BoundaryAdherence    1.0
3    Altura (cm)  BoundaryAdherence    1.0
\end{sphinxVerbatim}

\end{sphinxuseclass}\end{sphinxVerbatimOutput}

\end{sphinxuseclass}
\sphinxAtStartPar
La m√©trica \sphinxcode{\sphinxupquote{BoundaryAdherence}} verifica si los valores sint√©ticos se mantienen dentro de los rangos m√≠nimos y m√°ximos de los datos reales, devolviendo el porcentaje de filas v√°lidas. En las siguientes gr√°ficas podemos visualizar la similitud entre los datos reales y los sint√©ticos obtenidos mediante Gaussian Copula.

\begin{sphinxuseclass}{cell}\begin{sphinxVerbatimInput}

\begin{sphinxuseclass}{cell_input}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{}\PYGZsh{} Visualizaci√≥n de datos}

\PYG{n}{columnas} \PYG{o}{=} \PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Peso (g)}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Longitud (cm)}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Anchura (cm)}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Altura (cm)}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}

\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{sdv}\PYG{n+nn}{.}\PYG{n+nn}{evaluation}\PYG{n+nn}{.}\PYG{n+nn}{single\PYGZus{}table}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{get\PYGZus{}column\PYGZus{}plot}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{seaborn}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{sns}

\PYG{n}{fig}\PYG{p}{,} \PYG{n}{axs} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplots}\PYG{p}{(}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{15}\PYG{p}{,} \PYG{l+m+mi}{12}\PYG{p}{)}\PYG{p}{)}
\PYG{k}{for} \PYG{n}{i}\PYG{p}{,} \PYG{n}{col} \PYG{o+ow}{in} \PYG{n+nb}{enumerate}\PYG{p}{(}\PYG{n}{columnas}\PYG{p}{)}\PYG{p}{:}
    \PYG{n}{ax} \PYG{o}{=} \PYG{n}{axs}\PYG{p}{[}\PYG{n}{i}\PYG{o}{/}\PYG{o}{/}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{i}\PYG{o}{\PYGZpc{}}\PYG{k}{2}]
    \PYG{n}{sns}\PYG{o}{.}\PYG{n}{kdeplot}\PYG{p}{(}\PYG{n}{real\PYGZus{}data}\PYG{p}{[}\PYG{n}{col}\PYG{p}{]}\PYG{p}{,} \PYG{n}{ax}\PYG{o}{=}\PYG{n}{ax}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{\PYGZsh{}1f77b4}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Real}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{fill}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.5}\PYG{p}{)}
    \PYG{n}{sns}\PYG{o}{.}\PYG{n}{kdeplot}\PYG{p}{(}\PYG{n}{synthetic\PYGZus{}data}\PYG{p}{[}\PYG{n}{col}\PYG{p}{]}\PYG{p}{,} \PYG{n}{ax}\PYG{o}{=}\PYG{n}{ax}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{\PYGZsh{}2ca02c}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Gaussian Copula}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{fill}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.5}\PYG{p}{)}
    \PYG{n}{ax}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Distribuci√≥n de }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{col}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{ax}\PYG{o}{.}\PYG{n}{legend}\PYG{p}{(}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{suptitle}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Comparaci√≥n de datos reales vs. sint√©ticos Gaussian Copula}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{y}\PYG{o}{=}\PYG{l+m+mf}{1.02}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{}\PYGZsh{} Medidas de similiud estad√≠stica}

\PYG{n}{quality\PYGZus{}reportGC} \PYG{o}{=} \PYG{n}{evaluate\PYGZus{}quality}\PYG{p}{(}\PYG{n}{real\PYGZus{}data}\PYG{p}{,} \PYG{n}{synthetic\PYGZus{}data}\PYG{o}{.}\PYG{n}{sample}\PYG{p}{(}\PYG{n}{n}\PYG{o}{=}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{real\PYGZus{}data}\PYG{p}{)}\PYG{p}{,} \PYG{n}{random\PYGZus{}state}\PYG{o}{=}\PYG{l+m+mi}{42}\PYG{p}{)}\PYG{p}{,} \PYG{n}{metadata}\PYG{p}{,} \PYG{n}{verbose}\PYG{o}{=}\PYG{k+kc}{False}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{}\PYGZsh{} Obtenemos el valor promedio de la similitud}
\PYG{n}{overall\PYGZus{}score} \PYG{o}{=} \PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{quality\PYGZus{}reportGC}\PYG{o}{.}\PYG{n}{get\PYGZus{}score}\PYG{p}{(}\PYG{p}{)}\PYG{o}{*}\PYG{l+m+mi}{100}\PYG{l+s+si}{:}\PYG{l+s+s2}{.2f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZpc{}}\PYG{l+s+s2}{\PYGZdq{}}
\PYG{n}{glue}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{scoreGAN}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{overall\PYGZus{}score}\PYG{p}{,} \PYG{n}{display}\PYG{o}{=}\PYG{k+kc}{False}\PYG{p}{)}\PYG{p}{;} \PYG{c+c1}{\PYGZsh{} Definimos una variable para usar en el texto markdown}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s2}{SIMILITUD ESTAD√çSTICA}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Overall score: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{overall\PYGZus{}score}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{}\PYGZsh{} Ajuste por columna de forma individual    }
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s2}{Resultados de ajuste real vs. sint√©tico por columna de datos}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{n}{quality\PYGZus{}reportGC}\PYG{o}{.}\PYG{n}{get\PYGZus{}details}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Column Shapes}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{)}
\end{sphinxVerbatim}

\end{sphinxuseclass}\end{sphinxVerbatimInput}
\begin{sphinxVerbatimOutput}

\begin{sphinxuseclass}{cell_output}
\noindent\sphinxincludegraphics{{cd770d1f412a0d1487bfc8a8aaf98ea59fc768af49407efb4c27a4a80c456b29}.png}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
SIMILITUD ESTAD√çSTICA

Overall score: 96.26\PYGZpc{}


Resultados de ajuste real vs. sint√©tico por columna de datos

          Column        Metric     Score
0       Peso (g)  KSComplement  0.928230
1  Longitud (cm)  KSComplement  0.928230
2   Anchura (cm)  KSComplement  0.923445
3    Altura (cm)  KSComplement  0.952153
\end{sphinxVerbatim}

\end{sphinxuseclass}\end{sphinxVerbatimOutput}

\end{sphinxuseclass}
\sphinxAtStartPar
Los resultados obtenidos indican un alto grado de similitud entre los datos sint√©ticos y reales, con una adecuaci√≥n del \DUrole{output,text_plain}{‚Äò96.26\%‚Äô}. La m√©trica \sphinxcode{\sphinxupquote{KSComplement}} eval√∫a el grado de similitud individualmente entre cada columna real y su sint√©tica bas√°ndose en la forma de sus distribuciones univariadas (forma, media, dispersi√≥n). Los valores obtenidos indican un elevado grado de ajuste entre los datos reales y sint√©ticos, tal y como tambi√©n se puede apreciar en las gr√°ficas anteriores.

\sphinxAtStartPar
La siguiente tabla recoge la correlaci√≥n entre pares de columnas num√©ricas y determina el grado de similitud entre los datos reales y sint√©ticos (\sphinxcode{\sphinxupquote{CorrelationSimilarity}}), comparando espec√≠ficamente las tendencias en sus distribuciones en 2D. Como se desprende de los valores obtenidos, los porcentajes de correlaci√≥n son, en la mayor√≠a de los casos, \(\approx 1\), lo cual garantiza la validad de los datos sint√©ticos obtenidos

\begin{sphinxuseclass}{cell}\begin{sphinxVerbatimInput}

\begin{sphinxuseclass}{cell_input}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s2}{ Correlaciones entre variables real vs. sint√©tica}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{n}{quality\PYGZus{}reportGC}\PYG{o}{.}\PYG{n}{get\PYGZus{}details}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Column Pair Trends}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{)}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\end{sphinxVerbatim}

\end{sphinxuseclass}\end{sphinxVerbatimInput}
\begin{sphinxVerbatimOutput}

\begin{sphinxuseclass}{cell_output}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
 Correlaciones entre variables real vs. sint√©tica

        Column 1       Column 2                 Metric     Score  \PYGZbs{}
0       Peso (g)  Longitud (cm)  CorrelationSimilarity  0.995285
1       Peso (g)   Anchura (cm)  CorrelationSimilarity  0.998692
2       Peso (g)    Altura (cm)  CorrelationSimilarity  0.987694
3  Longitud (cm)   Anchura (cm)  CorrelationSimilarity  0.999846
4  Longitud (cm)    Altura (cm)  CorrelationSimilarity  0.983536
5   Anchura (cm)    Altura (cm)  CorrelationSimilarity  0.987907

   Real Correlation  Synthetic Correlation
0          0.932951               0.942382
1          0.942354               0.939738
2          0.861768               0.837156
3          0.936674               0.936982
4          0.870165               0.837236
5          0.842673               0.818487
\end{sphinxVerbatim}

\end{sphinxuseclass}\end{sphinxVerbatimOutput}

\end{sphinxuseclass}
\sphinxstepscope


\section{Conditional Tabular GAN (CTGAN)}
\label{\detokenize{content/02/CTGAN:conditional-tabular-gan-ctgan}}\label{\detokenize{content/02/CTGAN::doc}}
\sphinxAtStartPar
CTGAN es una variaci√≥n de las \sphinxstylestrong{Redes Generativas Adversarias (GAN, por sus siglas en ingl√©s)} especialmente dise√±ado para conjuntos de datos tabulares, una categor√≠a que hist√≥ricamente ha planteado desaf√≠os significativos en el campo del aprendizaje autom√°tico generativo. Las redes antag√≥nicas generativas o redes adversarias generativas (GANs) son un m√©todo para la optimizaci√≥n competitivo entre dos redes neuronales, una llamada generadora y otra discriminadora, con el objetivo de conseguir generar nuevas instancias idealmente indistinguibles a las pertenecientes a la distribuci√≥n de probabilidad de la que derivan los datos de entrenamiento.

\sphinxAtStartPar
Las GANs, originalmente concebidas para tareas de s√≠ntesis de im√°genes {[}\sphinxhref{https://doi.org/10.1145/3422622}{Goodfellow et al., 2014}{]}, han demostrado en los √∫ltimos a√±os una notable capacidad para modelar distribuciones complejas en espacios tabulares multivariantes, especialmente en dominios donde los datos reales son escasos o costosos de obtener. El fundamento te√≥rico general del que derivan, permite su utilizaci√≥n para la generaci√≥n de cualquier tipo de datos, habi√©ndose demostrado efectiva en campos diversos como son la visi√≥n por computador {[}\sphinxhref{https://doi.org/10.48550/arXiv.1505.03906}{Roy et al., 2015}, \sphinxhref{https://doi.org/10.48550/arXiv.1710.10196}{Karras et al., 2017}{]}, la segmentaci√≥n sem√°ntica {[}\sphinxhref{https://doi.org/10.48550/arXiv.1711.03213}{Hoffman et al., 2017}{]}, la s√≠ntesis de series temporales {[}\sphinxhref{https://doi.org/10.48550/arXiv.1806.01875}{Hartmann et al., 2018}{]}, la edici√≥n de imagen {[}\sphinxhref{https://doi.org/10.1145/3447648}{Abdal et al., 2020}{]}, el procesamiento del lenguaje natural {[}\sphinxhref{https://doi.org/10.48550/arXiv.1801.07736}{Fedus et al., 2018}{]}, la generaci√≥n de imagen a partir de texto {[}\sphinxhref{https://doi.org/10.48550/arXiv.2103.00020}{Radford et al., 2021}{]} y m√°s recientemente \sphinxhref{https://doi.org/10.1007/s00778-023-00807-y}{Xu et al. (2023)} demuestran que las GANs superan a t√©cnicas convencionales de s√≠ntesis en la preservaci√≥n de estructuras de dependencia no lineal en variables tabulares reales de alta dimensi√≥n.

\sphinxAtStartPar
Para cualquier conjunto de datos, podemos hipotetizar que es posible definir una distribuci√≥n de probabilidad \(P_{data}\) representativa de la poblaci√≥n representada por la muestra formada por el conjunto de datos. De ser esto posible, para cualquier valor de \(x\) ser√° posible establecer un valor \(P_{data}(x)\) que determine la probabilidad de que \(x\) pertenezca a la poblaci√≥n. De existir una funci√≥n de este tipo, ser√≠a una funci√≥n discriminativa que dada una instancia permitir√≠a conocer la probabilidad de pertenencia a la poblaci√≥n. Los modelos generativos modelizan la distribuci√≥n de probabilidad mencionada pero no proporcionan un valor de probabilidad, sino que generan instancias nuevas que pertenecen a distribuciones de probabilidad pr√≥ximas a la que pretenden asemejar. Las GANs definen un esquema de aprendizaje que facilita la codificaci√≥n de los atributos definitorios de la distribuci√≥n de probabilidad en una red neuronal de manera que la red incorpore la informaci√≥n esencial que le permite generar instancias pertenecientes a distribuciones de probabilidad pr√≥ximas a la que el conjunto de datos que pretende representar.

\sphinxAtStartPar
La arquitectura de las Redes Generativas Adversarias (GAN, por sus siglas en ingl√©s) se basa en la interacci√≥n entre dos redes neuronales que trabajan de forma opuesta pero complementaria: una red generadora \((G)\) y una red discriminadora \((D)\). La red generadora tiene como objetivo crear datos sint√©ticos que imiten con la mayor fidelidad posible los datos reales del conjunto original. Por su parte, la red discriminadora act√∫a como un detector, cuya tarea es evaluar si una determinada entrada procede del conjunto de datos reales o ha sido generada artificialmente por \(G\).

\sphinxAtStartPar
Durante el proceso de entrenamiento, ambas redes se enfrentan en un proceso competitivo. La generadora intenta ‚Äúenga√±ar‚Äù a la discriminadora creando datos cada vez m√°s realistas, mientras que la discriminadora se entrena para detectar con mayor precisi√≥n las falsificaciones. Este enfoque adversarial permite que ambas redes mejoren progresivamente: \(G\) produce datos sint√©ticos m√°s convincentes y \(D\) refina sus capacidades de detecci√≥n. Esta din√°mica se puede entender como un juego de suma cero, donde el √©xito de una red implica el fracaso de la otra, y que te√≥ricamente puede llevar a un punto en el que ninguna de las redes puede mejorar su rendimiento sin afectar negativamente a la otra (equilibrio de Nash).

\begin{figure}[htbp]
\centering
\capstart

\noindent\sphinxincludegraphics[width=1.000\linewidth]{{Modelo_GAN}.png}
\caption{Modelo funcional de una red GAN}\label{\detokenize{content/02/CTGAN:figura-2-1}}\end{figure}

\sphinxAtStartPar
En la figura se muestra un diagrama representativo del proceso de optimizaci√≥n de las GAN. La \sphinxstylestrong{red generadora} \(G(z)\) recibe como entrada un vector de ruido aleatorio \(z\), generado a partir de una distribuci√≥n conocida \(p_z\), y produce como salida un dato sint√©tico \(x_{fake}\) que intenta imitar los datos reales. La \sphinxstylestrong{red discriminadora} \(D(x)\) recibe como entrada un dato \(x_{real}\)  o \(x_{fake}\) (generado) y devuelve una probabilidad \sphinxcode{\sphinxupquote{D(x)}} entre \(0\) y \(1\) que indica cu√°n probable es que \(x\) provenga del conjunto real de datos.

\sphinxAtStartPar
Amabas redes se consideran antag√≥nicas dado que sus objetivos son opuestos:
\begin{itemize}
\item {}
\sphinxAtStartPar
\(D\) quiere \sphinxstylestrong{maximizar} la probabilidad de detectar correctamente los datos reales y rechazar los sint√©ticos.

\item {}
\sphinxAtStartPar
\(G\) quiere \sphinxstylestrong{minimizar} la probabilidad de que \(D\) detecte que sus datos son falsos.

\end{itemize}

\sphinxAtStartPar
El proceso se modela como un \sphinxstylestrong{juego de suma cero} mediante la siguiente funci√≥n objetivo:
\begin{equation*}
\begin{split}
\min_G \max_D V(D, G) = \mathbb{E}_{x \sim p_{\text{datos}}(x)}[\log D(x)] + \mathbb{E}_{z \sim p_z(z)}[\log(1 - D(G(z)))]
\end{split}
\end{equation*}\begin{itemize}
\item {}
\sphinxAtStartPar
El primer t√©rmino recompensa a \(D\) por identificar correctamente datos reales.

\item {}
\sphinxAtStartPar
El segundo t√©rmino recompensa a \(D\) por detectar correctamente los datos generados por \(G\).

\end{itemize}

\sphinxAtStartPar
Mientras tanto, \(G\) intenta minimizar esta funci√≥n enga√±ando a \(D\), es decir, haciendo que \(D(G(z))\) sea lo m√°s cercano posible a 1.

\sphinxAtStartPar
Durante el entrenamiento, ambas redes mejoran iterativamente. Te√≥ricamente, el proceso puede converger a un \sphinxstylestrong{equilibrio de Nash}, en el que \(G\) genera datos tan similares a los reales que \(D\) no puede distinguir entre ellos, y devuelve aproximadamente:
\begin{equation*}
\begin{split}
D(x) \approx 0.5
\end{split}
\end{equation*}
\sphinxAtStartPar
En ese punto, el sistema ha alcanzado un equilibrio: ni \(G\) ni \(D\) pueden mejorar sin perjudicar a la otra red.

\sphinxAtStartPar
El modelo CTGAN (Conditional Tabular GAN) representa un enfoque avanzado de generaci√≥n de datos sint√©ticos espec√≠ficamente dise√±ado para conjuntos de datos tabulares, una categor√≠a que hist√≥ricamente ha planteado desaf√≠os significativos en el campo del aprendizaje autom√°tico generativo. A diferencia de las GANs tradicionales, orientadas principalmente a la s√≠ntesis de datos en dominios estructurados como im√°genes o secuencias temporales, los datos tabulares presentan heterogeneidad tipol√≥gica (variables continuas, categ√≥ricas y ordinales) y complejas dependencias estad√≠sticas interatributo. CTGAN resuelve esta complejidad mediante una arquitectura condicional que permite preservar la distribuci√≥n marginal y condicional de cada atributo, logrando generar muestras sint√©ticas estad√≠sticamente similares y coherentes con los datos originales.

\sphinxAtStartPar
Al igual que las GAN, su dise√±o se basa en un esquema adversarial compuesto por dos redes neuronales: el generador, que crea datos sint√©ticos a partir de ruido aleatorio y vectores condicionales, y el discriminador, que eval√∫a la autenticidad de los datos. Una innovaci√≥n clave de CTGAN es el uso estrat√©gico de funciones de activaci√≥n, particularmente ReLU (Rectified Linear Unit) y LeakyReLU, que optimizan el flujo de gradientes durante el entrenamiento.

\sphinxAtStartPar
En el \sphinxstylestrong{generador} se emplea ReLU, para promover una activaci√≥n fuerte y directa.

\begin{sphinxadmonition}{note}{ReLU ((Rectified Linear Unit)}

\sphinxAtStartPar
La \sphinxstylestrong{funci√≥n de activaci√≥n \sphinxcode{\sphinxupquote{ReLU}} (Rectified Linear Unit)} es una de las funciones no lineales m√°s utilizadas en redes neuronales profundas debido a su simplicidad y eficacia computacional. Se define como \(\text{ReLU}(x) = \max(0, x)\), lo que implica que las salidas negativas se eliminan (se convierten en cero) mientras que las positivas se mantienen sin alteraci√≥n. Esta propiedad introduce no linealidad en la red neuronal, permite que las neuronas se activen solo cuando es necesario y, al mismo tiempo, evita problemas de saturaci√≥n que se presentan en otras funciones. Sin embargo, \sphinxcode{\sphinxupquote{ReLU}} puede presentar el problema del ‚Äúapagado de neuronas‚Äù (dead neurons), cuando los valores de entrada son negativos de forma persistente, impidiendo que esas neuronas contribuyan al aprendizaje.
\end{sphinxadmonition}

\sphinxAtStartPar
Por otro lado, el \sphinxstylestrong{discriminador} utiliza Leaky ReLU (que anula los valores negarios) para evitar el colapso de unidades activas y asegurar una mejor capacidad de detecci√≥n de patrones tanto en regiones positivas como negativas del espacio de entrada.

\begin{sphinxadmonition}{note}{Leaky ReLU}

\sphinxAtStartPar
Leaky ReLU es una evoluci√≥n de la funci√≥n de activaci√≥n ReLU especialmente orientada a solventar el problema de ‚Äúapagado de neuronas‚Äù (dead neurons), cuando los valores de entrada son negativos de forma persistente, impidiendo que esas neuronas contribuyan al aprendizaje. Esta funci√≥n introduce una variante al considerar una peque√±a pendiente negativa para los valores menores que cero. Su definici√≥n es:
\begin{equation*}
\begin{split}
\text{LeakyReLU}(x) =
\begin{cases}
x & \text{si } x \geq 0 \\
\alpha x & \text{si } x < 0
\end{cases}
\end{split}
\end{equation*}
\sphinxAtStartPar
donde \(\alpha\) es un peque√±o valor positivo, t√≠picamente \(0.01\). Esta modificaci√≥n permite que las neuronas contin√∫en actualizando sus pesos incluso cuando sus entradas son negativas, lo que favorece una mejor propagaci√≥n del gradiente durante el entrenamiento y mejora la robustez de la red.
\end{sphinxadmonition}

\sphinxAtStartPar
Tanto el generador como el discriminador de la red CTGAN est√°n compuestos por \sphinxstylestrong{cuatro capas ocultas densamente conectadas} (\sphinxstyleemphasis{fully connected layers}) con \sphinxstylestrong{64 neuronass} que responden a un compromiso t√©cnico entre capacidad representacional, estabilidad del entrenamiento y eficiencia computacional, especialmente en el contexto de modelos generativos aplicados a datos tabulares de baja dimensionalidad, como es el caso de las variables morfom√©tricas (longitud, anchura, altura y peso) de juveniles de peces.

\sphinxAtStartPar
Desde un punto de vista pr√°ctico, 64 unidades por capa ofrecen una capacidad suficiente para capturar relaciones no lineales complejas entre las variables del espacio latente y las caracter√≠sticas morfol√≥gicas de salida, sin llegar a una sobreparametrizaci√≥n excesiva que pueda inducir sobreajuste o inestabilidad adversarial durante el entrenamiento de la GAN. Esta elecci√≥n proporciona un n√∫mero razonable de par√°metros entrenables, lo cual resulta adecuado cuando se trabaja con conjuntos de datos de tama√±o moderado, como ocurre en nuestro caso.

\sphinxAtStartPar
A este respecto, estudios recientes sobre GANs para datos tabulares ‚Äîcomo CTAB\sphinxhyphen{}GAN+ {[}\sphinxhref{https://doi.org/10.3389/fdata.2023.1296508}{Zao et al., 2024}{]} y CTGAN {[}\sphinxhref{https://doi.org/10.1007/s00778-023-00807-y}{Liu et al., 2023}{]}‚Äî concluyen que arquitecturas con capas ocultas de entre 64 y 128 neuronas suelen alcanzar un buen equilibrio entre precisi√≥n, velocidad de convergencia y estabilidad del discriminador. Por debajo de este umbral (p.e., 16 o 32 neuronas), se puede observar p√©rdida de capacidad expresiva, mientras que valores superiores (p.e., 256) pueden ser innecesarios para problemas con pocos atributos y generar ruido o fluctuaciones en el aprendizaje entre adversarios.

\begin{sphinxuseclass}{cell}\begin{sphinxVerbatimInput}

\begin{sphinxuseclass}{cell_input}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Importar librer√≠as necesarias}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{pandas}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{pd}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{numpy}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{np}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{scipy}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{matplotlib}\PYG{n+nn}{.}\PYG{n+nn}{pyplot}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{plt}

\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{sdv}\PYG{n+nn}{.}\PYG{n+nn}{single\PYGZus{}table}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{CTGANSynthesizer}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{sdv}\PYG{n+nn}{.}\PYG{n+nn}{metadata}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{Metadata}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{pathlib}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{Path}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{myst\PYGZus{}nb}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{glue}

\PYG{n}{num\PYGZus{}synthetic} \PYG{o}{=} \PYG{l+m+mi}{500} \PYG{c+c1}{\PYGZsh{}variable para definir el n√∫mero de registros sint√©ticos}

\PYG{c+c1}{\PYGZsh{} 1. Cargar datos reales}
\PYG{c+c1}{\PYGZsh{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{n}{path\PYGZus{}realData} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{.././data/Dimensiones\PYGZus{}lenguado.xlsx}\PYG{l+s+s1}{\PYGZsq{}}
\PYG{n}{real\PYGZus{}data} \PYG{o}{=} \PYG{n}{pd}\PYG{o}{.}\PYG{n}{read\PYGZus{}excel}\PYG{p}{(}\PYG{n}{path\PYGZus{}realData}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} 2. Obtener los metadata del dataset}
\PYG{c+c1}{\PYGZsh{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}

\PYG{n}{metadata\PYGZus{}path} \PYG{o}{=} \PYG{n}{Path}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{.././data/metadata\PYGZus{}lenguado.json}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}

\PYG{k}{if} \PYG{n}{metadata\PYGZus{}path}\PYG{o}{.}\PYG{n}{exists}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
    \PYG{c+c1}{\PYGZsh{} Cargar metadatos desde el JSON (evita el warning)}
    \PYG{n}{metadata} \PYG{o}{=} \PYG{n}{Metadata}\PYG{o}{.}\PYG{n}{load\PYGZus{}from\PYGZus{}json}\PYG{p}{(}\PYG{n}{metadata\PYGZus{}path}\PYG{p}{)}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Metadatos cargados desde JSON.}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{k}{else}\PYG{p}{:}
    \PYG{c+c1}{\PYGZsh{} Detectar metadatos y guardarlos en JSON para futuras ejecuciones}
    \PYG{n}{metadata} \PYG{o}{=} \PYG{n}{Metadata}\PYG{o}{.}\PYG{n}{detect\PYGZus{}from\PYGZus{}dataframe}\PYG{p}{(}\PYG{n}{real\PYGZus{}data}\PYG{p}{)}
    \PYG{n}{metadata}\PYG{o}{.}\PYG{n}{save\PYGZus{}to\PYGZus{}json}\PYG{p}{(}\PYG{n}{metadata\PYGZus{}path}\PYG{p}{)}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Metadatos detectados y guardados en JSON.}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} 3. Entrenar la red CTGAN}
\PYG{c+c1}{\PYGZsh{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Iniciando CTGAN...}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}

\PYG{n}{synthesizer} \PYG{o}{=} \PYG{n}{CTGANSynthesizer}\PYG{p}{(}
    \PYG{n}{metadata} \PYG{o}{=} \PYG{n}{metadata}\PYG{p}{,}
    \PYG{n}{enforce\PYGZus{}min\PYGZus{}max\PYGZus{}values} \PYG{o}{=} \PYG{k+kc}{True}\PYG{p}{,} \PYG{c+c1}{\PYGZsh{} Forzar datos real√≠sticos}
    \PYG{n}{enforce\PYGZus{}rounding} \PYG{o}{=} \PYG{k+kc}{True}\PYG{p}{,} \PYG{c+c1}{\PYGZsh{} Redondeos autom√°ticos}
    \PYG{n}{epochs} \PYG{o}{=} \PYG{l+m+mi}{500}\PYG{p}{,}
    \PYG{n}{verbose} \PYG{o}{=} \PYG{k+kc}{True}
\PYG{p}{)}\PYG{p}{;}

\PYG{c+c1}{\PYGZsh{} 4. Generar datos sint√©ticos}
\PYG{c+c1}{\PYGZsh{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{contextlib}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{io}

\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Entrenando CTGAN (esto puede tardar varios minutos)...}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Suprimir toda la salida est√°ndar para que no se vea al compilar}
\PYG{k}{with} \PYG{n}{contextlib}\PYG{o}{.}\PYG{n}{redirect\PYGZus{}stdout}\PYG{p}{(}\PYG{n}{io}\PYG{o}{.}\PYG{n}{StringIO}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{p}{:}
    \PYG{k}{with} \PYG{n}{contextlib}\PYG{o}{.}\PYG{n}{redirect\PYGZus{}stderr}\PYG{p}{(}\PYG{n}{io}\PYG{o}{.}\PYG{n}{StringIO}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{synthesizer}\PYG{o}{.}\PYG{n}{fit}\PYG{p}{(}\PYG{n}{real\PYGZus{}data}\PYG{p}{)}\PYG{p}{;}


\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Generando datos sint√©ticos}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n}{syntheticGAN\PYGZus{}data} \PYG{o}{=} \PYG{n}{synthesizer}\PYG{o}{.}\PYG{n}{sample}\PYG{p}{(}\PYG{n}{num\PYGZus{}rows}\PYG{o}{=}\PYG{n}{num\PYGZus{}synthetic}\PYG{p}{)}\PYG{p}{;}
\PYG{n}{display}\PYG{p}{(}\PYG{n}{syntheticGAN\PYGZus{}data}\PYG{o}{.}\PYG{n}{head}\PYG{p}{(}\PYG{l+m+mi}{10}\PYG{p}{)}\PYG{p}{)}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Se muestran 10 primeros registros sint√©ticos CTGAN de un total de }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{num\PYGZus{}synthetic}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} 5. Guardar satos sint√©ticos}
\PYG{c+c1}{\PYGZsh{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}

\PYG{n}{path\PYGZus{}syntheticCTGANData} \PYG{o}{=} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{.././data/SyntheticCTGAN.xlsx}\PYG{l+s+s2}{\PYGZdq{}}
\PYG{n}{syntheticGAN\PYGZus{}data}\PYG{o}{.}\PYG{n}{to\PYGZus{}excel}\PYG{p}{(}\PYG{n}{path\PYGZus{}syntheticCTGANData}\PYG{p}{,} \PYG{n}{index}\PYG{o}{=}\PYG{k+kc}{False}\PYG{p}{,} \PYG{n}{engine}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{openpyxl}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} 6. Validaci√≥n calidad datos sint√©ticos}
\PYG{c+c1}{\PYGZsh{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}

\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{sdv}\PYG{n+nn}{.}\PYG{n+nn}{evaluation}\PYG{n+nn}{.}\PYG{n+nn}{single\PYGZus{}table}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{run\PYGZus{}diagnostic}\PYG{p}{,} \PYG{n}{evaluate\PYGZus{}quality}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{sdv}\PYG{n+nn}{.}\PYG{n+nn}{evaluation}\PYG{n+nn}{.}\PYG{n+nn}{single\PYGZus{}table}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{get\PYGZus{}column\PYGZus{}plot}

\PYG{c+c1}{\PYGZsh{}\PYGZsh{} Diagn√≥stico b√°sico}
\PYG{n}{diagnostic} \PYG{o}{=} \PYG{n}{run\PYGZus{}diagnostic}\PYG{p}{(}\PYG{n}{real\PYGZus{}data}\PYG{p}{,} \PYG{n}{syntheticGAN\PYGZus{}data}\PYG{p}{,} \PYG{n}{metadata}\PYG{p}{,} \PYG{k+kc}{False}\PYG{p}{)}

\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s2}{DIAGN√ìSTICO B√ÅSICO CALIDAD DATOS}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{n}{diagnostic}\PYG{o}{.}\PYG{n}{get\PYGZus{}details}\PYG{p}{(}\PYG{n}{property\PYGZus{}name}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Data Validity}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{}\PYGZsh{} Visualizaci√≥n de datos}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{sdv}\PYG{n+nn}{.}\PYG{n+nn}{evaluation}\PYG{n+nn}{.}\PYG{n+nn}{single\PYGZus{}table}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{get\PYGZus{}column\PYGZus{}plot}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{seaborn}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{sns}

\PYG{n}{columnas} \PYG{o}{=} \PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Peso (g)}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Longitud (cm)}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Anchura (cm)}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Altura (cm)}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}

\PYG{n}{fig}\PYG{p}{,} \PYG{n}{axs} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplots}\PYG{p}{(}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{15}\PYG{p}{,} \PYG{l+m+mi}{12}\PYG{p}{)}\PYG{p}{)}
\PYG{k}{for} \PYG{n}{i}\PYG{p}{,} \PYG{n}{col} \PYG{o+ow}{in} \PYG{n+nb}{enumerate}\PYG{p}{(}\PYG{n}{columnas}\PYG{p}{)}\PYG{p}{:}
    \PYG{n}{ax} \PYG{o}{=} \PYG{n}{axs}\PYG{p}{[}\PYG{n}{i}\PYG{o}{/}\PYG{o}{/}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{i}\PYG{o}{\PYGZpc{}}\PYG{k}{2}]
    \PYG{n}{sns}\PYG{o}{.}\PYG{n}{kdeplot}\PYG{p}{(}\PYG{n}{real\PYGZus{}data}\PYG{p}{[}\PYG{n}{col}\PYG{p}{]}\PYG{p}{,} \PYG{n}{ax}\PYG{o}{=}\PYG{n}{ax}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{\PYGZsh{}1f77b4}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Real}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{fill}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.5}\PYG{p}{)}
    \PYG{n}{sns}\PYG{o}{.}\PYG{n}{kdeplot}\PYG{p}{(}\PYG{n}{syntheticGAN\PYGZus{}data}\PYG{p}{[}\PYG{n}{col}\PYG{p}{]}\PYG{p}{,} \PYG{n}{ax}\PYG{o}{=}\PYG{n}{ax}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{\PYGZsh{}d62728}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{CTGAN}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{fill}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.5}\PYG{p}{)}
    \PYG{n}{ax}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Distribuci√≥n de }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{col}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{ax}\PYG{o}{.}\PYG{n}{legend}\PYG{p}{(}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{suptitle}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Comparaci√≥n de datos reales vs. sint√©ticos (CTGAN)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{y}\PYG{o}{=}\PYG{l+m+mf}{1.02}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{}\PYGZsh{} Medidas de similiud estad√≠stica}

\PYG{n}{quality\PYGZus{}reportGAN} \PYG{o}{=} \PYG{n}{evaluate\PYGZus{}quality}\PYG{p}{(}\PYG{n}{real\PYGZus{}data}\PYG{p}{,} \PYG{n}{syntheticGAN\PYGZus{}data}\PYG{o}{.}\PYG{n}{sample}\PYG{p}{(}\PYG{n}{n}\PYG{o}{=}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{real\PYGZus{}data}\PYG{p}{)}\PYG{p}{,} \PYG{n}{random\PYGZus{}state}\PYG{o}{=}\PYG{l+m+mi}{42}\PYG{p}{)}\PYG{p}{,} \PYG{n}{metadata}\PYG{p}{,} \PYG{k+kc}{False}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{}\PYGZsh{} Obtenemos el valor promedio de la similitud}
\PYG{n}{overall\PYGZus{}scoreGAN} \PYG{o}{=} \PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{quality\PYGZus{}reportGAN}\PYG{o}{.}\PYG{n}{get\PYGZus{}score}\PYG{p}{(}\PYG{p}{)}\PYG{o}{*}\PYG{l+m+mi}{100}\PYG{l+s+si}{:}\PYG{l+s+s2}{.2f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZpc{}}\PYG{l+s+s2}{\PYGZdq{}}
\PYG{n}{glue}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{scoreGAN}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{overall\PYGZus{}scoreGAN}\PYG{p}{,} \PYG{n}{display}\PYG{o}{=}\PYG{k+kc}{False}\PYG{p}{)}\PYG{p}{;} \PYG{c+c1}{\PYGZsh{} Definimos una variable para usar en el texto markdown}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s2}{SIMILITUD ESTAD√çSTICA}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Overall score: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{overall\PYGZus{}scoreGAN}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\end{sphinxVerbatim}

\end{sphinxuseclass}\end{sphinxVerbatimInput}
\begin{sphinxVerbatimOutput}

\begin{sphinxuseclass}{cell_output}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
Metadatos cargados desde JSON.
Iniciando CTGAN...
Entrenando CTGAN (esto puede tardar varios minutos)...
\end{sphinxVerbatim}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
Generando datos sint√©ticos
\end{sphinxVerbatim}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
   Peso (g)  Longitud (cm)  Anchura (cm)  Altura (cm)
0      0.46            6.7           1.9          0.5
1      3.06            8.4           5.0          0.7
2      6.28           10.0           1.6          0.7
3      0.46            6.3           2.8          0.5
4      6.75            5.6           4.1          0.4
5      2.72            5.1           4.6          0.6
6      9.85           10.7           2.6          0.3
7      0.46            5.3           2.9          0.9
8      1.64           11.0           4.2          0.5
9      1.31            9.0           2.4          0.4
\end{sphinxVerbatim}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
Se muestran 10 primeros registros sint√©ticos CTGAN de un total de 500

DIAGN√ìSTICO B√ÅSICO CALIDAD DATOS

          Column             Metric  Score
0       Peso (g)  BoundaryAdherence    1.0
1  Longitud (cm)  BoundaryAdherence    1.0
2   Anchura (cm)  BoundaryAdherence    1.0
3    Altura (cm)  BoundaryAdherence    1.0
\end{sphinxVerbatim}

\noindent\sphinxincludegraphics{{101de52b59b3ed49a64f8853b5a8f1a27a413493984983b8ff1813fcfc88f211}.png}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
SIMILITUD ESTAD√çSTICA

Overall score: 69.00\PYGZpc{}
\end{sphinxVerbatim}

\end{sphinxuseclass}\end{sphinxVerbatimOutput}

\end{sphinxuseclass}
\begin{sphinxuseclass}{cell}\begin{sphinxVerbatimInput}

\begin{sphinxuseclass}{cell_input}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s2}{ Distribuciones individuales real vs. sint√©tica}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{n}{quality\PYGZus{}reportGAN}\PYG{o}{.}\PYG{n}{get\PYGZus{}details}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Column Shapes}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{)}
\end{sphinxVerbatim}

\end{sphinxuseclass}\end{sphinxVerbatimInput}
\begin{sphinxVerbatimOutput}

\begin{sphinxuseclass}{cell_output}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
 Distribuciones individuales real vs. sint√©tica

          Column        Metric     Score
0       Peso (g)  KSComplement  0.645933
1  Longitud (cm)  KSComplement  0.803828
2   Anchura (cm)  KSComplement  0.803828
3    Altura (cm)  KSComplement  0.870813
\end{sphinxVerbatim}

\end{sphinxuseclass}\end{sphinxVerbatimOutput}

\end{sphinxuseclass}
\begin{sphinxuseclass}{cell}\begin{sphinxVerbatimInput}

\begin{sphinxuseclass}{cell_input}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s2}{ Correlaciones entre variables real vs. sint√©tica}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{n}{quality\PYGZus{}reportGAN}\PYG{o}{.}\PYG{n}{get\PYGZus{}details}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Column Pair Trends}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{)}
\end{sphinxVerbatim}

\end{sphinxuseclass}\end{sphinxVerbatimInput}
\begin{sphinxVerbatimOutput}

\begin{sphinxuseclass}{cell_output}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
 Correlaciones entre variables real vs. sint√©tica

        Column 1       Column 2                 Metric     Score  \PYGZbs{}
0       Peso (g)  Longitud (cm)  CorrelationSimilarity  0.623063
1       Peso (g)   Anchura (cm)  CorrelationSimilarity  0.540390
2       Peso (g)    Altura (cm)  CorrelationSimilarity  0.549910
3  Longitud (cm)   Anchura (cm)  CorrelationSimilarity  0.643393
4  Longitud (cm)    Altura (cm)  CorrelationSimilarity  0.611668
5   Anchura (cm)    Altura (cm)  CorrelationSimilarity  0.624636

   Real Correlation  Synthetic Correlation
0          0.932951               0.179077
1          0.942354               0.023134
2          0.861768              \PYGZhy{}0.038412
3          0.936674               0.223459
4          0.870165               0.093501
5          0.842673               0.091944
\end{sphinxVerbatim}

\end{sphinxuseclass}\end{sphinxVerbatimOutput}

\end{sphinxuseclass}
\sphinxAtStartPar
Como se puede deducir de las tablas anteriores, la generaci√≥n de datos sint√©ticos mediante \sphinxstylestrong{CTGAN proporciona unas m√©tricas mucho m√°s pobres} que las obtenidas con el m√©todo Gaussian Copula, con una baja correlaci√≥n con los datos reales y en consecuencia \sphinxstylestrong{invalidando los registros sint√©ticos obtenidos} de peso, longitud, anchura y altura.

\sphinxstepscope


\section{Tabular Variational Autoencoder (TVAE)}
\label{\detokenize{content/02/TVAE:tabular-variational-autoencoder-tvae}}\label{\detokenize{content/02/TVAE::doc}}
\sphinxAtStartPar
El TVAE (Tabular Variational Autoencoder) es otro m√©todo avanzado de inteligencia artificial para generar datos sint√©ticos real√≠sticos que combina redes neuronales con principios estad√≠sticos. En esencia, funciona como un sistema de compresi√≥n y reconstrucci√≥n inteligente: primero, un ‚Äú\sphinxstyleemphasis{encoder}‚Äù reduce los datos originales a una representaci√≥n compacta llamada ‚Äúespacio latente‚Äù, donde se capturan las caracter√≠sticas esenciales de la informaci√≥n. Luego, un ‚Äú\sphinxstyleemphasis{decoder}‚Äù utiliza esta representaci√≥n para recrear los datos originales o generar nuevas muestras sint√©ticas. Lo que diferencia al TVAE de m√©todos m√°s simples es que este espacio latente no es ca√≥tico, sino que sigue una distribuci√≥n gaussiana controlada, lo que permite generar datos variados pero coherentes con la estructura original.

\sphinxAtStartPar
Matem√°ticamente, el TVAE se basa en el concepto de ‚Äúinferencia variacional‚Äù, que busca aproximar distribuciones complejas de datos mediante modelos probabil√≠sticos. Durante el entrenamiento, el sistema no solo aprende a reconstruir datos, sino que tambi√©n minimiza la divergencia entre la distribuci√≥n del espacio latente y una distribuci√≥n gaussiana est√°ndar. Esto se logra mediante una funci√≥n de p√©rdida que balancea dos objetivos: la precisi√≥n en la reconstrucci√≥n (para que los datos sint√©ticos se parezcan a los reales) y la regularizaci√≥n (para que el espacio latente mantenga una estructura estad√≠stica ordenada). Este equilibrio evita que el modelo genere datos id√©nticos a los originales o, por el contrario, produzca informaci√≥n sin sentido.

\sphinxAtStartPar
Para adaptarse espec√≠ficamente a datos tabulares (como es en nuestro caso), el TVAE incorpora transformaciones especializadas. As√≠, las variables continuas se modelan como mezclas de distribuciones gaussianas, lo que permite capturar multimodalidad (varios picos en los datos), mientras que las variables categ√≥ricas se procesan con codificaciones que preservan sus relaciones. Esta flexibilidad permite al TVAE manejar relaciones no lineales y complejas entre variables, como las t√≠picas en datos biol√≥gicos, donde m√©todos tradicionales basados en correlaciones lineales resultan insuficientes.

\sphinxAtStartPar
La principal ventaja del TVAE frente a m√©todos como Gaussian Copula radica en su capacidad para aprender patrones intrincados sin depender de suposiciones simplificadas sobre la estructura de los datos. Sin embargo, requiere mayor poder computacional y ajuste fino de hiperpar√°metros (como la dimensi√≥n del espacio latente o el peso de la regularizaci√≥n). Por esto, es ideal para casos donde la calidad de los datos sint√©ticos es cr√≠tica, como en investigaci√≥n m√©dica o biol√≥gica \sphinxhref{https://doi.org/10.48550/arXiv.2205.03257}{{[}Jordon et al., 2022{]}}, donde preservar la complejidad de las distribuciones originales es esencial para validaciones posteriores. Su fundamento matem√°tico lo convierte en una herramienta robusta para expandir conjuntos de datos limitados manteniendo la consistencia estad√≠stica de la poblaci√≥n original.

\begin{sphinxuseclass}{cell}\begin{sphinxVerbatimInput}

\begin{sphinxuseclass}{cell_input}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{pandas}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{pd}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{numpy}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{np}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{sdv}\PYG{n+nn}{.}\PYG{n+nn}{single\PYGZus{}table}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{TVAESynthesizer}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{sdv}\PYG{n+nn}{.}\PYG{n+nn}{metadata}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{SingleTableMetadata}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{sdv}\PYG{n+nn}{.}\PYG{n+nn}{evaluation}\PYG{n+nn}{.}\PYG{n+nn}{single\PYGZus{}table}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{run\PYGZus{}diagnostic}\PYG{p}{,} \PYG{n}{evaluate\PYGZus{}quality}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{sdv}\PYG{n+nn}{.}\PYG{n+nn}{evaluation}\PYG{n+nn}{.}\PYG{n+nn}{single\PYGZus{}table}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{get\PYGZus{}column\PYGZus{}plot}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{sdv}\PYG{n+nn}{.}\PYG{n+nn}{metadata}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{Metadata}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{matplotlib}\PYG{n+nn}{.}\PYG{n+nn}{pyplot}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{plt}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{seaborn}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{sns}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{pathlib}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{Path}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{myst\PYGZus{}nb}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{glue}

\PYG{n}{num\PYGZus{}synthetic} \PYG{o}{=} \PYG{l+m+mi}{500} \PYG{c+c1}{\PYGZsh{}variable para definir el n√∫mero de registros sint√©ticos}

\PYG{c+c1}{\PYGZsh{} 1. Cargar datos reales}
\PYG{c+c1}{\PYGZsh{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{n}{path\PYGZus{}realData} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{.././data/Dimensiones\PYGZus{}lenguado.xlsx}\PYG{l+s+s1}{\PYGZsq{}}
\PYG{n}{real\PYGZus{}data} \PYG{o}{=} \PYG{n}{pd}\PYG{o}{.}\PYG{n}{read\PYGZus{}excel}\PYG{p}{(}\PYG{n}{path\PYGZus{}realData}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} 2. Obtener los metadata del dataset}
\PYG{c+c1}{\PYGZsh{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}

\PYG{n}{metadata\PYGZus{}path} \PYG{o}{=} \PYG{n}{Path}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{.././data/metadata\PYGZus{}lenguado.json}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}

\PYG{k}{if} \PYG{n}{metadata\PYGZus{}path}\PYG{o}{.}\PYG{n}{exists}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
    \PYG{c+c1}{\PYGZsh{} Cargar metadatos desde el JSON (evita el warning)}
    \PYG{n}{metadata} \PYG{o}{=} \PYG{n}{Metadata}\PYG{o}{.}\PYG{n}{load\PYGZus{}from\PYGZus{}json}\PYG{p}{(}\PYG{n}{metadata\PYGZus{}path}\PYG{p}{)}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Metadatos cargados desde JSON.}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{k}{else}\PYG{p}{:}
    \PYG{c+c1}{\PYGZsh{} Detectar metadatos y guardarlos en JSON para futuras ejecuciones}
    \PYG{n}{metadata} \PYG{o}{=} \PYG{n}{Metadata}\PYG{o}{.}\PYG{n}{detect\PYGZus{}from\PYGZus{}dataframe}\PYG{p}{(}\PYG{n}{real\PYGZus{}data}\PYG{p}{)}
    \PYG{n}{metadata}\PYG{o}{.}\PYG{n}{save\PYGZus{}to\PYGZus{}json}\PYG{p}{(}\PYG{n}{metadata\PYGZus{}path}\PYG{p}{)}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Metadatos detectados y guardados en JSON.}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} 3. Inicializar y entrenar TVAE}
\PYG{c+c1}{\PYGZsh{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Inicializando TVAE...}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n}{tvae\PYGZus{}model} \PYG{o}{=} \PYG{n}{TVAESynthesizer}\PYG{p}{(}
    \PYG{n}{metadata} \PYG{o}{=} \PYG{n}{metadata}\PYG{p}{,}
    \PYG{n}{epochs}\PYG{o}{=}\PYG{l+m+mi}{300}\PYG{p}{,}           \PYG{c+c1}{\PYGZsh{} N√∫mero de √©pocas de entrenamiento}
    \PYG{n}{batch\PYGZus{}size}\PYG{o}{=}\PYG{l+m+mi}{32}\PYG{p}{,}        \PYG{c+c1}{\PYGZsh{} Tama√±o del batch}
    \PYG{n}{embedding\PYGZus{}dim}\PYG{o}{=}\PYG{l+m+mi}{128}\PYG{p}{,}    \PYG{c+c1}{\PYGZsh{} Dimensi√≥n del espacio latente}
    \PYG{n}{compress\PYGZus{}dims}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{128}\PYG{p}{,} \PYG{l+m+mi}{128}\PYG{p}{)}\PYG{p}{,}  \PYG{c+c1}{\PYGZsh{} Capas del encoder}
    \PYG{n}{decompress\PYGZus{}dims}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{128}\PYG{p}{,} \PYG{l+m+mi}{128}\PYG{p}{)}\PYG{p}{,} \PYG{c+c1}{\PYGZsh{} Capas del decoder}
    \PYG{n}{loss\PYGZus{}factor}\PYG{o}{=}\PYG{l+m+mi}{2}\PYG{p}{,}        \PYG{c+c1}{\PYGZsh{} Balance entre p√©rdida de reconstrucci√≥n y KL}
    \PYG{n}{cuda}\PYG{o}{=}\PYG{k+kc}{True}             \PYG{c+c1}{\PYGZsh{} Usar GPU si est√° disponible}
\PYG{p}{)}

\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Entrenando TVAE (esto puede tomar varios minutos)...}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n}{tvae\PYGZus{}model}\PYG{o}{.}\PYG{n}{fit}\PYG{p}{(}\PYG{n}{real\PYGZus{}data}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} 4. Generar datos sint√©ticos}
\PYG{c+c1}{\PYGZsh{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Generando datos sint√©ticos...}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n}{syntheticTVAE\PYGZus{}data} \PYG{o}{=} \PYG{n}{tvae\PYGZus{}model}\PYG{o}{.}\PYG{n}{sample}\PYG{p}{(}\PYG{n}{num\PYGZus{}rows}\PYG{o}{=}\PYG{l+m+mi}{500}\PYG{p}{)}\PYG{p}{;}
\PYG{n}{display}\PYG{p}{(}\PYG{n}{syntheticTVAE\PYGZus{}data}\PYG{o}{.}\PYG{n}{head}\PYG{p}{(}\PYG{l+m+mi}{10}\PYG{p}{)}\PYG{p}{)}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Se muestran 10 primeros registros sint√©ticos TVAE de un total de }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{num\PYGZus{}synthetic}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} 5. Guardar resultados}
\PYG{c+c1}{\PYGZsh{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{n}{path\PYGZus{}syntheticTVAEData} \PYG{o}{=} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{.././data/SyntheticTVAE.xlsx}\PYG{l+s+s2}{\PYGZdq{}}
\PYG{n}{syntheticTVAE\PYGZus{}data}\PYG{o}{.}\PYG{n}{to\PYGZus{}excel}\PYG{p}{(}\PYG{n}{path\PYGZus{}syntheticTVAEData}\PYG{p}{,} \PYG{n}{index}\PYG{o}{=}\PYG{k+kc}{False}\PYG{p}{,} \PYG{n}{engine}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{openpyxl}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} 6. Evaluaci√≥n datos sint√©ticos}
\PYG{c+c1}{\PYGZsh{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}

\PYG{c+c1}{\PYGZsh{}\PYGZsh{} Diagn√≥stico b√°sico}
\PYG{n}{diagnosticTVAE} \PYG{o}{=} \PYG{n}{run\PYGZus{}diagnostic}\PYG{p}{(}\PYG{n}{real\PYGZus{}data}\PYG{p}{,} \PYG{n}{syntheticTVAE\PYGZus{}data}\PYG{p}{,} \PYG{n}{metadata}\PYG{p}{,} \PYG{k+kc}{False}\PYG{p}{)}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s2}{DIAGN√ìSTICO B√ÅSICO CALIDAD DATOS}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{n}{diagnosticTVAE}\PYG{o}{.}\PYG{n}{get\PYGZus{}details}\PYG{p}{(}\PYG{n}{property\PYGZus{}name}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Data Validity}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{}\PYGZsh{} Visualizaci√≥n datos}
\PYG{c+c1}{\PYGZsh{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}

\PYG{n}{columnas} \PYG{o}{=} \PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Peso (g)}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Longitud (cm)}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Anchura (cm)}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Altura (cm)}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}
\PYG{n}{fig}\PYG{p}{,} \PYG{n}{axes} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplots}\PYG{p}{(}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{15}\PYG{p}{,} \PYG{l+m+mi}{10}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{variables} \PYG{o}{=} \PYG{n}{real\PYGZus{}data}\PYG{o}{.}\PYG{n}{columns}

\PYG{k}{for} \PYG{n}{i}\PYG{p}{,} \PYG{n}{var} \PYG{o+ow}{in} \PYG{n+nb}{enumerate}\PYG{p}{(}\PYG{n}{variables}\PYG{p}{)}\PYG{p}{:}
    \PYG{n}{row}\PYG{p}{,} \PYG{n}{col} \PYG{o}{=} \PYG{n}{i} \PYG{o}{/}\PYG{o}{/} \PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{i} \PYG{o}{\PYGZpc{}} \PYG{l+m+mi}{2}
    \PYG{n}{sns}\PYG{o}{.}\PYG{n}{kdeplot}\PYG{p}{(}\PYG{n}{real\PYGZus{}data}\PYG{p}{[}\PYG{n}{var}\PYG{p}{]}\PYG{p}{,} \PYG{n}{ax}\PYG{o}{=}\PYG{n}{axes}\PYG{p}{[}\PYG{n}{row}\PYG{p}{,} \PYG{n}{col}\PYG{p}{]}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Real}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{fill}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.7}\PYG{p}{)}
    \PYG{n}{sns}\PYG{o}{.}\PYG{n}{kdeplot}\PYG{p}{(}\PYG{n}{syntheticTVAE\PYGZus{}data}\PYG{p}{[}\PYG{n}{var}\PYG{p}{]}\PYG{p}{,} \PYG{n}{ax}\PYG{o}{=}\PYG{n}{axes}\PYG{p}{[}\PYG{n}{row}\PYG{p}{,} \PYG{n}{col}\PYG{p}{]}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Sint√©tico}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{fill}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.7}\PYG{p}{)}
    \PYG{n}{axes}\PYG{p}{[}\PYG{n}{row}\PYG{p}{,} \PYG{n}{col}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Distribuci√≥n de }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{var}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{axes}\PYG{p}{[}\PYG{n}{row}\PYG{p}{,} \PYG{n}{col}\PYG{p}{]}\PYG{o}{.}\PYG{n}{legend}\PYG{p}{(}\PYG{p}{)}

\PYG{n}{plt}\PYG{o}{.}\PYG{n}{suptitle}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Comparaci√≥n: Datos Reales vs Sint√©ticos (TVAE)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{fontsize}\PYG{o}{=}\PYG{l+m+mi}{16}\PYG{p}{,} \PYG{n}{y}\PYG{o}{=}\PYG{l+m+mf}{0.98}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}


\PYG{c+c1}{\PYGZsh{}\PYGZsh{} Medidas de similiud estad√≠stica}

\PYG{n}{quality\PYGZus{}reportTVAE} \PYG{o}{=} \PYG{n}{evaluate\PYGZus{}quality}\PYG{p}{(}\PYG{n}{real\PYGZus{}data}\PYG{p}{,} \PYG{n}{syntheticTVAE\PYGZus{}data}\PYG{o}{.}\PYG{n}{sample}\PYG{p}{(}\PYG{n}{n}\PYG{o}{=}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{real\PYGZus{}data}\PYG{p}{)}\PYG{p}{,} \PYG{n}{random\PYGZus{}state}\PYG{o}{=}\PYG{l+m+mi}{42}\PYG{p}{)}\PYG{p}{,} \PYG{n}{metadata}\PYG{p}{,} \PYG{k+kc}{False}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{}\PYGZsh{} Obtenemos el valor promedio de la similitud}
\PYG{n}{overall\PYGZus{}scoreTVAE} \PYG{o}{=} \PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{quality\PYGZus{}reportTVAE}\PYG{o}{.}\PYG{n}{get\PYGZus{}score}\PYG{p}{(}\PYG{p}{)}\PYG{o}{*}\PYG{l+m+mi}{100}\PYG{l+s+si}{:}\PYG{l+s+s2}{.2f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZpc{}}\PYG{l+s+s2}{\PYGZdq{}}
\PYG{n}{glue}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{scoreTVAE}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{overall\PYGZus{}scoreTVAE}\PYG{p}{,} \PYG{n}{display}\PYG{o}{=}\PYG{k+kc}{False}\PYG{p}{)}\PYG{p}{;} \PYG{c+c1}{\PYGZsh{} Definimos una variable para usar en el texto markdown}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s2}{SIMILITUD ESTAD√çSTICA}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Overall score: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{overall\PYGZus{}scoreTVAE}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}

\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s2}{ Distribuciones individuales real vs. sint√©tica}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{n}{quality\PYGZus{}reportTVAE}\PYG{o}{.}\PYG{n}{get\PYGZus{}details}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Column Shapes}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{)}

\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s2}{ Correlaciones entre variables real vs. sint√©tica}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{n}{quality\PYGZus{}reportTVAE}\PYG{o}{.}\PYG{n}{get\PYGZus{}details}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Column Pair Trends}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{)}
\end{sphinxVerbatim}

\end{sphinxuseclass}\end{sphinxVerbatimInput}
\begin{sphinxVerbatimOutput}

\begin{sphinxuseclass}{cell_output}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
Metadatos cargados desde JSON.
Inicializando TVAE...
Entrenando TVAE (esto puede tomar varios minutos)...
\end{sphinxVerbatim}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
  File \PYGZdq{}C:\PYGZbs{}Users\PYGZbs{}javie\PYGZbs{}Workspaces\PYGZbs{}base12\PYGZbs{}Lib\PYGZbs{}site\PYGZhy{}packages\PYGZbs{}joblib\PYGZbs{}externals\PYGZbs{}loky\PYGZbs{}backend\PYGZbs{}context.py\PYGZdq{}, line 257, in \PYGZus{}count\PYGZus{}physical\PYGZus{}cores
    cpu\PYGZus{}info = subprocess.run(
               \PYGZca{}\PYGZca{}\PYGZca{}\PYGZca{}\PYGZca{}\PYGZca{}\PYGZca{}\PYGZca{}\PYGZca{}\PYGZca{}\PYGZca{}\PYGZca{}\PYGZca{}\PYGZca{}\PYGZca{}
  File \PYGZdq{}C:\PYGZbs{}Python\PYGZbs{}Python312\PYGZbs{}Lib\PYGZbs{}subprocess.py\PYGZdq{}, line 548, in run
    with Popen(*popenargs, **kwargs) as process:
         \PYGZca{}\PYGZca{}\PYGZca{}\PYGZca{}\PYGZca{}\PYGZca{}\PYGZca{}\PYGZca{}\PYGZca{}\PYGZca{}\PYGZca{}\PYGZca{}\PYGZca{}\PYGZca{}\PYGZca{}\PYGZca{}\PYGZca{}\PYGZca{}\PYGZca{}\PYGZca{}\PYGZca{}\PYGZca{}\PYGZca{}\PYGZca{}\PYGZca{}\PYGZca{}\PYGZca{}
  File \PYGZdq{}C:\PYGZbs{}Python\PYGZbs{}Python312\PYGZbs{}Lib\PYGZbs{}subprocess.py\PYGZdq{}, line 1026, in \PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}
    self.\PYGZus{}execute\PYGZus{}child(args, executable, preexec\PYGZus{}fn, close\PYGZus{}fds,
  File \PYGZdq{}C:\PYGZbs{}Python\PYGZbs{}Python312\PYGZbs{}Lib\PYGZbs{}subprocess.py\PYGZdq{}, line 1538, in \PYGZus{}execute\PYGZus{}child
    hp, ht, pid, tid = \PYGZus{}winapi.CreateProcess(executable, args,
                       \PYGZca{}\PYGZca{}\PYGZca{}\PYGZca{}\PYGZca{}\PYGZca{}\PYGZca{}\PYGZca{}\PYGZca{}\PYGZca{}\PYGZca{}\PYGZca{}\PYGZca{}\PYGZca{}\PYGZca{}\PYGZca{}\PYGZca{}\PYGZca{}\PYGZca{}\PYGZca{}\PYGZca{}\PYGZca{}\PYGZca{}\PYGZca{}\PYGZca{}\PYGZca{}\PYGZca{}\PYGZca{}\PYGZca{}\PYGZca{}\PYGZca{}\PYGZca{}\PYGZca{}\PYGZca{}\PYGZca{}\PYGZca{}\PYGZca{}\PYGZca{}\PYGZca{}
\end{sphinxVerbatim}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
Generando datos sint√©ticos...
\end{sphinxVerbatim}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
   Peso (g)  Longitud (cm)  Anchura (cm)  Altura (cm)
0      2.77            5.9           2.4          0.4
1      3.77            7.3           2.3          0.4
2     10.62            9.3           3.9          0.6
3     11.72            9.5           3.8          0.6
4      4.73            8.2           3.4          0.5
5      3.57            8.3           2.4          0.4
6      2.50            5.2           2.3          0.3
7      2.97            6.2           2.3          0.4
8      7.94            9.3           3.0          0.5
9      2.92            6.0           2.0          0.3
\end{sphinxVerbatim}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
Se muestran 10 primeros registros sint√©ticos TVAE de un total de 500

DIAGN√ìSTICO B√ÅSICO CALIDAD DATOS

          Column             Metric  Score
0       Peso (g)  BoundaryAdherence    1.0
1  Longitud (cm)  BoundaryAdherence    1.0
2   Anchura (cm)  BoundaryAdherence    1.0
3    Altura (cm)  BoundaryAdherence    1.0
\end{sphinxVerbatim}

\noindent\sphinxincludegraphics{{f66db7e2964f01c988dc71e4e04f37bce31b839357af3158c4fca1afefd83e3a}.png}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
SIMILITUD ESTAD√çSTICA

Overall score: 93.71\PYGZpc{}


 Distribuciones individuales real vs. sint√©tica

          Column        Metric     Score
0       Peso (g)  KSComplement  0.861244
1  Longitud (cm)  KSComplement  0.923445
2   Anchura (cm)  KSComplement  0.952153
3    Altura (cm)  KSComplement  0.947368

 Correlaciones entre variables real vs. sint√©tica

        Column 1       Column 2                 Metric     Score  \PYGZbs{}
0       Peso (g)  Longitud (cm)  CorrelationSimilarity  0.921427
1       Peso (g)   Anchura (cm)  CorrelationSimilarity  0.929216
2       Peso (g)    Altura (cm)  CorrelationSimilarity  0.983946
3  Longitud (cm)   Anchura (cm)  CorrelationSimilarity  0.904529
4  Longitud (cm)    Altura (cm)  CorrelationSimilarity  0.986978
5   Anchura (cm)    Altura (cm)  CorrelationSimilarity  0.992524

   Real Correlation  Synthetic Correlation
0          0.932951               0.775805
1          0.942354               0.800787
2          0.861768               0.829660
3          0.936674               0.745732
4          0.870165               0.844121
5          0.842673               0.827720
\end{sphinxVerbatim}

\end{sphinxuseclass}\end{sphinxVerbatimOutput}

\end{sphinxuseclass}
\sphinxAtStartPar
En l√≠neas generales, este m√©todo proporciona una similud estad√≠stica general del \DUrole{output,text_plain}{‚Äò93.71\%‚Äô}. Un an√°lisis con mayor detalle nos revela que la generaci√≥n de datos sint√©ticos a nivel de variable individual mantiene razonablemente bien las caracter√≠sticas originales (\(\approx 90\%\)). Por otro lado, la m√©trica \sphinxcode{\sphinxupquote{CorrelationSimilarity}} entre pares de variables es elevada aunque inferior al m√©todo Gaussian Copula. En lo que se refiere a las correlaciones sint√©ticas entre variables, los valores porcentuales son bastante menores que los correspondientes referencias con datos reales, lo cual sugiere que los datos obtenidos pueden no ser v√°lidos para entrenamiento de algoritmos de \sphinxstyleemphasis{machine learning}.

\sphinxstepscope


\section{Conclusi√≥n}
\label{\detokenize{content/02/Conclusion:conclusion}}\label{\detokenize{content/02/Conclusion::doc}}
\sphinxAtStartPar
En la siguiente gr√°fica se puede apreciar el comportamiento de los tres m√©todos de generaci√≥n de datos sint√©ticos estudiados.

\begin{sphinxuseclass}{cell}\begin{sphinxVerbatimInput}

\begin{sphinxuseclass}{cell_input}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{pandas}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{pd}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{numpy}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{np}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{matplotlib}\PYG{n+nn}{.}\PYG{n+nn}{pyplot}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{plt}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{seaborn}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{sns}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{pathlib}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{Path}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{myst\PYGZus{}nb}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{glue}

\PYG{n}{real\PYGZus{}data} \PYG{o}{=} \PYG{n}{pd}\PYG{o}{.}\PYG{n}{read\PYGZus{}excel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{.././data/Dimensiones\PYGZus{}lenguado.xlsx}\PYG{l+s+s1}{\PYGZsq{}} \PYG{p}{)}
\PYG{n}{synthetic\PYGZus{}data} \PYG{o}{=} \PYG{n}{pd}\PYG{o}{.}\PYG{n}{read\PYGZus{}excel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{.././data/SyntheticGaussianCopula.xlsx}\PYG{l+s+s1}{\PYGZsq{}} \PYG{p}{)}
\PYG{n}{syntheticGAN\PYGZus{}data} \PYG{o}{=} \PYG{n}{pd}\PYG{o}{.}\PYG{n}{read\PYGZus{}excel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{.././data/SyntheticCTGAN.xlsx}\PYG{l+s+s1}{\PYGZsq{}} \PYG{p}{)}
\PYG{n}{syntheticTVAE\PYGZus{}data} \PYG{o}{=} \PYG{n}{pd}\PYG{o}{.}\PYG{n}{read\PYGZus{}excel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{.././data/SyntheticTVAE.xlsx}\PYG{l+s+s1}{\PYGZsq{}} \PYG{p}{)}

\PYG{n}{columnas} \PYG{o}{=} \PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Peso (g)}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Longitud (cm)}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Anchura (cm)}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Altura (cm)}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}

\PYG{n}{fig}\PYG{p}{,} \PYG{n}{axs} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplots}\PYG{p}{(}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{15}\PYG{p}{,} \PYG{l+m+mi}{12}\PYG{p}{)}\PYG{p}{)}
\PYG{k}{for} \PYG{n}{i}\PYG{p}{,} \PYG{n}{col} \PYG{o+ow}{in} \PYG{n+nb}{enumerate}\PYG{p}{(}\PYG{n}{columnas}\PYG{p}{)}\PYG{p}{:}
    \PYG{n}{ax} \PYG{o}{=} \PYG{n}{axs}\PYG{p}{[}\PYG{n}{i}\PYG{o}{/}\PYG{o}{/}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{i}\PYG{o}{\PYGZpc{}}\PYG{k}{2}]
    \PYG{n}{sns}\PYG{o}{.}\PYG{n}{kdeplot}\PYG{p}{(}\PYG{n}{real\PYGZus{}data}\PYG{p}{[}\PYG{n}{col}\PYG{p}{]}\PYG{p}{,} \PYG{n}{ax}\PYG{o}{=}\PYG{n}{ax}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{\PYGZsh{}1f77b4}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Real}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{fill}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.5}\PYG{p}{)}
    \PYG{n}{sns}\PYG{o}{.}\PYG{n}{kdeplot}\PYG{p}{(}\PYG{n}{synthetic\PYGZus{}data}\PYG{p}{[}\PYG{n}{col}\PYG{p}{]}\PYG{p}{,} \PYG{n}{ax}\PYG{o}{=}\PYG{n}{ax}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{\PYGZsh{}2ca02c}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Gaussian Copula}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{fill}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.5}\PYG{p}{)}
    \PYG{n}{sns}\PYG{o}{.}\PYG{n}{kdeplot}\PYG{p}{(}\PYG{n}{syntheticGAN\PYGZus{}data}\PYG{p}{[}\PYG{n}{col}\PYG{p}{]}\PYG{p}{,} \PYG{n}{ax}\PYG{o}{=}\PYG{n}{ax}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{\PYGZsh{}d62728}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{CTGAN}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{fill}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.5}\PYG{p}{)}
    \PYG{n}{sns}\PYG{o}{.}\PYG{n}{kdeplot}\PYG{p}{(}\PYG{n}{syntheticTVAE\PYGZus{}data}\PYG{p}{[}\PYG{n}{col}\PYG{p}{]}\PYG{p}{,} \PYG{n}{ax}\PYG{o}{=}\PYG{n}{ax}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{\PYGZsh{}9467bd}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{TVAE}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{fill}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.5}\PYG{p}{)}
    \PYG{n}{ax}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Distribuci√≥n de }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{col}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{ax}\PYG{o}{.}\PYG{n}{legend}\PYG{p}{(}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{suptitle}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Comparaci√≥n de datos reales vs. sint√©ticos}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{y}\PYG{o}{=}\PYG{l+m+mf}{1.02}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}
\end{sphinxVerbatim}

\end{sphinxuseclass}\end{sphinxVerbatimInput}
\begin{sphinxVerbatimOutput}

\begin{sphinxuseclass}{cell_output}
\noindent\sphinxincludegraphics{{31bfb5300642f4a944df6453e939e879305fbf3ba30a92813ef0f196681b4199}.png}

\end{sphinxuseclass}\end{sphinxVerbatimOutput}

\end{sphinxuseclass}
\sphinxAtStartPar
Los resultados obtenidos con el m√©todo Gaussian Copula son los que mejor se ajustan al dataset real. TVAE tambi√©n mantiene una adecuada distribuci√≥n respecto a las variables individuales, pero muestra unos picos de densidad m√°s elevados lo cual indica que est√° sobreestimando par√°metros. Los resultados m√°s pobres se han obtenido con CTGAN. Uno de los principales motivos de estos resulatdos tan bajos radica en que las GANs tabulares aprenden correlaciones mediante adversarial training, que es inestable con muestras peque√±as. {[}\sphinxhref{https://doi.org/10.48550/arXiv.1907.00503}{Xu et al., 2019}{]} recomiendan una poblaci√≥n m√≠nima de \(N>1000\) muestras para que poder generalizar.

\sphinxstepscope


\part{PT3 \sphinxhyphen{} Predicci√≥n del Peso}

\sphinxstepscope


\chapter{Desarrollo Experimental de un Modelo de IA para la Estimaci√≥n del Peso}
\label{\detokenize{content/03/Peso:desarrollo-experimental-de-un-modelo-de-ia-para-la-estimacion-del-peso}}\label{\detokenize{content/03/Peso::doc}}
\begin{sphinxadmonition}{note}{Resumen}

\sphinxAtStartPar
La predicci√≥n del peso del lenguado (\sphinxstyleemphasis{Solea solea}) a partir de su tama√±o es un problema relevante en acuicultura, especialmente para la optimizaci√≥n de la alimentaci√≥n y el control del crecimiento. Este estudio presenta un m√©todo para el desarrollo de un algoritmo de predicci√≥n del peso del lenguado a partir de variables morfol√≥gicas extra√≠das mediante visi√≥n artificial. Las variables consideradas incluyen la longitud, la anchura y la superficie real del pez, obtenidas autom√°ticamente a partir de im√°genes digitales en condiciones controladas. El algoritmo, basado en t√©cnicas de regresi√≥n y aprendizaje autom√°tico, se ha dise√±ado para integrarse en un sistema aut√≥nomo de clasificaci√≥n y estimaci√≥n de peso en tiempo real, con aplicaci√≥n directa al \sphinxstyleemphasis{gradding} automatizado de alevines en tres categor√≠as de tama√±o: peque√±o, mediano y grande. Este enfoque proporciona una soluci√≥n precisa y escalable para optimizar el manejo de peces en sistemas de acuicultura, contribuyendo a una mejora en la eficiencia operativa y el bienestar animal.

\sphinxAtStartPar
\sphinxstylestrong{Entregable}: E3.1\\
\sphinxstylestrong{Versi√≥n}: 1.0\\
\sphinxstylestrong{Autor}: Javier √Ålvarez Osuna\\
\sphinxstylestrong{Email}: javier.osuna@fishfarmfeeder.com\\
\sphinxstylestrong{ORCID}: \sphinxhref{https://orcid.org/0000-0001-7063-1279}{0000\sphinxhyphen{}0001\sphinxhyphen{}7063\sphinxhyphen{}1279}\\
\sphinxstylestrong{Licencia}: CC\sphinxhyphen{}BY\sphinxhyphen{}4.0\\
\sphinxstylestrong{C√≥digo proyecto}: IG408M.2025.000.000072

\begin{figure}[H]
\centering

\noindent\sphinxincludegraphics[width=1.000\linewidth]{{FLATCLASS_logo_publicidad}.png}
\end{figure}
\end{sphinxadmonition}


\section{Introducci√≥n}
\label{\detokenize{content/03/Peso:introduccion}}
\sphinxAtStartPar
En este cap√≠tulo se describen las l√≠neas de trabajo desarrolladas, en el marco del proyecto FLATCLASS, para el desarrollo de un modelo predictivo basado en Inteligencia Artificial (IA) para estimar el peso de ejemplares de lenguado utilizando las variables morfom√©tricas de lenguado obtenidas mediante visi√≥n artificial. El prop√≥sito del modelo es desarrollar una herramienta no invasiva, escalable y en tiempo real, que cumpla con los requisitos de robustez y precisi√≥n necesarios en entornos de producci√≥n acu√≠cola. El planteamiento metodol√≥gico combina t√©cnicas de aprendizaje supervisado con variables morfom√©tricas clave como longitud, ancho y altura corporal, lo que permite capturar relaciones no lineales con la masa del pescado.

\sphinxAtStartPar
En estudios recientes como el de \sphinxhref{https://doi.org/10.3390/s22145161}{Tengtrairat et al., 2022}, se aplic√≥ una combinaci√≥n de visi√≥n estereosc√≥pica y regresiones profundas para estimar peso de tilapia con un error medio de 30‚ÄØg y un R¬≤ del 0,70. Del mismo modo, \sphinxhref{https://doi.org/10.3390/app13010069}{Lopez‚ÄëTejeida et al., 2023} demostraron que el uso de c√°maras infrarrojas NIR y regresi√≥n matem√°tica permite reducir el estr√©s en el pez y mejorar la precisi√≥n del modelo de peso con una metodolog√≠a no invasiva. Estos enfoques validan cient√≠ficamente la relevancia y aplicabilidad de los m√©todos que presentamos.

\sphinxAtStartPar
Adicionalmente, trabajos como los de \sphinxhref{https://doi.org/10.48550/arXiv.1909.02710}{Konovalov et al., 2019} y \sphinxhref{https://doi.org/10.48550/arXiv.1909.02710}{Moseli et al., 2024} confirman que las redes neuronales convolucionales permiten segmentar y estimar pesos con errores inferiores al 5\% en poblaciones variadas. Nuestro dise√±o experimental plantea una estructura reproducible basada en: (1) adquisici√≥n de im√°genes bajo condiciones controladas, (2) extracci√≥n de informaci√≥n morfom√©trica y etiquetado de muestras, (3) entrenamiento de modelos de IA con validaci√≥n cruzada, y (4) evaluaci√≥n de desempe√±o mediante m√©tricas estad√≠sticas y t√©cnicas de an√°lisis de error. Esto garantiza una base s√≥lida tanto para la validaci√≥n como para la futura implementaci√≥n del modelo en escenarios reales.

\sphinxstepscope


\section{Estudio matem√°tico de las relaciones entre las dimensiones morfol√≥gicas y el peso}
\label{\detokenize{content/03/Coeficientes:estudio-matematico-de-las-relaciones-entre-las-dimensiones-morfologicas-y-el-peso}}\label{\detokenize{content/03/Coeficientes::doc}}

\subsection{Justificaci√≥n matem√°tica y biol√≥gica}
\label{\detokenize{content/03/Coeficientes:justificacion-matematica-y-biologica}}
\sphinxAtStartPar
La relaci√≥n entre la longitud y el peso en peces suele seguir la ley c√∫bica (\(W\propto L^{3}\)), pero en peces planos como el lenguado, la relaci√≥n superficie\sphinxhyphen{}peso es m√°s adecuada, ya que su cuerpo es achatado y su crecimiento no es isom√©trico. Los trabajos de {[}\sphinxhref{https://doi.org/10.1111/j.1439-0426.2006.00805.x}{Froese, 2006}{]} y \sphinxhref{https://doi.org/10.1111/j.1751-5823.2012.00179\_26.x}{{[}Haddon et al., 2011{]}} pusieron de manifiesto que en peces planos existe una correlaci√≥n entre el peso del individuo (\(W\)) y la superficie (\(S\)) del mismo que viene dada por la expresi√≥n matem√°tica:
\begin{equation}\label{equation:content/03/Coeficientes:eq_peso-superficie}
\begin{split}W=aS^b\end{split}
\end{equation}
\sphinxAtStartPar
en donde:
\begin{itemize}
\item {}
\sphinxAtStartPar
\(a\) es un coeficiente emp√≠rico que depende de la especie y las condiciones de cultivo.

\item {}
\sphinxAtStartPar
\(b\) es un exponente que describe la tasa de crecimiento en funci√≥n de la superficie.

\end{itemize}

\sphinxAtStartPar
ya que la altura es menos predictiva que la longitud \sphinxhyphen{} anchura (L/A) que s√≥lo contribuye \(\sim5\%\) en modelos morfol√≥gicos.

\sphinxAtStartPar
Para obtener valores espec√≠ficos de ay b, se suelen ajustar datos experimentales usando regresi√≥n no lineal minimizando el error cuadr√°tico medio:
\begin{equation}\label{equation:content/03/Coeficientes:eq_ECM}
\begin{split}ECM=\dfrac{1}{N}\sum_{i=1}^N(W_i-aS_i^b)^2\end{split}
\end{equation}
\sphinxAtStartPar
\sphinxhref{https://doi.org/10.1111/j.1095-8649.2011.03223.x}{{[}Torres et al., 2012{]}} recoge que en experimentos realizados con peces planos de las familias Soleidae y Pleuronectidae los coeficientes de la ecuaci√≥n (1) toman los siguientes valores:
\begin{equation*}
\begin{split}a\approx0,03\quad b\approx1,1-1,4\end{split}
\end{equation*}
\sphinxAtStartPar
habiendo estimado que en el caso concreto del lenguado estos coeficientes son: \(a=0.024\quad b=1.32\)

\sphinxAtStartPar
Los recientes estudios de \sphinxhref{https://doi.org/10.21608/ejabf.2023.322449}{{[}El\sphinxhyphen{}Bokhty et al., 2023{]}} ponen en entredicho la ecuaci√≥n (1) y sugieren que el crecimiento alom√©trico positivo del lenguado com√∫n (\sphinxstyleemphasis{Solea solea}) responde a la variable morfol√≥gica de longitud (\(L\)) que se ajusta a la expresi√≥n matem√°tica:
\begin{equation}\label{equation:content/03/Coeficientes:eq_peso-longitud}
\begin{split}W=a\cdot L^b\end{split}
\end{equation}
\sphinxAtStartPar
Concluyendo, en sus trabajos, que los coeficientes de dicha expresi√≥n son:
\begin{equation*}
\begin{split}a\approx0,00029\quad b\approx3,3777\end{split}
\end{equation*}
\sphinxAtStartPar
Sin embargo, una investigaci√≥n realizada en las aguas costeras de Pakist√°n analiz√≥ seis especies de peces planos y encontr√≥ variaciones significativas en par√°metros como la longitud, la anchura y el peso entre las diferentes especies \sphinxhref{https://doi.org/10.19080/OFOAJ.2021.14.555884}{{[}W. Ali et al., 2021{]}}.  Aunque este estudio no present√≥ una f√≥rmula espec√≠fica que relacione el peso con la longitud y la anchura simult√°neamente, sugiere que la anchura es una medida morfol√≥gica relevante en la evaluaci√≥n de las relaciones morfom√©tricas en peces planos. Ambas variables podr√≠an relacionarse mediante la siguiente expresi√≥n matem√°tica:
\begin{equation}\label{equation:content/03/Coeficientes:eq_peso-longitud_anchura}
\begin{split}W=k\cdot L^a \cdot A^b\end{split}
\end{equation}
\sphinxAtStartPar
en donde:
\begin{itemize}
\item {}
\sphinxAtStartPar
\(W\) = peso,

\item {}
\sphinxAtStartPar
\(L\) = longitud,

\item {}
\sphinxAtStartPar
\(A\) = anchura,

\item {}
\sphinxAtStartPar
\(k\), \(a\), \(b\) = par√°metros espec√≠ficos por especie

\end{itemize}

\sphinxAtStartPar
Por otro lado \sphinxhref{https://doi.org/0.1016/j.aqrep.2021.100676}{{[}Freitas et al.,2021{]}} en sus trabajos con \sphinxstyleemphasis{Paralichthys olivaceus} (falso Halibut del jap√≥n) apunt√°n a que una relaci√≥n volum√©trica es m√°s adecuada si se tiene en cuenta la comprensi√≥n dorsoventral. Esta par√°metro morfol√≥gico act√∫a como un factor de correcci√≥n que hace que el volumen real sea \(\approx70-80\%\) de LxAxH, siendo concretamente de \(0.72\) en el Halibut. Seg√∫n estos autores el peso de los peces de esta especie se ajustan a la siguiente f√≥rmula:
\begin{equation*}
\begin{split}W=1,05\cdot V^{0,98}\end{split}
\end{equation*}
\sphinxAtStartPar
que responde a la expresi√≥n matem√°tica gen√©rica:
\begin{equation}\label{equation:content/03/Coeficientes:eq_peso-volumen}
\begin{split}W=a\cdot (c\cdot V)^b\end{split}
\end{equation}
\sphinxAtStartPar
en donde:
\begin{itemize}
\item {}
\sphinxAtStartPar
\(W\) = peso,

\item {}
\sphinxAtStartPar
\(V\) = volumen obtenido como \(L\cdot A \cdot H\)

\item {}
\sphinxAtStartPar
\(L\) = longitud,

\item {}
\sphinxAtStartPar
\(A\) = anchura,

\item {}
\sphinxAtStartPar
\(H\) = altura,

\item {}
\sphinxAtStartPar
\(c\) = factor de correcci√≥n \(\leq 1\)

\item {}
\sphinxAtStartPar
\(a\), \(b\) = par√°metros espec√≠ficos por especie

\end{itemize}

\sphinxAtStartPar
\sphinxhref{https://doi.org/0.1007/s12562-019-01287-2}{{[}Lee et al., 2019{]}} usaron un esc√°ner 3D para medir el volumen real en \sphinxstyleemphasis{Scophthalmus maximus} (Rodaballo) encontrando que el peso de los ejemplares del estudio se ajustan a la expresi√≥n:
\begin{equation*}
\begin{split}W=1,12\cdot V-3,25\quad(R^{2}=0,96)\end{split}
\end{equation*}

\subsection{An√°lisis de modelos peso \sphinxhyphen{} morfolog√≠a}
\label{\detokenize{content/03/Coeficientes:analisis-de-modelos-peso-morfologia}}
\sphinxAtStartPar
Se dispone de un dataset \sphinxcode{\sphinxupquote{Dimensiones\_lenguado.xls}} con N=200 registros morfom√©tricos de alevines de lenguado, que incluye medidas de longitud, anchura, altura y peso. Considerando la diversidad de enfoques existentes en la literatura cient√≠fica, se plantea la evaluaci√≥n comparativa de distintas expresiones matem√°ticas que describan la relaci√≥n entre el peso y las variables morfol√≥gicas. En particular, se estudiar√°n modelos cl√°sicos basados en la relaci√≥n \(W = a \cdot L^b\), \(W = a \cdot S^b\) as√≠ como formulaciones extendidas que incorporan m√∫ltiples dimensiones corporales, como \(W = k \cdot L^a \cdot A^b \cdot H^c\), con el objetivo de determinar cu√°l de estas expresiones proporciona un ajuste m√°s preciso a los datos observados. La selecci√≥n del modelo √≥ptimo se basar√° en criterios estad√≠sticos de bondad de ajuste y parsimonia, tales como el coeficiente de determinaci√≥n ajustado (R¬≤ ajustado), el error cuadr√°tico medio (RMSE).
Los diferentes modelos de ajuste evaluados fueron ejecutados en un entorno Jupyterlab haciendo uso de librer√≠as python especializadas como: pandas, numpy y scikit\sphinxhyphen{}learn.

\begin{sphinxuseclass}{cell}\begin{sphinxVerbatimInput}

\begin{sphinxuseclass}{cell_input}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Cargar librerias necesarias}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{pandas}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{pd}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{numpy}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{np}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{matplotlib}\PYG{n+nn}{.}\PYG{n+nn}{pyplot}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{plt}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{sklearn}\PYG{n+nn}{.}\PYG{n+nn}{linear\PYGZus{}model}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{LinearRegression}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{sklearn}\PYG{n+nn}{.}\PYG{n+nn}{metrics}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{r2\PYGZus{}score}\PYG{p}{,} \PYG{n}{mean\PYGZus{}squared\PYGZus{}error}\PYG{p}{,} \PYG{n}{mean\PYGZus{}absolute\PYGZus{}error}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{scipy}\PYG{n+nn}{.}\PYG{n+nn}{optimize}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{curve\PYGZus{}fit}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{matplotlib}\PYG{n+nn}{.}\PYG{n+nn}{colors}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{CSS4\PYGZus{}COLORS}

\PYG{n}{plt}\PYG{o}{.}\PYG{n}{style}\PYG{o}{.}\PYG{n}{use}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{seaborn\PYGZhy{}v0\PYGZus{}8\PYGZhy{}muted}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Cargar el dataset}
\PYG{n}{file\PYGZus{}path} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{.././data/Dimensiones\PYGZus{}lenguado.xlsx}\PYG{l+s+s1}{\PYGZsq{}}
\PYG{n}{df} \PYG{o}{=} \PYG{n}{pd}\PYG{o}{.}\PYG{n}{read\PYGZus{}excel}\PYG{p}{(}\PYG{n}{file\PYGZus{}path}\PYG{p}{)}
\PYG{n}{df}\PYG{o}{.}\PYG{n}{head}\PYG{p}{(}\PYG{p}{)}
\end{sphinxVerbatim}

\end{sphinxuseclass}\end{sphinxVerbatimInput}
\begin{sphinxVerbatimOutput}

\begin{sphinxuseclass}{cell_output}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
   Peso (g)  Longitud (cm)  Anchura (cm)  Altura (cm)
0      0.46            3.3           1.3          0.2
1      1.08            4.5           1.1          0.3
2      0.67            3.9           1.5          0.2
3      0.98            4.4           1.7          0.3
4      0.93            4.2           1.8          0.3
\end{sphinxVerbatim}

\end{sphinxuseclass}\end{sphinxVerbatimOutput}

\end{sphinxuseclass}
\begin{sphinxuseclass}{cell}\begin{sphinxVerbatimInput}

\begin{sphinxuseclass}{cell_input}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Definimos variables comunes}
\PYG{n}{L} \PYG{o}{=} \PYG{n}{df}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Longitud (cm)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{o}{.}\PYG{n}{values}
\PYG{n}{A} \PYG{o}{=} \PYG{n}{df}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Anchura (cm)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{o}{.}\PYG{n}{values}
\PYG{n}{H} \PYG{o}{=} \PYG{n}{df}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Altura (cm)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{o}{.}\PYG{n}{values}
\PYG{n}{W} \PYG{o}{=} \PYG{n}{df}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Peso (g)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{o}{.}\PYG{n}{values}
\PYG{n}{V} \PYG{o}{=} \PYG{n}{L} \PYG{o}{*} \PYG{n}{A} \PYG{o}{*} \PYG{n}{H}
\PYG{n}{n} \PYG{o}{=} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{W}\PYG{p}{)}
\end{sphinxVerbatim}

\end{sphinxuseclass}\end{sphinxVerbatimInput}

\end{sphinxuseclass}

\subsubsection{Modelo potencia peso \sphinxhyphen{} longitud: \protect\(W=a\cdot L^b\protect\)}
\label{\detokenize{content/03/Coeficientes:modelo-potencia-peso-longitud-w-a-cdot-l-b}}
\begin{sphinxuseclass}{cell}\begin{sphinxVerbatimInput}

\begin{sphinxuseclass}{cell_input}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{long\PYGZus{}model}\PYG{p}{(}\PYG{n}{L}\PYG{p}{,}\PYG{n}{a}\PYG{p}{,}\PYG{n}{b}\PYG{p}{)}\PYG{p}{:}
    \PYG{k}{return} \PYG{n}{a}\PYG{o}{*}\PYG{n}{L}\PYG{o}{*}\PYG{o}{*}\PYG{n}{b}

\PYG{n}{params\PYGZus{}long}\PYG{p}{,} \PYG{n}{\PYGZus{}} \PYG{o}{=} \PYG{n}{curve\PYGZus{}fit}\PYG{p}{(}\PYG{n}{long\PYGZus{}model}\PYG{p}{,} \PYG{n}{L}\PYG{p}{,} \PYG{n}{W}\PYG{p}{)}
\PYG{n}{a}\PYG{p}{,}\PYG{n}{b} \PYG{o}{=} \PYG{n}{params\PYGZus{}long}
\PYG{n}{W\PYGZus{}pred\PYGZus{}long} \PYG{o}{=} \PYG{n}{long\PYGZus{}model}\PYG{p}{(}\PYG{n}{L}\PYG{p}{,} \PYG{n}{a}\PYG{p}{,}\PYG{n}{b}\PYG{p}{)}
\PYG{n}{r2\PYGZus{}long} \PYG{o}{=} \PYG{n}{r2\PYGZus{}score}\PYG{p}{(}\PYG{n}{W}\PYG{p}{,} \PYG{n}{W\PYGZus{}pred\PYGZus{}long}\PYG{p}{)}
\PYG{n}{r2\PYGZus{}adj\PYGZus{}long}\PYG{o}{=} \PYG{l+m+mi}{1} \PYG{o}{\PYGZhy{}} \PYG{p}{(}\PYG{l+m+mi}{1} \PYG{o}{\PYGZhy{}} \PYG{n}{r2\PYGZus{}long}\PYG{p}{)} \PYG{o}{*} \PYG{p}{(}\PYG{n}{n} \PYG{o}{\PYGZhy{}} \PYG{l+m+mi}{1}\PYG{p}{)} \PYG{o}{/} \PYG{p}{(}\PYG{n}{n} \PYG{o}{\PYGZhy{}} \PYG{l+m+mi}{1} \PYG{o}{\PYGZhy{}} \PYG{l+m+mi}{1}\PYG{p}{)}
\PYG{n}{rmse\PYGZus{}long} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sqrt}\PYG{p}{(}\PYG{n}{mean\PYGZus{}squared\PYGZus{}error}\PYG{p}{(}\PYG{n}{W}\PYG{p}{,} \PYG{n}{W\PYGZus{}pred\PYGZus{}long}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{mae\PYGZus{}long} \PYG{o}{=} \PYG{n}{mean\PYGZus{}absolute\PYGZus{}error}\PYG{p}{(}\PYG{n}{W}\PYG{p}{,} \PYG{n}{W\PYGZus{}pred\PYGZus{}long}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Visualizaci√≥n ajuste}

\PYG{c+c1}{\PYGZsh{} √çndices y residuos}
\PYG{n}{indices} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{arange}\PYG{p}{(}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{W}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{residuos} \PYG{o}{=} \PYG{n}{W} \PYG{o}{\PYGZhy{}} \PYG{n}{W\PYGZus{}pred\PYGZus{}long}

\PYG{c+c1}{\PYGZsh{} Crear la figura con 3 subplots}
\PYG{n}{fig}\PYG{p}{,} \PYG{n}{axs} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplots}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{3}\PYG{p}{,} \PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{18}\PYG{p}{,} \PYG{l+m+mi}{5}\PYG{p}{)}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} === 1. Peso real vs. Peso predicho ===}
\PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{scatter}\PYG{p}{(}\PYG{n}{W}\PYG{p}{,} \PYG{n}{W\PYGZus{}pred\PYGZus{}long}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.7}\PYG{p}{)}
\PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{p}{[}\PYG{n+nb}{min}\PYG{p}{(}\PYG{n}{W}\PYG{p}{)}\PYG{p}{,} \PYG{n+nb}{max}\PYG{p}{(}\PYG{n}{W}\PYG{p}{)}\PYG{p}{]}\PYG{p}{,} \PYG{p}{[}\PYG{n+nb}{min}\PYG{p}{(}\PYG{n}{W}\PYG{p}{)}\PYG{p}{,} \PYG{n+nb}{max}\PYG{p}{(}\PYG{n}{W}\PYG{p}{)}\PYG{p}{]}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{r\PYGZhy{}\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{L√≠nea ideal}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Peso real}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Peso predicho}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Real vs. Predicho}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{legend}\PYG{p}{(}\PYG{p}{)}
\PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{grid}\PYG{p}{(}\PYG{k+kc}{True}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} === 2. Comparaci√≥n por √≠ndice ===}
\PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{scatter}\PYG{p}{(}\PYG{n}{indices}\PYG{p}{,} \PYG{n}{W}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{n}{CSS4\PYGZus{}COLORS}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{lightskyblue}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Peso real}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.8}\PYG{p}{)}
\PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{scatter}\PYG{p}{(}\PYG{n}{indices}\PYG{p}{,} \PYG{n}{W\PYGZus{}pred\PYGZus{}long}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{n}{CSS4\PYGZus{}COLORS}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{darkorange}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Peso predicho}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.6}\PYG{p}{)}
\PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{√çndice de muestra}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Peso}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Peso real vs. predicho por muestra}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{legend}\PYG{p}{(}\PYG{p}{)}
\PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{grid}\PYG{p}{(}\PYG{k+kc}{True}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} === 3. Gr√°fico de residuos ===}
\PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{o}{.}\PYG{n}{scatter}\PYG{p}{(}\PYG{n}{W\PYGZus{}pred\PYGZus{}long}\PYG{p}{,} \PYG{n}{residuos}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.6}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{n}{CSS4\PYGZus{}COLORS}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{violet}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{)}
\PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{o}{.}\PYG{n}{axhline}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{red}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{linestyle}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZhy{}\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Peso predicho}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Residuo}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{An√°lisis de residuos}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{o}{.}\PYG{n}{grid}\PYG{p}{(}\PYG{k+kc}{True}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Ajustar dise√±o y mostrar}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Resultados del ajuste}

\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Modelo ajustado: W = }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{a}\PYG{l+s+si}{:}\PYG{l+s+s2}{.5f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{ ¬∑ L\PYGZca{}}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{b}\PYG{l+s+si}{:}\PYG{l+s+s2}{.5f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{R¬≤ = }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{r2\PYGZus{}long}\PYG{l+s+si}{:}\PYG{l+s+s2}{.4f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{MAE = }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{mae\PYGZus{}long}\PYG{l+s+si}{:}\PYG{l+s+s2}{.4f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{ g}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{RSME = }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{rmse\PYGZus{}long}\PYG{l+s+si}{:}\PYG{l+s+s2}{.4f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{ g}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{R¬≤adj = }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{r2\PYGZus{}adj\PYGZus{}long}\PYG{l+s+si}{:}\PYG{l+s+s2}{.4f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{ g}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\end{sphinxVerbatim}

\end{sphinxuseclass}\end{sphinxVerbatimInput}
\begin{sphinxVerbatimOutput}

\begin{sphinxuseclass}{cell_output}
\noindent\sphinxincludegraphics{{44e924eb1c1d8ed01c23a6d55f030a1e9a19681adb870886207af25f90daff45}.png}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
Modelo ajustado: W = 0.00933 ¬∑ L\PYGZca{}3.13480
R¬≤ = 0.9433
MAE = 0.5246 g
RSME = 0.8638 g
R¬≤adj = 0.9430 g
\end{sphinxVerbatim}

\end{sphinxuseclass}\end{sphinxVerbatimOutput}

\end{sphinxuseclass}

\subsubsection{Modelo potencia peso \sphinxhyphen{} superficie: \protect\(W=a\cdot S^b\protect\)}
\label{\detokenize{content/03/Coeficientes:modelo-potencia-peso-superficie-w-a-cdot-s-b}}
\sphinxAtStartPar
Para un ajuste √≥ptimo de este modelo hay que tener en cuenta que la morfolog√≠a aplanada y asim√©trica de los lenguados.

\sphinxAtStartPar
Dado que el lenguado es m√°s ancho que alto y tiene una doerma similar a un disco aplanado, podemos usar la f√≥rmula del √°rea de una elipse como aproximaci√≥n:
\begin{equation*}
\begin{split}S=\dfrac{\pi \cdot L \cdot A}{4}\end{split}
\end{equation*}
\sphinxAtStartPar
Si tenemos en cuenta que el lenguado no es una elipse perfecta y que la superficie dorsal suele ser m√°s curva de la ventral tendremos que aplicar un factor de correcci√≥n cuyo valor var√≠a seg√∫n la especie {[}\sphinxhref{https://www.researchgate.net/publication/255641396\_A\_Note\_on\_The\_Examination\_of\_Morphometric\_Differentiation\_Among\_Fish\_Populations\_The\_Truss\_System}{Turan C., 1999}; \sphinxhref{https://doi.org/10.5370/JEET.2013.8.5.1194}{Jeong et al., 2013}{]} y que en el caso del lenguado puede estimarse \(\approx 75-90 \%\) del √°rea de la elipse definida por su longitud y anchura.

\sphinxAtStartPar
Este enfoque matem√°tico s√≥lo es aplicable si, como es este caso, el dataset no contiene un valor de superficie real obtenido mediante funciones de procesado de imagen que permita la segmentaci√≥n precisa del contorno corporal del lenguado y el c√°lculo de su superficie proyectada mediante herramientas como \sphinxcode{\sphinxupquote{cv2.contourArea()}}de OpenCV.

\begin{sphinxuseclass}{cell}\begin{sphinxVerbatimInput}

\begin{sphinxuseclass}{cell_input}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Si el dataset contiene datos de superficie real:}
\PYG{c+c1}{\PYGZsh{} S = df[\PYGZsq{}Superficie (cm2)\PYGZsq{}].values}

\PYG{c+c1}{\PYGZsh{} Si el dataset no contiene datos de superficie real:}
\PYG{n}{S} \PYG{o}{=} \PYG{n}{L} \PYG{o}{*} \PYG{n}{A}
\PYG{n}{coef} \PYG{o}{=} \PYG{l+m+mf}{0.75}

\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{potencia\PYGZus{}model}\PYG{p}{(}\PYG{n}{S}\PYG{p}{,} \PYG{n}{a}\PYG{p}{,} \PYG{n}{b}\PYG{p}{)}\PYG{p}{:}
    \PYG{c+c1}{\PYGZsh{} Si hay datos de superficie real obtenidos por procesado de imagen entonces:}
    \PYG{c+c1}{\PYGZsh{} superficie\PYGZus{}real = S}
    \PYG{n}{superficie\PYGZus{}real} \PYG{o}{=} \PYG{n}{coef} \PYG{o}{*} \PYG{p}{(}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{pi} \PYG{o}{/} \PYG{l+m+mi}{4}\PYG{p}{)} \PYG{o}{*} \PYG{n}{S}\PYG{p}{)}
    \PYG{k}{return} \PYG{n}{a} \PYG{o}{*} \PYG{p}{(}\PYG{n}{superficie\PYGZus{}real}\PYG{p}{)}\PYG{o}{*}\PYG{o}{*}\PYG{n}{b}

\PYG{n}{params\PYGZus{}pow}\PYG{p}{,} \PYG{n}{\PYGZus{}} \PYG{o}{=} \PYG{n}{curve\PYGZus{}fit}\PYG{p}{(}\PYG{n}{potencia\PYGZus{}model}\PYG{p}{,} \PYG{n}{S}\PYG{p}{,} \PYG{n}{W}\PYG{p}{)}
\PYG{n}{a}\PYG{p}{,}\PYG{n}{b} \PYG{o}{=} \PYG{n}{params\PYGZus{}pow}
\PYG{n}{W\PYGZus{}pred\PYGZus{}pow} \PYG{o}{=} \PYG{n}{potencia\PYGZus{}model}\PYG{p}{(}\PYG{n}{S}\PYG{p}{,} \PYG{n}{a}\PYG{p}{,} \PYG{n}{b}\PYG{p}{)}
\PYG{n}{r2\PYGZus{}pow} \PYG{o}{=} \PYG{n}{r2\PYGZus{}score}\PYG{p}{(}\PYG{n}{W}\PYG{p}{,} \PYG{n}{W\PYGZus{}pred\PYGZus{}pow}\PYG{p}{)}
\PYG{n}{r2\PYGZus{}adj\PYGZus{}pow} \PYG{o}{=} \PYG{l+m+mi}{1} \PYG{o}{\PYGZhy{}} \PYG{p}{(}\PYG{l+m+mi}{1} \PYG{o}{\PYGZhy{}} \PYG{n}{r2\PYGZus{}pow}\PYG{p}{)} \PYG{o}{*} \PYG{p}{(}\PYG{n}{n} \PYG{o}{\PYGZhy{}} \PYG{l+m+mi}{1}\PYG{p}{)} \PYG{o}{/} \PYG{p}{(}\PYG{n}{n} \PYG{o}{\PYGZhy{}} \PYG{l+m+mi}{1} \PYG{o}{\PYGZhy{}} \PYG{l+m+mi}{1}\PYG{p}{)}
\PYG{n}{rmse\PYGZus{}pow} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sqrt}\PYG{p}{(}\PYG{n}{mean\PYGZus{}squared\PYGZus{}error}\PYG{p}{(}\PYG{n}{W}\PYG{p}{,} \PYG{n}{W\PYGZus{}pred\PYGZus{}pow}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{mae\PYGZus{}pow} \PYG{o}{=} \PYG{n}{mean\PYGZus{}absolute\PYGZus{}error}\PYG{p}{(}\PYG{n}{W}\PYG{p}{,} \PYG{n}{W\PYGZus{}pred\PYGZus{}pow}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Visualizaci√≥n ajuste}

\PYG{c+c1}{\PYGZsh{} √çndices y residuos}
\PYG{n}{indices} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{arange}\PYG{p}{(}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{W}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{residuos} \PYG{o}{=} \PYG{n}{W} \PYG{o}{\PYGZhy{}} \PYG{n}{W\PYGZus{}pred\PYGZus{}pow}

\PYG{c+c1}{\PYGZsh{} Crear la figura con 3 subplots}
\PYG{n}{fig}\PYG{p}{,} \PYG{n}{axs} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplots}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{3}\PYG{p}{,} \PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{18}\PYG{p}{,} \PYG{l+m+mi}{5}\PYG{p}{)}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} === 1. Peso real vs. Peso predicho ===}
\PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{scatter}\PYG{p}{(}\PYG{n}{W}\PYG{p}{,} \PYG{n}{W\PYGZus{}pred\PYGZus{}pow}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.7}\PYG{p}{)}
\PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{p}{[}\PYG{n+nb}{min}\PYG{p}{(}\PYG{n}{W}\PYG{p}{)}\PYG{p}{,} \PYG{n+nb}{max}\PYG{p}{(}\PYG{n}{W}\PYG{p}{)}\PYG{p}{]}\PYG{p}{,} \PYG{p}{[}\PYG{n+nb}{min}\PYG{p}{(}\PYG{n}{W}\PYG{p}{)}\PYG{p}{,} \PYG{n+nb}{max}\PYG{p}{(}\PYG{n}{W}\PYG{p}{)}\PYG{p}{]}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{r\PYGZhy{}\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{L√≠nea ideal}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Peso real}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Peso predicho}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Real vs. Predicho}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{legend}\PYG{p}{(}\PYG{p}{)}
\PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{grid}\PYG{p}{(}\PYG{k+kc}{True}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} === 2. Comparaci√≥n por √≠ndice ===}
\PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{scatter}\PYG{p}{(}\PYG{n}{indices}\PYG{p}{,} \PYG{n}{W}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{n}{CSS4\PYGZus{}COLORS}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{lightskyblue}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Peso real}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.8}\PYG{p}{)}
\PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{scatter}\PYG{p}{(}\PYG{n}{indices}\PYG{p}{,} \PYG{n}{W\PYGZus{}pred\PYGZus{}pow}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{n}{CSS4\PYGZus{}COLORS}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{darkorange}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Peso predicho}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.6}\PYG{p}{)}
\PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{√çndice de muestra}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Peso}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Peso real vs. predicho por muestra}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{legend}\PYG{p}{(}\PYG{p}{)}
\PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{grid}\PYG{p}{(}\PYG{k+kc}{True}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} === 3. Gr√°fico de residuos ===}
\PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{o}{.}\PYG{n}{scatter}\PYG{p}{(}\PYG{n}{W\PYGZus{}pred\PYGZus{}pow}\PYG{p}{,} \PYG{n}{residuos}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.6}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{n}{CSS4\PYGZus{}COLORS}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{violet}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{)}
\PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{o}{.}\PYG{n}{axhline}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{red}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{linestyle}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZhy{}\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Peso predicho}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Residuo}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{An√°lisis de residuos}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{o}{.}\PYG{n}{grid}\PYG{p}{(}\PYG{k+kc}{True}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Ajustar dise√±o y mostrar}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Resultados del ajuste}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Modelo ajustado: W = }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{a}\PYG{l+s+si}{:}\PYG{l+s+s2}{.5f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{ ¬∑ S\PYGZus{}real\PYGZca{}}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{b}\PYG{l+s+si}{:}\PYG{l+s+s2}{.5f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{S\PYGZus{}real: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{coef}\PYG{l+s+si}{:}\PYG{l+s+s2}{.3f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{ ¬∑ }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{np}\PYG{o}{.}\PYG{n}{pi}\PYG{l+s+si}{:}\PYG{l+s+s2}{.5f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{ ¬∑ S/4}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{R¬≤ = }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{r2\PYGZus{}pow}\PYG{l+s+si}{:}\PYG{l+s+s2}{.4f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{MAE = }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{mae\PYGZus{}pow}\PYG{l+s+si}{:}\PYG{l+s+s2}{.4f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{ g}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{RSME = }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{rmse\PYGZus{}pow}\PYG{l+s+si}{:}\PYG{l+s+s2}{.4f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{ g}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{R¬≤ adj = }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{r2\PYGZus{}adj\PYGZus{}pow}\PYG{l+s+si}{:}\PYG{l+s+s2}{.4f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{ g}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\end{sphinxVerbatim}

\end{sphinxuseclass}\end{sphinxVerbatimInput}
\begin{sphinxVerbatimOutput}

\begin{sphinxuseclass}{cell_output}
\noindent\sphinxincludegraphics{{2276d97aece9866f2fb157ce71a1628baec8a5e182218170fc0638bc6b0c4acb}.png}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
Modelo ajustado: W = 0.13360 ¬∑ S\PYGZus{}real\PYGZca{}1.43623
S\PYGZus{}real: 0.750 ¬∑ 3.14159 ¬∑ S/4
R¬≤ = 0.9733
MAE = 0.3734 g
RSME = 0.5925 g
R¬≤ adj = 0.9732 g
\end{sphinxVerbatim}

\end{sphinxuseclass}\end{sphinxVerbatimOutput}

\end{sphinxuseclass}

\subsubsection{Modelo alom√©trico Longitud \sphinxhyphen{} Anchura: \protect\(W=k \cdot L^a \cdot A^b\protect\)}
\label{\detokenize{content/03/Coeficientes:modelo-alometrico-longitud-anchura-w-k-cdot-l-a-cdot-a-b}}
\begin{sphinxuseclass}{cell}\begin{sphinxVerbatimInput}

\begin{sphinxuseclass}{cell_input}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{alometric\PYGZus{}LA\PYGZus{}model}\PYG{p}{(}\PYG{n}{X}\PYG{p}{,} \PYG{n}{k}\PYG{p}{,} \PYG{n}{a}\PYG{p}{,} \PYG{n}{b}\PYG{p}{)}\PYG{p}{:}
    \PYG{n}{L}\PYG{p}{,} \PYG{n}{A} \PYG{o}{=} \PYG{n}{X}
    \PYG{k}{return} \PYG{n}{k} \PYG{o}{*} \PYG{p}{(}\PYG{n}{L}\PYG{o}{*}\PYG{o}{*}\PYG{n}{a}\PYG{p}{)} \PYG{o}{*} \PYG{p}{(}\PYG{n}{A}\PYG{o}{*}\PYG{o}{*}\PYG{n}{b}\PYG{p}{)}

\PYG{n}{params\PYGZus{}la}\PYG{p}{,} \PYG{n}{\PYGZus{}} \PYG{o}{=} \PYG{n}{curve\PYGZus{}fit}\PYG{p}{(}\PYG{n}{alometric\PYGZus{}LA\PYGZus{}model}\PYG{p}{,} \PYG{p}{(}\PYG{n}{L}\PYG{p}{,} \PYG{n}{A}\PYG{p}{)}\PYG{p}{,} \PYG{n}{W}\PYG{p}{)}
\PYG{n}{k}\PYG{p}{,}\PYG{n}{a}\PYG{p}{,}\PYG{n}{b} \PYG{o}{=} \PYG{n}{params\PYGZus{}la}
\PYG{n}{W\PYGZus{}pred\PYGZus{}la} \PYG{o}{=} \PYG{n}{alometric\PYGZus{}LA\PYGZus{}model}\PYG{p}{(}\PYG{p}{(}\PYG{n}{L}\PYG{p}{,} \PYG{n}{A}\PYG{p}{)}\PYG{p}{,} \PYG{n}{k}\PYG{p}{,}\PYG{n}{a}\PYG{p}{,}\PYG{n}{b}\PYG{p}{)}
\PYG{n}{r2\PYGZus{}la} \PYG{o}{=} \PYG{n}{r2\PYGZus{}score}\PYG{p}{(}\PYG{n}{W}\PYG{p}{,} \PYG{n}{W\PYGZus{}pred\PYGZus{}la}\PYG{p}{)}
\PYG{n}{r2\PYGZus{}adj\PYGZus{}la} \PYG{o}{=} \PYG{l+m+mi}{1} \PYG{o}{\PYGZhy{}} \PYG{p}{(}\PYG{l+m+mi}{1} \PYG{o}{\PYGZhy{}} \PYG{n}{r2\PYGZus{}la}\PYG{p}{)} \PYG{o}{*} \PYG{p}{(}\PYG{n}{n} \PYG{o}{\PYGZhy{}} \PYG{l+m+mi}{1}\PYG{p}{)} \PYG{o}{/} \PYG{p}{(}\PYG{n}{n} \PYG{o}{\PYGZhy{}} \PYG{l+m+mi}{2} \PYG{o}{\PYGZhy{}} \PYG{l+m+mi}{1}\PYG{p}{)}
\PYG{n}{rmse\PYGZus{}la} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sqrt}\PYG{p}{(}\PYG{n}{mean\PYGZus{}squared\PYGZus{}error}\PYG{p}{(}\PYG{n}{W}\PYG{p}{,} \PYG{n}{W\PYGZus{}pred\PYGZus{}la}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{mae\PYGZus{}la} \PYG{o}{=} \PYG{n}{mean\PYGZus{}absolute\PYGZus{}error}\PYG{p}{(}\PYG{n}{W}\PYG{p}{,} \PYG{n}{W\PYGZus{}pred\PYGZus{}la}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} √çndices y residuos}
\PYG{n}{indices} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{arange}\PYG{p}{(}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{W}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{residuos} \PYG{o}{=} \PYG{n}{W} \PYG{o}{\PYGZhy{}} \PYG{n}{W\PYGZus{}pred\PYGZus{}la}

\PYG{c+c1}{\PYGZsh{} Crear la figura con 3 subplots}
\PYG{n}{fig}\PYG{p}{,} \PYG{n}{axs} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplots}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{3}\PYG{p}{,} \PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{18}\PYG{p}{,} \PYG{l+m+mi}{5}\PYG{p}{)}\PYG{p}{)}


\PYG{c+c1}{\PYGZsh{} === 1. Peso real vs. Peso predicho ===}
\PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{scatter}\PYG{p}{(}\PYG{n}{W}\PYG{p}{,} \PYG{n}{W\PYGZus{}pred\PYGZus{}la}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.7}\PYG{p}{)}
\PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{p}{[}\PYG{n+nb}{min}\PYG{p}{(}\PYG{n}{W}\PYG{p}{)}\PYG{p}{,} \PYG{n+nb}{max}\PYG{p}{(}\PYG{n}{W}\PYG{p}{)}\PYG{p}{]}\PYG{p}{,} \PYG{p}{[}\PYG{n+nb}{min}\PYG{p}{(}\PYG{n}{W}\PYG{p}{)}\PYG{p}{,} \PYG{n+nb}{max}\PYG{p}{(}\PYG{n}{W}\PYG{p}{)}\PYG{p}{]}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{r\PYGZhy{}\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{L√≠nea ideal}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Peso real}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Peso predicho}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Real vs. Predicho}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{legend}\PYG{p}{(}\PYG{p}{)}
\PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{grid}\PYG{p}{(}\PYG{k+kc}{True}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} === 2. Comparaci√≥n por √≠ndice ===}
\PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{scatter}\PYG{p}{(}\PYG{n}{indices}\PYG{p}{,} \PYG{n}{W}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{n}{CSS4\PYGZus{}COLORS}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{lightskyblue}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Peso real}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.8}\PYG{p}{)}
\PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{scatter}\PYG{p}{(}\PYG{n}{indices}\PYG{p}{,} \PYG{n}{W\PYGZus{}pred\PYGZus{}la}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{n}{CSS4\PYGZus{}COLORS}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{darkorange}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Peso predicho}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.6}\PYG{p}{)}
\PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{√çndice de muestra}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Peso}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Peso real vs. predicho por muestra}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{legend}\PYG{p}{(}\PYG{p}{)}
\PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{grid}\PYG{p}{(}\PYG{k+kc}{True}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} === 3. Gr√°fico de residuos ===}
\PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{o}{.}\PYG{n}{scatter}\PYG{p}{(}\PYG{n}{W\PYGZus{}pred\PYGZus{}la}\PYG{p}{,} \PYG{n}{residuos}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.6}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{n}{CSS4\PYGZus{}COLORS}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{violet}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{)}
\PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{o}{.}\PYG{n}{axhline}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{red}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{linestyle}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZhy{}\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Peso predicho}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Residuo}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{An√°lisis de residuos}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{o}{.}\PYG{n}{grid}\PYG{p}{(}\PYG{k+kc}{True}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Ajustar dise√±o y mostrar}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Resultados del ajuste}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Modelo ajustado: W = }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{k}\PYG{l+s+si}{:}\PYG{l+s+s2}{.5f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{¬∑L\PYGZca{}}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{a}\PYG{l+s+si}{:}\PYG{l+s+s2}{.3f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{¬∑A\PYGZca{}}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{b}\PYG{l+s+si}{:}\PYG{l+s+s2}{.3f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{R¬≤ = }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{r2\PYGZus{}la}\PYG{l+s+si}{:}\PYG{l+s+s2}{.4f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{MAE = }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{mae\PYGZus{}la}\PYG{l+s+si}{:}\PYG{l+s+s2}{.4f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{ g}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{RSME = }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{rmse\PYGZus{}la}\PYG{l+s+si}{:}\PYG{l+s+s2}{.4f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{ g}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{R¬≤ adj = }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{r2\PYGZus{}adj\PYGZus{}la}\PYG{l+s+si}{:}\PYG{l+s+s2}{.4f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{ g}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\end{sphinxVerbatim}

\end{sphinxuseclass}\end{sphinxVerbatimInput}
\begin{sphinxVerbatimOutput}

\begin{sphinxuseclass}{cell_output}
\noindent\sphinxincludegraphics{{38762abd81e9639b04d5e9b6d5469ba3728653a33bd04db249a57aa4d1641e9c}.png}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
Modelo ajustado: W = 0.04891¬∑L\PYGZca{}1.644¬∑A\PYGZca{}1.272
R¬≤ = 0.9739
MAE = 0.3735 g
RSME = 0.5854 g
R¬≤ adj = 0.9737 g
\end{sphinxVerbatim}

\end{sphinxuseclass}\end{sphinxVerbatimOutput}

\end{sphinxuseclass}

\subsubsection{Modelo de potencia volum√©trico: \protect\(W=a \cdot (c\cdot V)^b\protect\)}
\label{\detokenize{content/03/Coeficientes:modelo-de-potencia-volumetrico-w-a-cdot-c-cdot-v-b}}
\begin{sphinxuseclass}{cell}\begin{sphinxVerbatimInput}

\begin{sphinxuseclass}{cell_input}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Factor de compresi√≥n dorsoventral}
\PYG{n}{c} \PYG{o}{=} \PYG{l+m+mf}{0.72}

\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{volumen\PYGZus{}model}\PYG{p}{(}\PYG{n}{V}\PYG{p}{,} \PYG{n}{a}\PYG{p}{,} \PYG{n}{b}\PYG{p}{)}\PYG{p}{:}
    \PYG{k}{return} \PYG{n}{a} \PYG{o}{*} \PYG{p}{(}\PYG{n}{c} \PYG{o}{*} \PYG{n}{V}\PYG{p}{)}\PYG{o}{*}\PYG{o}{*}\PYG{n}{b}

\PYG{n}{params\PYGZus{}vol}\PYG{p}{,} \PYG{n}{\PYGZus{}} \PYG{o}{=} \PYG{n}{curve\PYGZus{}fit}\PYG{p}{(}\PYG{n}{volumen\PYGZus{}model}\PYG{p}{,} \PYG{n}{V}\PYG{p}{,} \PYG{n}{W}\PYG{p}{)}
\PYG{n}{a}\PYG{p}{,}\PYG{n}{b} \PYG{o}{=} \PYG{n}{params\PYGZus{}vol}
\PYG{n}{W\PYGZus{}pred\PYGZus{}vol} \PYG{o}{=} \PYG{n}{volumen\PYGZus{}model}\PYG{p}{(}\PYG{n}{V}\PYG{p}{,} \PYG{o}{*}\PYG{n}{params\PYGZus{}vol}\PYG{p}{)}
\PYG{n}{r2\PYGZus{}vol} \PYG{o}{=} \PYG{n}{r2\PYGZus{}score}\PYG{p}{(}\PYG{n}{W}\PYG{p}{,} \PYG{n}{W\PYGZus{}pred\PYGZus{}vol}\PYG{p}{)}
\PYG{n}{r2\PYGZus{}adj\PYGZus{}vol} \PYG{o}{=} \PYG{l+m+mi}{1} \PYG{o}{\PYGZhy{}} \PYG{p}{(}\PYG{l+m+mi}{1} \PYG{o}{\PYGZhy{}} \PYG{n}{r2\PYGZus{}vol}\PYG{p}{)} \PYG{o}{*} \PYG{p}{(}\PYG{n}{n} \PYG{o}{\PYGZhy{}} \PYG{l+m+mi}{1}\PYG{p}{)} \PYG{o}{/} \PYG{p}{(}\PYG{n}{n} \PYG{o}{\PYGZhy{}} \PYG{l+m+mi}{1} \PYG{o}{\PYGZhy{}} \PYG{l+m+mi}{1}\PYG{p}{)}
\PYG{n}{rmse\PYGZus{}vol} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sqrt}\PYG{p}{(}\PYG{n}{mean\PYGZus{}squared\PYGZus{}error}\PYG{p}{(}\PYG{n}{W}\PYG{p}{,} \PYG{n}{W\PYGZus{}pred\PYGZus{}vol}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{mae\PYGZus{}vol} \PYG{o}{=} \PYG{n}{mean\PYGZus{}absolute\PYGZus{}error}\PYG{p}{(}\PYG{n}{W}\PYG{p}{,} \PYG{n}{W\PYGZus{}pred\PYGZus{}vol}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Visualizaci√≥n ajuste}
\PYG{n}{indices} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{arange}\PYG{p}{(}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{W}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{residuos} \PYG{o}{=} \PYG{n}{W} \PYG{o}{\PYGZhy{}} \PYG{n}{W\PYGZus{}pred\PYGZus{}vol}

\PYG{n}{fig}\PYG{p}{,} \PYG{n}{axs} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplots}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{3}\PYG{p}{,} \PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{18}\PYG{p}{,} \PYG{l+m+mi}{5}\PYG{p}{)}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} === 1. Peso real vs. Peso predicho ===}
\PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{scatter}\PYG{p}{(}\PYG{n}{W}\PYG{p}{,} \PYG{n}{W\PYGZus{}pred\PYGZus{}vol}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.7}\PYG{p}{)}
\PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{p}{[}\PYG{n+nb}{min}\PYG{p}{(}\PYG{n}{W}\PYG{p}{)}\PYG{p}{,} \PYG{n+nb}{max}\PYG{p}{(}\PYG{n}{W}\PYG{p}{)}\PYG{p}{]}\PYG{p}{,} \PYG{p}{[}\PYG{n+nb}{min}\PYG{p}{(}\PYG{n}{W}\PYG{p}{)}\PYG{p}{,} \PYG{n+nb}{max}\PYG{p}{(}\PYG{n}{W}\PYG{p}{)}\PYG{p}{]}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{r\PYGZhy{}\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{L√≠nea ideal}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Peso real (W)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Peso predicho}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Real vs. Predicho}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{legend}\PYG{p}{(}\PYG{p}{)}
\PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{grid}\PYG{p}{(}\PYG{k+kc}{True}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} === 2. Comparaci√≥n por √≠ndice ===}
\PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{scatter}\PYG{p}{(}\PYG{n}{indices}\PYG{p}{,} \PYG{n}{W}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{n}{CSS4\PYGZus{}COLORS}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{lightskyblue}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Peso real}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.8}\PYG{p}{)}
\PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{scatter}\PYG{p}{(}\PYG{n}{indices}\PYG{p}{,} \PYG{n}{W\PYGZus{}pred\PYGZus{}vol}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{n}{CSS4\PYGZus{}COLORS}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{darkorange}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Peso predicho}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.6}\PYG{p}{)}
\PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{√çndice de muestra}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Peso}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Peso real vs. predicho por muestra}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{legend}\PYG{p}{(}\PYG{p}{)}
\PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{grid}\PYG{p}{(}\PYG{k+kc}{True}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} === 3. Gr√°fico de residuos ===}
\PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{o}{.}\PYG{n}{scatter}\PYG{p}{(}\PYG{n}{W\PYGZus{}pred\PYGZus{}vol}\PYG{p}{,} \PYG{n}{residuos}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.6}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{n}{CSS4\PYGZus{}COLORS}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{violet}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{)}
\PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{o}{.}\PYG{n}{axhline}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{red}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{linestyle}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZhy{}\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Peso predicho}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Residuo}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{An√°lisis de residuos}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{o}{.}\PYG{n}{grid}\PYG{p}{(}\PYG{k+kc}{True}\PYG{p}{)}

\PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Resultados del ajuste}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Modelo ajustado: W = }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{a}\PYG{l+s+si}{:}\PYG{l+s+s2}{.5f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{ ¬∑ (}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{c}\PYG{l+s+si}{:}\PYG{l+s+s2}{.3f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{V)\PYGZca{}}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{b}\PYG{l+s+si}{:}\PYG{l+s+s2}{.5f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{R¬≤ = }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{r2\PYGZus{}vol}\PYG{l+s+si}{:}\PYG{l+s+s2}{.4f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{MAE = }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{mae\PYGZus{}vol}\PYG{l+s+si}{:}\PYG{l+s+s2}{.4f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{ g}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{RSME = }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{rmse\PYGZus{}vol}\PYG{l+s+si}{:}\PYG{l+s+s2}{.4f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{ g}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{R¬≤ adj = }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{r2\PYGZus{}adj\PYGZus{}vol}\PYG{l+s+si}{:}\PYG{l+s+s2}{.4f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{ g}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\end{sphinxVerbatim}

\end{sphinxuseclass}\end{sphinxVerbatimInput}
\begin{sphinxVerbatimOutput}

\begin{sphinxuseclass}{cell_output}
\noindent\sphinxincludegraphics{{e0800f4e91383775e5710572b3a329f514745e6aaa476fd8d3c016b479478d6c}.png}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
Modelo ajustado: W = 0.75546 ¬∑ (0.720V)\PYGZca{}0.95762
R¬≤ = 0.9746
MAE = 0.4241 g
RSME = 0.5785 g
R¬≤ adj = 0.9744 g
\end{sphinxVerbatim}

\end{sphinxuseclass}\end{sphinxVerbatimOutput}

\end{sphinxuseclass}

\subsubsection{Modelo alom√©trico Longitud \sphinxhyphen{} Anchura \sphinxhyphen{} Altura: \protect\(W = k \cdot L^a \cdot A^b \cdot H^c\protect\)}
\label{\detokenize{content/03/Coeficientes:modelo-alometrico-longitud-anchura-altura-w-k-cdot-l-a-cdot-a-b-cdot-h-c}}
\begin{sphinxuseclass}{cell}\begin{sphinxVerbatimInput}

\begin{sphinxuseclass}{cell_input}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{alometric\PYGZus{}model}\PYG{p}{(}\PYG{n}{X}\PYG{p}{,} \PYG{n}{k}\PYG{p}{,} \PYG{n}{a}\PYG{p}{,} \PYG{n}{b}\PYG{p}{,} \PYG{n}{c}\PYG{p}{)}\PYG{p}{:}
    \PYG{n}{L}\PYG{p}{,} \PYG{n}{A}\PYG{p}{,} \PYG{n}{H} \PYG{o}{=} \PYG{n}{X}
    \PYG{k}{return} \PYG{n}{k} \PYG{o}{*} \PYG{p}{(}\PYG{n}{L}\PYG{o}{*}\PYG{o}{*}\PYG{n}{a}\PYG{p}{)} \PYG{o}{*} \PYG{p}{(}\PYG{n}{A}\PYG{o}{*}\PYG{o}{*}\PYG{n}{b}\PYG{p}{)} \PYG{o}{*} \PYG{p}{(}\PYG{n}{H}\PYG{o}{*}\PYG{o}{*}\PYG{n}{c}\PYG{p}{)}

\PYG{n}{params\PYGZus{}nl}\PYG{p}{,} \PYG{n}{\PYGZus{}} \PYG{o}{=} \PYG{n}{curve\PYGZus{}fit}\PYG{p}{(}\PYG{n}{alometric\PYGZus{}model}\PYG{p}{,} \PYG{p}{(}\PYG{n}{L}\PYG{p}{,} \PYG{n}{A}\PYG{p}{,} \PYG{n}{H}\PYG{p}{)}\PYG{p}{,} \PYG{n}{W}\PYG{p}{)}
\PYG{n}{k}\PYG{p}{,}\PYG{n}{a}\PYG{p}{,}\PYG{n}{b}\PYG{p}{,}\PYG{n}{c} \PYG{o}{=} \PYG{n}{params\PYGZus{}nl}
\PYG{n}{W\PYGZus{}pred\PYGZus{}nl} \PYG{o}{=} \PYG{n}{alometric\PYGZus{}model}\PYG{p}{(}\PYG{p}{(}\PYG{n}{L}\PYG{p}{,} \PYG{n}{A}\PYG{p}{,} \PYG{n}{H}\PYG{p}{)}\PYG{p}{,} \PYG{n}{k}\PYG{p}{,} \PYG{n}{a}\PYG{p}{,} \PYG{n}{b}\PYG{p}{,} \PYG{n}{c}\PYG{p}{)}
\PYG{n}{r2\PYGZus{}nl} \PYG{o}{=} \PYG{n}{r2\PYGZus{}score}\PYG{p}{(}\PYG{n}{W}\PYG{p}{,} \PYG{n}{W\PYGZus{}pred\PYGZus{}nl}\PYG{p}{)}
\PYG{n}{r2\PYGZus{}adj\PYGZus{}nl} \PYG{o}{=} \PYG{l+m+mi}{1} \PYG{o}{\PYGZhy{}} \PYG{p}{(}\PYG{l+m+mi}{1} \PYG{o}{\PYGZhy{}} \PYG{n}{r2\PYGZus{}nl}\PYG{p}{)} \PYG{o}{*} \PYG{p}{(}\PYG{n}{n} \PYG{o}{\PYGZhy{}} \PYG{l+m+mi}{1}\PYG{p}{)} \PYG{o}{/} \PYG{p}{(}\PYG{n}{n} \PYG{o}{\PYGZhy{}} \PYG{l+m+mi}{3} \PYG{o}{\PYGZhy{}} \PYG{l+m+mi}{1}\PYG{p}{)}
\PYG{n}{rmse\PYGZus{}nl} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sqrt}\PYG{p}{(}\PYG{n}{mean\PYGZus{}squared\PYGZus{}error}\PYG{p}{(}\PYG{n}{W}\PYG{p}{,} \PYG{n}{W\PYGZus{}pred\PYGZus{}nl}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{mae\PYGZus{}nl} \PYG{o}{=} \PYG{n}{mean\PYGZus{}absolute\PYGZus{}error}\PYG{p}{(}\PYG{n}{W}\PYG{p}{,} \PYG{n}{W\PYGZus{}pred\PYGZus{}nl}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} √çndices de los datos}
\PYG{n}{indices} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{arange}\PYG{p}{(}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{W}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{residuos} \PYG{o}{=} \PYG{n}{W} \PYG{o}{\PYGZhy{}} \PYG{n}{W\PYGZus{}pred\PYGZus{}nl}

\PYG{n}{fig}\PYG{p}{,} \PYG{n}{axs} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplots}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{3}\PYG{p}{,} \PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{18}\PYG{p}{,} \PYG{l+m+mi}{5}\PYG{p}{)}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} === 1. Peso real vs. Peso predicho ===}
\PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{scatter}\PYG{p}{(}\PYG{n}{W}\PYG{p}{,} \PYG{n}{W\PYGZus{}pred\PYGZus{}nl}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.7}\PYG{p}{)}
\PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{p}{[}\PYG{n+nb}{min}\PYG{p}{(}\PYG{n}{W}\PYG{p}{)}\PYG{p}{,} \PYG{n+nb}{max}\PYG{p}{(}\PYG{n}{W}\PYG{p}{)}\PYG{p}{]}\PYG{p}{,} \PYG{p}{[}\PYG{n+nb}{min}\PYG{p}{(}\PYG{n}{W}\PYG{p}{)}\PYG{p}{,} \PYG{n+nb}{max}\PYG{p}{(}\PYG{n}{W}\PYG{p}{)}\PYG{p}{]}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{r\PYGZhy{}\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{L√≠nea ideal}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Peso real (W)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Peso predicho (W\PYGZus{}pred\PYGZus{}nl)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Real vs. Predicho}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{legend}\PYG{p}{(}\PYG{p}{)}
\PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{grid}\PYG{p}{(}\PYG{k+kc}{True}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} === 2. Comparaci√≥n por √≠ndice ===}
\PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{scatter}\PYG{p}{(}\PYG{n}{indices}\PYG{p}{,} \PYG{n}{W}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{n}{CSS4\PYGZus{}COLORS}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{lightskyblue}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Peso real}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.8}\PYG{p}{)}
\PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{scatter}\PYG{p}{(}\PYG{n}{indices}\PYG{p}{,} \PYG{n}{W\PYGZus{}pred\PYGZus{}nl}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{n}{CSS4\PYGZus{}COLORS}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{darkorange}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Peso predicho}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.6}\PYG{p}{)}
\PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{√çndice de muestra}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Peso}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Peso real vs. predicho por muestra}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{legend}\PYG{p}{(}\PYG{p}{)}
\PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{grid}\PYG{p}{(}\PYG{k+kc}{True}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} === 3. Gr√°fico de residuos ===}
\PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{o}{.}\PYG{n}{scatter}\PYG{p}{(}\PYG{n}{W\PYGZus{}pred\PYGZus{}nl}\PYG{p}{,} \PYG{n}{residuos}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.6}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{n}{CSS4\PYGZus{}COLORS}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{violet}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{)}
\PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{o}{.}\PYG{n}{axhline}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{red}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{linestyle}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZhy{}\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Peso predicho (W\PYGZus{}pred\PYGZus{}nl)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Residuo (W \PYGZhy{} W\PYGZus{}pred\PYGZus{}nl)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{An√°lisis de residuos}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{axs}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{o}{.}\PYG{n}{grid}\PYG{p}{(}\PYG{k+kc}{True}\PYG{p}{)}

\PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}


\PYG{c+c1}{\PYGZsh{} Resultados del ajuste}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Modelo ajustado: W = }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{k}\PYG{l+s+si}{:}\PYG{l+s+s2}{.5f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{¬∑ L\PYGZca{}}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{a}\PYG{l+s+si}{:}\PYG{l+s+s2}{.5f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{ ¬∑ A\PYGZca{}}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{b}\PYG{l+s+si}{:}\PYG{l+s+s2}{.5f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{¬∑ H\PYGZca{}}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{c}\PYG{l+s+si}{:}\PYG{l+s+s2}{.5f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{R¬≤ = }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{r2\PYGZus{}nl}\PYG{l+s+si}{:}\PYG{l+s+s2}{.4f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{MAE = }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{mae\PYGZus{}nl}\PYG{l+s+si}{:}\PYG{l+s+s2}{.4f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{ g}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{RSME = }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{rmse\PYGZus{}nl}\PYG{l+s+si}{:}\PYG{l+s+s2}{.4f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{ g}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{R¬≤ adj = }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{r2\PYGZus{}adj\PYGZus{}nl}\PYG{l+s+si}{:}\PYG{l+s+s2}{.4f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{ g}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\end{sphinxVerbatim}

\end{sphinxuseclass}\end{sphinxVerbatimInput}
\begin{sphinxVerbatimOutput}

\begin{sphinxuseclass}{cell_output}
\noindent\sphinxincludegraphics{{84f274be0dc1f5a6ba0c30afee4d8128ac1243fcdadecf8116ade04a975420d1}.png}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
Modelo ajustado: W = 0.17609¬∑ L\PYGZca{}1.24336 ¬∑ A\PYGZca{}1.16881¬∑ H\PYGZca{}0.49480
R¬≤ = 0.9833
MAE = 0.3237 g
RSME = 0.4681 g
R¬≤ adj = 0.9831 g
\end{sphinxVerbatim}

\end{sphinxuseclass}\end{sphinxVerbatimOutput}

\end{sphinxuseclass}

\subsection{Comparativa de modelos analizados}
\label{\detokenize{content/03/Coeficientes:comparativa-de-modelos-analizados}}
\begin{sphinxuseclass}{cell}\begin{sphinxVerbatimInput}

\begin{sphinxuseclass}{cell_input}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{modelos} \PYG{o}{=} \PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Longitud}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Superficie}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Longitud\PYGZhy{}Anchura}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Volumen}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Longitud\PYGZhy{}Anchura\PYGZhy{}Altura}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}
\PYG{n}{r2} \PYG{o}{=} \PYG{p}{[}\PYG{n}{r2\PYGZus{}long}\PYG{p}{,} \PYG{n}{r2\PYGZus{}pow}\PYG{p}{,} \PYG{n}{r2\PYGZus{}la}\PYG{p}{,} \PYG{n}{r2\PYGZus{}vol}\PYG{p}{,} \PYG{n}{r2\PYGZus{}nl}\PYG{p}{]}
\PYG{n}{r2\PYGZus{}adj} \PYG{o}{=} \PYG{p}{[}\PYG{n}{r2\PYGZus{}adj\PYGZus{}long}\PYG{p}{,} \PYG{n}{r2\PYGZus{}adj\PYGZus{}pow}\PYG{p}{,} \PYG{n}{r2\PYGZus{}adj\PYGZus{}la}\PYG{p}{,} \PYG{n}{r2\PYGZus{}adj\PYGZus{}vol}\PYG{p}{,} \PYG{n}{r2\PYGZus{}adj\PYGZus{}nl}\PYG{p}{]}
\PYG{n}{rmse} \PYG{o}{=} \PYG{p}{[}\PYG{n}{rmse\PYGZus{}long}\PYG{p}{,} \PYG{n}{rmse\PYGZus{}pow}\PYG{p}{,} \PYG{n}{rmse\PYGZus{}la}\PYG{p}{,} \PYG{n}{rmse\PYGZus{}vol}\PYG{p}{,} \PYG{n}{rmse\PYGZus{}nl}\PYG{p}{]}
\PYG{n}{mae} \PYG{o}{=} \PYG{p}{[}\PYG{n}{mae\PYGZus{}long}\PYG{p}{,} \PYG{n}{mae\PYGZus{}pow}\PYG{p}{,} \PYG{n}{mae\PYGZus{}la}\PYG{p}{,} \PYG{n}{mae\PYGZus{}vol}\PYG{p}{,} \PYG{n}{mae\PYGZus{}nl}\PYG{p}{]}

\PYG{n}{results} \PYG{o}{=} \PYG{n}{pd}\PYG{o}{.}\PYG{n}{DataFrame}\PYG{p}{(}\PYG{p}{\PYGZob{}}
    \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Modelo Peso vs.}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{modelos}\PYG{p}{,}
    \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{R¬≤}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{r2}\PYG{p}{,}
    \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{R¬≤ ajustado}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{r2\PYGZus{}adj}\PYG{p}{,}
    \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{RMSE}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{rmse}\PYG{p}{,}
    \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{MAE}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{mae}
\PYG{p}{\PYGZcb{}}\PYG{p}{)}
\PYG{n}{results}
\end{sphinxVerbatim}

\end{sphinxuseclass}\end{sphinxVerbatimInput}
\begin{sphinxVerbatimOutput}

\begin{sphinxuseclass}{cell_output}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
           Modelo Peso vs.        R¬≤  R¬≤ ajustado      RMSE       MAE
0                 Longitud  0.943280     0.943006  0.863761  0.524589
1               Superficie  0.973307     0.973178  0.592544  0.373385
2         Longitud\PYGZhy{}Anchura  0.973946     0.973693  0.585408  0.373508
3                  Volumen  0.974558     0.974435  0.578497  0.424128
4  Longitud\PYGZhy{}Anchura\PYGZhy{}Altura  0.983343     0.983099  0.468080  0.323711
\end{sphinxVerbatim}

\end{sphinxuseclass}\end{sphinxVerbatimOutput}

\end{sphinxuseclass}

\subsection{Conclusiones}
\label{\detokenize{content/03/Coeficientes:conclusiones}}
\sphinxAtStartPar
El an√°lisis comparativo de los cinco modelos lineales desarrollados para predecir el peso de alevines de \sphinxstyleemphasis{Solea solea} revela que la adici√≥n progresiva de variables morfol√≥gicas incrementa el poder explicativo desde un \(R^{2}\) de \(0,94\), obtenido con la longitud como √∫nico predictor, hasta un \(0,98\) cuando se incorporan longitud, anchura y altura. Esta mejora se traduce en una reducci√≥n del error cuadr√°tico medio (RMSE) de \(0,86\,g\) a \(0,47\,g\) y del error absoluto medio (MAE) de \(0,52\,g\) a \(0,32\,g\). No obstante, la ganancia marginal entre los modelos basados en superficie (longitud‚ÄØ√ó‚ÄØanchura) y los que incluyen altura o volumen apenas alcanza \(0,11‚Äì0,12\,g\) en RMSE, lo que sugiere rendimientos decrecientes al introducir la tercera dimensi√≥n. Dado que la altura exige una adquisici√≥n estereosc√≥pica o reconstrucci√≥n volum√©trica costosa y propensa a errores, mientras que longitud y anchura se obtienen con alta precisi√≥n mediante sistemas de visi√≥n artificial 2‚ÄëD, el modelo de superficie emerge como la opci√≥n √≥ptima para estimaciones en l√≠nea de la biomasa durante el grading industrial.

\sphinxAtStartPar
Sin embargo, los coeficientes de ajuste fueron calculados sobre el conjunto completo de 209 individuos sin partici√≥n de entrenamiento y prueba ni validaci√≥n cruzada, lo que introduce un sesgo optimista dif√≠cil de cuantificar. Adem√°s, la ausencia de diagn√≥sticos de normalidad de residuos y de colinealidad entre predictores cuestiona la solidez estad√≠stica de los modelos multivariantes y aconseja la aplicaci√≥n de transformaciones alom√©tricas y t√©cnicas de regularizaci√≥n antes de su despliegue. Bajo un escenario operativo en el que los l√≠mites de talla est√°n separados varias veces el MAE (\textasciitilde{}0,37‚ÄØg para el modelo de superficie), el error residual estimado parece compatible con la precisi√≥n requerida; con todo, resulta imprescindible fijar umbrales de aceptabilidad. En s√≠ntesis, la modelizaci√≥n basada en longitud y anchura proporciona una estimaci√≥n robusta y operacionalmente viable del peso de \sphinxstyleemphasis{S. solea}, mientras que la inclusi√≥n de la altura ofrece beneficios estad√≠sticos marginales que no compensan la complejidad pr√°ctica a√±adida sin una validaci√≥n rigurosa que confirme su ventaja.

\sphinxstepscope


\section{An√°lisis del modelo alom√©trico longitud\sphinxhyphen{}anchura}
\label{\detokenize{content/03/Analisis:analisis-del-modelo-alometrico-longitud-anchura}}\label{\detokenize{content/03/Analisis::doc}}
\sphinxAtStartPar
Para profundizar en el modelo alom√©trico definido por la expresi√≥n matem√°tica \eqref{equation:content/03/Coeficientes:eq_peso-longitud_anchura} es preciso adoptar una estrategia rigurosamente secuencial que combine diagn√≥stico estad√≠stico exhaustivo, exploraci√≥n de formas funcionales alternativas y validaci√≥n externa. A lo largo de este cap√≠tulo analizaremos cada uno de estas fases de forma pormenorizada.


\subsection{Prean√°lisis exploratorio (EDA)}
\label{\detokenize{content/03/Analisis:preanalisis-exploratorio-eda}}
\sphinxAtStartPar
Un primer an√°lisis preliminar ya se realiz√≥ en el entregable E2.1 relativo a la {\hyperref[\detokenize{content/02/Dataset::doc}]{\sphinxcrossref{\DUrole{std,std-doc}{‚ÄúObtenci√≥n y etiquetado del dataset‚Äù}}}}. El an√°lisis de la matriz de correlaci√≥n indic√≥ que, en el lenguado, el peso est√° fuertemente asociado con la longitud y la anchura (r‚âà0,94), mientras que su asociaci√≥n con la altura (espesor corporal) es claramente menor (r‚âà0,86). En t√©rminos de varianza explicada, longitud y anchura individualmente capturan \textasciitilde{}88\% del comportamiento del peso (r¬≤‚âà0,8836), frente a \textasciitilde{}74\% para la altura (r¬≤‚âà0,7396). Esto es coherente con la biomec√°nica del pez plano: el peso depende del volumen, pero en especies deprimidas dorsoventralmente la variabilidad del √°rea proyectada (aprox. longitud√óanchura) domina sobre la variaci√≥n del espesor. La correlaci√≥n igualmente alta entre longitud y anchura (r‚âà0,94) sugiere una morfolog√≠a con proporciones relativamente estables durante el crecimiento (isometr√≠a planiforme) o, al menos, una fuerte covariaci√≥n de ambas dimensiones; en la pr√°ctica, esto implica multicolinealidad si se usan juntas en regresi√≥n. La correlaci√≥n m√°s baja de peso con la altura indica que el espesor es m√°s variable entre individuos (condici√≥n corporal, estado nutricional, maduraci√≥n gonadal), aportando informaci√≥n menos estable sobre el peso que las dimensiones planas. En conjunto, estas correlaciones significan que la masa del lenguado est√° principalmente determinada por su extensi√≥n superficial y que la altura a√±ade variabilidad m√°s idiosincr√°tica.

\sphinxAtStartPar
Para poder comprender mejor la relaci√≥n entre estas tres variables: peso \((W)\), longitud \((L)\) y anchura \((A)\) realizamos la correspondiente gr√°fica.

\begin{sphinxuseclass}{cell}\begin{sphinxVerbatimInput}

\begin{sphinxuseclass}{cell_input}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{pandas}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{pd}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{numpy}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{np}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{matplotlib}\PYG{n+nn}{.}\PYG{n+nn}{pyplot}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{plt}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{seaborn}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{sns}

\PYG{c+c1}{\PYGZsh{} Leer el dataset}
\PYG{n}{file\PYGZus{}path} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{.././data/Dimensiones\PYGZus{}lenguado.xlsx}\PYG{l+s+s1}{\PYGZsq{}}
\PYG{n}{df} \PYG{o}{=} \PYG{n}{pd}\PYG{o}{.}\PYG{n}{read\PYGZus{}excel}\PYG{p}{(}\PYG{n}{file\PYGZus{}path}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} SCATTER 3D PESO‚ÄìLONGITUD‚ÄìANCHURA}
\PYG{c+c1}{\PYGZsh{} \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{n}{fig} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{8}\PYG{p}{,}\PYG{l+m+mi}{8}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{ax} \PYG{o}{=} \PYG{n}{fig}\PYG{o}{.}\PYG{n}{add\PYGZus{}subplot}\PYG{p}{(}\PYG{l+m+mi}{111}\PYG{p}{,} \PYG{n}{projection}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{3d}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{ax}\PYG{o}{.}\PYG{n}{scatter}\PYG{p}{(}\PYG{n}{df}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Longitud (cm)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{,}
           \PYG{n}{df}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Anchura (cm)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{,}
           \PYG{n}{df}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Peso (g)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{,}
           \PYG{n}{s}\PYG{o}{=}\PYG{l+m+mi}{18}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.8}\PYG{p}{)}

\PYG{n}{ax}\PYG{o}{.}\PYG{n}{set\PYGZus{}xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Longitud (cm)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{labelpad}\PYG{o}{=}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{n}{fontsize}\PYG{o}{=}\PYG{l+m+mi}{14}\PYG{p}{)}
\PYG{n}{ax}\PYG{o}{.}\PYG{n}{set\PYGZus{}ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Anchura (cm)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{labelpad}\PYG{o}{=}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{n}{fontsize}\PYG{o}{=}\PYG{l+m+mi}{14}\PYG{p}{)}
\PYG{n}{ax}\PYG{o}{.}\PYG{n}{set\PYGZus{}zlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)} \PYG{c+c1}{\PYGZsh{} vaciamos el z\PYGZhy{}label ‚Äúnormal‚Äù}

\PYG{c+c1}{\PYGZsh{} Colocamos el texto como overlay 2\PYGZhy{}D para que no se recorte}
\PYG{n}{fig}\PYG{o}{.}\PYG{n}{text}\PYG{p}{(}\PYG{l+m+mf}{0.94}\PYG{p}{,} \PYG{l+m+mf}{0.52}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Peso (g)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{rotation}\PYG{o}{=}\PYG{l+m+mi}{90}\PYG{p}{,}
         \PYG{n}{va}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{center}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{ha}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{center}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{fontsize}\PYG{o}{=}\PYG{l+m+mi}{14}\PYG{p}{)}

\PYG{n}{ax}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Relaci√≥n Peso\PYGZhy{}Longitud\PYGZhy{}Anchura}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n}{ax}\PYG{o}{.}\PYG{n}{set\PYGZus{}box\PYGZus{}aspect}\PYG{p}{(}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mf}{0.8}\PYG{p}{]}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplots\PYGZus{}adjust}\PYG{p}{(}\PYG{n}{left}\PYG{o}{=}\PYG{l+m+mf}{0.05}\PYG{p}{,} \PYG{n}{right}\PYG{o}{=}\PYG{l+m+mf}{0.95}\PYG{p}{,} \PYG{n}{bottom}\PYG{o}{=}\PYG{l+m+mf}{0.05}\PYG{p}{,} \PYG{n}{top}\PYG{o}{=}\PYG{l+m+mf}{0.90}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}
\end{sphinxVerbatim}

\end{sphinxuseclass}\end{sphinxVerbatimInput}
\begin{sphinxVerbatimOutput}

\begin{sphinxuseclass}{cell_output}
\noindent\sphinxincludegraphics{{cbe03cbe628da960cc1fa765c89f3c5db7043e3e09d77d2bc506c1e4db884bdd}.png}

\end{sphinxuseclass}\end{sphinxVerbatimOutput}

\end{sphinxuseclass}
\sphinxAtStartPar
El diagrama de dispersi√≥n tridimensional muestra que los datos se distribuyen sobre una superficie t√≠pica de crecimiento alom√©trico: el peso (\(W\)) aumenta de forma supralineal con la longitud (\(L\)) y la anchura (\(A\)). Esta curvatura descarta cualquier ajuste plano cl√°sico y avala la f√≥rmula \eqref{equation:content/03/Coeficientes:eq_peso-longitud_anchura}; en coordenadas logar√≠tmicas la nube se comprimir√≠a pr√°cticamente en un plano, lo que simplifica la estimaci√≥n de \(a\), \(b\) y \(k\) mediante regresi√≥n lineal m√∫ltiple sobre \(\ln W\).

\sphinxAtStartPar
La secci√≥n horizontal del gr√°fico exhibe una correlaci√≥n positiva marcada entre \(L\) y \(A\); sin embargo, la dispersi√≥n transversal confirma que la anchura aporta informaci√≥n independiente ‚Äî es decir, \(b\) no resulta redundante respecto a \(a\). Adem√°s, la amplitud de la nube crece con el tama√±o, evidenciando heterocedasticidad: los ejemplares grandes presentan mayor variabilidad relativa de peso. Este patr√≥n exige, o bien la transformaci√≥n log‚Äìlog previa al ajuste, o bien el empleo de estimadores ponderados o robustos para preservar la validez inferencial.

\sphinxAtStartPar
En la proyecci√≥n vertical se identifican varios individuos que se separan netamente de la masa principal: unos pocos muy pesados para su talla y uno o dos sorprendentemente livianos. Estos casos coinciden con los at√≠picos y deben revisarse individualmente ‚Äîpudiendo tratarse de errores de registro, diferencias de condici√≥n corporal o etapas ontog√©nicas poco representadas.

\sphinxAtStartPar
\sphinxstylestrong{En conclusi√≥n, el an√°lisis gr√°fico corrobora la idoneidad de un modelo alom√©trico en \(L\) y \(A\), subraya la necesidad de transformar logar√≠tmicamente los datos o emplear m√©todos robustos y pone de relieve la importancia de manejar adecuadamente los valores at√≠picos para obtener estimaciones fiables de los par√°metros biol√≥gicos.}


\subsection{Visualizaci√≥n de \sphinxstyleemphasis{outliers}}
\label{\detokenize{content/03/Analisis:visualizacion-de-outliers}}
\sphinxAtStartPar
En el an√°lisis exploratorio se ha comprobado la existencia de \sphinxstyleemphasis{outliers} y su visualizaci√≥n es fundamental para comprender su impacto en la construcci√≥n del modelo predictivo. Estos valores at√≠picos pueden surgir por errores en la medici√≥n, variabilidad natural en la poblaci√≥n o condiciones excepcionales, y su presencia puede distorsionar los par√°metros estad√≠sticos y sesgar el modelo de regresi√≥n. Al representar gr√°ficamente los \sphinxstyleemphasis{outliers} se facilita la identificaci√≥n de observaciones aberrantes que podr√≠an afectar la linealidad, homocedasticidad o normalidad de los residuos. Adem√°s, su visualizaci√≥n permite evaluar si deben ser tratados mediante estrategias como winsorizaci√≥n, eliminaci√≥n o imputaci√≥n robusta, optimizando as√≠ la generalizaci√≥n del modelo.

\sphinxAtStartPar
Para contabilizar y visualizar estos \sphinxstyleemphasis{outliers} vamos a emplear primeramente un enfoque univariado (detecci√≥n en una dimensi√≥n) para despu√©s aplicar un enfoque multivariado que permite la detecci√≥n en m√∫ltiples variables.


\subsubsection{M√©todos univariados (detecci√≥n en una dimensi√≥n)}
\label{\detokenize{content/03/Analisis:metodos-univariados-deteccion-en-una-dimension}}\begin{itemize}
\item {}
\sphinxAtStartPar
\sphinxstylestrong{Rango intercuart√≠lico (IQR)} se define como la amplitud \(Q_{3}-Q_{1}\), donde \(Q_{1}\) y \(Q_{3}\) son, respectivamente, los percentiles 25\% y 75\% de la distribuci√≥n ordenada de una variable aleatoria continua. Constituye una medida robusta de dispersi√≥n, insensible a colas pesadas o valores aberrantes, pues encapsula el 50\% central de las observaciones. En procedimientos de depuraci√≥n de datos, el criterio aplicable considera at√≠pica toda observaci√≥n \(x\) que verifique \(x < Q_{1}-k\cdot \text{IQR}\) o \(x > Q_{3}+k\cdot \text{IQR}\), con \(k=1.5\) como valor convencional. Este umbral utiliza el IQR como escala de variabilidad intr√≠nseca y permite identificar \sphinxstyleemphasis{outliers} sin asumir normalidad ni recurrir a momentos de orden superior, favoreciendo diagn√≥sticos estad√≠sticos robustos en muestras heterog√©neas.

\item {}
\sphinxAtStartPar
\sphinxstylestrong{El Z\sphinxhyphen{}score}, o puntuaci√≥n est√°ndar, es una m√©trica estad√≠stica que cuantifica cu√°ntas desviaciones est√°ndar se aleja una observaci√≥n del valor medio de la distribuci√≥n, expresado como \(Z=\dfrac{X‚àíŒº}{œÉ}\), donde \(X\) es el valor observado, \(Œº\) la media poblacional y \(œÉ\) la desviaci√≥n est√°ndar. Este m√©todo es particularmente √∫til para identificar \sphinxstyleemphasis{outliers} en distribuciones normales o aproximadamente normales, consider√°ndose valores at√≠picos aquellos con \(‚à£Z‚à£>3\) (umbral que abarca el 99.7\% de los datos bajo la curva gaussiana). Sin embargo, su eficacia disminuye en distribuciones sesgadas o con colas pesadas, ya que la media y la desviaci√≥n est√°ndar son sensibles a valores extremos.

\end{itemize}

\begin{sphinxuseclass}{cell}\begin{sphinxVerbatimInput}

\begin{sphinxuseclass}{cell_input}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{c+c1}{\PYGZsh{}    METODOS UNIVARIADOS}
\PYG{c+c1}{\PYGZsh{} \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{iqr\PYGZus{}mask}\PYG{p}{(}\PYG{n}{series}\PYG{p}{,} \PYG{n}{k}\PYG{o}{=}\PYG{l+m+mf}{1.5}\PYG{p}{)}\PYG{p}{:}
    \PYG{n}{q1}\PYG{p}{,} \PYG{n}{q3} \PYG{o}{=} \PYG{n}{series}\PYG{o}{.}\PYG{n}{quantile}\PYG{p}{(}\PYG{p}{[}\PYG{l+m+mf}{0.25}\PYG{p}{,} \PYG{l+m+mf}{0.75}\PYG{p}{]}\PYG{p}{)}
    \PYG{n}{iqr} \PYG{o}{=} \PYG{n}{q3} \PYG{o}{\PYGZhy{}} \PYG{n}{q1}
    \PYG{k}{return} \PYG{p}{(}\PYG{n}{series} \PYG{o}{\PYGZlt{}} \PYG{n}{q1} \PYG{o}{\PYGZhy{}} \PYG{n}{k}\PYG{o}{*}\PYG{n}{iqr}\PYG{p}{)} \PYG{o}{|} \PYG{p}{(}\PYG{n}{series} \PYG{o}{\PYGZgt{}} \PYG{n}{q3} \PYG{o}{+} \PYG{n}{k}\PYG{o}{*}\PYG{n}{iqr}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} ********************************}
\PYG{c+c1}{\PYGZsh{}    IQR sobre cada variable}
\PYG{c+c1}{\PYGZsh{} ********************************}
\PYG{n}{mask\PYGZus{}iqr} \PYG{o}{=} \PYG{p}{(}
    \PYG{n}{iqr\PYGZus{}mask}\PYG{p}{(}\PYG{n}{df}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Peso (g)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{)} \PYG{o}{|}
    \PYG{n}{iqr\PYGZus{}mask}\PYG{p}{(}\PYG{n}{df}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Longitud (cm)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{)} \PYG{o}{|}
    \PYG{n}{iqr\PYGZus{}mask}\PYG{p}{(}\PYG{n}{df}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Anchura (cm)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{)}
\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Generamos una copia del data frame original}
\PYG{n}{df\PYGZus{}outliers} \PYG{o}{=} \PYG{n}{df}\PYG{o}{.}\PYG{n}{copy}\PYG{p}{(}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} A√±adimos los outliers detectados}
\PYG{n}{df\PYGZus{}outliers}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{out\PYGZus{}IQR}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{n}{mask\PYGZus{}iqr}


\PYG{c+c1}{\PYGZsh{} Filtrar outliers y a√±adir columnas de diagn√≥stico}
\PYG{n}{outliers\PYGZus{}iqr} \PYG{o}{=} \PYG{n}{df\PYGZus{}outliers}\PYG{p}{[}\PYG{n}{mask\PYGZus{}iqr}\PYG{p}{]}\PYG{o}{.}\PYG{n}{copy}\PYG{p}{(}\PYG{p}{)}
\PYG{n}{outliers\PYGZus{}iqr}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Raz√≥n\PYGZus{}outlier}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{\PYGZdq{}}

\PYG{c+c1}{\PYGZsh{} Identificar qu√© variables contribuyeron}

\PYG{k}{if} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Longitud (cm)}\PYG{l+s+s1}{\PYGZsq{}} \PYG{o+ow}{in} \PYG{n}{df}\PYG{o}{.}\PYG{n}{columns}\PYG{p}{:}
    \PYG{n}{outliers\PYGZus{}iqr}\PYG{o}{.}\PYG{n}{loc}\PYG{p}{[}\PYG{n}{iqr\PYGZus{}mask}\PYG{p}{(}\PYG{n}{df}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Longitud (cm)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{)}\PYG{p}{[}\PYG{n}{mask\PYGZus{}iqr}\PYG{p}{]}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Raz√≥n\PYGZus{}outlier}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{+}\PYG{o}{=} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Longitud; }\PYG{l+s+s2}{\PYGZdq{}}
\PYG{k}{if} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Anchura (cm)}\PYG{l+s+s1}{\PYGZsq{}} \PYG{o+ow}{in} \PYG{n}{df}\PYG{o}{.}\PYG{n}{columns}\PYG{p}{:}
    \PYG{n}{outliers\PYGZus{}iqr}\PYG{o}{.}\PYG{n}{loc}\PYG{p}{[}\PYG{n}{iqr\PYGZus{}mask}\PYG{p}{(}\PYG{n}{df}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Anchura (cm)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{)}\PYG{p}{[}\PYG{n}{mask\PYGZus{}iqr}\PYG{p}{]}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Raz√≥n\PYGZus{}outlier}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{+}\PYG{o}{=} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Anchura; }\PYG{l+s+s2}{\PYGZdq{}}
\PYG{k}{if} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Peso (g)}\PYG{l+s+s1}{\PYGZsq{}} \PYG{o+ow}{in} \PYG{n}{df}\PYG{o}{.}\PYG{n}{columns}\PYG{p}{:}
    \PYG{n}{outliers\PYGZus{}iqr}\PYG{o}{.}\PYG{n}{loc}\PYG{p}{[}\PYG{n}{iqr\PYGZus{}mask}\PYG{p}{(}\PYG{n}{df}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Peso (g)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{)}\PYG{p}{[}\PYG{n}{mask\PYGZus{}iqr}\PYG{p}{]}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Raz√≥n\PYGZus{}outlier}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{+}\PYG{o}{=} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Peso; }\PYG{l+s+s2}{\PYGZdq{}}

\PYG{c+c1}{\PYGZsh{} Mostrar resultado}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{IQR: N√∫mero de outliers detectados IQR: }\PYG{l+s+si}{\PYGZob{}}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{outliers\PYGZus{}iqr}\PYG{p}{)}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n}{outliers\PYGZus{}iqr}\PYG{o}{.}\PYG{n}{head}\PYG{p}{(}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{outliers\PYGZus{}iqr}\PYG{p}{)}\PYG{p}{)}
\end{sphinxVerbatim}

\end{sphinxuseclass}\end{sphinxVerbatimInput}
\begin{sphinxVerbatimOutput}

\begin{sphinxuseclass}{cell_output}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
IQR: N√∫mero de outliers detectados IQR: 11
\end{sphinxVerbatim}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
     Peso (g)  Longitud (cm)  Anchura (cm)  Altura (cm)  out\PYGZus{}IQR  \PYGZbs{}
194     13.45            9.7           4.0          0.6     True
197     13.56            9.7           4.1          0.6     True
200     14.13           10.1           4.1          0.7     True
201     14.04           10.5           4.1          0.7     True
202     14.67           10.7           4.2          0.7     True
203     15.65           10.7           4.5          0.6     True
204     14.50           10.8           4.5          0.6     True
205     19.88           11.4           4.4          0.9     True
206     16.47           11.0           4.6          0.7     True
207     17.04           10.6           4.8          0.7     True
208     21.98           10.6           5.2          0.8     True

       Raz√≥n\PYGZus{}outlier
194           Peso;
197           Peso;
200           Peso;
201           Peso;
202           Peso;
203           Peso;
204           Peso;
205           Peso;
206           Peso;
207           Peso;
208  Anchura; Peso;
\end{sphinxVerbatim}

\end{sphinxuseclass}\end{sphinxVerbatimOutput}

\end{sphinxuseclass}
\begin{sphinxuseclass}{cell}\begin{sphinxVerbatimInput}

\begin{sphinxuseclass}{cell_input}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} ********************************}
\PYG{c+c1}{\PYGZsh{}    Z\PYGZhy{}SCORE sobre cada variable}
\PYG{c+c1}{\PYGZsh{} ********************************}

\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{scipy}\PYG{n+nn}{.}\PYG{n+nn}{stats}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{zscore}

\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{zscore\PYGZus{}mask}\PYG{p}{(}\PYG{n}{series}\PYG{p}{,} \PYG{n}{threshold}\PYG{o}{=}\PYG{l+m+mi}{3}\PYG{p}{)}\PYG{p}{:}
    \PYG{n}{z\PYGZus{}scores} \PYG{o}{=} \PYG{n}{zscore}\PYG{p}{(}\PYG{n}{series}\PYG{p}{)}
    \PYG{k}{return} \PYG{n+nb}{abs}\PYG{p}{(}\PYG{n}{z\PYGZus{}scores}\PYG{p}{)} \PYG{o}{\PYGZgt{}} \PYG{n}{threshold}

\PYG{n}{mask\PYGZus{}zscore} \PYG{o}{=} \PYG{p}{(}
    \PYG{n}{zscore\PYGZus{}mask}\PYG{p}{(}\PYG{n}{df}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Peso (g)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{)} \PYG{o}{|}
    \PYG{n}{zscore\PYGZus{}mask}\PYG{p}{(}\PYG{n}{df}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Longitud (cm)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{)} \PYG{o}{|}
    \PYG{n}{zscore\PYGZus{}mask}\PYG{p}{(}\PYG{n}{df}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Anchura (cm)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{)}
\PYG{p}{)}
\PYG{c+c1}{\PYGZsh{} Introducimos los outliers en el dataframe correspondiente}
\PYG{n}{df\PYGZus{}outliers}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{out\PYGZus{}ZScore}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]} \PYG{o}{=} \PYG{n}{mask\PYGZus{}zscore}

\PYG{c+c1}{\PYGZsh{} Filtrar outliers y a√±adir columnas de diagn√≥stico}
\PYG{n}{outliers\PYGZus{}zscore} \PYG{o}{=} \PYG{n}{df\PYGZus{}outliers}\PYG{p}{[}\PYG{n}{mask\PYGZus{}zscore}\PYG{p}{]}\PYG{o}{.}\PYG{n}{copy}\PYG{p}{(}\PYG{p}{)}
\PYG{n}{outliers\PYGZus{}zscore}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Raz√≥n\PYGZus{}outlier}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{\PYGZdq{}}

\PYG{c+c1}{\PYGZsh{} A√±adir Z\PYGZhy{}scores para cada variable}
\PYG{k}{for} \PYG{n}{col} \PYG{o+ow}{in} \PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Peso (g)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Longitud (cm)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Anchura (cm)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{:}
    \PYG{k}{if} \PYG{n}{col} \PYG{o+ow}{in} \PYG{n}{df}\PYG{o}{.}\PYG{n}{columns}\PYG{p}{:}
        \PYG{n}{outliers\PYGZus{}zscore}\PYG{p}{[}\PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Z\PYGZus{}}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{col}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{n}{zscore}\PYG{p}{(}\PYG{n}{df}\PYG{p}{[}\PYG{n}{col}\PYG{p}{]}\PYG{p}{)}\PYG{p}{[}\PYG{n}{mask\PYGZus{}zscore}\PYG{p}{]}

\PYG{c+c1}{\PYGZsh{} Identificar qu√© variables contribuyeron}
\PYG{k}{if} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Longitud (cm)}\PYG{l+s+s1}{\PYGZsq{}} \PYG{o+ow}{in} \PYG{n}{df}\PYG{o}{.}\PYG{n}{columns}\PYG{p}{:}
    \PYG{n}{outliers\PYGZus{}zscore}\PYG{o}{.}\PYG{n}{loc}\PYG{p}{[}\PYG{n}{zscore\PYGZus{}mask}\PYG{p}{(}\PYG{n}{df}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Longitud (cm)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{)}\PYG{p}{[}\PYG{n}{mask\PYGZus{}zscore}\PYG{p}{]}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Raz√≥n\PYGZus{}outlier}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{+}\PYG{o}{=} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Longitud; }\PYG{l+s+s2}{\PYGZdq{}}
\PYG{k}{if} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Anchura (cm)}\PYG{l+s+s1}{\PYGZsq{}} \PYG{o+ow}{in} \PYG{n}{df}\PYG{o}{.}\PYG{n}{columns}\PYG{p}{:}
    \PYG{n}{outliers\PYGZus{}zscore}\PYG{o}{.}\PYG{n}{loc}\PYG{p}{[}\PYG{n}{zscore\PYGZus{}mask}\PYG{p}{(}\PYG{n}{df}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Anchura (cm)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{)}\PYG{p}{[}\PYG{n}{mask\PYGZus{}zscore}\PYG{p}{]}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Raz√≥n\PYGZus{}outlier}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{+}\PYG{o}{=} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Anchura; }\PYG{l+s+s2}{\PYGZdq{}}
\PYG{k}{if} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Peso (g)}\PYG{l+s+s1}{\PYGZsq{}} \PYG{o+ow}{in} \PYG{n}{df}\PYG{o}{.}\PYG{n}{columns}\PYG{p}{:}
    \PYG{n}{outliers\PYGZus{}zscore}\PYG{o}{.}\PYG{n}{loc}\PYG{p}{[}\PYG{n}{zscore\PYGZus{}mask}\PYG{p}{(}\PYG{n}{df}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Peso (g)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{)}\PYG{p}{[}\PYG{n}{mask\PYGZus{}zscore}\PYG{p}{]}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Raz√≥n\PYGZus{}outlier}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{+}\PYG{o}{=} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Peso; }\PYG{l+s+s2}{\PYGZdq{}}

\PYG{c+c1}{\PYGZsh{} Mostrar resultado}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Z\PYGZhy{}Score: N√∫mero de outliers detectados (|Z| \PYGZgt{} 3): }\PYG{l+s+si}{\PYGZob{}}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{outliers\PYGZus{}zscore}\PYG{p}{)}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n}{display}\PYG{p}{(}\PYG{n}{outliers\PYGZus{}zscore}\PYG{o}{.}\PYG{n}{style}\PYG{o}{.}\PYG{n}{format}\PYG{p}{(}\PYG{p}{\PYGZob{}}\PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Z\PYGZus{}}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{col}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+si}{\PYGZob{}:.2f\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}} \PYG{k}{for} \PYG{n}{col} \PYG{o+ow}{in} \PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Peso (g)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Longitud (cm)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Anchura (cm)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{k}{if} \PYG{n}{col} \PYG{o+ow}{in} \PYG{n}{df}\PYG{o}{.}\PYG{n}{columns}\PYG{p}{\PYGZcb{}}\PYG{p}{)}\PYG{p}{)}
\end{sphinxVerbatim}

\end{sphinxuseclass}\end{sphinxVerbatimInput}
\begin{sphinxVerbatimOutput}

\begin{sphinxuseclass}{cell_output}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
Z\PYGZhy{}Score: N√∫mero de outliers detectados (|Z| \PYGZgt{} 3): 4
\end{sphinxVerbatim}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYGZlt{}pandas.io.formats.style.Styler at 0x246bc8a4980\PYGZgt{}
\end{sphinxVerbatim}

\end{sphinxuseclass}\end{sphinxVerbatimOutput}

\end{sphinxuseclass}

\subsubsection{M√©todos multivariados}
\label{\detokenize{content/03/Analisis:metodos-multivariados}}
\sphinxAtStartPar
\sphinxstylestrong{Isolation Forest} es un algoritmo de detecci√≥n de anomal√≠as no supervisado basado en el principio de particiones aleatorias. A partir de un conjunto de \(n\) observaciones \(\{\mathbf{x}{i}\}{i=1}^{n}\subset\mathbb{R}^{p}\), se construye un bosque de \(t\) √°rboles binarios denominados \sphinxstyleemphasis{iTrees}; cada \sphinxstyleemphasis{iTree} se genera seleccionando recursivamente, de forma aleatoria, (i) una caracter√≠stica \(j\in\{1,\dots,p\}\) y (ii) un valor de corte \(\theta\) comprendido entre los valores m√≠nimo y m√°ximo de la caracter√≠stica en el subconjunto actual. El proceso contin√∫a hasta que la partici√≥n contiene un √∫nico punto o alcanza una profundidad m√°xima \(h_{\max}\). La idea fundamental es que las observaciones an√≥malas, al hallarse escasamente representadas y en regiones perif√©ricas del espacio de caracter√≠sticas, tienden a quedar aisladas tras un n√∫mero bajo de divisiones. Para cada muestra \(\mathbf{x}\) se define una profundidad promedio \(E[h(\mathbf{x})]\) ‚Äîpromediada sobre los \(t\) √°rboles‚Äî y de ella se deduce la puntuaci√≥n de anomal√≠a
\begin{equation}\label{equation:content/03/Analisis:eq_iforest_1}
\begin{split}s(\mathbf{x}) = 2^{-\frac{E[h(\mathbf{x})]}{c(n)}},
\qquad
c(n) = H_{n-1}-\frac{2(n-1)}{n},\end{split}
\end{equation}
\sphinxAtStartPar
donde \(H_{n}\) es el \(n\)\sphinxhyphen{}√©simo n√∫mero arm√≥nico. Los valores de \(s(\mathbf{x})\) se normalizan en \([0,1]\); puntuaciones pr√≥ximas a 1 indican observaciones susceptibles de ser outliers. El esquema evita suposiciones param√©tricas sobre la forma de la distribuci√≥n, es eficiente en alta dimensionalidad \((O(t\,n\log n))\) y permite fijar \sphinxstyleemphasis{a priori} la proporci√≥n esperada de anomal√≠as mediante el par√°metro \sphinxcode{\sphinxupquote{contamination}}, lo que lo hace id√≥neo para depuraci√≥n robusta de conjuntos de datos complejos.

\sphinxAtStartPar
Para abordar este algoritmo eliminamos de nuestro \sphinxstyleemphasis{dataset} la variable \sphinxcode{\sphinxupquote{Altura}} porque como ya concluimos anteriormente su exclusi√≥n no produce p√©rmida fundamental de informaci√≥n y s√≠ podria afectar a los resultados. Previamente a la aplicacion del algoritmo es necesario normalizar (estandarizar) las columnas seleccionadas para garantizar la efectividad del algoritmo en la detecci√≥n de anomal√≠as. Al estandarizar las variables mediante la transformaci√≥n \(\dfrac{X‚àíŒº}{œÉ}\), se homogenizan las escalas de todas las caracter√≠sticas, evitando que aquellas con magnitudes mayores dominen artificialmente el c√°lculo de anomal√≠as. Este paso es esencial porque \sphinxstyleemphasis{Isolation Forest}, al basarse en particiones aleatorias del espacio de caracter√≠sticas, puede generar sesgos en conjuntos de datos con variables en escalas heterog√©neas. La estandarizaci√≥n no solo mejora la sensibilidad del modelo a patrones multivariados de \sphinxstyleemphasis{outliers}, sino que tambi√©n facilita la interpretaci√≥n de los \sphinxstyleemphasis{scores} de anomal√≠a al operar en un espacio m√©trico coherente. Adicionalmente, al fijar la media en 0 y la varianza en 1, se optimiza el rendimiento computacional del algoritmo, ya que las distancias utilizadas en las particiones aleatorias de los √°rboles reflejan contribuciones equilibradas de todas las variables.

\begin{sphinxuseclass}{cell}\begin{sphinxVerbatimInput}

\begin{sphinxuseclass}{cell_input}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} ********************************}
\PYG{c+c1}{\PYGZsh{}  ISOLATION FOREST MULTIVARIABLE}
\PYG{c+c1}{\PYGZsh{} ********************************}

\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{sklearn}\PYG{n+nn}{.}\PYG{n+nn}{ensemble}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{IsolationForest}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{sklearn}\PYG{n+nn}{.}\PYG{n+nn}{preprocessing}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{StandardScaler}

\PYG{n}{iso} \PYG{o}{=} \PYG{n}{IsolationForest}\PYG{p}{(}\PYG{n}{contamination}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{auto}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{random\PYGZus{}state}\PYG{o}{=}\PYG{l+m+mi}{42}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Eliminamos la columna altura del dataset}
\PYG{n}{iso\PYGZus{}cols} \PYG{o}{=} \PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Peso (g)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Longitud (cm)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Anchura (cm)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}
\PYG{n}{X} \PYG{o}{=} \PYG{n}{df}\PYG{p}{[}\PYG{n}{iso\PYGZus{}cols}\PYG{p}{]}

\PYG{c+c1}{\PYGZsh{} Normalizamos los datos}
\PYG{n}{scaler} \PYG{o}{=} \PYG{n}{StandardScaler}\PYG{p}{(}\PYG{p}{)}
\PYG{n}{X\PYGZus{}scaled} \PYG{o}{=} \PYG{n}{scaler}\PYG{o}{.}\PYG{n}{fit\PYGZus{}transform}\PYG{p}{(}\PYG{n}{X}\PYG{p}{)}

\PYG{n}{labels\PYGZus{}iso} \PYG{o}{=} \PYG{n}{iso}\PYG{o}{.}\PYG{n}{fit\PYGZus{}predict}\PYG{p}{(}\PYG{n}{X\PYGZus{}scaled}\PYG{p}{)}
\PYG{n}{mask\PYGZus{}iso} \PYG{o}{=} \PYG{n}{labels\PYGZus{}iso} \PYG{o}{==} \PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}

\PYG{c+c1}{\PYGZsh{} Guardamos los ouliers en el dataframe}
\PYG{n}{df\PYGZus{}outliers}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{out\PYGZus{}iso}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]} \PYG{o}{=} \PYG{n}{mask\PYGZus{}iso}

\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{N¬∫ de outliers detectados: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{df\PYGZus{}outliers}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{out\PYGZus{}iso}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{o}{.}\PYG{n}{sum}\PYG{p}{(}\PYG{p}{)}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n}{display}\PYG{p}{(}\PYG{n}{df}\PYG{p}{[}\PYG{n}{df\PYGZus{}outliers}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{out\PYGZus{}iso}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{p}{]}\PYG{p}{)}

\PYG{n}{fig}\PYG{p}{,} \PYG{p}{(}\PYG{n}{ax1}\PYG{p}{,} \PYG{n}{ax2}\PYG{p}{)} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplots}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{14}\PYG{p}{,} \PYG{l+m+mi}{5}\PYG{p}{)}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Gr√°fica 1}
\PYG{n}{sns}\PYG{o}{.}\PYG{n}{scatterplot}\PYG{p}{(}\PYG{n}{data}\PYG{o}{=}\PYG{n}{df\PYGZus{}outliers}\PYG{p}{,} \PYG{n}{x}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Longitud (cm)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{y}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Peso (g)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,}
                \PYG{n}{hue}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{out\PYGZus{}iso}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{ax}\PYG{o}{=}\PYG{n}{ax1}\PYG{p}{,}
                \PYG{n}{palette}\PYG{o}{=}\PYG{p}{\PYGZob{}}\PYG{k+kc}{False}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{\PYGZsh{}2b7bba}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{k+kc}{True}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{\PYGZsh{}d62728}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{\PYGZcb{}}\PYG{p}{,}
                \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.8}\PYG{p}{,} \PYG{n}{s}\PYG{o}{=}\PYG{l+m+mi}{40}\PYG{p}{)}
\PYG{n}{ax1}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Peso vs Longitud ‚Äì outliers resaltados}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n}{ax1}\PYG{o}{.}\PYG{n}{legend}\PYG{p}{(}\PYG{n}{title}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Outlier}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{loc}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{upper left}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Gr√°fica 2}
\PYG{n}{sns}\PYG{o}{.}\PYG{n}{scatterplot}\PYG{p}{(}\PYG{n}{data}\PYG{o}{=}\PYG{n}{df\PYGZus{}outliers}\PYG{p}{,} \PYG{n}{x}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Anchura (cm)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{y}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Peso (g)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,}
                \PYG{n}{hue}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{out\PYGZus{}iso}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{ax}\PYG{o}{=}\PYG{n}{ax2}\PYG{p}{,}
                \PYG{n}{palette}\PYG{o}{=}\PYG{p}{\PYGZob{}}\PYG{k+kc}{False}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{\PYGZsh{}2b7bba}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{k+kc}{True}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{\PYGZsh{}d62728}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{\PYGZcb{}}\PYG{p}{,}
                \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.8}\PYG{p}{,} \PYG{n}{s}\PYG{o}{=}\PYG{l+m+mi}{40}\PYG{p}{)}
\PYG{n}{ax2}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Peso vs Anchura ‚Äì outliers resaltados}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n}{ax2}\PYG{o}{.}\PYG{n}{legend}\PYG{p}{(}\PYG{n}{title}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Outlier}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{loc}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{upper left}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}

\PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}
\end{sphinxVerbatim}

\end{sphinxuseclass}\end{sphinxVerbatimInput}
\begin{sphinxVerbatimOutput}

\begin{sphinxuseclass}{cell_output}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
N¬∫ de outliers detectados: 36
\end{sphinxVerbatim}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
     Peso (g)  Longitud (cm)  Anchura (cm)  Altura (cm)
0        0.46            3.3           1.3          0.2
1        1.08            4.5           1.1          0.3
2        0.67            3.9           1.5          0.2
3        0.98            4.4           1.7          0.3
4        0.93            4.2           1.8          0.3
5        1.89            4.5           2.0          0.4
6        1.60            5.1           1.8          0.3
92       3.06            6.0           2.9          0.4
141      6.96            7.2           3.3          0.5
153      3.40            6.8           3.9          0.4
156      4.50            7.4           3.7          0.4
183     10.08            7.8           4.2          0.7
185      9.79            9.7           3.5          0.6
186     10.10            9.7           3.5          0.6
187      9.28            9.5           3.6          0.6
188      9.51            9.4           3.7          0.6
189     10.18            9.1           3.9          0.5
190     10.38            9.3           3.9          0.6
191      9.82            9.7           3.8          0.6
192     11.35            9.7           4.0          0.6
193     12.70            9.7           4.0          0.7
194     13.45            9.7           4.0          0.6
195     11.22           10.1           3.9          0.6
196     12.37            9.7           4.1          0.6
197     13.56            9.7           4.1          0.6
198     11.28           10.0           4.0          0.6
199     12.91           10.1           4.0          0.6
200     14.13           10.1           4.1          0.7
201     14.04           10.5           4.1          0.7
202     14.67           10.7           4.2          0.7
203     15.65           10.7           4.5          0.6
204     14.50           10.8           4.5          0.6
205     19.88           11.4           4.4          0.9
206     16.47           11.0           4.6          0.7
207     17.04           10.6           4.8          0.7
208     21.98           10.6           5.2          0.8
\end{sphinxVerbatim}

\noindent\sphinxincludegraphics{{ff33ea5e1d6af53aa657bea9cf8ae53d30188d4a1fd2fc61e152136f03fa6e29}.png}

\end{sphinxuseclass}\end{sphinxVerbatimOutput}

\end{sphinxuseclass}
\sphinxAtStartPar
Los tres m√©todos empelados para encontrar outliers presentan diferentes n√∫meros de \sphinxstyleemphasis{outliers}. Dado que cada algoritmo de detecci√≥n de \sphinxstyleemphasis{outliers} se fundamenta en marcos estad√≠sticos divergentes ‚Äîel m√©todo del rango intercuart√≠lico (IQR) opera bajo un enfoque univariante robusto basado en cuantiles, pero carece de sensibilidad para capturar relaciones multivariadas; el Z\sphinxhyphen{}score presupone una distribuci√≥n cuasi\sphinxhyphen{}normal y cuantifica desviaciones en unidades de escala est√°ndar; mientras que Isolation Forest implementa un paradigma no param√©trico que aisla observaciones at√≠picas en espacios p\sphinxhyphen{}dimensionales mediante hiperplanos aleatorios‚Äî, se deriva como consecuencia te√≥rica que los conjuntos de anomal√≠as identificados presentar√°n necesariamente solapamientos parciales.

\sphinxAtStartPar
Un an√°lisis de conjuntos (operaciones de intersecci√≥n y diferencia) puede ser una metodolog√≠a adecuada para: a) discriminar entre outliers de alta consistencia (aquellos que simult√°neamente exceden los umbrales de dispersi√≥n no param√©trica, violan los supuestos de normalidad y manifiestan rareza en la topolog√≠a multivariante), y b) identificar observaciones cuya clasificaci√≥n como at√≠picas es artefactual, dependiente de los supuestos espec√≠ficos de cada modelo. Este protocolo de validaci√≥n cruzada minimiza los errores de Tipo I (falsos positivos), incrementa la validez del preprocesamiento estad√≠stico y permite as√≠ una cuantificaci√≥n formal del sesgo metodol√≥gico inherente a cada t√©cnica.

\sphinxAtStartPar
El objetivo de este an√°lisis de conjuntos es delimitar aquellas observaciones que son identificadas como \sphinxstyleemphasis{outliers} por al menos dos m√©todos independientes, estableciendo as√≠ un criterio de consenso que refuerza la fiabilidad de la detecci√≥n. Cuando un mismo dato es marcado como an√≥malo por m√∫ltiples t√©cnicas ‚Äîcada una basada en supuestos estad√≠sticos distintos (p. ej., dispersi√≥n robusta, normalidad, o rareza multivariante)‚Äî, la probabilidad de que se trate de un verdadero valor aberrante, y no de un artefacto metodol√≥gico, aumenta significativamente.

\sphinxAtStartPar
Por tanto, estos \sphinxstyleemphasis{outliers} multimodales deben considerarse como observaciones genuinamente an√≥malas, ya sea debido a errores de medici√≥n o comportamientos sist√©micos at√≠picos, y su exclusi√≥n o tratamiento se justifica para garantizar la validez inferencial de los an√°lisis posteriores.

\begin{sphinxuseclass}{cell}\begin{sphinxVerbatimInput}

\begin{sphinxuseclass}{cell_input}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Conjuntos y solapamientos}
\PYG{n}{set\PYGZus{}iqr} \PYG{o}{=} \PYG{n+nb}{set}\PYG{p}{(}\PYG{n}{df\PYGZus{}outliers}\PYG{o}{.}\PYG{n}{index}\PYG{p}{[}\PYG{n}{df\PYGZus{}outliers}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{out\PYGZus{}IQR}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{]}\PYG{p}{)}
\PYG{n}{set\PYGZus{}zscore}   \PYG{o}{=} \PYG{n+nb}{set}\PYG{p}{(}\PYG{n}{df\PYGZus{}outliers}\PYG{o}{.}\PYG{n}{index}\PYG{p}{[}\PYG{n}{df\PYGZus{}outliers}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{out\PYGZus{}ZScore}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{]}\PYG{p}{)}
\PYG{n}{set\PYGZus{}if}  \PYG{o}{=} \PYG{n+nb}{set}\PYG{p}{(}\PYG{n}{df\PYGZus{}outliers}\PYG{o}{.}\PYG{n}{index}\PYG{p}{[}\PYG{n}{df\PYGZus{}outliers}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{out\PYGZus{}iso}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{]}\PYG{p}{)}

\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{‚îÄ Outliers por m√©todo ‚îÄ}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{IQR                : }\PYG{l+s+si}{\PYGZob{}}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{set\PYGZus{}iqr}\PYG{p}{)}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Z\PYGZhy{}Score |z| \PYGZgt{} 3    : }\PYG{l+s+si}{\PYGZob{}}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{set\PYGZus{}zscore}\PYG{p}{)}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Isolation Forest   : }\PYG{l+s+si}{\PYGZob{}}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{set\PYGZus{}if}\PYG{p}{)}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}

\PYG{n}{idx\PYGZus{}common} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{p}{[}
    \PYG{n+nb}{sorted}\PYG{p}{(}\PYG{n}{set\PYGZus{}iqr} \PYG{o}{\PYGZam{}} \PYG{n}{set\PYGZus{}zscore}\PYG{p}{)}\PYG{p}{,}
    \PYG{n+nb}{sorted}\PYG{p}{(}\PYG{n}{set\PYGZus{}iqr} \PYG{o}{\PYGZam{}} \PYG{n}{set\PYGZus{}if}\PYG{p}{)}\PYG{p}{,}
    \PYG{n+nb}{sorted}\PYG{p}{(}\PYG{n}{set\PYGZus{}zscore} \PYG{o}{\PYGZam{}} \PYG{n}{set\PYGZus{}if}\PYG{p}{)}\PYG{p}{,}
    \PYG{n+nb}{sorted}\PYG{p}{(}\PYG{n}{set\PYGZus{}iqr} \PYG{o}{\PYGZam{}} \PYG{n}{set\PYGZus{}zscore} \PYG{o}{\PYGZam{}} \PYG{n}{set\PYGZus{}if}\PYG{p}{)}
    \PYG{p}{]}\PYG{p}{,} \PYG{n}{dtype}\PYG{o}{=}\PYG{n+nb}{object}\PYG{p}{)} \PYG{c+c1}{\PYGZsh{} dtype=object para listas de distinto tama√±o}

\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{‚îÄ Intersecciones ‚îÄ}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{IQR ‚à© Z\PYGZhy{}Score: }\PYG{l+s+si}{\PYGZob{}}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{set\PYGZus{}iqr}\PYG{+w}{ }\PYG{o}{\PYGZam{}}\PYG{+w}{ }\PYG{n}{set\PYGZus{}zscore}\PYG{p}{)}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n}{outliers\PYGZus{}common} \PYG{o}{=} \PYG{n}{df\PYGZus{}outliers}\PYG{o}{.}\PYG{n}{loc}\PYG{p}{[}\PYG{n}{idx\PYGZus{}common}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{]}
\PYG{n}{display}\PYG{p}{(}\PYG{n}{outliers\PYGZus{}common}\PYG{p}{)}

\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{IQR ‚à© Isolation Forest     : }\PYG{l+s+si}{\PYGZob{}}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{set\PYGZus{}iqr}\PYG{+w}{ }\PYG{o}{\PYGZam{}}\PYG{+w}{ }\PYG{n}{set\PYGZus{}if}\PYG{p}{)}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n}{display}\PYG{p}{(}\PYG{n}{df\PYGZus{}outliers}\PYG{o}{.}\PYG{n}{loc}\PYG{p}{[}\PYG{n}{idx\PYGZus{}common}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{]}\PYG{p}{)}

\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Z\PYGZhy{}Score ‚à© Isolation Forest : }\PYG{l+s+si}{\PYGZob{}}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{set\PYGZus{}zscore}\PYG{+w}{ }\PYG{o}{\PYGZam{}}\PYG{+w}{ }\PYG{n}{set\PYGZus{}if}\PYG{p}{)}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n}{display}\PYG{p}{(}\PYG{n}{df\PYGZus{}outliers}\PYG{o}{.}\PYG{n}{loc}\PYG{p}{[}\PYG{n}{idx\PYGZus{}common}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{p}{]}\PYG{p}{)}

\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{IQR ‚à© Z\PYGZhy{}Score ‚à© IF         : }\PYG{l+s+si}{\PYGZob{}}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{set\PYGZus{}iqr}\PYG{+w}{ }\PYG{o}{\PYGZam{}}\PYG{+w}{ }\PYG{n}{set\PYGZus{}zscore}\PYG{+w}{ }\PYG{o}{\PYGZam{}}\PYG{+w}{ }\PYG{n}{set\PYGZus{}if}\PYG{p}{)}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n}{display}\PYG{p}{(}\PYG{n}{df\PYGZus{}outliers}\PYG{o}{.}\PYG{n}{loc}\PYG{p}{[}\PYG{n}{idx\PYGZus{}common}\PYG{p}{[}\PYG{l+m+mi}{3}\PYG{p}{]}\PYG{p}{]}\PYG{p}{)}
\end{sphinxVerbatim}

\end{sphinxuseclass}\end{sphinxVerbatimInput}
\begin{sphinxVerbatimOutput}

\begin{sphinxuseclass}{cell_output}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
‚îÄ Outliers por m√©todo ‚îÄ

IQR                : 11
Z\PYGZhy{}Score |z| \PYGZgt{} 3    : 4
Isolation Forest   : 36

‚îÄ Intersecciones ‚îÄ

IQR ‚à© Z\PYGZhy{}Score: 4
\end{sphinxVerbatim}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
     Peso (g)  Longitud (cm)  Anchura (cm)  Altura (cm)  out\PYGZus{}IQR  out\PYGZus{}ZScore  \PYGZbs{}
205     19.88           11.4           4.4          0.9     True        True
206     16.47           11.0           4.6          0.7     True        True
207     17.04           10.6           4.8          0.7     True        True
208     21.98           10.6           5.2          0.8     True        True

     out\PYGZus{}iso
205     True
206     True
207     True
208     True
\end{sphinxVerbatim}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
IQR ‚à© Isolation Forest     : 11
\end{sphinxVerbatim}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
     Peso (g)  Longitud (cm)  Anchura (cm)  Altura (cm)  out\PYGZus{}IQR  out\PYGZus{}ZScore  \PYGZbs{}
194     13.45            9.7           4.0          0.6     True       False
197     13.56            9.7           4.1          0.6     True       False
200     14.13           10.1           4.1          0.7     True       False
201     14.04           10.5           4.1          0.7     True       False
202     14.67           10.7           4.2          0.7     True       False
203     15.65           10.7           4.5          0.6     True       False
204     14.50           10.8           4.5          0.6     True       False
205     19.88           11.4           4.4          0.9     True        True
206     16.47           11.0           4.6          0.7     True        True
207     17.04           10.6           4.8          0.7     True        True
208     21.98           10.6           5.2          0.8     True        True

     out\PYGZus{}iso
194     True
197     True
200     True
201     True
202     True
203     True
204     True
205     True
206     True
207     True
208     True
\end{sphinxVerbatim}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
Z\PYGZhy{}Score ‚à© Isolation Forest : 4
\end{sphinxVerbatim}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
     Peso (g)  Longitud (cm)  Anchura (cm)  Altura (cm)  out\PYGZus{}IQR  out\PYGZus{}ZScore  \PYGZbs{}
205     19.88           11.4           4.4          0.9     True        True
206     16.47           11.0           4.6          0.7     True        True
207     17.04           10.6           4.8          0.7     True        True
208     21.98           10.6           5.2          0.8     True        True

     out\PYGZus{}iso
205     True
206     True
207     True
208     True
\end{sphinxVerbatim}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
IQR ‚à© Z\PYGZhy{}Score ‚à© IF         : 4
\end{sphinxVerbatim}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
     Peso (g)  Longitud (cm)  Anchura (cm)  Altura (cm)  out\PYGZus{}IQR  out\PYGZus{}ZScore  \PYGZbs{}
205     19.88           11.4           4.4          0.9     True        True
206     16.47           11.0           4.6          0.7     True        True
207     17.04           10.6           4.8          0.7     True        True
208     21.98           10.6           5.2          0.8     True        True

     out\PYGZus{}iso
205     True
206     True
207     True
208     True
\end{sphinxVerbatim}

\end{sphinxuseclass}\end{sphinxVerbatimOutput}

\end{sphinxuseclass}
\sphinxAtStartPar
Los tres m√©todos usados coinciden en se√±alar los cuatros registros 205 \sphinxhyphen{} 208 como \sphinxstyleemphasis{outliers} lo cual es indicativo de posibles errores o individuos excepcionales en nuestro dataset y deber√≠an no ser considerados en una mejora del modelo alom√©trico inferido. Por otro lado los registros 194\sphinxhyphen{}204 detectados como valores an√≥malos por los m√©todos IRQ e Isolation Forest pueden representar sesgo de muestreo, diferencias de condici√≥n o simple variabilidad natural.

\sphinxAtStartPar
La relaci√≥n emp√≠rica \(ùëä=ùëò \cdot L^a \cdot A^b\) es, por naturaleza, multiplicativa; de ella se deriva que la varianza de \(ùëä\) crece proporcionalmente a \(ùêø\) y \(A\). Este comportamiento genera heterocedasticidad: los residuos asociados a los ejemplares grandes presentan una dispersi√≥n mucho mayor que los de los de menor trama√±o, Bajo esta condici√≥n, las m√©tricas univariantes (IQR, desviaciones ùëß) y los algoritmos multivariantes (Isolation Forest) operan con escalas que ‚Äúinflan‚Äù artificialmente la distancia de los ejemplares grandes y ‚Äúcomprimen‚Äù la de los peque√±os, sesgando la detecci√≥n de valores at√≠picos. Aplicar una \sphinxstylestrong{transformaci√≥n logar√≠tmica} \(ln(‚ãÖ)\)
convierte esa relaci√≥n de potencia en un modelo lineal aditivo y estabiliza la varianza, de modo que la dispersi√≥n residual es aproximadamente homoced√°stica y m√°s sim√©trica. Los trabajos de \sphinxhref{https://doi.org/10.1111/bij.12038}{Packart (2013)} y posteriormente de  \sphinxhref{https://doi.org/10.1177/00045632211050531}{West (2022)} han demostrado que, tras la aplicac√≥n de una transformada logar√≠tmica, las colas asim√©tricas se reducen y las pruebas basadas en desviaci√≥n est√°ndar recuperan su tasa nominal de error I, recomendando expl√≠citamente esta pr√°ctica previa a cualquier inferencia param√©trica.

\sphinxAtStartPar
En estudios ictiol√≥gicos recientes la pr√°ctica se ha consolidado como est√°ndar. \sphinxhref{https://doi.org/10.3390/fishes8050222}{Rodr√≠guez\sphinxhyphen{}Garc√≠a et al. (2023)} aplican la transformaci√≥n logar√≠tmica antes de filtrar anomal√≠as en m√°s de 40 especies descartadas por la flota del golfo de C√°diz y resaltan que, tras el log, s√≥lo persiste un subconjunto m√≠nimo de registros verdaderamente aberrantes, mientras que la mayor√≠a de los \sphinxstyleemphasis{outliers} iniciales se explican por la escala multiplicativa del crecimiento. \sphinxhref{https://doi.org/10.1016/j.ejar.2022.07.005}{Xia et al. (2022)} en seis especies del Yangts√©‚Äî siguen este protocolo: estiman los par√°metros en escala log y eval√∫an la calidad de ajuste y los residuos sobre los datos transformados, obteniendo un filtrado de anomal√≠as significativamente m√°s fiable.

\begin{sphinxadmonition}{note}{Conclusi√≥n}

\sphinxAtStartPar
En nuestro caso, transformar a \(ln\) permitir√° redefinir los umbrales de IQR y Z\sphinxhyphen{}score sobre distribuciones casi sim√©tricas y comparables, validar la relevancia biol√≥gica de los registros 205‚Äì208 ‚Äîahora \sphinxstyleemphasis{outliers} un√°nimes‚Äî y re\sphinxhyphen{}evaluar los casos 194‚Äì204 en un entorno de varianza estabilizada, evitando expulsar datos v√°lidos que s√≥lo parec√≠an extremos por efecto de escala.
\end{sphinxadmonition}


\subsection{Transformada logar√≠tmica}
\label{\detokenize{content/03/Analisis:transformada-logaritmica}}
\begin{sphinxuseclass}{cell}\begin{sphinxVerbatimInput}

\begin{sphinxuseclass}{cell_input}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} ===============================================================}
\PYG{c+c1}{\PYGZsh{}     Transformaci√≥n logar√≠tmica, visualizaci√≥n preliminar}
\PYG{c+c1}{\PYGZsh{}          y re\PYGZhy{}detecci√≥n de outliers}
\PYG{c+c1}{\PYGZsh{} ===============================================================}

\PYG{c+c1}{\PYGZsh{} \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{c+c1}{\PYGZsh{} 1.  Seleccionar y depurar variables num√©ricas}
\PYG{c+c1}{\PYGZsh{} \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{n}{numeric\PYGZus{}cols} \PYG{o}{=} \PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Peso (g)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Longitud (cm)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Anchura (cm)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}

\PYG{c+c1}{\PYGZsh{}eps = 1e\PYGZhy{}6                                 \PYGZsh{} evita log(0)}
\PYG{c+c1}{\PYGZsh{}df[numeric\PYGZus{}cols] = df[numeric\PYGZus{}cols].clip(lower=eps)}

\PYG{c+c1}{\PYGZsh{} \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{c+c1}{\PYGZsh{} 2.  Transformaci√≥n log\PYGZhy{}natural}
\PYG{c+c1}{\PYGZsh{} \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{n}{df\PYGZus{}log} \PYG{o}{=} \PYG{n}{df}\PYG{p}{[}\PYG{n}{numeric\PYGZus{}cols}\PYG{p}{]}\PYG{o}{.}\PYG{n}{copy}\PYG{p}{(}\PYG{p}{)}
\PYG{n}{df\PYGZus{}log} \PYG{o}{=} \PYG{n}{df\PYGZus{}log}\PYG{p}{[}\PYG{n}{df\PYGZus{}log}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Peso (g)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{\PYGZgt{}} \PYG{l+m+mi}{0}\PYG{p}{]}

\PYG{n}{df\PYGZus{}log}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{log\PYGZus{}Peso}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{log}\PYG{p}{(}\PYG{n}{df\PYGZus{}log}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Peso (g)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{)}
\PYG{n}{df\PYGZus{}log}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{log\PYGZus{}Longitud}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{log}\PYG{p}{(}\PYG{n}{df\PYGZus{}log}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Longitud (cm)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{)}
\PYG{n}{df\PYGZus{}log}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{log\PYGZus{}Anchura}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{log}\PYG{p}{(}\PYG{n}{df\PYGZus{}log}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Anchura (cm)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{c+c1}{\PYGZsh{} 3.  Visualizar efecto de la transformaci√≥n}
\PYG{c+c1}{\PYGZsh{} \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{n}{sns}\PYG{o}{.}\PYG{n}{set}\PYG{p}{(}\PYG{n}{style}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{ticks}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{context}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{talk}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{}\PYGZsh{} 3\PYGZhy{}a. Histogramas Peso: original vs ln}
\PYG{n}{fig}\PYG{p}{,} \PYG{n}{ax} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplots}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{l+m+mi}{4}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{sns}\PYG{o}{.}\PYG{n}{histplot}\PYG{p}{(}\PYG{n}{df}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Peso (g)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{,} \PYG{n}{ax}\PYG{o}{=}\PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,} \PYG{n}{bins}\PYG{o}{=}\PYG{l+m+mi}{30}\PYG{p}{,} \PYG{n}{kde}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{)}
\PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Distribuci√≥n Peso (g) original}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n}{sns}\PYG{o}{.}\PYG{n}{histplot}\PYG{p}{(}\PYG{n}{df\PYGZus{}log}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{log\PYGZus{}Peso}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{,} \PYG{n}{ax}\PYG{o}{=}\PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{n}{bins}\PYG{o}{=}\PYG{l+m+mi}{30}\PYG{p}{,} \PYG{n}{kde}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{\PYGZsh{}ff7f0e}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Distribuci√≥n ln Peso}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{}\PYGZsh{} 3\PYGZhy{}b. Scatter Peso‚ÄìLongitud: lineal vs log\PYGZhy{}log}
\PYG{n}{fig}\PYG{p}{,} \PYG{n}{ax} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplots}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{l+m+mi}{4}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{sns}\PYG{o}{.}\PYG{n}{scatterplot}\PYG{p}{(}\PYG{n}{data}\PYG{o}{=}\PYG{n}{df}\PYG{p}{,} \PYG{n}{x}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Longitud (cm)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{y}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Peso (g)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{ax}\PYG{o}{=}\PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.7}\PYG{p}{)}
\PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Peso vs Longitud (escala lineal)}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n}{sns}\PYG{o}{.}\PYG{n}{scatterplot}\PYG{p}{(}\PYG{n}{x}\PYG{o}{=}\PYG{n}{df\PYGZus{}log}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{log\PYGZus{}Longitud}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{,} \PYG{n}{y}\PYG{o}{=}\PYG{n}{df\PYGZus{}log}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{log\PYGZus{}Peso}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{,} \PYG{n}{ax}\PYG{o}{=}\PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.7}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{\PYGZsh{}ff7f0e}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{ln Peso vs ln Longitud}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}


\PYG{c+c1}{\PYGZsh{}\PYGZsh{} 3\PYGZhy{}c. Scatter Peso‚ÄìAnchura: lineal vs log\PYGZhy{}log}
\PYG{n}{fig}\PYG{p}{,} \PYG{n}{ax} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplots}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{l+m+mi}{4}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{sns}\PYG{o}{.}\PYG{n}{scatterplot}\PYG{p}{(}\PYG{n}{data}\PYG{o}{=}\PYG{n}{df}\PYG{p}{,}
                \PYG{n}{x}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Anchura (cm)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{y}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Peso (g)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,}
                \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.7}\PYG{p}{,} \PYG{n}{ax}\PYG{o}{=}\PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{)}
\PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Peso vs Anchura (escala lineal)}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}xlabel}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Anchura (cm)}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}ylabel}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Peso (g)}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n}{sns}\PYG{o}{.}\PYG{n}{scatterplot}\PYG{p}{(}\PYG{n}{x}\PYG{o}{=}\PYG{n}{df\PYGZus{}log}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{log\PYGZus{}Anchura}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{,}
                \PYG{n}{y}\PYG{o}{=}\PYG{n}{df\PYGZus{}log}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{log\PYGZus{}Peso}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{,}
                \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.7}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{\PYGZsh{}ff7f0e}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{ax}\PYG{o}{=}\PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)}
\PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{ln Peso vs ln Anchura}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}xlabel}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{ln Anchura (cm)}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}ylabel}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{ln Peso (g)}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}

\PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}
\end{sphinxVerbatim}

\end{sphinxuseclass}\end{sphinxVerbatimInput}
\begin{sphinxVerbatimOutput}

\begin{sphinxuseclass}{cell_output}
\noindent\sphinxincludegraphics{{6e1f732a76106d46938952ffcb00265e67332a1e2ea642da9ec31410bfcc4e3f}.png}

\noindent\sphinxincludegraphics{{8a0fc139d3ba479e16b219a8052ad0980bebb7681aa774dbf703d3e18428d317}.png}

\noindent\sphinxincludegraphics{{fcc20e9fd86b39e0b79ae283e0f75229a38189f9535ae2a946481916ecbeaa6f}.png}

\end{sphinxuseclass}\end{sphinxVerbatimOutput}

\end{sphinxuseclass}
\sphinxAtStartPar
Como se puede apreciar en las gr√°ficas obtenidas, el uso de la transformada logar√≠tmica produce una normalizaci√≥n de la distribuci√≥n sesgada del peso y una linealizaci√≥n de las relaciones exponenciales de Peso vs. Longitud y Peso vs. Anchura. En el primer caso, normalizaci√≠√≥n, esto nos va a permitir un mejor ajuste a modelos param√©tricos. En el segundo caso, linealizaci√≥n, nos va a permitir aplicar unas regresi√≥n lineal multiparam√©trica sencilla para poder encontar los factores \(k\), \(a\) y \(b\) que definen el modelo alom√©trico de la ecuaci√≥n \eqref{equation:content/03/Coeficientes:eq_peso-longitud_anchura}.

\sphinxAtStartPar
Nuestro siguiente paso es detectar los \sphinxstyleemphasis{outliers} por los tres m√©todos usados con anterioridad (IRQ, Z\sphinxhyphen{}Scores e Isolation Forest) con los dtaos transformados.

\begin{sphinxuseclass}{cell}\begin{sphinxVerbatimInput}

\begin{sphinxuseclass}{cell_input}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{c+c1}{\PYGZsh{} 4.  Detecci√≥n de outliers en escala log}
\PYG{c+c1}{\PYGZsh{} \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{scipy}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{stats}

\PYG{c+c1}{\PYGZsh{} M√©todo IQR}
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{detect\PYGZus{}outliers\PYGZus{}iqr}\PYG{p}{(}\PYG{n}{col}\PYG{p}{,} \PYG{n}{k}\PYG{o}{=}\PYG{l+m+mf}{1.5}\PYG{p}{)}\PYG{p}{:}
    \PYG{n}{q1}\PYG{p}{,} \PYG{n}{q3} \PYG{o}{=} \PYG{n}{col}\PYG{o}{.}\PYG{n}{quantile}\PYG{p}{(}\PYG{p}{[}\PYG{l+m+mf}{0.25}\PYG{p}{,} \PYG{l+m+mf}{0.75}\PYG{p}{]}\PYG{p}{)}
    \PYG{n}{iqr} \PYG{o}{=} \PYG{n}{q3} \PYG{o}{\PYGZhy{}} \PYG{n}{q1}
    \PYG{k}{return} \PYG{p}{(}\PYG{n}{col} \PYG{o}{\PYGZlt{}} \PYG{n}{q1} \PYG{o}{\PYGZhy{}} \PYG{n}{k}\PYG{o}{*}\PYG{n}{iqr}\PYG{p}{)} \PYG{o}{|} \PYG{p}{(}\PYG{n}{col} \PYG{o}{\PYGZgt{}} \PYG{n}{q3} \PYG{o}{+} \PYG{n}{k}\PYG{o}{*}\PYG{n}{iqr}\PYG{p}{)}

\PYG{n}{mask\PYGZus{}iqr\PYGZus{}log} \PYG{o}{=} \PYG{p}{(}
    \PYG{n}{detect\PYGZus{}outliers\PYGZus{}iqr}\PYG{p}{(}\PYG{n}{df\PYGZus{}log}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{log\PYGZus{}Peso}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{)} \PYG{o}{|}
    \PYG{n}{detect\PYGZus{}outliers\PYGZus{}iqr}\PYG{p}{(}\PYG{n}{df\PYGZus{}log}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{log\PYGZus{}Longitud}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{)} \PYG{o}{|}
    \PYG{n}{detect\PYGZus{}outliers\PYGZus{}iqr}\PYG{p}{(}\PYG{n}{df\PYGZus{}log}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{log\PYGZus{}Anchura}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{)}
\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} M√©todo Z\PYGZhy{}score}
\PYG{n}{z\PYGZus{}scores} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{abs}\PYG{p}{(}\PYG{n}{stats}\PYG{o}{.}\PYG{n}{zscore}\PYG{p}{(}\PYG{n}{df\PYGZus{}log}\PYG{p}{[}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{log\PYGZus{}Peso}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{log\PYGZus{}Longitud}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{log\PYGZus{}Anchura}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{]}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{mask\PYGZus{}z\PYGZus{}log} \PYG{o}{=} \PYG{p}{(}\PYG{n}{z\PYGZus{}scores} \PYG{o}{\PYGZgt{}} \PYG{l+m+mi}{3}\PYG{p}{)}\PYG{o}{.}\PYG{n}{any}\PYG{p}{(}\PYG{n}{axis}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} M√©todo Isolation Forest}
\PYG{n}{X\PYGZus{}scaled\PYGZus{}log} \PYG{o}{=} \PYG{n}{StandardScaler}\PYG{p}{(}\PYG{p}{)}\PYG{o}{.}\PYG{n}{fit\PYGZus{}transform}\PYG{p}{(}\PYG{n}{df\PYGZus{}log}\PYG{p}{[}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{log\PYGZus{}Longitud}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{log\PYGZus{}Anchura}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{log\PYGZus{}Peso}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{]}\PYG{p}{)}
\PYG{n}{iso\PYGZus{}forest} \PYG{o}{=} \PYG{n}{IsolationForest}\PYG{p}{(}\PYG{n}{contamination}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{auto}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,}\PYG{n}{random\PYGZus{}state}\PYG{o}{=}\PYG{l+m+mi}{42}\PYG{p}{)}
\PYG{n}{mask\PYGZus{}if\PYGZus{}log} \PYG{o}{=} \PYG{n}{iso\PYGZus{}forest}\PYG{o}{.}\PYG{n}{fit\PYGZus{}predict}\PYG{p}{(}\PYG{n}{X\PYGZus{}scaled\PYGZus{}log}\PYG{p}{)} \PYG{o}{==} \PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}

\PYG{c+c1}{\PYGZsh{} Mostrar resultados}
\PYG{n}{df\PYGZus{}log}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{out\PYGZus{}IQR\PYGZus{}log}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{n}{mask\PYGZus{}iqr\PYGZus{}log}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Outliers m√©todo IQR}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n}{display}\PYG{p}{(}\PYG{n}{df\PYGZus{}log}\PYG{p}{[}\PYG{n}{df\PYGZus{}log}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{out\PYGZus{}IQR\PYGZus{}log}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{]}\PYG{p}{)}

\PYG{n}{df\PYGZus{}log}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{out\PYGZus{}Z\PYGZus{}log}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}   \PYG{o}{=} \PYG{n}{mask\PYGZus{}z\PYGZus{}log}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Outliers m√©todo Z\PYGZhy{}Score}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n}{display}\PYG{p}{(}\PYG{n}{df\PYGZus{}log}\PYG{p}{[}\PYG{n}{df\PYGZus{}log}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{out\PYGZus{}Z\PYGZus{}log}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{]}\PYG{p}{)}

\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Outliers m√©todo Isolation Forest}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n}{df\PYGZus{}log}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{out\PYGZus{}IF\PYGZus{}log}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}  \PYG{o}{=} \PYG{n}{mask\PYGZus{}if\PYGZus{}log}
\PYG{n}{display}\PYG{p}{(}\PYG{n}{df\PYGZus{}log}\PYG{p}{[}\PYG{n}{df\PYGZus{}log}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{out\PYGZus{}IF\PYGZus{}log}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{]}\PYG{p}{)}
\end{sphinxVerbatim}

\end{sphinxuseclass}\end{sphinxVerbatimInput}
\begin{sphinxVerbatimOutput}

\begin{sphinxuseclass}{cell_output}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
Outliers m√©todo IQR
\end{sphinxVerbatim}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
   Peso (g)  Longitud (cm)  Anchura (cm)  log\PYGZus{}Peso  log\PYGZus{}Longitud  log\PYGZus{}Anchura  \PYGZbs{}
0      0.46            3.3           1.3 \PYGZhy{}0.776529      1.193922     0.262364
1      1.08            4.5           1.1  0.076961      1.504077     0.095310
2      0.67            3.9           1.5 \PYGZhy{}0.400478      1.360977     0.405465

   out\PYGZus{}IQR\PYGZus{}log
0         True
1         True
2         True
\end{sphinxVerbatim}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
Outliers m√©todo Z\PYGZhy{}Score
\end{sphinxVerbatim}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
   Peso (g)  Longitud (cm)  Anchura (cm)  log\PYGZus{}Peso  log\PYGZus{}Longitud  log\PYGZus{}Anchura  \PYGZbs{}
0      0.46            3.3           1.3 \PYGZhy{}0.776529      1.193922     0.262364
1      1.08            4.5           1.1  0.076961      1.504077     0.095310

   out\PYGZus{}IQR\PYGZus{}log  out\PYGZus{}Z\PYGZus{}log
0         True       True
1         True       True
\end{sphinxVerbatim}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
Outliers m√©todo Isolation Forest
\end{sphinxVerbatim}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
     Peso (g)  Longitud (cm)  Anchura (cm)  log\PYGZus{}Peso  log\PYGZus{}Longitud  \PYGZbs{}
0        0.46            3.3           1.3 \PYGZhy{}0.776529      1.193922
1        1.08            4.5           1.1  0.076961      1.504077
2        0.67            3.9           1.5 \PYGZhy{}0.400478      1.360977
3        0.98            4.4           1.7 \PYGZhy{}0.020203      1.481605
4        0.93            4.2           1.8 \PYGZhy{}0.072571      1.435085
5        1.89            4.5           2.0  0.636577      1.504077
6        1.60            5.1           1.8  0.470004      1.629241
7        1.90            5.0           2.0  0.641854      1.609438
8        1.59            5.4           1.9  0.463734      1.686399
42       2.83            5.2           2.5  1.040277      1.648659
62       4.29            7.0           2.1  1.456287      1.945910
92       3.06            6.0           2.9  1.118415      1.791759
153      3.40            6.8           3.9  1.223775      1.916923
156      4.50            7.4           3.7  1.504077      2.001480
183     10.08            7.8           4.2  2.310553      2.054124
195     11.22           10.1           3.9  2.417698      2.312535
200     14.13           10.1           4.1  2.648300      2.312535
201     14.04           10.5           4.1  2.641910      2.351375
202     14.67           10.7           4.2  2.685805      2.370244
203     15.65           10.7           4.5  2.750471      2.370244
204     14.50           10.8           4.5  2.674149      2.379546
205     19.88           11.4           4.4  2.989714      2.433613
206     16.47           11.0           4.6  2.801541      2.397895
207     17.04           10.6           4.8  2.835564      2.360854
208     21.98           10.6           5.2  3.090133      2.360854

     log\PYGZus{}Anchura  out\PYGZus{}IQR\PYGZus{}log  out\PYGZus{}Z\PYGZus{}log  out\PYGZus{}IF\PYGZus{}log
0       0.262364         True       True        True
1       0.095310         True       True        True
2       0.405465         True      False        True
3       0.530628        False      False        True
4       0.587787        False      False        True
5       0.693147        False      False        True
6       0.587787        False      False        True
7       0.693147        False      False        True
8       0.641854        False      False        True
42      0.916291        False      False        True
62      0.741937        False      False        True
92      1.064711        False      False        True
153     1.360977        False      False        True
156     1.308333        False      False        True
183     1.435085        False      False        True
195     1.360977        False      False        True
200     1.410987        False      False        True
201     1.410987        False      False        True
202     1.435085        False      False        True
203     1.504077        False      False        True
204     1.504077        False      False        True
205     1.481605        False      False        True
206     1.526056        False      False        True
207     1.568616        False      False        True
208     1.648659        False      False        True
\end{sphinxVerbatim}

\end{sphinxuseclass}\end{sphinxVerbatimOutput}

\end{sphinxuseclass}
\begin{sphinxuseclass}{cell}\begin{sphinxVerbatimInput}

\begin{sphinxuseclass}{cell_input}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} ===============================================================}
\PYG{c+c1}{\PYGZsh{}  Comparativa de intersecciones entre los tres m√©todos (log)}
\PYG{c+c1}{\PYGZsh{} ===============================================================}

\PYG{c+c1}{\PYGZsh{} \PYGZhy{}\PYGZhy{}\PYGZhy{} Conjuntos de √≠ndices por m√©todo \PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{n}{set\PYGZus{}iqr\PYGZus{}log} \PYG{o}{=} \PYG{n+nb}{set}\PYG{p}{(}\PYG{n}{df\PYGZus{}log}\PYG{o}{.}\PYG{n}{index}\PYG{p}{[}\PYG{n}{df\PYGZus{}log}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{out\PYGZus{}IQR\PYGZus{}log}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{]}\PYG{p}{)}
\PYG{n}{set\PYGZus{}z\PYGZus{}log}   \PYG{o}{=} \PYG{n+nb}{set}\PYG{p}{(}\PYG{n}{df\PYGZus{}log}\PYG{o}{.}\PYG{n}{index}\PYG{p}{[}\PYG{n}{df\PYGZus{}log}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{out\PYGZus{}Z\PYGZus{}log}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{]}\PYG{p}{)}
\PYG{n}{set\PYGZus{}if\PYGZus{}log}  \PYG{o}{=} \PYG{n+nb}{set}\PYG{p}{(}\PYG{n}{df\PYGZus{}log}\PYG{o}{.}\PYG{n}{index}\PYG{p}{[}\PYG{n}{df\PYGZus{}log}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{out\PYGZus{}IF\PYGZus{}log}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{]}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} \PYGZhy{}\PYGZhy{}\PYGZhy{} DataFrame que contiene √∫nicamente los registros marcados por alg√∫n m√©todo \PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{n}{df\PYGZus{}log}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{out\PYGZus{}any\PYGZus{}log}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{n}{df\PYGZus{}log}\PYG{p}{[}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{out\PYGZus{}IQR\PYGZus{}log}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{out\PYGZus{}Z\PYGZus{}log}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{out\PYGZus{}IF\PYGZus{}log}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{]}\PYG{o}{.}\PYG{n}{any}\PYG{p}{(}\PYG{n}{axis}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{)}

\PYG{n}{df\PYGZus{}outliers} \PYG{o}{=} \PYG{n}{df\PYGZus{}log}\PYG{p}{[}\PYG{n}{df\PYGZus{}log}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{out\PYGZus{}any\PYGZus{}log}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{]}

\PYG{c+c1}{\PYGZsh{} \PYGZhy{}\PYGZhy{}\PYGZhy{} Construimos un array con las cuatro intersecciones \PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{n}{idx\PYGZus{}common} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{p}{[}
    \PYG{n+nb}{sorted}\PYG{p}{(}\PYG{n}{set\PYGZus{}iqr\PYGZus{}log} \PYG{o}{\PYGZam{}} \PYG{n}{set\PYGZus{}z\PYGZus{}log}\PYG{p}{)}\PYG{p}{,}                \PYG{c+c1}{\PYGZsh{} IQR ‚à© Z\PYGZhy{}Score}
    \PYG{n+nb}{sorted}\PYG{p}{(}\PYG{n}{set\PYGZus{}iqr\PYGZus{}log} \PYG{o}{\PYGZam{}} \PYG{n}{set\PYGZus{}if\PYGZus{}log}\PYG{p}{)}\PYG{p}{,}               \PYG{c+c1}{\PYGZsh{} IQR ‚à© IF}
    \PYG{n+nb}{sorted}\PYG{p}{(}\PYG{n}{set\PYGZus{}z\PYGZus{}log}   \PYG{o}{\PYGZam{}} \PYG{n}{set\PYGZus{}if\PYGZus{}log}\PYG{p}{)}\PYG{p}{,}               \PYG{c+c1}{\PYGZsh{} Z\PYGZhy{}Score ‚à© IF}
    \PYG{n+nb}{sorted}\PYG{p}{(}\PYG{n}{set\PYGZus{}iqr\PYGZus{}log} \PYG{o}{\PYGZam{}} \PYG{n}{set\PYGZus{}z\PYGZus{}log} \PYG{o}{\PYGZam{}} \PYG{n}{set\PYGZus{}if\PYGZus{}log}\PYG{p}{)}    \PYG{c+c1}{\PYGZsh{} IQR ‚à© Z\PYGZhy{}Score ‚à© IF}
\PYG{p}{]}\PYG{p}{,} \PYG{n}{dtype}\PYG{o}{=}\PYG{n+nb}{object}\PYG{p}{)}   \PYG{c+c1}{\PYGZsh{} dtype=object permite listas de longitud variable}

\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{‚îÄ Intersecciones (escala log) ‚îÄ}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}

\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{IQR ‚à© Z\PYGZhy{}Score              : }\PYG{l+s+si}{\PYGZob{}}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{idx\PYGZus{}common}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{)}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n}{display}\PYG{p}{(}\PYG{n}{df\PYGZus{}outliers}\PYG{o}{.}\PYG{n}{loc}\PYG{p}{[}\PYG{n}{idx\PYGZus{}common}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{]}\PYG{p}{)}

\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{IQR ‚à© Isolation Forest     : }\PYG{l+s+si}{\PYGZob{}}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{idx\PYGZus{}common}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n}{display}\PYG{p}{(}\PYG{n}{df\PYGZus{}outliers}\PYG{o}{.}\PYG{n}{loc}\PYG{p}{[}\PYG{n}{idx\PYGZus{}common}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{]}\PYG{p}{)}

\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Z\PYGZhy{}Score ‚à© Isolation Forest : }\PYG{l+s+si}{\PYGZob{}}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{idx\PYGZus{}common}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{p}{)}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n}{display}\PYG{p}{(}\PYG{n}{df\PYGZus{}outliers}\PYG{o}{.}\PYG{n}{loc}\PYG{p}{[}\PYG{n}{idx\PYGZus{}common}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{p}{]}\PYG{p}{)}

\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{IQR ‚à© Z\PYGZhy{}Score ‚à© IF         : }\PYG{l+s+si}{\PYGZob{}}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{idx\PYGZus{}common}\PYG{p}{[}\PYG{l+m+mi}{3}\PYG{p}{]}\PYG{p}{)}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n}{display}\PYG{p}{(}\PYG{n}{df\PYGZus{}outliers}\PYG{o}{.}\PYG{n}{loc}\PYG{p}{[}\PYG{n}{idx\PYGZus{}common}\PYG{p}{[}\PYG{l+m+mi}{3}\PYG{p}{]}\PYG{p}{]}\PYG{p}{)}
\end{sphinxVerbatim}

\end{sphinxuseclass}\end{sphinxVerbatimInput}
\begin{sphinxVerbatimOutput}

\begin{sphinxuseclass}{cell_output}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
‚îÄ Intersecciones (escala log) ‚îÄ

IQR ‚à© Z\PYGZhy{}Score              : 2
\end{sphinxVerbatim}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
   Peso (g)  Longitud (cm)  Anchura (cm)  log\PYGZus{}Peso  log\PYGZus{}Longitud  log\PYGZus{}Anchura  \PYGZbs{}
0      0.46            3.3           1.3 \PYGZhy{}0.776529      1.193922     0.262364
1      1.08            4.5           1.1  0.076961      1.504077     0.095310

   out\PYGZus{}IQR\PYGZus{}log  out\PYGZus{}Z\PYGZus{}log  out\PYGZus{}IF\PYGZus{}log  out\PYGZus{}any\PYGZus{}log
0         True       True        True         True
1         True       True        True         True
\end{sphinxVerbatim}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
IQR ‚à© Isolation Forest     : 3
\end{sphinxVerbatim}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
   Peso (g)  Longitud (cm)  Anchura (cm)  log\PYGZus{}Peso  log\PYGZus{}Longitud  log\PYGZus{}Anchura  \PYGZbs{}
0      0.46            3.3           1.3 \PYGZhy{}0.776529      1.193922     0.262364
1      1.08            4.5           1.1  0.076961      1.504077     0.095310
2      0.67            3.9           1.5 \PYGZhy{}0.400478      1.360977     0.405465

   out\PYGZus{}IQR\PYGZus{}log  out\PYGZus{}Z\PYGZus{}log  out\PYGZus{}IF\PYGZus{}log  out\PYGZus{}any\PYGZus{}log
0         True       True        True         True
1         True       True        True         True
2         True      False        True         True
\end{sphinxVerbatim}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
Z\PYGZhy{}Score ‚à© Isolation Forest : 2
\end{sphinxVerbatim}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
   Peso (g)  Longitud (cm)  Anchura (cm)  log\PYGZus{}Peso  log\PYGZus{}Longitud  log\PYGZus{}Anchura  \PYGZbs{}
0      0.46            3.3           1.3 \PYGZhy{}0.776529      1.193922     0.262364
1      1.08            4.5           1.1  0.076961      1.504077     0.095310

   out\PYGZus{}IQR\PYGZus{}log  out\PYGZus{}Z\PYGZus{}log  out\PYGZus{}IF\PYGZus{}log  out\PYGZus{}any\PYGZus{}log
0         True       True        True         True
1         True       True        True         True
\end{sphinxVerbatim}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
IQR ‚à© Z\PYGZhy{}Score ‚à© IF         : 2
\end{sphinxVerbatim}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
   Peso (g)  Longitud (cm)  Anchura (cm)  log\PYGZus{}Peso  log\PYGZus{}Longitud  log\PYGZus{}Anchura  \PYGZbs{}
0      0.46            3.3           1.3 \PYGZhy{}0.776529      1.193922     0.262364
1      1.08            4.5           1.1  0.076961      1.504077     0.095310

   out\PYGZus{}IQR\PYGZus{}log  out\PYGZus{}Z\PYGZus{}log  out\PYGZus{}IF\PYGZus{}log  out\PYGZus{}any\PYGZus{}log
0         True       True        True         True
1         True       True        True         True
\end{sphinxVerbatim}

\end{sphinxuseclass}\end{sphinxVerbatimOutput}

\end{sphinxuseclass}
\sphinxAtStartPar
Los tres m√©todos usados coinciden en marcar como \sphinxstyleemphasis{outliers} los registros con √≠ndice \(0\) y \(1\) coincidente, en gran parte, con la gr√°fica de distribucion de peso en la transformada logaritmica.

\sphinxAtStartPar
Hay que tener en cuenta que en la deteccion de valores an√≥malos con los datos originales, el peso aumenta de manera multiplicativa con la longitud y la anchura: a medida que los peces crecen, la variabilidad absoluta de sus masas se dispara. Los m√©todos cl√°sicos de detecci√≥n (IQR, Z\sphinxhyphen{}score o Isolation Forest) se basan en distancias lineales; por eso se√±alan como at√≠picos a los cuatro ejemplares m√°s pesados: su desviaci√≥n, medida en gramos, es mucho mayor que la de cualquier juvenil.

\sphinxAtStartPar
Al pasar los datos a escala logar√≠tmica convertimos esa relaci√≥n multiplicativa en una relaci√≥n aditiva y hacemos que la varianza sea pr√°cticamente constante en todo el rango de tallas. La compresi√≥n de la cola derecha y la expansi√≥n de la izquierda cambian el foco: los adultos dejan de parecer extremos, mientras que tres peces muy peque√±os y sorprendentemente ligeros sobresalen ahora como los casos m√°s raros. Ese cambio de perspectiva ‚Äîbien descrito en la literatura sobre transformaciones varianza\sphinxhyphen{}estabilizadoras \sphinxhref{https://doi.org/10.1201/9780203738535}{{[}Carroll et al., 1988{]}}
y en estudios alom√©tricos {[}\sphinxhref{https://doi.org/10.1016/j.fishres.2012.02.001}{Torres et al., 2012}; \sphinxhref{https://doi.org/10.1111/j.1439-0426.2006.00805.x}{Froese, 2006}; \sphinxhref{https://doi.org/10.1111/j.1439-0426.2003.00480.x}{Borges et al., 2003}{]}‚Äî confirma que el log reduce los falsos positivos entre los grandes pero realza desv√≠os porcentuales en los peque√±os.

\sphinxAtStartPar
\sphinxstylestrong{¬øQu√© hacer con estos dos registros?}

\sphinxAtStartPar
Su inclusion en una regresi√≥n log\sphinxhyphen{}log podr√≠a sesgar los par√°metros \(k\), \(a\) y \(b\) y ensanchar sus intervalos de confianza. En ausencia de evidencia biol√≥gica a favor de su inclusi√≥n, la pr√°ctica m√°s segura para inferir un modelo alom√©trico por OLS es excluir esos puntos o, al menos, contrastar los coeficientes obtenidos con y sin ellos para demostrar que las conclusiones no dependen de casos extremos.

\sphinxstepscope


\section{Algoritmo de inferencia del peso \protect\(W\protect\)}
\label{\detokenize{content/03/Modelo:algoritmo-de-inferencia-del-peso-w}}\label{\detokenize{content/03/Modelo::doc}}
\sphinxAtStartPar
A partir de los estudios matematicos realizados en los cap√≠tulos anteriores podemos desarrollar un \sphinxstyleemphasis{pipeline} que dados los valores de longitud \(L\) y anchura \(A\) de un lenguado obtenidos por medici√≥n directa o mediante visi√≥n artificial obtengamos el peso estimado. La trasnformada logaritmica produce una normalizaci√≥n de la distribuci√≥n sesgada del peso y una linealizaci√≥n de las relaciones exponenciales de Peso vs. Longitud y Peso vs. Anchura, lo que nos permite usar el m√©todo \sphinxcode{\sphinxupquote{LinearRegression}} de la librer√≠a \sphinxcode{\sphinxupquote{scikit\sphinxhyphen{}learn}}. Esta librer√≠a ofrece implementaciones listas para usar de los algoritmos m√°s frecuentes en clasificaci√≥n, regresi√≥n, clustering, reducci√≥n de dimensi√≥n, validaci√≥n de modelos y preprocesado, todo ello bajo una API unificada que se resume en los m√©todos fit, predict y transform. Esta coherencia facilita encadenar pasos mediante \sphinxstyleemphasis{pipelines}, realizar b√∫squedas de hiperpar√°metros y/o estimar el error de generalizaci√≥n.

\sphinxAtStartPar
En aprendizaje autom√°tico, el \sphinxstylestrong{error de generalizaci√≥n} (tambi√©n denominado \sphinxstyleemphasis{riesgo esperado}) es la discrepancia estad√≠stica entre las predicciones de un modelo y los valores reales que se observar√≠an si el modelo se aplicase a todo el universo de datos posibles, no s√≥lo a la muestra con la que fue entrenado. Este error uede estimarse emp√≠ricamente y, a la vez, reducirse mediante validaci√≥n cruzada K\sphinxhyphen{}Fold. Esta t√©cnica particiona aleatoriamenteel conjunto de datos en \(K\) pliegues de tama√±o similar, cada iteraci√≥n reserva un pliegue como ‚Äúmuestra externa‚Äù y entrena el modelo con los \(K ‚Äì 1\) restantes, de modo que todas las observaciones se emplean sucesivamente como datos no vistos; el promedio de la m√©trica sobre los \(K\) ciclos proporciona una estimaci√≥n casi insesgada del riesgo esperado y presenta menor varianza que un √∫nico \sphinxstyleemphasis{hold\sphinxhyphen{}out}. Adem√°s, esa estructura repetida permite comparar hiperpar√°metros, arquitecturas o transformaciones y seleccionar la configuraci√≥n que minimiza la p√©rdida promedio en los pliegues, lo cual act√∫a como un proceso de regularizaci√≥n impl√≠cita que aten√∫a el sobreajuste y, por ende, disminuye el error de generalizaci√≥n del modelo final entrenado con el conjunto completo.

\begin{sphinxadmonition}{note}{¬øQue √©s \sphinxstyleemphasis{hold\sphinxhyphen{}out?}}

\sphinxAtStartPar
En aprendizaje autom√°tico, un \sphinxstyleemphasis{hold\sphinxhyphen{}out} es una estrategia de validaci√≥n que consiste en apartar de forma permanente una fracci√≥n del dataset ‚Äît√≠picamente entre el 20 \% y el 30 \%‚Äî para usarla exclusivamente como conjunto de prueba (test set). El resto de las observaciones se emplea para entrenar el modelo (y opcionalmente para ajustar hiperpar√°metros mediante un subconjunto de validaci√≥n interno). Durante el entrenamiento el modelo nunca ‚Äúve‚Äù los datos del \sphinxstyleemphasis{hold\sphinxhyphen{}out}; as√≠, el rendimiento calculado sobre ese bloque reservado ofrece una estimaci√≥n objetiva de su capacidad de generalizar a datos completamente nuevos. El m√©todo es sencillo y eficiente cuando se dispone de un volumen de datos muy grande, pero puede ser inestable en muestras moderadas o peque√±as, ya que la estimaci√≥n depende fuertemente de c√≥mo se haya realizado la partici√≥n; por esa raz√≥n suele sustituirse o complementarse con t√©cnicas m√°s robustas como la validaci√≥n cruzada K\sphinxhyphen{}Fold.
\end{sphinxadmonition}

\begin{sphinxuseclass}{cell}\begin{sphinxVerbatimInput}

\begin{sphinxuseclass}{cell_input}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} ==============================}
\PYG{c+c1}{\PYGZsh{} 1. CARGA DE LIBRER√çAS}
\PYG{c+c1}{\PYGZsh{} ==============================}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{numpy}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{np}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{pandas}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{pd}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{sklearn}\PYG{n+nn}{.}\PYG{n+nn}{linear\PYGZus{}model}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{LinearRegression}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{sklearn}\PYG{n+nn}{.}\PYG{n+nn}{model\PYGZus{}selection}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{KFold}\PYG{p}{,} \PYG{n}{cross\PYGZus{}val\PYGZus{}score}
\PYG{k+kn}{from}\PYG{+w}{ }\PYG{n+nn}{sklearn}\PYG{n+nn}{.}\PYG{n+nn}{metrics}\PYG{+w}{ }\PYG{k+kn}{import} \PYG{n}{mean\PYGZus{}squared\PYGZus{}error}\PYG{p}{,} \PYG{n}{make\PYGZus{}scorer}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{statsmodels}\PYG{n+nn}{.}\PYG{n+nn}{api}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{sm}            \PYG{c+c1}{\PYGZsh{} para diagn√≥stico opcional}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{matplotlib}\PYG{n+nn}{.}\PYG{n+nn}{pyplot}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{plt}

\PYG{c+c1}{\PYGZsh{} ==============================}
\PYG{c+c1}{\PYGZsh{} 2. LECTURA DEL DATASET + LIMPIEZA}
\PYG{c+c1}{\PYGZsh{} ==============================}
\PYG{n}{df} \PYG{o}{=} \PYG{n}{pd}\PYG{o}{.}\PYG{n}{read\PYGZus{}excel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{.././data/Dimensiones\PYGZus{}lenguado.xlsx}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Eliminamos los outliers detectados con IQR, Z\PYGZhy{}Score e Isolation Forest}
\PYG{n}{df} \PYG{o}{=} \PYG{n}{df}\PYG{o}{.}\PYG{n}{drop}\PYG{p}{(}\PYG{n}{index}\PYG{o}{=}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)}\PYG{o}{.}\PYG{n}{reset\PYGZus{}index}\PYG{p}{(}\PYG{n}{drop}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Renombramos columnas a algo m√°s manejable}
\PYG{n}{df} \PYG{o}{=} \PYG{n}{df}\PYG{o}{.}\PYG{n}{rename}\PYG{p}{(}\PYG{n}{columns}\PYG{o}{=}\PYG{p}{\PYGZob{}}
    \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Peso (g)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{W}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,}
    \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Longitud (cm)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{L}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,}
    \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Anchura (cm)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{A}\PYG{l+s+s1}{\PYGZsq{}}
\PYG{p}{\PYGZcb{}}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} ==============================}
\PYG{c+c1}{\PYGZsh{} 3. TRANSFORMACI√ìN LOGAR√çTMICA}
\PYG{c+c1}{\PYGZsh{}    ln(W) = ln(k) + a¬∑ln(L) + b¬∑ln(A)}
\PYG{c+c1}{\PYGZsh{} ==============================}
\PYG{n}{df}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{lnW}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{log}\PYG{p}{(}\PYG{n}{df}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{W}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{)}
\PYG{n}{df}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{lnL}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{log}\PYG{p}{(}\PYG{n}{df}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{L}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{)}
\PYG{n}{df}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{lnA}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{log}\PYG{p}{(}\PYG{n}{df}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{A}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{)}

\PYG{n}{X} \PYG{o}{=} \PYG{n}{df}\PYG{p}{[}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{lnL}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{lnA}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{]}\PYG{o}{.}\PYG{n}{values}          \PYG{c+c1}{\PYGZsh{} variables predictoras}
\PYG{n}{y} \PYG{o}{=} \PYG{n}{df}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{lnW}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{o}{.}\PYG{n}{values}                   \PYG{c+c1}{\PYGZsh{} variable respuesta}

\PYG{c+c1}{\PYGZsh{} ==============================}
\PYG{c+c1}{\PYGZsh{} 4. AJUSTE DEL MODELO}
\PYG{c+c1}{\PYGZsh{} ==============================}
\PYG{n}{linreg} \PYG{o}{=} \PYG{n}{LinearRegression}\PYG{p}{(}\PYG{p}{)}\PYG{o}{.}\PYG{n}{fit}\PYG{p}{(}\PYG{n}{X}\PYG{p}{,} \PYG{n}{y}\PYG{p}{)}
\PYG{n}{a}\PYG{p}{,} \PYG{n}{b}       \PYG{o}{=} \PYG{n}{linreg}\PYG{o}{.}\PYG{n}{coef\PYGZus{}}              \PYG{c+c1}{\PYGZsh{} exponentes}
\PYG{n}{ln\PYGZus{}k}       \PYG{o}{=} \PYG{n}{linreg}\PYG{o}{.}\PYG{n}{intercept\PYGZus{}}         \PYG{c+c1}{\PYGZsh{} ln(k)}
\PYG{n}{k}          \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{exp}\PYG{p}{(}\PYG{n}{ln\PYGZus{}k}\PYG{p}{)}              \PYG{c+c1}{\PYGZsh{} constante de proporcionalidad}
\PYG{n}{r2\PYGZus{}train}   \PYG{o}{=} \PYG{n}{linreg}\PYG{o}{.}\PYG{n}{score}\PYG{p}{(}\PYG{n}{X}\PYG{p}{,} \PYG{n}{y}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} ==============================}
\PYG{c+c1}{\PYGZsh{} 5. VALIDACI√ìN CRUZADA (5\PYGZhy{}fold)}
\PYG{c+c1}{\PYGZsh{} ==============================}
\PYG{n}{kf}      \PYG{o}{=} \PYG{n}{KFold}\PYG{p}{(}\PYG{n}{n\PYGZus{}splits}\PYG{o}{=}\PYG{l+m+mi}{5}\PYG{p}{,} \PYG{n}{shuffle}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{,} \PYG{n}{random\PYGZus{}state}\PYG{o}{=}\PYG{l+m+mi}{42}\PYG{p}{)}
\PYG{n}{r2\PYGZus{}cv}   \PYG{o}{=} \PYG{n}{cross\PYGZus{}val\PYGZus{}score}\PYG{p}{(}\PYG{n}{linreg}\PYG{p}{,} \PYG{n}{X}\PYG{p}{,} \PYG{n}{y}\PYG{p}{,} \PYG{n}{cv}\PYG{o}{=}\PYG{n}{kf}\PYG{p}{,} \PYG{n}{scoring}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{r2}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{o}{.}\PYG{n}{mean}\PYG{p}{(}\PYG{p}{)}
\PYG{n}{rmse\PYGZus{}cv} \PYG{o}{=} \PYG{o}{\PYGZhy{}}\PYG{n}{cross\PYGZus{}val\PYGZus{}score}\PYG{p}{(}
    \PYG{n}{linreg}\PYG{p}{,} \PYG{n}{X}\PYG{p}{,} \PYG{n}{y}\PYG{p}{,}
    \PYG{n}{cv}\PYG{o}{=}\PYG{n}{kf}\PYG{p}{,}
    \PYG{n}{scoring}\PYG{o}{=}\PYG{n}{make\PYGZus{}scorer}\PYG{p}{(}
        \PYG{k}{lambda} \PYG{n}{y\PYGZus{}true}\PYG{p}{,} \PYG{n}{y\PYGZus{}pred}\PYG{p}{:} \PYG{o}{\PYGZhy{}}\PYG{n}{np}\PYG{o}{.}\PYG{n}{sqrt}\PYG{p}{(}\PYG{n}{mean\PYGZus{}squared\PYGZus{}error}\PYG{p}{(}\PYG{n}{y\PYGZus{}true}\PYG{p}{,} \PYG{n}{y\PYGZus{}pred}\PYG{p}{)}\PYG{p}{)}
    \PYG{p}{)}
\PYG{p}{)}\PYG{o}{.}\PYG{n}{mean}\PYG{p}{(}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} ==============================}
\PYG{c+c1}{\PYGZsh{} 6. RESULTADOS}
\PYG{c+c1}{\PYGZsh{} ==============================}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Modelo alom√©trico:  W = }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{k}\PYG{l+s+si}{:}\PYG{l+s+s2}{.5f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{ ¬∑ L\PYGZca{}}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{a}\PYG{l+s+si}{:}\PYG{l+s+s2}{.3f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{ ¬∑ A\PYGZca{}}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{b}\PYG{l+s+si}{:}\PYG{l+s+s2}{.3f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{R¬≤ (entrenamiento): }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{r2\PYGZus{}train}\PYG{l+s+si}{:}\PYG{l+s+s2}{.4f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{R¬≤ (5\PYGZhy{}fold CV):     }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{r2\PYGZus{}cv}\PYG{l+s+si}{:}\PYG{l+s+s2}{.4f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{RMSE log\PYGZhy{}espacio (CV): }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{rmse\PYGZus{}cv}\PYG{l+s+si}{:}\PYG{l+s+s2}{.4f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} ==============================}
\PYG{c+c1}{\PYGZsh{} 7. DIAGN√ìSTICO OPCIONAL (Statsmodels)}
\PYG{c+c1}{\PYGZsh{} ==============================}
\PYG{n}{X\PYGZus{}sm} \PYG{o}{=} \PYG{n}{sm}\PYG{o}{.}\PYG{n}{add\PYGZus{}constant}\PYG{p}{(}\PYG{n}{df}\PYG{p}{[}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{lnL}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{lnA}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{]}\PYG{p}{)}
\PYG{n}{ols}   \PYG{o}{=} \PYG{n}{sm}\PYG{o}{.}\PYG{n}{OLS}\PYG{p}{(}\PYG{n}{y}\PYG{p}{,} \PYG{n}{X\PYGZus{}sm}\PYG{p}{)}\PYG{o}{.}\PYG{n}{fit}\PYG{p}{(}\PYG{p}{)}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{n}{ols}\PYG{o}{.}\PYG{n}{summary}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}


\PYG{c+c1}{\PYGZsh{} ==============================}
\PYG{c+c1}{\PYGZsh{} 8. FUNCI√ìN INFERENCIA}
\PYG{c+c1}{\PYGZsh{} =============================}

\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{estimate\PYGZus{}weight}\PYG{p}{(}\PYG{n}{L\PYGZus{}cm}\PYG{p}{:} \PYG{n+nb}{float}\PYG{p}{,} \PYG{n}{A\PYGZus{}cm}\PYG{p}{:} \PYG{n+nb}{float}\PYG{p}{)} \PYG{o}{\PYGZhy{}}\PYG{o}{\PYGZgt{}} \PYG{n+nb}{float}\PYG{p}{:}
\PYG{+w}{    }\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Devuelve el peso estimado (gramos) a partir de la longitud (L\PYGZus{}cm)}
\PYG{l+s+sd}{    y la anchura (A\PYGZus{}cm) usando el modelo W = k¬∑L\PYGZca{}a¬∑A\PYGZca{}b.}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{n}{ln\PYGZus{}hatW} \PYG{o}{=} \PYG{n}{ln\PYGZus{}k} \PYG{o}{+} \PYG{n}{a} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{log}\PYG{p}{(}\PYG{n}{L\PYGZus{}cm}\PYG{p}{)} \PYG{o}{+} \PYG{n}{b} \PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{log}\PYG{p}{(}\PYG{n}{A\PYGZus{}cm}\PYG{p}{)}
    \PYG{k}{return} \PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{exp}\PYG{p}{(}\PYG{n}{ln\PYGZus{}hatW}\PYG{p}{)}\PYG{p}{)}


\PYG{c+c1}{\PYGZsh{} ==============================}
\PYG{c+c1}{\PYGZsh{} 9. GR√ÅFICAS REAL vs. ESTIMADO}
\PYG{c+c1}{\PYGZsh{} =============================}

\PYG{c+c1}{\PYGZsh{} Pesos real y estimado en el orden del √≠ndice}
\PYG{n}{W\PYGZus{}real} \PYG{o}{=} \PYG{n}{df}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{W}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{o}{.}\PYG{n}{values}
\PYG{n}{W\PYGZus{}pred} \PYG{o}{=} \PYG{n}{estimate\PYGZus{}weight}\PYG{p}{(}\PYG{n}{df}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{L}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{o}{.}\PYG{n}{values}\PYG{p}{,} \PYG{n}{df}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{A}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{o}{.}\PYG{n}{values}\PYG{p}{)}

\PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{8}\PYG{p}{,} \PYG{l+m+mi}{4}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}
    \PYG{n}{W\PYGZus{}real}\PYG{p}{,}
    \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Peso real}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,}
    \PYG{n}{marker}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{o}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,}
    \PYG{n}{lw}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{,}
    \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{green}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,}    \PYG{c+c1}{\PYGZsh{} color solicitado}
    \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.2}         \PYG{c+c1}{\PYGZsh{} transparencia solicitada}
\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{W\PYGZus{}pred}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Peso estimado}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{marker}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{s}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{lw}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{orange}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.5}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Peso (g)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{√çndice del registro}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Peso real vs. peso estimado}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{legend}\PYG{p}{(}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}
\end{sphinxVerbatim}

\end{sphinxuseclass}\end{sphinxVerbatimInput}
\begin{sphinxVerbatimOutput}

\begin{sphinxuseclass}{cell_output}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
Modelo alom√©trico:  W = 0.03904 ¬∑ L\PYGZca{}1.895 ¬∑ A\PYGZca{}1.009
R¬≤ (entrenamiento): 0.9722
R¬≤ (5\PYGZhy{}fold CV):     0.9654
RMSE log\PYGZhy{}espacio (CV): 0.1109
                            OLS Regression Results
==============================================================================
Dep. Variable:                      y   R\PYGZhy{}squared:                       0.972
Model:                            OLS   Adj. R\PYGZhy{}squared:                  0.972
Method:                 Least Squares   F\PYGZhy{}statistic:                     3568.
Date:                Wed, 15 Oct 2025   Prob (F\PYGZhy{}statistic):          1.93e\PYGZhy{}159
Time:                        10:15:06   Log\PYGZhy{}Likelihood:                 177.68
No. Observations:                 207   AIC:                            \PYGZhy{}349.4
Df Residuals:                     204   BIC:                            \PYGZhy{}339.4
Df Model:                           2
Covariance Type:            nonrobust
==============================================================================
                 coef    std err          t      P\PYGZgt{}|t|      [0.025      0.975]
\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}
const         \PYGZhy{}3.2431      0.123    \PYGZhy{}26.447      0.000      \PYGZhy{}3.485      \PYGZhy{}3.001
lnL            1.8952      0.103     18.477      0.000       1.693       2.097
lnA            1.0092      0.088     11.427      0.000       0.835       1.183
==============================================================================
Omnibus:                       36.827   Durbin\PYGZhy{}Watson:                   1.883
Prob(Omnibus):                  0.000   Jarque\PYGZhy{}Bera (JB):              140.764
Skew:                          \PYGZhy{}0.618   Prob(JB):                     2.71e\PYGZhy{}31
Kurtosis:                       6.846   Cond. No.                         60.2
==============================================================================

Notes:
[1] Standard Errors assume that the covariance matrix of the errors is correctly specified.
\end{sphinxVerbatim}

\noindent\sphinxincludegraphics{{d1f1d2474d4ed529df077414a7f8273524f962d3790ca361d6acadfabc993f27}.png}

\end{sphinxuseclass}\end{sphinxVerbatimOutput}

\end{sphinxuseclass}

\subsection{Resultados}
\label{\detokenize{content/03/Modelo:resultados}}
\sphinxAtStartPar
El modelo obtenido ajusta un 97 \% de la variabilidad del peso, con coeficientes altamente significativos y un ajuste global validado por un F\sphinxhyphen{}statistic muy elevado. El diagn√≥stico de residuos ‚Äîla diferencia entre lo que el modelo predice y el dato observado‚Äî revela un ajuste cuantitativamente s√≥lido pero con ligeras desviaciones respecto a los supuestos cl√°sicos.

\sphinxAtStartPar
El estad√≠stico Durbin‚ÄìWatson nos indica la independencia entre errores consecutivos. Este par√°metro oscila entre 0 y 4, siendo el valor de 2 indicativo de un comportamiento ideal. Un 1.88 est√° tan cerca de 2 que podemos decir que no hay correlaci√≥n apreciable entre errores. En lo que respecta a la forma en la que se distribuyen los errores, los tests Omnibus y Jarque‚ÄìBera (p ‚âà 0) se√±alan que los residuos no son estrictamente normales, existiendo algo m√°s de casos con errores grandes por debajo de lo esperado (Skew < 0) con m√°s valores extremos de los normal (Kurtois > 3).

\sphinxAtStartPar
Por otro lado,  el n√∫mero de condici√≥n (Cond. No.) 60.2 indica colinealidad entre predictores moderada. Como es normal en peces, la longitud \(L\) y la anchura \(A\) son par√°metros muy interrelacionamos en peces. El valor obtenido con este estad√≠stico refleja justamente la existencia de correlacion que no compromete la predicci√≥n pero puede inflar la varianza de los coeficientes.

\sphinxAtStartPar
En l√≠neas generales el modelo es muy bueno explicando el peso a partir de las variables morfologicas. Para usos pr√°cticos de predicci√≥n, las peque√±as desviaciones de normalidad no son un problema. A efectos pr√°cticos una cuantificacion de la biomasa total del dataset observado vs. estimado arroja unos datos de 1117,03 g. y de 1109,92 g. respectivamente, lo cual indica que el algoritmo es capaz de ajustar la biomasa total de la muestra observada con una certeza del 99,34\%.







\renewcommand{\indexname}{Index}
\printindex
\end{document} 